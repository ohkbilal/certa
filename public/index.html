<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CERTA V17.7 - Industrial Fluid Assessment Platform | Policy V16.8 | 430+ Fluids</title>
<!-- UI-ENG-1 Â§29.7: Professional Typography -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CERTA V17.2 - UI-ENG-1 PROFESSIONAL ENGINEERING INTERFACE
   Policy V16.5.2 Â§29 | ISO 3864/ANSI Z535 Colors | Build: 2026-01-29
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* UI-ENG-1 Â§29.6: ISO 3864 / ANSI Z535 Safety Colors */
:root {
  --safety-danger: #DC2626;
  --safety-danger-bg: #FEE2E2;
  --safety-warning: #F59E0B;
  --safety-warning-bg: #FEF3C7;
  --safety-caution: #FBBF24;
  --safety-safe: #22C55E;
  --safety-safe-bg: #DCFCE7;
  --safety-info: #3B82F6;
  --safety-mandatory: #2563EB;
  
  /* UI-ENG-1 Â§29.7: Typography */
  --font-sans: 'Inter', 'Segoe UI', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', 'Consolas', monospace;
}

/* Dark Theme (Default) */
[data-theme="dark"] {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #1e293b;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --border-color: #334155;
  --accent: #3b82f6;
}

/* Light Theme */
[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --border-color: #e2e8f0;
  --accent: #2563eb;
}

*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-sans);background:linear-gradient(135deg,var(--bg-primary) 0%,var(--bg-secondary) 100%);min-height:100vh;color:var(--text-primary);padding:20px}

/* UI-ENG-1 Â§29.7: Monospace for numerical values */
input[type="number"], .prop-value, .re-value, .num, [data-numeric] {
  font-family: var(--font-mono) !important;
}

.container{max-width:900px;margin:0 auto}
.header{text-align:center;margin-bottom:30px;padding:30px;background:linear-gradient(135deg,#1e40af 0%,#7c3aed 100%);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.3)}
.header h1{font-size:2rem;margin-bottom:10px;text-shadow:0 2px 10px rgba(0,0,0,0.3)}
.header p{opacity:0.9;font-size:1.1rem}

/* UI-ENG-1: Policy Compliance Badges */
.policy-badges{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px 0}
.pbadge{padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
.pbadge-green{background:#059669;color:white}
.pbadge-purple{background:#7c3aed;color:white}
.pbadge-cyan{background:#0891b2;color:white}
.pbadge-gray{background:#475569;color:white}

/* UI-ENG-1 Â§29.6: Regime Badge with Risk-Proportional Styling */
.regime-badge-ui{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border-radius:12px;font-weight:700;font-size:1rem;text-transform:uppercase;letter-spacing:0.5px}
.regime-badge-ui.explosive{background:linear-gradient(135deg,#7f1d1d,#991b1b);color:#fecaca;border:2px solid var(--safety-danger);animation:pulse-danger 2s infinite}
.regime-badge-ui.oxidizing{background:linear-gradient(135deg,#7c2d12,#c2410c);color:#fed7aa;border:2px solid #f97316}
.regime-badge-ui.fluoride{background:linear-gradient(135deg,#581c87,#7c3aed);color:#e9d5ff;border:2px solid #a855f7}
.regime-badge-ui.acid{background:linear-gradient(135deg,#991b1b,#dc2626);color:#fecaca;border:2px solid var(--safety-danger)}
.regime-badge-ui.base{background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#dbeafe;border:2px solid var(--safety-info)}
.regime-badge-ui.neutral{background:linear-gradient(135deg,#064e3b,#059669);color:#d1fae5;border:2px solid var(--safety-safe)}
@keyframes pulse-danger{0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,0.4)}50%{box-shadow:0 0 0 8px rgba(220,38,38,0)}}

/* UI-ENG-1: Material Compatibility Badges */
.compat-ui{display:inline-flex;padding:3px 10px;border-radius:10px;font-size:0.65rem;font-weight:700;text-transform:uppercase}
.compat-ui.pass{background:var(--safety-safe-bg);color:#065f46;border:1px solid var(--safety-safe)}
.compat-ui.conditional{background:var(--safety-warning-bg);color:#92400e;border:1px solid var(--safety-warning)}
.compat-ui.fail{background:var(--safety-danger-bg);color:#991b1b;border:1px solid var(--safety-danger)}

/* UI-ENG-1: Confidence Indicators */
.conf-badge{display:inline-flex;padding:2px 6px;border-radius:8px;font-size:0.6rem;font-weight:600;font-family:var(--font-mono)}
.conf-badge.high{background:#064e3b;color:#6ee7b7}
.conf-badge.medium{background:#78350f;color:#fcd34d}
.conf-badge.low{background:#7f1d1d;color:#fca5a5}

.card{background:var(--bg-card);border-radius:16px;padding:24px;margin-bottom:20px;border:1px solid var(--border-color);box-shadow:0 10px 30px rgba(0,0,0,0.2)}
.search-box{width:100%;padding:14px 20px;border:2px solid var(--border-color);border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-size:1rem;margin-bottom:15px;transition:all 0.3s;font-family:var(--font-sans)}
.search-box:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.3)}
label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-secondary)}
select{width:100%;padding:14px;border:2px solid var(--border-color);border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-size:1rem;cursor:pointer;font-family:var(--font-sans)}
select[size]{padding:0;overflow-y:auto}
select[size] option{padding:10px 14px;border-bottom:1px solid var(--border-color)}
select[size] option:hover{background:#1e3a5f}
select[size] option:checked{background:var(--accent);color:white}
.fluid-item{padding:12px 14px;border-bottom:1px solid var(--border-color);cursor:pointer;color:var(--text-primary);font-size:0.9rem;transition:background 0.15s}
.fluid-item:hover{background:#1e3a5f}
.fluid-item.selected{background:var(--accent);color:white;font-weight:600}
select:focus{outline:none;border-color:var(--accent)}
.input-row{display:grid;grid-template-columns:1fr 100px;gap:12px;margin-bottom:20px}
input[type="number"]{width:100%;padding:14px;border:2px solid var(--border-color);border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-size:1rem}
input[type="number"]:focus{outline:none;border-color:var(--accent)}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s;font-family:var(--font-sans)}
.btn-primary{background:linear-gradient(135deg,var(--accent) 0%,#8b5cf6 100%);color:white}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(59,130,246,0.4)}
.btn-secondary{background:var(--border-color);color:var(--text-primary);margin-top:10px}
.btn-secondary:hover{background:#475569}
.results{margin-top:20px}
.results h2{font-size:1.5rem;margin-bottom:5px}
.results-cat{color:var(--text-secondary);margin-bottom:20px}
.warning{background:#7c2d12;border:1px solid #ea580c;color:#fed7aa;padding:12px;border-radius:8px;margin-bottom:15px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px}
/* V16.1 FIX: Mobile responsive - ensure all content visible per V15 Â§15 */
@media(max-width:600px){
  .grid{grid-template-columns:1fr}
  .header h1{font-size:1.4rem}
  .container{padding:8px}
  .card{padding:12px}
  .input-row{grid-template-columns:1fr 80px}
  .seal-specs{grid-template-columns:1fr}
  .mat-grid{grid-template-columns:repeat(2,1fr)}
  .compare-table{font-size:.7rem;min-width:unset;width:100%;table-layout:fixed}
  .compare-table th,.compare-table td{padding:8px 4px;word-wrap:break-word;overflow-wrap:break-word}
  .compare-table th:first-child,.compare-table td:first-child{width:25%}
  .compare-table th:nth-child(2),.compare-table td:nth-child(2){width:20%}
  .ppe-grid{grid-template-columns:1fr}
  .lang-bar{flex-wrap:wrap}
  .lang-btn{padding:6px 10px;font-size:.75rem}
  .flow-inputs{grid-template-columns:1fr}
  .re-display{font-size:1.2rem}
  .cav-card{padding:12px}
  /* V16.1: Fix lifecycle box and table overflow on mobile */
  .lifecycle-box{padding:10px;margin-left:-8px;margin-right:-8px;border-radius:8px}
  .table-scroll-wrapper{margin:0 -4px;padding:0 4px;width:calc(100% + 8px);overflow-x:auto;-webkit-overflow-scrolling:touch}
  .section-content{padding:12px}
  .policy-badges{gap:4px}
  .pbadge{font-size:0.6rem;padding:3px 6px}
}
.lang-bar{display:flex;gap:8px;justify-content:center;margin:15px 0}
.lang-btn{padding:8px 14px;background:var(--border-color);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);cursor:pointer;font-size:.85rem;transition:all .2s;font-family:var(--font-sans)}
.lang-btn:hover{background:#475569}
.lang-btn.active{background:var(--accent);border-color:var(--accent)}
.flow-card{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 100%);border-radius:16px;padding:24px;margin-bottom:20px;border:2px solid #3b82f6}
.flow-title{font-size:1.2rem;margin-bottom:15px;display:flex;align-items:center;gap:10px}
.flow-inputs{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px}
.flow-group{background:rgba(0,0,0,.2);padding:12px;border-radius:8px}
.flow-group label{font-size:.8rem;color:#94a3b8;margin-bottom:6px}
.flow-group input,.flow-group select{width:100%;padding:10px;background:#0f172a;border:1px solid #475569;border-radius:6px;color:#e2e8f0;font-size:.95rem}
.re-display{text-align:center;padding:20px;background:rgba(0,0,0,.3);border-radius:12px;margin-top:15px}
.re-value{font-size:2rem;font-weight:700;color:#60a5fa}
.re-label{font-size:.85rem;color:#94a3b8;margin-top:5px}
.flow-regime{margin-top:15px;padding:12px;border-radius:8px;text-align:center;font-weight:600}
.flow-regime.laminar{background:#064e3b;border:2px solid #10b981;color:#6ee7b7}
.flow-regime.transition{background:#78350f;border:2px solid #f59e0b;color:#fcd34d}
.flow-regime.turbulent{background:#7f1d1d;border:2px solid #ef4444;color:#fca5a5}
.cav-card{background:linear-gradient(135deg,#4c1d95 0%,#6d28d9 100%);border-radius:16px;padding:24px;margin-bottom:20px;border:2px solid #8b5cf6}
.cav-title{font-size:1.2rem;margin-bottom:15px}
.cav-result{padding:15px;border-radius:10px;margin-top:15px}
.cav-result.safe{background:#064e3b;border:2px solid #10b981}
.cav-result.warning{background:#78350f;border:2px solid #f59e0b}
.cav-result.danger{background:#7f1d1d;border:2px solid #ef4444}
.cav-status{font-size:1.5rem;font-weight:700;text-align:center;margin-bottom:10px}
.cav-details{display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.85rem}
.cav-item{background:rgba(0,0,0,.2);padding:8px;border-radius:6px}
.api-badge{display:inline-block;background:#10b981;color:#022c22;padding:4px 10px;border-radius:12px;font-size:.75rem;font-weight:600;margin-left:10px}
.api-endpoint{background:#0f172a;padding:12px;border-radius:8px;font-family:monospace;font-size:.8rem;overflow-x:auto;margin:10px 0;border:1px solid #334155}
.api-copy{padding:6px 12px;background:#3b82f6;border:none;border-radius:4px;color:white;cursor:pointer;font-size:.75rem;margin-top:8px}
.prop{background:#0f172a;padding:20px;border-radius:12px;text-align:center;border:1px solid #334155}
.prop-label{font-size:0.85rem;color:#94a3b8;margin-bottom:5px}
.prop-value{font-size:1.8rem;font-weight:700;color:#3b82f6}
.prop-unit{font-size:0.8rem;color:#64748b;margin-top:5px}
.temp-display{background:#0f172a;padding:12px;border-radius:8px;text-align:center;color:#94a3b8;margin-bottom:20px}
.section{border:1px solid #334155;border-radius:12px;margin-bottom:15px;overflow:hidden}
.section-header{background:#0f172a;padding:15px 20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600}
.section-header:hover{background:#1e293b}
.section-content{display:none;padding:20px;background:#0f172a}
.section-content.open{display:block}
.compat-group{margin-bottom:20px}
.compat-title{font-weight:600;margin-bottom:10px;padding:8px 12px;border-radius:6px}
.compat-title.excellent{background:#064e3b;color:#6ee7b7}
.compat-title.good{background:#1e3a5f;color:#7dd3fc}
.compat-title.poor{background:#7f1d1d;color:#fca5a5}
.compat-title.conditional{background:#1e3a5f;color:#7dd3fc}
.compat-item.conditional{background:#0c4a6e;border:1px solid #0284c7}
.compat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px}
.compat-item{padding:10px;border-radius:8px;text-align:center}
.compat-item.excellent{background:#022c22;border:1px solid #065f46}
.compat-item.good{background:#0c2d48;border:1px solid #1e40af}
.compat-item.poor{background:#450a0a;border:1px solid #991b1b}
.compat-name{font-weight:600;font-size:0.9rem}
.compat-type{font-size:0.75rem;color:#94a3b8}
.seal-card{background:#1e293b;border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid #475569}
.seal-card.sealless{border-left-color:#10b981;background:#022c22}
.seal-card.critical{border-left-color:#ef4444;background:#450a0a}
.seal-card.recommended{border-left-color:#f59e0b;background:#451a03}
.seal-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.seal-badge{padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:700}
.seal-badge.sealless{background:#10b981;color:#022c22}
.seal-badge.critical{background:#ef4444;color:white}
.seal-badge.recommended{background:#f59e0b;color:#451a03}
.seal-type{font-weight:700;font-size:1.1rem}
.seal-priority{color:#94a3b8;font-size:0.85rem;margin-bottom:10px}
.seal-reason{background:#0f172a;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #3b82f6}
.seal-specs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:600px){.seal-specs{grid-template-columns:1fr}}
.seal-spec{background:#0f172a;padding:10px;border-radius:6px}
.seal-spec-label{font-size:0.75rem;color:#64748b;margin-bottom:4px}
.hazard-signal{padding:15px;border-radius:10px;text-align:center;font-size:1.5rem;font-weight:700;margin-bottom:15px}
.hazard-signal.danger{background:#7f1d1d;border:2px solid #ef4444}
.hazard-signal.warning{background:#78350f;border:2px solid #f59e0b}
.hazard-signal.none{background:#1e293b;border:2px solid #475569;color:#94a3b8}
.hazard-section{margin-bottom:15px}
.hazard-section h4{color:#94a3b8;margin-bottom:8px;font-size:0.9rem}
.hazard-grid{display:flex;flex-wrap:wrap;gap:8px}
.hazard-class{background:#1e293b;padding:8px 12px;border-radius:6px;font-size:0.85rem;border:1px solid #334155}
.hazard-section ul{list-style:none;padding-left:0}
.hazard-section li{padding:6px 0;border-bottom:1px solid #334155}
.hazard-section li:last-child{border-bottom:none}
.ppe-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.ppe-item{background:#1e3a5f;padding:10px;border-radius:6px;font-size:0.85rem}
.first-aid{background:#064e3b;padding:12px;border-radius:8px;border:1px solid #10b981}
.disposal{background:#1e293b;padding:12px;border-radius:8px;border:1px solid #475569}
.aicis{background:#0f172a;padding:12px;border-radius:8px;margin-top:15px;font-size:0.85rem;color:#94a3b8}
.ref-item{border:1px solid #334155;border-radius:8px;margin-bottom:8px;overflow:hidden}
.ref-header{padding:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#1e293b}
.ref-header:hover{background:#334155}
.ref-num{color:#3b82f6;font-weight:700;margin-right:10px}
.ref-title{font-weight:500}
.ref-citations{display:none;padding:12px;background:#0f172a}
.ref-citations.open{display:block}
.citation{display:flex;align-items:flex-start;gap:10px;padding:8px;border-bottom:1px solid #334155;flex-wrap:wrap}
.citation:last-child{border-bottom:none}
.citation-label{background:#3b82f6;color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:700;min-width:60px;text-align:center}
.citation-text{flex:1;font-size:0.85rem;color:#cbd5e1;font-style:italic;min-width:200px}
.copy-btn{padding:4px 12px;background:#334155;border:none;border-radius:4px;color:#e2e8f0;cursor:pointer;font-size:0.75rem}
.copy-btn:hover{background:#475569}
.copy-btn.copied{background:#10b981}
.cats-section{margin-top:30px}
.cats-section h3{margin-bottom:15px;color:#94a3b8}
.cats-grid{display:flex;flex-wrap:wrap;gap:8px}
.cat-item{background:#1e293b;padding:8px 14px;border-radius:20px;font-size:0.8rem;border:1px solid #334155;cursor:pointer;transition:all 0.2s ease}
.cat-item:hover{background:#334155;border-color:#3b82f6;transform:translateY(-2px)}
.cat-item.acid{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);border-color:#dc2626;color:#fecaca}
.cat-item.base{background:linear-gradient(135deg,#1e3a8a 0%,#1d4ed8 100%);border-color:#3b82f6;color:#bfdbfe}
.cat-item.solvent{background:linear-gradient(135deg,#581c87 0%,#7c3aed 100%);border-color:#8b5cf6;color:#ddd6fe}
.cat-item.water{background:linear-gradient(135deg,#0c4a6e 0%,#0369a1 100%);border-color:#0ea5e9;color:#bae6fd}
.cat-item.fuel{background:linear-gradient(135deg,#78350f 0%,#a16207 100%);border-color:#f59e0b;color:#fef3c7}
.cat-item.food{background:linear-gradient(135deg,#14532d 0%,#166534 100%);border-color:#22c55e;color:#bbf7d0}
.cat-item.gas{background:linear-gradient(135deg,#1f2937 0%,#374151 100%);border-color:#6b7280;color:#e5e7eb}
.chart-box{background:#0f172a;border-radius:12px;padding:20px;margin-bottom:20px;border:2px solid #3b82f6}
.chart-title{text-align:center;font-size:1.1rem;margin-bottom:15px;color:#3b82f6}
#viscChart{width:100%;height:280px;background:#1e293b;border-radius:8px}
.chart-legend{display:flex;gap:20px;justify-content:center;margin-top:12px;font-size:0.85rem}
.legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
.legend-dot.data{background:#3b82f6}
.legend-dot.current{background:#ef4444}
.lifecycle-box{background:linear-gradient(135deg,#064e3b 0%,#065f46 100%);border-radius:16px;padding:24px;margin-bottom:20px;border:2px solid #10b981}
.lifecycle-title{font-size:1.2rem;margin-bottom:10px}
.mat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin:15px 0}
/* V16.1: Material button states per V15 Policy Â§15 - UI must mirror FAO exactly */
.mat-btn{padding:10px;background:#022c22;border:1px solid #10b981;border-radius:8px;cursor:pointer;text-align:center;transition:all 0.2s;font-size:0.85rem;color:#a7f3d0}
.mat-btn:hover{background:#064e3b}
.mat-btn.selected{background:#10b981;color:#022c22;font-weight:600}
/* V16.1 FIX: Excluded materials - V15 Â§12.2, Â§15 */
.mat-btn.excluded{background:#450a0a;border:2px solid #dc2626;color:#fca5a5;cursor:not-allowed;opacity:0.8}
.mat-btn.excluded:hover{background:#450a0a}
.mat-btn.excluded::after{content:' â›”';font-size:0.7rem}
/* V16.1 FIX: Conditional materials - V15 Â§11 */
.mat-btn.conditional{background:#451a03;border:2px solid #f59e0b;color:#fcd34d}
.mat-btn.conditional:hover{background:#78350f}
.mat-btn.conditional::after{content:' âš ï¸';font-size:0.7rem}
/* V16.1 FIX: Pass materials - explicitly green */
.mat-btn.pass{background:#022c22;border:1px solid #10b981;color:#a7f3d0}
.mat-btn.pass:hover{background:#064e3b}
.compare-table{width:100%;border-collapse:collapse;margin-top:15px;font-size:0.85rem}
.compare-table th,.compare-table td{padding:12px;text-align:left;border-bottom:1px solid #334155}
.compare-table th{background:#1e293b;color:#94a3b8;white-space:nowrap}
/* V16.1: Table scroll wrapper for mobile - full width visibility */
.table-scroll-wrapper{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;position:relative}
.table-scroll-wrapper table{min-width:450px}
.rating-badge{padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600}
.rating-badge.excellent{background:#10b981;color:#022c22}
.rating-badge.good{background:#3b82f6;color:white}
.rating-badge.fair{background:#f59e0b;color:#451a03}
.rating-badge.poor{background:#ef4444;color:white}
.rating-badge.conditional{background:#f59e0b;color:#451a03}
.cost-bar{height:8px;background:#334155;border-radius:4px;margin-top:4px}
.cost-fill{height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);border-radius:4px}
.rec-box{background:#1e293b;border-radius:12px;padding:16px;margin-top:15px;border-left:4px solid #10b981}
.rec-title{font-weight:700;margin-bottom:10px;color:#10b981}
.rec-item{padding:8px 0;border-bottom:1px solid #334155}
.rec-item:last-child{border-bottom:none}
.rec-badge{padding:3px 8px;border-radius:10px;font-size:0.7rem;font-weight:700;margin-right:8px}
.rec-badge.best{background:#10b981;color:#022c22}
.rec-badge.premium{background:#8b5cf6;color:white}
.rec-badge.avoid{background:#ef4444;color:white}
/* Confidence Score Styles */
.conf-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.conf-badge.very-high{background:#064e3b;color:#6ee7b7;border:1px solid #10b981}
.conf-badge.high{background:#1e3a5f;color:#7dd3fc;border:1px solid #3b82f6}
.conf-badge.moderate{background:#78350f;color:#fcd34d;border:1px solid #f59e0b}
.conf-badge.low{background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444}
.conf-badge:hover{transform:scale(1.05)}
.conf-info{font-size:0.85rem;cursor:help}
.conf-breakdown{display:none;margin-top:8px;padding:10px;background:#0f172a;border-radius:8px;font-size:0.8rem;border:1px solid #334155}
.conf-breakdown.open{display:block}
.conf-factor{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #1e293b}
.conf-factor:last-child{border-bottom:none}
.conf-factor-name{color:#94a3b8}
.conf-factor-score{font-weight:600}
.conf-factor-score.high{color:#10b981}
.conf-factor-score.mid{color:#f59e0b}
.conf-factor-score.low{color:#ef4444}
.conf-disclaimer{font-size:0.7rem;color:#64748b;margin-top:8px;font-style:italic}
.conf-warning{font-size:0.7rem;color:#fbbf24;background:#422006;padding:4px 8px;border-radius:4px;margin-top:4px;border-left:2px solid #f59e0b}
/* Hard Failure Gate V7.2 Styles */
.gate-banner{background:linear-gradient(135deg,#450a0a 0%,#7f1d1d 50%,#991b1b 100%);border:3px solid #ef4444;border-radius:16px;padding:24px;margin:20px 0;box-shadow:0 8px 32px rgba(239,68,68,0.3)}
.gate-header{font-size:1.4rem;font-weight:800;color:#fef2f2;text-align:center;margin-bottom:16px;text-transform:uppercase;letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,0.5)}
@media(max-width:600px){.gate-header{font-size:1rem;letter-spacing:1px}}
.gate-archetypes{text-align:center;color:#fca5a5;font-size:0.9rem;margin-bottom:16px;padding:8px;background:rgba(0,0,0,0.3);border-radius:8px;font-family:monospace}
.gate-section{margin:16px 0;padding:16px;border-radius:12px}
.gate-section.fatal{background:rgba(127,29,29,0.8);border-left:4px solid #ef4444}
.gate-section.temp{background:rgba(180,83,9,0.6);border-left:4px solid #f59e0b}
.gate-section.conditional{background:rgba(30,58,138,0.6);border-left:4px solid #3b82f6}
.gate-section.excluded{background:linear-gradient(135deg,#4a0519 0%,#7f1d1d 100%);border-left:4px solid #dc2626;border:2px solid #ef4444}
.gate-excluded-intro{color:#fecaca;font-size:0.85rem;margin-bottom:12px;font-style:italic}
.gate-excluded-item{background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin:8px 0;border-left:3px solid #ef4444}
.gate-excluded-name{color:#fef2f2;font-size:0.95rem}
.gate-excluded-mode{color:#f87171;font-size:0.8rem;margin-top:4px}
.gate-excluded-reason{color:#fca5a5;font-size:0.8rem;margin-top:4px;font-style:italic}
.gate-excluded-alt{color:#86efac;font-size:0.8rem;margin-top:6px}
.gate-dual-rating{color:#94a3b8;font-size:0.75rem;margin:4px 0}
.rating-excellent{color:#22c55e;font-weight:600}
.rating-limited{color:#f59e0b;font-weight:600}
.rating-none{color:#ef4444;font-weight:600}
.rating-acceptable{color:#22c55e;font-weight:600}
.rating-conditional{color:#f59e0b;font-weight:600}
.rating-prohibited{color:#ef4444;font-weight:600}
.gate-label{font-size:0.8rem;font-weight:700;color:#fef2f2;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.gate-item{color:#fee2e2;font-size:0.85rem;padding:12px;margin:8px 0;background:rgba(0,0,0,0.2);border-radius:8px;border-bottom:none}
.gate-failure-mode{color:#fcd34d;font-size:0.8rem;margin-top:4px}
.gate-trigger{color:#f87171;font-size:0.75rem;margin-top:4px;font-style:italic}
.gate-mitigation{color:#86efac;font-size:0.8rem;margin-top:6px}
.gate-mitigations{color:#86efac;font-size:0.75rem;margin-top:6px}
.gate-mitigations ul{margin:4px 0 0 16px;padding:0}
.gate-mitigations li{margin:2px 0}
.gate-monitoring{color:#93c5fd;font-size:0.75rem;margin-top:6px}
.gate-monitoring ul{margin:4px 0 0 16px;padding:0}
.gate-monitoring li{margin:2px 0}
.gate-confidence{color:#a5b4fc;font-size:0.7rem;margin-top:8px;text-align:right;font-weight:600}
.gate-footer{text-align:center;color:#9ca3af;font-size:0.7rem;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);font-style:italic}
.gate-rationales{margin-top:16px;padding:16px;background:rgba(15,23,42,0.8);border-radius:12px;border:1px solid #334155}
.gate-rationale{color:#94a3b8;font-size:0.8rem;padding:8px 0;border-bottom:1px solid #1e293b;line-height:1.5}
.gate-rationale:last-child{border-bottom:none}
.gate-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:0.7rem;font-weight:700;margin:4px 4px 4px 0;text-transform:uppercase}
.gate-badge.materials{background:#7c3aed;color:white}
.gate-badge.chemeng{background:#0891b2;color:white}
.gate-badge.scientist{background:#059669;color:white}
.gate-conditional-banner{background:linear-gradient(135deg,#172554 0%,#1e3a8a 50%,#1d4ed8 100%);border:2px solid #3b82f6;border-radius:12px;padding:16px;margin:16px 0}
.gate-conditional-header{font-size:1.1rem;font-weight:700;color:#bfdbfe;margin-bottom:12px}
.gate-conditional-item{background:rgba(30,58,138,0.5);padding:10px;border-radius:8px;margin:8px 0;color:#dbeafe;font-size:0.85rem}
.archetype-tag{display:inline-block;padding:3px 10px;background:#1e293b;border:1px solid #475569;border-radius:12px;font-size:0.7rem;color:#94a3b8;margin:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CERTA V15.1 UI/UX ENHANCEMENTS - All 12 Recommendations Implemented
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Enhancement #11: Theme Support */
:root{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#1e293b;--text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#64748b;--accent-blue:#3b82f6;--accent-green:#10b981;--accent-yellow:#f59e0b;--accent-red:#ef4444;--border-color:#334155}
[data-theme="light"]{--bg-primary:#f8fafc;--bg-secondary:#ffffff;--bg-card:#ffffff;--text-primary:#1e293b;--text-secondary:#475569;--border-color:#e2e8f0}
.theme-toggle{position:absolute;top:15px;right:15px;width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;cursor:pointer;font-size:1.2rem;transition:all 0.2s}
.theme-toggle:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}

/* Enhancement #1: Regime Banner */
.regime-banner{border-radius:16px;padding:24px;margin:20px 0;text-align:center;position:relative;overflow:hidden}
.regime-banner::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.regime-banner.critical{background:linear-gradient(135deg,#450a0a 0%,#7f1d1d 100%);border:2px solid #dc2626;box-shadow:0 0 40px rgba(220,38,38,0.3)}
.regime-banner.critical::before{background:linear-gradient(90deg,#dc2626,#ef4444,#dc2626)}
.regime-banner.severe{background:linear-gradient(135deg,#431407 0%,#7c2d12 100%);border:2px solid #ea580c}
.regime-banner.severe::before{background:#ea580c}
.regime-banner.warning{background:linear-gradient(135deg,#451a03 0%,#78350f 100%);border:2px solid #f59e0b}
.regime-banner.warning::before{background:#f59e0b}
.regime-banner.caution{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 100%);border:2px solid #3b82f6}
.regime-banner.caution::before{background:#3b82f6}
.regime-banner.safe{background:linear-gradient(135deg,#052e16 0%,#065f46 100%);border:2px solid #10b981}
.regime-banner.safe::before{background:#10b981}
.regime-icon{font-size:2.5rem;margin-bottom:10px}
.regime-name{font-size:1.4rem;font-weight:800;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;font-family:monospace;color:#fef2f2}
.regime-desc{font-size:0.9rem;color:#fecaca;max-width:500px;margin:0 auto 15px}
.regime-reqs{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
.regime-req{padding:6px 14px;background:rgba(0,0,0,0.3);border-radius:20px;font-size:0.8rem;color:#fef2f2}

/* Enhancement #9: Pipeline Progress */
.pipeline{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:15px;margin:20px 0}
.pipeline-stages{display:flex;justify-content:space-between;position:relative}
.pipeline-stages::before{content:'';position:absolute;top:18px;left:30px;right:30px;height:2px;background:var(--border-color)}
.pipeline-stage{display:flex;flex-direction:column;align-items:center;z-index:1}
.stage-dot{width:36px;height:36px;border-radius:50%;background:var(--bg-secondary);border:3px solid var(--border-color);display:flex;align-items:center;justify-content:center;font-size:0.9rem;margin-bottom:6px;transition:all 0.3s}
.stage-dot.complete{background:#10b981;border-color:#10b981;color:white}
.stage-dot.active{background:#3b82f6;border-color:#3b82f6;color:white;animation:pulse 1.5s infinite}
.stage-dot.failed{background:#ef4444;border-color:#ef4444;color:white}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,0.4)}50%{box-shadow:0 0 0 10px rgba(59,130,246,0)}}
.stage-label{font-size:0.65rem;color:var(--text-muted);text-align:center;max-width:60px}

/* Enhancement #3: Seal Eligibility Cards */
.seal-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:24px;margin:20px 0}
.seal-header{text-align:center;margin-bottom:20px}
.seal-state{display:inline-block;padding:12px 24px;border-radius:30px;font-weight:700;font-size:0.95rem;text-transform:uppercase;letter-spacing:1px}
.seal-state.standard{background:#10b981;color:#052e16}
.seal-state.reinforced{background:#f59e0b;color:#451a03}
.seal-state.specialized{background:#8b5cf6;color:white}
.seal-state.sealless{background:#ef4444;color:white}
.seal-state.suppressed{background:#64748b;color:white}
.seal-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-top:20px}
.seal-opt{background:var(--bg-primary);border:2px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;transition:all 0.2s}
.seal-opt.allowed{border-color:#10b981;background:rgba(16,185,129,0.1)}
.seal-opt.required{border-color:#3b82f6;background:rgba(59,130,246,0.15);box-shadow:0 0 20px rgba(59,130,246,0.2)}
.seal-opt.forbidden{border-color:#ef4444;background:rgba(239,68,68,0.1);opacity:0.6}
.seal-opt-icon{font-size:1.8rem;margin-bottom:8px}
.seal-opt-name{font-weight:600;font-size:0.85rem;margin-bottom:6px}
.seal-opt-status{font-size:0.7rem;padding:3px 10px;border-radius:10px;text-transform:uppercase}
.seal-opt.allowed .seal-opt-status{background:#10b981;color:#052e16}
.seal-opt.required .seal-opt-status{background:#3b82f6;color:white}
.seal-opt.forbidden .seal-opt-status{background:#ef4444;color:white}

/* Enhancement #1B: FAO Footer (V15 Â§14) */
.fao-footer{background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;padding:12px 20px;margin-top:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;font-family:monospace;font-size:0.8rem}
.fao-item{display:flex;align-items:center;gap:6px}
.fao-label{color:var(--text-muted)}
.fao-value{color:#06b6d4;font-weight:600}
.fao-copy{padding:6px 12px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:0.75rem;transition:all 0.2s}
.fao-copy:hover{border-color:#3b82f6}
.fao-copy.copied{background:#10b981;color:white;border-color:#10b981}

/* Enhancement #2: Industry Selector */
.selector-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:15px}
@media(max-width:768px){.selector-grid{grid-template-columns:1fr}}
.selector-group label{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block}
.selector-group select{width:100%;padding:12px;background:var(--bg-primary);border:2px solid var(--border-color);border-radius:10px;color:var(--text-primary);font-size:0.9rem}

/* Enhancement #8: Export Panel */
.export-panel{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:24px;margin:20px 0}
.export-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:600px){.export-grid{grid-template-columns:repeat(2,1fr)}}
.export-btn{display:flex;flex-direction:column;align-items:center;gap:8px;padding:20px 12px;background:var(--bg-primary);border:2px solid var(--border-color);border-radius:12px;cursor:pointer;transition:all 0.2s;color:var(--text-primary)}
.export-btn:hover{border-color:#3b82f6;transform:translateY(-2px);box-shadow:0 8px 20px rgba(59,130,246,0.2)}
.export-btn .icon{font-size:1.8rem}
.export-btn .label{font-weight:600;font-size:0.85rem}
.export-btn .desc{font-size:0.7rem;color:var(--text-muted)}

/* Enhancement #5: Mobile Bottom Nav */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border-color);padding:8px 0;z-index:1000}
@media(max-width:768px){.mobile-nav{display:flex;justify-content:space-around}body{padding-bottom:80px}}
.mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 15px;background:none;border:none;color:var(--text-muted);cursor:pointer;border-radius:10px;transition:all 0.2s}
.mobile-nav-item:hover,.mobile-nav-item.active{color:#3b82f6;background:rgba(59,130,246,0.1)}
.mobile-nav-item .icon{font-size:1.3rem}
.mobile-nav-item .label{font-size:0.65rem;text-transform:uppercase}

/* Enhancement #6: Service Life Gauge */
.gauge-container{background:var(--bg-primary);border:1px solid var(--border-color);border-radius:12px;padding:16px;margin:15px 0}
.gauge-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.gauge-title{font-weight:600;font-size:0.9rem}
.gauge-value{font-size:1.4rem;font-weight:700;color:#3b82f6}
.gauge-bar{height:12px;background:var(--border-color);border-radius:6px;overflow:hidden}
.gauge-fill{height:100%;border-radius:6px;transition:width 0.5s}
.gauge-markers{display:flex;justify-content:space-between;margin-top:6px;font-size:0.7rem;color:var(--text-muted)}

/* Enhancement #4: Material Matrix Toggle */
.view-toggle{display:flex;gap:8px;margin-bottom:15px}
.view-btn{padding:8px 14px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:0.8rem;transition:all 0.2s}
.view-btn:hover{border-color:#3b82f6}
.view-btn.active{background:#3b82f6;border-color:#3b82f6;color:white}

/* Enhancement #7: Accessibility */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
*:focus-visible{outline:3px solid #3b82f6;outline-offset:2px}

/* Enhancement #12: Onboarding */
.onboarding{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:2000}
.onboarding.active{display:flex}
.onboarding-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:20px;padding:40px;max-width:450px;margin:20px;text-align:center}
.onboarding-step{font-size:0.8rem;color:var(--text-muted);margin-bottom:12px}
.onboarding-title{font-size:1.4rem;font-weight:700;margin-bottom:12px}
.onboarding-text{color:var(--text-secondary);margin-bottom:25px;line-height:1.6}
.onboarding-actions{display:flex;gap:10px;justify-content:center}
.onboarding-btn{padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.2s}
.onboarding-btn.primary{background:#3b82f6;border:none;color:white}
.onboarding-btn.secondary{background:transparent;border:1px solid var(--border-color);color:var(--text-secondary)}

/* V15.2: Quick Access Panel CSS removed - feature disabled per RULEBOOK V3 Â§8 */
/* V15.2: quick-item CSS removed - feature disabled */

/* V17.6 F2-001: Disclaimer Modal - Parliament Session 13 Mandate */
.disclaimer-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px}
.disclaimer-modal{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border:2px solid #dc2626;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.5)}
.disclaimer-header{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);padding:20px;text-align:center;border-radius:14px 14px 0 0}
.disclaimer-header h2{color:#fef2f2;font-size:1.5rem;margin:0}
.disclaimer-header .icon{font-size:3rem;margin-bottom:10px}
.disclaimer-body{padding:24px}
.disclaimer-section{margin-bottom:20px}
.disclaimer-section h3{color:#f87171;font-size:1rem;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.disclaimer-section p,.disclaimer-section li{color:#e2e8f0;font-size:0.9rem;line-height:1.6}
.disclaimer-section ul{margin:10px 0;padding-left:20px}
.disclaimer-section li{margin:6px 0}
.disclaimer-checkbox{display:flex;align-items:flex-start;gap:12px;padding:16px;background:#450a0a;border:1px solid #dc2626;border-radius:8px;margin:20px 0;cursor:pointer}
.disclaimer-checkbox input{width:20px;height:20px;margin-top:2px;cursor:pointer}
.disclaimer-checkbox label{color:#fecaca;font-size:0.9rem;cursor:pointer;font-weight:500}
.disclaimer-btn{width:100%;padding:16px;font-size:1.1rem;font-weight:700;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s}
.disclaimer-btn:disabled{background:#475569;color:#94a3b8;cursor:not-allowed}
.disclaimer-btn:not(:disabled){background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:white}
.disclaimer-btn:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(16,185,129,0.3)}

/* V17.6: Results Warning Banner */
.results-warning-banner{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);border:2px solid #dc2626;border-radius:12px;padding:16px;margin-bottom:20px;text-align:center}
.results-warning-banner .icon{font-size:2rem;margin-bottom:8px}
.results-warning-banner .title{color:#fef2f2;font-size:1.1rem;font-weight:700;margin-bottom:6px}
.results-warning-banner .text{color:#fecaca;font-size:0.85rem;line-height:1.5}

/* V17.6 B1-001: Value Proposition Banner */
.value-prop-banner{background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%);border-radius:12px;padding:16px;margin:15px 0;text-align:center}
.value-prop-banner .headline{color:white;font-size:1rem;font-weight:700;margin-bottom:6px}
.value-prop-banner .subtext{color:#bfdbfe;font-size:0.8rem}
</style>
</head>
<body>
<!-- V17.6 F2-001: Mandatory Disclaimer Modal - Parliament Session 13 -->
<div class="disclaimer-overlay" id="disclaimerOverlay" style="display:none">
<div class="disclaimer-modal">
<div class="disclaimer-header">
<div class="icon">âš ï¸</div>
<h2>IMPORTANT: Screening Tool Disclaimer</h2>
</div>
<div class="disclaimer-body">
<div class="disclaimer-section">
<h3>â›” THIS IS NOT A CERTIFICATION TOOL</h3>
<p>CERTA provides <strong>screening guidance only</strong>. Results are for preliminary assessment and do not constitute engineering certification, safety approval, or manufacturer endorsement.</p>
</div>
<div class="disclaimer-section">
<h3>ğŸ”¬ PROFESSIONAL VERIFICATION REQUIRED</h3>
<p>Before implementing any material selection based on CERTA results, you must:</p>
<ul>
<li>Consult with qualified corrosion engineers or materials specialists</li>
<li>Conduct actual corrosion testing under your specific conditions</li>
<li>Obtain manufacturer approval for your application</li>
<li>Comply with all applicable codes, standards, and regulations</li>
</ul>
</div>
<div class="disclaimer-section">
<h3>âš–ï¸ LIMITATION OF LIABILITY</h3>
<p>CERTA and its operators accept no liability for equipment failures, safety incidents, or any damages arising from use of this tool. Users assume all risks associated with material selection decisions.</p>
</div>
<div class="disclaimer-checkbox">
<input type="checkbox" id="disclaimerCheck" onchange="updateDisclaimerBtn()">
<label for="disclaimerCheck">I understand that CERTA is a screening tool only, results require professional verification, and I accept full responsibility for any decisions made using this information.</label>
</div>
<button class="disclaimer-btn" id="disclaimerAccept" disabled onclick="acceptDisclaimer()">I Understand and Accept</button>
</div>
</div>
</div>

<!-- Onboarding Overlay -->
<div class="onboarding" id="onboarding">
<div class="onboarding-card">
<div class="onboarding-step">Step <span id="onboardStep">1</span> of 4</div>
<h2 class="onboarding-title" id="onboardTitle">Welcome to CERTA V17.0</h2>
<p class="onboarding-text" id="onboardText">CERTA is a chemistry-first industrial screening engine for material compatibility. This quick tour will show you the key features.</p>
<div class="onboarding-actions">
<button class="onboarding-btn secondary" onclick="skipOnboarding()">Skip Tour</button>
<button class="onboarding-btn primary" onclick="nextOnboarding()">Next â†’</button>
</div>
</div>
</div> <div class="container">
<div class="header" style="position:relative">
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme"><span id="themeIcon">ğŸŒ™</span></button>
<h1 id="mainTitle">ğŸ”¬ CERTA</h1>
<p id="mainSubtitle">V17.7 | Policy V16.8 | Professional Engineering Interface</p>
<!-- V17.6 B1-001: Value Proposition - Parliament Session 13 -->
<div class="value-prop-banner">
<div class="headline">â±ï¸ Save 4-6 Hours Per Material Selection Decision</div>
<div class="subtext">Consolidate 16+ data sources â€¢ Audit-ready PDF documentation â€¢ Standardize team decisions</div>
</div>
<div class="policy-badges">
<span class="pbadge pbadge-green">âœ“ V16.8</span>
<span class="pbadge pbadge-purple">UI-ENG-1</span>
<span class="pbadge pbadge-cyan">FAO</span>
<span class="pbadge pbadge-gray">430+ Fluids</span>
</div>
<div class="usage-counter" style="margin:10px 0;padding:8px 16px;background:rgba(0,0,0,0.2);border-radius:20px;display:inline-block">
<span style="color:#94a3b8;font-size:0.85rem">ğŸ“Š Calculations: </span>
<span id="usageCount" style="color:#60a5fa;font-weight:bold;font-family:var(--font-mono)">0</span>
</div>
<div class="lang-bar">
<button class="lang-btn active" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ EN</button>
<button class="lang-btn" onclick="setLang('es')">ğŸ‡ªğŸ‡¸ ES</button>
<button class="lang-btn" onclick="setLang('zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
<button class="lang-btn" onclick="setLang('de')">ğŸ‡©ğŸ‡ª DE</button>
<button class="lang-btn" onclick="setLang('ar')">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</button>
</div>
</div>
<!-- V16.1: Simple dropdown - one fluid at a time, scrollable list when clicked -->
<div class="card">
<label>ğŸ§ª Select Fluid <span id="fluidCount" style="color:#64748b;font-size:0.8rem">(0)</span></label>
<select id="fluidSelect" style="width:100%;padding:14px;border:2px solid #475569;border-radius:10px;background:#0f172a;color:#e2e8f0;font-size:1rem;cursor:pointer"></select>
<!-- Hidden search box for filter() function compatibility -->
<input type="hidden" id="searchBox" value="">
</div>
<div class="card">
<label>ğŸŒ¡ï¸ Temperature</label>
<div class="input-row">
<input type="number" id="tempInput" value="20" step="0.1">
<select id="tempUnit"><option value="C">Â°C</option><option value="F">Â°F</option><option value="K">K</option></select>
</div>
<button class="btn btn-primary" onclick="calc()">âš¡ Run Assessment</button> </div>
<div id="results"></div>
<!-- Reynolds Number Calculator - Now as optional tool after results -->
<div class="flow-card" id="reynoldsCard" style="display:none">
<div class="flow-title">ğŸ§® <span data-i18n="reynolds">Optional: Reynolds Number & Flow Regime</span></div>
<p style="color:#94a3b8;font-size:0.85rem;margin-bottom:12px">Use fluid properties above to calculate flow regime for your system</p>
<div class="flow-inputs">
<div class="flow-group">
<label data-i18n="flowRate">Flow Rate</label>
<input type="number" id="flowRate" value="10" step="0.1">
<select id="flowUnit" style="margin-top:6px"><option value="m3h">mÂ³/h</option><option value="lpm">L/min</option><option value="gpm">GPM</option></select>
</div>
<div class="flow-group">
<label data-i18n="pipeDia">Pipe Diameter</label>
<input type="number" id="pipeDia" value="50" step="1">
<select id="diaUnit" style="margin-top:6px"><option value="mm">mm</option><option value="in">inches</option></select>
</div>
</div>
<button class="btn btn-primary" onclick="calcReynolds()" data-i18n="calcRe">Calculate Reynolds Number</button>
<div class="re-display" id="reDisplay" style="display:none">
<div class="re-value" id="reValue">-</div>
<div class="re-label">Reynolds Number (Re)</div>
<div class="flow-regime" id="flowRegime">-</div>
<div style="margin-top:10px;font-size:.85rem;color:#94a3b8" id="reDetails"></div>
</div>
</div>
<!-- Cavitation Risk Assessment - Now as optional tool after results -->
<div class="cav-card" id="cavCard" style="display:none">
<div class="cav-title">ğŸ”¬ <span data-i18n="cavitation">Optional: Cavitation Risk Assessment</span></div>
<p style="color:#c4b5fd;font-size:0.85rem;margin-bottom:12px">Assess pump cavitation risk using calculated vapor pressure</p>
<div class="flow-inputs">
<div class="flow-group">
<label data-i18n="suctionP">Suction Pressure (bar abs)</label>
<input type="number" id="suctionP" value="1.5" step="0.1">
</div>
<div class="flow-group">
<label data-i18n="npshr">Pump NPSH Required (m)</label>
<input type="number" id="npshr" value="3.0" step="0.1">
</div>
</div>
<button class="btn btn-primary" onclick="calcCavitation()" data-i18n="calcCav">Assess Cavitation Risk</button>
<div class="cav-result" id="cavResult" style="display:none">
<div class="cav-status" id="cavStatus">-</div>
<div id="cavConfidence" style="text-align:center;margin:8px 0"></div>
<div class="cav-details">
<div class="cav-item"><strong>Vapor Pressure:</strong> <span id="vaporP">-</span></div>
<div class="cav-item"><strong>NPSH Available:</strong> <span id="npsha">-</span></div>
<div class="cav-item"><strong>NPSH Required:</strong> <span id="npshReq">-</span></div>
<div class="cav-item"><strong>Safety Margin:</strong> <span id="npshMargin">-</span></div>
</div>
<div id="cavParams" style="font-size:0.75rem;color:#a78bfa;margin-top:8px;padding:6px;background:rgba(0,0,0,0.2);border-radius:4px"></div>
</div>
</div>
<!-- Print Button - moved here before categories -->
<div class="card" id="printCard" style="display:none">
<button class="btn btn-secondary" onclick="printPDF()" style="width:100%">ğŸ–¨ï¸ Print / Save PDF Report</button>
</div>
<div class="card cats-section">
<h3>ğŸ“‚ Fluid Categories</h3>
<div class="cats-grid" id="catsGrid"></div>
</div>
</div>
<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  CERTA V15.0 - MASTER POLICY COMPLIANT ENGINE                             â•‘
// â•‘  Governance: V15.0 (FINAL - Single Constitution, Fully Integrated)        â•‘
// â•‘  Status: Logic, execution order, and governance are FROZEN                â•‘
// â•‘  Authority: This code implements the sole governing specification         â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ============================================================================
// Â§2. NON-NEGOTIABLE SYSTEM PRINCIPLES
// ============================================================================
const CERTA_VERSION = 'V17.0';
const CERTA_POLICY_VERSION = 'V15.0';  // Policy version unchanged per V15 Â§FINAL STATEMENT
const CERTA_STATUS = 'FINAL';
const CERTA_BUILD = 'V17.0-2026.01.27';  // V17.0: 30-Agent Audit Fixes (CF-1, CF-2, HF-1, HF-2, HF-3, MF-1, MF-2, MF-3)

// Â§2.1 Determinism: Identical inputs must always produce identical outputs
// Â§2.2 Fail-Closed: Missing data â†’ downgrade/suppress, never guess/crash/promote
// Â§2.3 Absolute Precedence (Immutable):
//   1. Hard chemical incompatibility
//   2. Regulatory / safety prohibition
//   3. Severe chemical regime risk
//   4. Conditional compatibility
//   5. Compatible

// ============================================================================
// Â§4. CLOSED TAXONOMIES (MANDATORY)
// ============================================================================
const TAXONOMIES = {
  // Decision states (Â§11 Monotonic: PASS â†’ CONDITIONAL â†’ FAIL â†’ INSUFFICIENT_DATA)
  DECISION_STATES: Object.freeze(['PASS', 'CONDITIONAL', 'FAIL', 'INSUFFICIENT_DATA']),

  // Structural validity states (Â§8)
  VALIDITY_STATES: Object.freeze(['VALID', 'VALID_EMPTY', 'INVALID']),

  // Seal eligibility states (Â§13.2)
  SEAL_STATES: Object.freeze([
    'STANDARD_ALLOWED',
    'REINFORCED_REQUIRED',
    'SPECIALIZED_REQUIRED',
    'SEALLESS_REQUIRED',
    'SEAL_SELECTION_SUPPRESSED'
  ]),

  // Primary regime precedence (Â§6 - highest wins)
  // V15.2: Combined EXPLOSIVE_ENERGETIC per V15 Policy Â§6, added HALOGENATED
  REGIME_PRECEDENCE: Object.freeze([
    'EXPLOSIVE_ENERGETIC',    // V15.2: Combined per V15 Policy Â§6
    'FLUORIDE_ACID',
    'OXIDIZING_ACID',
    'STRONG_BASE',
    'TOXIC_SPECIAL',
    'HALOGENATED',            // V15.2: Added - chlorides, HCl, seawater, chlorinated solvents
    'REDUCING_ACID',
    'ORGANIC_SOLVENT',
    'AQUEOUS_CORROSIVE',
    'NEUTRAL',
    'AQUEOUS_NON_HAZARDOUS',
    'UNKNOWN_RESTRICTED'
  ]),

  // Allowed-use classes
  ALLOWED_USE: Object.freeze(['RECOMMENDED', 'CONDITIONAL_INDUSTRY_STANDARD', 'CONDITIONAL_LIMITED', 'EXCLUDED'])
};

// ============================================================================
// V16.2 HARDENING MODULE - SYSTEMATIC FUNCTION PROOFING
// Per 15-Agent Recommendations | V15 Policy Compliance
// ============================================================================

// P1-D: Temperature sanity bounds (Agent 1: Chemistry Correctness)
const TEMP_BOUNDS = Object.freeze({
  ABSOLUTE_MIN: -273.15,  // Absolute zero
  ABSOLUTE_MAX: 500,      // Industrial max
  WARN_LOW: -50,          // Unusual low
  WARN_HIGH: 200          // Unusual high
});

// P2-A: Core functions that must exist (Agent 5: Regression & Feature)
const CORE_FUNCTIONS = Object.freeze([
  'createRunContext', 'resolvePrimaryRegime', 'resolveSealEligibility',
  'filterSealsByEligibility', 'constructCandidateSets', 'generateFAO',
  'validateUIState', 'validateStructure', 'runGateForAllMaterials',
  'evaluateCompatibilityV84', 'getFluidBehaviorProfile', 'calcConfidence',
  'generateChecksum', 'interp', 'calc', 'printPDF', 'calcLifecycle',
  'calcReynolds', 'calcCavitation'
]);

// P2-A: Startup validation (Agent 5: Regression & Feature)
function validateStartupIntegrity() {
  const errors = [];
  const warnings = [];
  
  // Check core functions exist
  CORE_FUNCTIONS.forEach(fn => {
    if (typeof window[fn] !== 'function') {
      errors.push('Missing core function: ' + fn);
    }
  });
  
  // Check taxonomies exist
  if (!TAXONOMIES || !TAXONOMIES.REGIME_PRECEDENCE) {
    errors.push('Missing TAXONOMIES');
  }
  
  // Check fluid database exists
  if (typeof F === 'undefined' || Object.keys(F).length < 100) {
    warnings.push('Fluid database may be incomplete');
  }
  
  // Check material database exists
  if (typeof M === 'undefined' || !M.materials) {
    warnings.push('Material database may be incomplete');
  }
  
  return { valid: errors.length === 0, errors, warnings };
}

// P2-C: Explicit state reset function (Agent 11: Cross-Run Contamination)
function resetAllState() {
  // Clear FAO
  _currentFAO = null;
  
  // Clear run context
  _currentRunContext = null;
  
  // Clear global calculation state
  if (typeof curFluid !== 'undefined') curFluid = null;
  if (typeof curTemp !== 'undefined') curTemp = null;
  if (typeof lastCalcData !== 'undefined') lastCalcData = null;
  if (typeof lastReynolds !== 'undefined') lastReynolds = null;
  if (typeof lastCavitation !== 'undefined') lastCavitation = null;
  
  // Clear audit trail
  if (typeof clearAuditTrail === 'function') {
    try { clearAuditTrail(); } catch(e) {}
  }
  
  // Clear cache
  if (typeof _clearCache === 'function') {
    try { _clearCache(); } catch(e) {}
  }
  
  // V17.0: Clear pending timers (MF-2 FIX)
  if (typeof SafeTimer !== 'undefined' && SafeTimer.clearAll) {
    try { SafeTimer.clearAll(); } catch(e) {}
  }
  
  // V17.0: Clear DOM cache (MF-1 FIX)
  if (typeof DOM !== 'undefined' && DOM.clearCache) {
    try { DOM.clearCache(); } catch(e) {}
  }
  
  // V17.0: Clear compat warnings (HF-1 FIX)
  if (typeof clearCompatWarnings === 'function') {
    try { clearCompatWarnings(); } catch(e) {}
  }
  
  return true;
}

// P1-B: Safe toFixed wrapper (Agent 2: Process/Mechanical)
function safeToFixed(value, decimals, fallback) {
  if (value === null || value === undefined || isNaN(value) || !isFinite(value)) {
    return fallback !== undefined ? fallback : '0';
  }
  return value.toFixed(decimals);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V17.0: 30-AGENT AUDIT COMPREHENSIVE FIXES
// CF-1: Null Safety (SCB-1) | CF-2: DOM Guards (SCB-4)
// HF-1: Compat Fallback Tracking (FMC-1) | HF-2: Shared Renderers (UIR-1)
// MF-1: DOM Caching (PER-1) | MF-2: Timer Tracking (PER-3) | MF-3: LRU Cache (PER-3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CF-2 FIX: Safe DOM utilities with caching (Agents SCB-4 + PER-1)
const DOM = {
  _cache: new Map(),
  
  get: function(id) {
    if (!this._cache.has(id)) {
      this._cache.set(id, document.getElementById(id));
    }
    return this._cache.get(id);
  },
  
  clearCache: function() {
    this._cache.clear();
  },
  
  setHTML: function(id, html) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (el) el.innerHTML = html;
    return el;
  },
  
  setText: function(id, text) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (el) el.textContent = text;
    return el;
  },
  
  setStyle: function(id, prop, value) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (el && el.style) el.style[prop] = value;
    return el;
  },
  
  toggleClass: function(id, cls) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (el && el.classList) el.classList.toggle(cls);
    return el;
  },
  
  addClass: function(id, cls) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (el && el.classList) el.classList.add(cls);
    return el;
  },
  
  removeClass: function(id, cls) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (el && el.classList) el.classList.remove(cls);
    return el;
  },
  
  getValue: function(id) {
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    return el ? el.value : '';
  },
  
  show: function(id) { return this.setStyle(id, 'display', 'block'); },
  hide: function(id) { return this.setStyle(id, 'display', 'none'); }
};

// MF-2 FIX: Safe setTimeout with tracking (Agent PER-3)
const SafeTimer = {
  _pending: [],
  
  set: function(fn, delay) {
    const id = setTimeout(() => {
      this._remove(id);
      try { fn(); } catch(e) { console.error('SafeTimer error:', e); }
    }, delay);
    this._pending.push(id);
    return id;
  },
  
  _remove: function(id) {
    const idx = this._pending.indexOf(id);
    if (idx > -1) this._pending.splice(idx, 1);
  },
  
  clear: function(id) { clearTimeout(id); this._remove(id); },
  clearAll: function() { this._pending.forEach(id => clearTimeout(id)); this._pending = []; }
};

// MF-3 FIX: LRU Cache with eviction (Agent PER-3)
class LRUCache {
  constructor(maxSize = 500) {
    this._maxSize = maxSize;
    this._cache = new Map();
  }
  
  get(key) {
    if (!this._cache.has(key)) return undefined;
    const value = this._cache.get(key);
    this._cache.delete(key);
    this._cache.set(key, value);
    return value;
  }
  
  set(key, value) {
    if (this._cache.has(key)) this._cache.delete(key);
    else if (this._cache.size >= this._maxSize) {
      const firstKey = this._cache.keys().next().value;
      this._cache.delete(firstKey);
    }
    this._cache.set(key, value);
    return value;
  }
  
  has(key) { return this._cache.has(key); }
  clear() { this._cache.clear(); }
  get size() { return this._cache.size; }
}

// HF-1 FIX: Compatibility fallback tracking (Agent FMC-1)
let _compatFallbackWarnings = [];

function getCompatWithWarning(ck) {
  const compat = M.compat[ck];
  if (!compat) {
    if (!_compatFallbackWarnings.includes(ck)) {
      _compatFallbackWarnings.push(ck);
      console.warn('V17 HF-1: Using default water compatibility for "' + ck + '"');
    }
    return M.compat['water'];
  }
  return compat;
}

function getCorrosionWithWarning(ck) {
  const corr = M.corrosion[ck];
  if (!corr) {
    console.warn('V17 HF-1: Using default water corrosion for "' + ck + '"');
    return M.corrosion['water'];
  }
  return corr;
}

function clearCompatWarnings() { _compatFallbackWarnings = []; }
function getCompatWarnings() { return [..._compatFallbackWarnings]; }
function hasCompatWarnings() { return _compatFallbackWarnings.length > 0; }

// HF-2 FIX: Shared rendering utilities for UI-PDF parity (Agent UIR-1)
function formatPropertyValue(value, decimals, unit) {
  return safeToFixed(value, decimals, '0') + (unit ? ' ' + unit : '');
}

function formatTCO(tco, life) {
  return {
    tcoDisplay: '$' + safeToFixed(tco, 0, '0') + '/mÂ²',
    lifeDisplay: life >= 50 ? '25+ yrs' : safeToFixed(life, 1, '0') + ' yrs'
  };
}

function formatCorrosionRate(cr) {
  if (!cr || cr.length < 2) return 'N/A';
  return safeToFixed(cr[0], 2, '0') + '-' + safeToFixed(cr[1], 2, '0') + ' mm/yr';
}

function generateCompatWarningBanner() {
  if (!hasCompatWarnings()) return '';
  return '<div class="warning" style="margin-bottom:12px;padding:10px;background:#451a03;border:1px solid #c2410c;border-radius:6px">' +
    '<strong>âš ï¸ Limited Data:</strong> Using default compatibility for: ' + getCompatWarnings().join(', ') + '</div>';
}

// P1-C: Safe division (Agent 2: Process/Mechanical)
function safeDivide(numerator, denominator, fallback) {
  if (denominator === 0 || denominator === null || denominator === undefined || 
      isNaN(denominator) || !isFinite(denominator)) {
    return fallback !== undefined ? fallback : 0;
  }
  const result = numerator / denominator;
  return isFinite(result) ? result : (fallback !== undefined ? fallback : 0);
}

// P1-D: Temperature validation (Agent 1: Chemistry Correctness)
function validateTemperature(tempC) {
  const result = { valid: true, warnings: [], errors: [] };
  
  if (tempC === null || tempC === undefined || isNaN(tempC)) {
    result.valid = false;
    result.errors.push('Invalid temperature value');
    return result;
  }
  
  if (tempC < TEMP_BOUNDS.ABSOLUTE_MIN) {
    result.valid = false;
    result.errors.push('Temperature below absolute zero (' + TEMP_BOUNDS.ABSOLUTE_MIN + 'Â°C)');
  }
  
  if (tempC > TEMP_BOUNDS.ABSOLUTE_MAX) {
    result.valid = false;
    result.errors.push('Temperature exceeds industrial maximum (' + TEMP_BOUNDS.ABSOLUTE_MAX + 'Â°C)');
  }
  
  if (result.valid && tempC < TEMP_BOUNDS.WARN_LOW) {
    result.warnings.push('Unusually low temperature - verify cryogenic compatibility');
  }
  
  if (result.valid && tempC > TEMP_BOUNDS.WARN_HIGH) {
    result.warnings.push('High temperature - verify material thermal limits');
  }
  
  return result;
}

// P2-B: Execution order tracking (Agent 4: Logic & Determinism)
let _executionSequence = [];
function trackExecutionStep(step) {
  _executionSequence.push({ step, timestamp: Date.now() });
}
function resetExecutionSequence() {
  _executionSequence = [];
}
function verifyExecutionOrder(requiredOrder) {
  const actualSteps = _executionSequence.map(s => s.step);
  for (let i = 0; i < requiredOrder.length; i++) {
    if (actualSteps.indexOf(requiredOrder[i]) === -1) {
      return { valid: false, missing: requiredOrder[i] };
    }
    if (i > 0) {
      const prevIdx = actualSteps.indexOf(requiredOrder[i-1]);
      const currIdx = actualSteps.indexOf(requiredOrder[i]);
      if (currIdx < prevIdx) {
        return { valid: false, outOfOrder: requiredOrder[i] + ' before ' + requiredOrder[i-1] };
      }
    }
  }
  return { valid: true };
}

// P2-D: FAO integrity hash (Agent 4: Logic & Determinism)
function computeFAOHash(fao) {
  if (!fao) return null;
  const str = JSON.stringify({
    runId: fao.runId,
    primaryRegime: fao.primaryRegime,
    sealEligibilityState: fao.sealEligibilityState,
    checksum: fao.checksum
  });
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return 'FAO-' + Math.abs(hash).toString(16).toUpperCase();
}

// P3-B: Temperature escalation logging (Agent 12: Temperature Escalation)
function logTemperatureEscalation(tempC, materialId, escalationType) {
  const entry = {
    type: 'TEMP_ESCALATION',
    timestamp: Date.now(),
    temperature: tempC,
    material: materialId,
    escalation: escalationType,
    thresholds: {
      elevated: tempC >= 60,
      high: tempC >= 80,
      steam: tempC >= 100,
      elastomerLimit: tempC >= 150
    }
  };
  if (typeof addAuditEntry === 'function') {
    try { addAuditEntry(entry); } catch(e) {}
  }
  return entry;
}

// P3-A: Fluid schema validation (Agent 7: Expansion Safety)
function validateFluidSchema(fluidId, fluidData) {
  const errors = [];
  if (!fluidData) {
    errors.push('Fluid data is null/undefined');
    return { valid: false, errors };
  }
  if (!fluidData.n) errors.push('Missing fluid name (n)');
  if (!fluidData.c) errors.push('Missing fluid category (c)');
  if (!fluidData.d || !Array.isArray(fluidData.d) || fluidData.d.length < 2) {
    errors.push('Missing or insufficient temperature data array (d)');
  }
  return { valid: errors.length === 0, errors };
}

// P3-A: Material schema validation (Agent 7: Expansion Safety)
function validateMaterialSchema(materialId, materialData) {
  const errors = [];
  if (!materialData) {
    errors.push('Material data is null/undefined');
    return { valid: false, errors };
  }
  if (!materialData.name) errors.push('Missing material name');
  if (!materialData.type) errors.push('Missing material type');
  return { valid: errors.length === 0, errors };
}

// P15: Candidate set consistency verification (Agent 15: Candidate Set)
function verifyCandidateSetConsistency(sets) {
  const errors = [];
  if (!sets) {
    errors.push('Candidate sets is null');
    return { valid: false, errors };
  }
  
  // Check required sets exist
  const requiredSets = ['CompatibilitySet', 'ConditionalReferenceSet', 'ExcludedSet'];
  requiredSets.forEach(setName => {
    if (!sets[setName]) {
      errors.push('Missing required set: ' + setName);
    }
  });
  
  // Check no material in both Excluded and Compatibility
  if (sets.CompatibilitySet && sets.ExcludedSet) {
    const compat = new Set(sets.CompatibilitySet.map(i => typeof i === 'string' ? i : i.matId));
    const excluded = new Set(sets.ExcludedSet.map(i => typeof i === 'string' ? i : i.matId));
    compat.forEach(m => {
      if (excluded.has(m)) {
        errors.push('Material in both CompatibilitySet and ExcludedSet: ' + m);
      }
    });
  }
  
  return { valid: errors.length === 0, errors };
}

// ============================================================================
// Â§5. RUN CONTEXT (SINGLE SOURCE OF TRUTH)
// ============================================================================
let _currentRunContext = null;
let _runCounter = 0;

function generateRunId() {
  return 'RUN-' + Date.now() + '-' + (++_runCounter).toString(36).toUpperCase();
}

function createRunContext(fluidId, temperature, unit) {
  // Â§5: If RunContext cannot be constructed â†’ run is INVALID
  if (!fluidId || !F[fluidId]) {
    return { valid: false, state: 'INVALID', error: 'Unknown fluid ID' };
  }

  let tempC = parseFloat(temperature);
  if (isNaN(tempC)) {
    return { valid: false, state: 'INVALID', error: 'Invalid temperature' };
  }
  if (unit === 'F') tempC = (tempC - 32) * 5 / 9;
  if (unit === 'K') tempC = tempC - 273.15;

  const fl = F[fluidId];
  if (!fl.d || !Array.isArray(fl.d) || fl.d.length === 0) {
    return { valid: false, state: 'INVALID', error: 'Invalid fluid data structure' };
  }

  // Resolve primary regime (Â§6)
  const regime = resolvePrimaryRegime(fluidId, tempC);

  // Construct immutable RunContext
  const ctx = Object.freeze({
    runId: generateRunId(),
    fluidId: fluidId,
    fluidLabel: fl.n,
    category: fl.c,
    concentration: extractConcentration(fluidId),
    temperature: tempC,
    temperatureUnit: 'C',
    phase: 'LIQUID', // Default, could be extended
    fluidTags: getFluidTags(fluidId),
    primaryRegime: regime.primary,
    secondaryRegimes: regime.secondary || [],
    policyVersion: CERTA_POLICY_VERSION,
    timestamp: Date.now()
  });

  _currentRunContext = ctx;
  return { valid: true, state: 'VALID', context: ctx };
}

function extractConcentration(fluidId) {
  // Extract concentration from fluid ID pattern (e.g., 'h2so4-98' â†’ 98)
  const match = fluidId.match(/-(\d+)$/);
  return match ? parseInt(match[1]) : null;
}

function getFluidTags(fluidId) {
  // Return relevant tags based on fluid characteristics
  const tags = [];
  const fl = F[fluidId];
  if (!fl) return tags;

  if (fl.c.includes('Acid')) tags.push('ACIDIC');
  if (fl.c.includes('Base') || fl.c.includes('Caustic')) tags.push('BASIC');
  if (fl.c.includes('Oxidizing') || fluidId.includes('hno3') || fluidId.includes('h2o2')) tags.push('OXIDIZING');
  if (fluidId.includes('hf')) tags.push('FLUORIDE');
  if (fl.c.includes('Solvent')) tags.push('ORGANIC_SOLVENT');
  if (fl.c.includes('Water')) tags.push('AQUEOUS');

  return tags;
}

// ============================================================================
// Â§6. PRIMARY REGIME AUTHORITY
// ============================================================================
function resolvePrimaryRegime(fluidId, tempC) {
  // V15.2: Regime precedence per V15 Policy Â§6 (highest wins)
  const fl = F[fluidId];
  if (!fl) return { primary: 'UNKNOWN_RESTRICTED', secondary: [] };

  const secondary = [];
  let primary = 'NEUTRAL';

  // V15.2: Check for EXPLOSIVE_ENERGETIC (combined per V15 Â§6)
  if (fluidId.includes('nitroglyc') || fluidId.includes('tnt') || fluidId.includes('petn') ||
      fluidId.includes('ammonium-nitrate') || fluidId.includes('rdx') || fluidId.includes('hmx')) {
    return { primary: 'EXPLOSIVE_ENERGETIC', secondary: [] };
  }

  // Check for FLUORIDE_ACID (HF) - V15 Â§12.2
  if (fluidId.includes('hf-') || fluidId === 'hf' || fluidId.includes('fluoride')) {
    primary = 'FLUORIDE_ACID';
    secondary.push('TOXIC_SPECIAL');
  }

  // Check for OXIDIZING_ACID - V15 Â§12.1
  else if (fluidId.includes('hno3') && extractConcentration(fluidId) >= 65) {
    primary = 'OXIDIZING_ACID';
    if (extractConcentration(fluidId) >= 90) secondary.push('TOXIC_SPECIAL');
  }
  else if (fluidId.includes('h2o2') && extractConcentration(fluidId) >= 30) {
    primary = 'OXIDIZING_ACID';
  }

  // Check for STRONG_BASE - V15 Â§12.3
  else if ((fluidId.includes('naoh') || fluidId.includes('koh') || fluidId.includes('caustic'))
           && extractConcentration(fluidId) >= 30) {
    primary = 'STRONG_BASE';
  }

  // Check for TOXIC_SPECIAL - V15 Â§12.4
  else if (fluidId.includes('cyanide') || fluidId.includes('arsenic') || fluidId.includes('mercury') ||
           fluidId.includes('benzene')) {
    primary = 'TOXIC_SPECIAL';
  }

  // V15.2: Check for HALOGENATED - chlorides, HCl, seawater, chlorinated solvents
  else if (fluidId.includes('hcl') || fluidId.includes('chloride') || fluidId.includes('seawater') ||
           fluidId.includes('hypochlorite') || fluidId.includes('chlorinated') || 
           fl.c.includes('Chlorinated')) {
    primary = 'HALOGENATED';
    if (fluidId.includes('hcl')) secondary.push('AQUEOUS_CORROSIVE');
  }

  // Check for REDUCING_ACID
  else if (fluidId.includes('h2so4') && extractConcentration(fluidId) >= 90) {
    primary = 'REDUCING_ACID'; // Concentrated H2SO4 is dehydrating/reducing
    secondary.push('OXIDIZING_ACID');
  }
  else if (fluidId.includes('h2so4') || fluidId.includes('h3po4')) {
    primary = 'AQUEOUS_CORROSIVE';
  }

  // Check for ORGANIC_SOLVENT
  else if (fl.c.includes('Solvent') || fl.c.includes('Organic')) {
    primary = 'ORGANIC_SOLVENT';
  }

  // Check for benign aqueous
  else if (fl.c.includes('Water') && !fluidId.includes('acid') && !fluidId.includes('base')) {
    primary = 'AQUEOUS_NON_HAZARDOUS';
  }

  return { primary, secondary };
}

// ============================================================================
// Â§8. STRUCTURAL VALIDITY STATES
// ============================================================================
function validateStructure(data, requiredFields) {
  if (data === null || data === undefined) return 'INVALID';
  if (Array.isArray(data) && data.length === 0) return 'VALID_EMPTY';
  if (typeof data === 'object' && Object.keys(data).length === 0) return 'VALID_EMPTY';

  if (requiredFields) {
    for (const field of requiredFields) {
      if (data[field] === undefined || data[field] === null) return 'INVALID';
    }
  }

  return 'VALID';
}

// ============================================================================
// Â§10. CANDIDATE SET CONSTRUCTION (CRITICAL)
// ============================================================================
function constructCandidateSets(runContext, gateResults) {
  // V15.2: All sets must exist and be iterable (Â§10)
  // Undefined or null sets = INVALID

  const sets = {
    CompatibilitySet: [],
    ConditionalReferenceSet: [],
    ExcludedSet: [],
    SealCandidateSet: [],
    RecommendationCandidateSet: [],
    TCOCandidateSet: [],
    _validity: 'VALID'
  };

  if (!gateResults || !runContext) {
    sets._validity = 'INVALID';
    return sets;
  }

  // Populate sets from gate results
  if (gateResults.passed) {
    sets.CompatibilitySet = [...gateResults.passed];
    sets.RecommendationCandidateSet = [...gateResults.passed];
  }

  if (gateResults.conditional) {
    sets.ConditionalReferenceSet = [...gateResults.conditional];
  }

  if (gateResults.failed) {
    sets.ExcludedSet = [...gateResults.failed];
  }

  // V15.2 FIX: Populate SealCandidateSet based on regime (V15 Â§10 + Â§13.5)
  const sealElig = resolveSealEligibility(runContext);
  sets.SealCandidateSet = sealElig.allowedCategories || [];

  // TCO eligibility (Â§14 in V15 policy)
  // V15.2: Updated to use EXPLOSIVE_ENERGETIC
  const suppressTCO = ['UNKNOWN_RESTRICTED', 'EXPLOSIVE_ENERGETIC', 'FLUORIDE_ACID', 'TOXIC_SPECIAL'];
  if (!suppressTCO.includes(runContext.primaryRegime)) {
    sets.TCOCandidateSet = [...sets.CompatibilitySet];
  }

  // Validate all sets exist and are arrays
  const requiredSets = ['CompatibilitySet', 'ConditionalReferenceSet', 'ExcludedSet',
                        'SealCandidateSet', 'RecommendationCandidateSet', 'TCOCandidateSet'];
  for (const setName of requiredSets) {
    if (!Array.isArray(sets[setName])) {
      sets._validity = 'INVALID';
      break;
    }
  }

  return Object.freeze(sets);
}

// ============================================================================
// Â§13. SEAL GOVERNANCE (FULLY INTEGRATED)
// ============================================================================
function resolveSealEligibility(runContext) {
  // V15.2: Â§13.2 - Exactly one seal eligibility state must be resolved
  if (!runContext || !runContext.primaryRegime) {
    return { state: 'SEAL_SELECTION_SUPPRESSED', reason: 'Invalid run context', allowedCategories: [] };
  }

  const regime = runContext.primaryRegime;
  const fluidId = runContext.fluidId;

  // Â§13.3 Explicit Allow Rule (Water & Benign Fluids)
  if (regime === 'NEUTRAL' || regime === 'AQUEOUS_NON_HAZARDOUS') {
    // Check toxicity and volatility conditions
    const fl = F[fluidId];
    if (fl && (fl.c.includes('Water') || fluidId === 'water' || fluidId === 'process-water')) {
      return {
        state: 'STANDARD_ALLOWED',
        reason: 'V15 Â§13.3: Benign aqueous fluid - standard seals permitted',
        allowedCategories: ['Single', 'Double', 'Cartridge']
      };
    }
  }

  // V15.2: Â§13.4 - EXPLOSIVE_ENERGETIC (combined) or FLUORIDE_ACID â†’ SEALLESS_REQUIRED
  if (regime === 'FLUORIDE_ACID' || regime === 'EXPLOSIVE_ENERGETIC') {
    return {
      state: 'SEALLESS_REQUIRED',
      reason: 'V15 Â§13.4: ' + regime + ' regime requires sealless containment',
      allowedCategories: ['Magnetic Drive', 'Canned Motor']
    };
  }

  // Â§13.4: TOXIC â†’ â‰¥ SPECIALIZED_REQUIRED
  if (regime === 'TOXIC_SPECIAL') {
    return {
      state: 'SPECIALIZED_REQUIRED',
      reason: 'V15 Â§13.4: Toxic fluid requires specialized containment',
      allowedCategories: ['Specialized Cartridge', 'OEM Engineered']
    };
  }

  // Â§13.4: OXIDIZING_ACID (non-toxic) â†’ REINFORCED_REQUIRED
  if (regime === 'OXIDIZING_ACID') {
    return {
      state: 'REINFORCED_REQUIRED',
      reason: 'V15 Â§13.4: Oxidizing chemistry requires reinforced sealing',
      allowedCategories: ['Double', 'Cartridge']
    };
  }

  // V15.2: HALOGENATED â†’ REINFORCED_REQUIRED (chloride SCC/pitting risk)
  if (regime === 'HALOGENATED') {
    return {
      state: 'REINFORCED_REQUIRED',
      reason: 'V15.2: Halogenated chemistry (chloride SCC/pitting risk) requires reinforced sealing',
      allowedCategories: ['Double', 'Cartridge']
    };
  }

  // Default for corrosive but manageable fluids
  if (regime === 'AQUEOUS_CORROSIVE' || regime === 'REDUCING_ACID' || regime === 'STRONG_BASE') {
    return {
      state: 'REINFORCED_REQUIRED',
      reason: 'V15 Â§13.4: Corrosive chemistry requires reinforced sealing',
      allowedCategories: ['Double', 'Cartridge']
    };
  }

  // Organic solvents - check for specific requirements
  if (regime === 'ORGANIC_SOLVENT') {
    return {
      state: 'REINFORCED_REQUIRED',
      reason: 'V15: Organic solvent requires compatible seal materials',
      allowedCategories: ['Double', 'Cartridge']
    };
  }

  // Unknown regime - V15 Â§9
  if (regime === 'UNKNOWN_RESTRICTED') {
    return {
      state: 'SEAL_SELECTION_SUPPRESSED',
      reason: 'V15 Â§9: Unknown regime - insufficient data for seal recommendation',
      allowedCategories: []
    };
  }

  // Default fallback - V15 Â§13.3
  return {
    state: 'STANDARD_ALLOWED',
    reason: 'V15 Â§13.3: Standard sealing appropriate for this chemistry',
    allowedCategories: ['Single', 'Double', 'Cartridge']
  };
}

// ============================================================================
// V15 Â§13.5: SEAL FILTERING BY ELIGIBILITY STATE
// CRITICAL: This function must be used IDENTICALLY in UI and PDF per Â§14.1
// ============================================================================
function filterSealsByEligibility(sealsArray, sealEligibility) {
  // V15 Â§13.5: Filter seals based on eligibility state
  const state = sealEligibility.state;
  
  // SEAL_SELECTION_SUPPRESSED: No seals shown (V15 Â§13.5)
  if (state === 'SEAL_SELECTION_SUPPRESSED') {
    return { seals: [], suppressed: true, reason: sealEligibility.reason };
  }
  
  // SEALLESS_REQUIRED: Only sealless options (V15 Â§13.4)
  if (state === 'SEALLESS_REQUIRED') {
    const filtered = sealsArray.filter(s => s.sealless === true);
    return { 
      seals: filtered, 
      suppressed: false, 
      filtered: true,
      reason: sealEligibility.reason,
      originalCount: sealsArray.length,
      filteredCount: filtered.length
    };
  }
  
  // SPECIALIZED_REQUIRED: Only specialized/OEM options (V15 Â§13.4)
  if (state === 'SPECIALIZED_REQUIRED') {
    const filtered = sealsArray.filter(s => 
      s.sealless === true || 
      s.priority.includes('CRITICAL') || 
      s.type.toLowerCase().includes('specialized') ||
      s.type.toLowerCase().includes('cartridge')
    );
    return { 
      seals: filtered.length > 0 ? filtered : sealsArray.filter(s => s.sealless), 
      suppressed: false, 
      filtered: true,
      reason: sealEligibility.reason,
      originalCount: sealsArray.length,
      filteredCount: filtered.length
    };
  }
  
  // REINFORCED_REQUIRED: Double or better (V15 Â§13.4)
  if (state === 'REINFORCED_REQUIRED') {
    const filtered = sealsArray.filter(s => 
      s.sealless === true || 
      s.type.toLowerCase().includes('double') ||
      s.type.toLowerCase().includes('cartridge') ||
      s.priority.includes('CRITICAL') ||
      s.priority.includes('STRONGLY')
    );
    return { 
      seals: filtered.length > 0 ? filtered : sealsArray, 
      suppressed: false, 
      filtered: true,
      reason: sealEligibility.reason,
      originalCount: sealsArray.length,
      filteredCount: filtered.length
    };
  }
  
  // STANDARD_ALLOWED: All non-sealless options okay (V15 Â§13.3)
  // Per V15 Â§13.6: If STANDARD_ALLOWED, no sealless option should be shown
  if (state === 'STANDARD_ALLOWED') {
    const filtered = sealsArray.filter(s => s.sealless !== true);
    return { 
      seals: filtered.length > 0 ? filtered : sealsArray, 
      suppressed: false, 
      filtered: false,
      reason: sealEligibility.reason
    };
  }
  
  // Fallback: return all seals
  return { seals: sealsArray, suppressed: false, filtered: false };
}

// ============================================================================
// Â§14. FINALASSESSMENTOUTPUT (FAO) - SINGLE SOURCE OF TRUTH
// ============================================================================
let _currentFAO = null;

function generateFAO(runContext, candidateSets, sealEligibility, recommendations, warnings) {
  // Â§14: Each run produces exactly one immutable FinalAssessmentOutput
  if (!runContext || runContext.valid === false) {
    return { valid: false, error: 'Invalid run context' };
  }

  const fao = Object.freeze({
    runId: runContext.runId,
    policyVersion: CERTA_POLICY_VERSION,
    timestamp: Date.now(),

    // Resolved regimes
    primaryRegime: runContext.primaryRegime,
    secondaryRegimes: runContext.secondaryRegimes,

    // Candidate sets (Â§10)
    candidateSets: candidateSets,

    // Seal eligibility (Â§13)
    sealEligibilityState: sealEligibility.state,
    allowedSealCategories: sealEligibility.allowedCategories,
    sealReason: sealEligibility.reason,

    // Recommendations
    recommendations: recommendations || [],

    // Warnings
    warnings: warnings || [],

    // UI labels (derived)
    uiLabels: generateUILabels(runContext, sealEligibility),

    // Checksum for UI=PDF verification
    checksum: generateChecksum(runContext)
  });

  _currentFAO = fao;
  return { valid: true, fao: fao };
}

function generateUILabels(runContext, sealEligibility) {
  return {
    regimeBadge: runContext.primaryRegime.replace(/_/g, ' '),
    sealBadge: sealEligibility.state.replace(/_/g, ' '),
    fluidLabel: runContext.fluidLabel,
    tempLabel: safeToFixed(runContext.temperature, 1, '0') + 'Â°C'
  };
}

function generateChecksum(runContext) {
  // Simple checksum for UI=PDF verification (Â§14.1)
  const str = runContext.runId + runContext.fluidId + safeToFixed(runContext.temperature, 1, '0');
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return 'CHK-' + Math.abs(hash).toString(16).toUpperCase();
}

// ============================================================================
// Â§15. UI / UX SAFETY CONTRACT
// ============================================================================
function validateUIState(fao) {
  // Â§15: UI must clear all prior outputs on new runId
  // Never render stale data, never infer or compute logic
  if (!fao || !fao.runId) return false;
  if (!_currentFAO || _currentFAO.runId !== fao.runId) return false;
  return true;
}

// ============================================================================
// Â§16. ERROR HANDLING
// ============================================================================
function handleEngineError(stage, error, runId) {
  // Â§16: Abort evaluation, clear outputs, log, display deterministic error
  console.error('[CERTA ERROR] Stage:', stage, 'RunId:', runId, 'Error:', error);

  return {
    isError: true,
    stage: stage,
    runId: runId || 'UNKNOWN',
    message: 'Evaluation aborted at stage: ' + stage,
    timestamp: Date.now()
  };
}

// ============================================================================
// Â§9. MISSING DATA GOVERNANCE
// ============================================================================
function assessDataCompleteness(fluidId, tempC) {
  const issues = [];
  const fl = F[fluidId];

  // Â§9.1 Missing Fluid Data
  if (!fl) {
    return { complete: false, regime: 'UNKNOWN_RESTRICTED', issues: ['Fluid not found'] };
  }

  if (!fl.d || fl.d.length === 0) {
    issues.push('No temperature-property data');
  }

  if (!fl.c) {
    issues.push('No category classification');
  }

  // Check if temperature is within data range
  if (fl.d && fl.d.length > 0) {
    const minT = fl.d[0][0];
    const maxT = fl.d[fl.d.length - 1][0];
    if (tempC < minT || tempC > maxT) {
      issues.push('Temperature outside data range (' + minT + '-' + maxT + 'Â°C)');
    }
  }

  // Â§9.3 No Silent Defaults - if issues exist, downgrade
  if (issues.length > 0) {
    return {
      complete: false,
      regime: 'UNKNOWN_RESTRICTED',
      issues: issues,
      message: 'Insufficient characterization - outputs suppressed'
    };
  }

  return { complete: true, issues: [] };
}

// ============================================================================
// OPTIMIZATION UTILITIES (Preserved from V91)
// ============================================================================

// NULL-SAFE FORMATTING
const SafeFormat = {
  decimal: function(v, p, fb) {
    p = p || 2; fb = fb || 'N/A';
    return (v != null && !isNaN(v)) ? Number(v).toFixed(p) : fb;
  },
  rate: function(r, fb) {
    fb = fb || 'N/A';
    if (r == null) return fb;
    if (typeof r === 'number') return isNaN(r) ? fb : r.toFixed(3) + ' mm/yr';
    if (r && r.rate != null) return isNaN(r.rate) ? fb : r.rate.toFixed(3) + ' mm/yr';
    return fb;
  },
  life: function(l, fb) {
    fb = fb || 'N/A';
    if (l == null || isNaN(l)) return fb;
    return l >= 50 ? '25+ yrs' : l.toFixed(1) + ' yrs';
  }
};

// V17.0: EVALUATION CACHE using LRU (MF-3 FIX - Agent PER-3)
const _evalCache = new LRUCache(500);
function _cacheKey(m,f,t,c) { return m+'|'+f+'|'+Math.round(t*10)+'|'+c; }
function _getCached(m,f,t,c) { return _evalCache.get(_cacheKey(m,f,t,c)); }
function _setCache(m,f,t,c,r) { return _evalCache.set(_cacheKey(m,f,t,c), r); }
function _clearCache() { _evalCache.clear(); }

// SEARCH INDEX
var _searchIndex = null;
var _categoryIndex = null;
function _buildSearchIndex() {
  if (_searchIndex) return;
  _searchIndex = [];
  _categoryIndex = {};
  for (var k in F) {
    if (F.hasOwnProperty(k)) {
      var e = { id: k, text: (F[k].n + ' ' + F[k].c).toLowerCase(), name: F[k].n, cat: F[k].c };
      _searchIndex.push(e);
      if (!_categoryIndex[F[k].c]) _categoryIndex[F[k].c] = [];
      _categoryIndex[F[k].c].push(e);
    }
  }
}

// AUDIT TRAIL (Circular Buffer)
var _auditBuf = [];
var _auditIdx = 0;
var _AUDIT_MAX = 1000;
function _addAudit(rule, mat, fluid, temp, decision, details) {
  var e = { ts: Date.now(), rule: rule, mat: mat, fluid: fluid, temp: temp, dec: decision, det: details };
  if (_auditBuf.length < _AUDIT_MAX) _auditBuf.push(e);
  else _auditBuf[_auditIdx % _AUDIT_MAX] = e;
  _auditIdx++;
  return e;
}

// DOM BATCH UPDATE
function _batchDOM(updates) {
  requestAnimationFrame(function() {
    for (var i = 0; i < updates.length; i++) {
      var el = document.getElementById(updates[i][0]);
      if (el) el.innerHTML = updates[i][1];
    }
  });
}

// INPUT VALIDATION
var VALIDATION = {
  temperature: function(t, u) {
    var n = parseFloat(t);
    if (isNaN(n)) return { valid: false, error: 'Invalid temperature' };
    var c = u === 'F' ? (n-32)*5/9 : u === 'K' ? n-273.15 : n;
    if (c < -273.15 || c > 1000) return { valid: false, error: 'Temperature out of range' };
    return { valid: true, value: c };
  },
  fluidId: function(id) {
    return F && F[id] ? { valid: true } : { valid: false, error: 'Unknown fluid' };
  }
};

// ============================================================================
// END V15 GOVERNANCE FRAMEWORK - Original CERTA data follows UNCHANGED
// Per Â§3: No features may be removed, no regressions allowed
// ============================================================================

const F={
'water':{n:'Water (Pure)',c:'Water & Aqueous',d:[[0,.9998,1.787],[10,.9997,1.307],[20,.9982,1.002],[30,.9957,.798],[40,.9922,.653],[50,.9881,.547],[60,.9832,.467],[70,.9778,.404],[80,.9718,.355],[90,.9653,.315],[100,.9584,.282]]},
'seawater':{n:'Seawater (3.5%)',c:'Water & Aqueous',d:[[0,1.028,1.89],[10,1.027,1.39],[20,1.025,1.08],[30,1.022,.86],[40,1.018,.70]]},
'process-water':{n:'Process Water',c:'Water & Aqueous',d:[[0,1.015,1.85],[20,1.012,1.05],[40,1.009,.68],[60,1.005,.51]]},
'h2so4-10':{n:'Sulfuric Acid 10%',c:'Acids - Sulfuric',d:[[0,1.066,1.48],[20,1.064,1.15],[40,1.061,.93],[60,1.058,.78]]},
'h2so4-20':{n:'Sulfuric Acid 20%',c:'Acids - Sulfuric',d:[[0,1.139,1.80],[20,1.136,1.38],[40,1.132,1.10],[60,1.127,.91]]},
'h2so4-50':{n:'Sulfuric Acid 50%',c:'Acids - Sulfuric',d:[[0,1.376,4.85],[20,1.370,3.40],[40,1.363,2.50],[60,1.355,1.91]]},
'h2so4-70':{n:'Sulfuric Acid 70%',c:'Acids - Sulfuric',d:[[0,1.608,12.8],[20,1.600,8.35],[40,1.591,5.70],[60,1.581,4.08]]},
'h2so4-93':{n:'Sulfuric Acid 93%',c:'Acids - Sulfuric',d:[[0,1.825,42.5],[20,1.818,23.2],[40,1.811,13.8],[60,1.804,8.8]]},
'h2so4-98':{n:'Sulfuric Acid 98%',c:'Acids - Sulfuric',d:[[0,1.841,48.4],[20,1.834,25.4],[40,1.827,14.5],[60,1.819,9.1]]},
'oleum-20':{n:'Oleum 20%',c:'Acids - Sulfuric',d:[[0,1.915,15.5],[20,1.908,9.8],[40,1.901,6.5],[60,1.894,4.7]]},
'hcl-10':{n:'Hydrochloric Acid 10%',c:'Acids - Hydrochloric',d:[[0,1.047,1.25],[20,1.045,1.05],[40,1.042,.89],[60,1.039,.77]]},
'hcl-20':{n:'Hydrochloric Acid 20%',c:'Acids - Hydrochloric',d:[[0,1.098,1.68],[20,1.095,1.35],[40,1.091,1.12],[60,1.087,.95]]},
'hcl-32':{n:'Hydrochloric Acid 32%',c:'Acids - Hydrochloric',d:[[0,1.160,2.35],[20,1.157,1.72],[40,1.153,1.34],[60,1.148,1.09]]},
'hcl-37':{n:'Hydrochloric Acid 37%',c:'Acids - Hydrochloric',d:[[0,1.179,2.65],[20,1.176,1.88],[40,1.171,1.42],[60,1.166,1.13]]},
'hno3-10':{n:'Nitric Acid 10%',c:'Acids - Nitric',d:[[0,1.054,1.22],[20,1.052,1.02],[40,1.049,.87],[60,1.045,.76]]},
'hno3-30':{n:'Nitric Acid 30%',c:'Acids - Nitric',d:[[0,1.180,1.65],[20,1.176,1.32],[40,1.171,1.09],[60,1.165,.92]]},
'hno3-50':{n:'Nitric Acid 50%',c:'Acids - Nitric',d:[[0,1.310,2.18],[20,1.304,1.70],[40,1.297,1.36],[60,1.289,1.12]]},
'hno3-70':{n:'Nitric Acid 70%',c:'Acids - Nitric',d:[[0,1.413,2.65],[20,1.406,2.03],[40,1.398,1.60],[60,1.389,1.30]]},
'h3po4-10':{n:'Phosphoric Acid 10%',c:'Acids - Phosphoric',d:[[0,1.052,1.35],[20,1.050,1.10],[40,1.047,.92],[60,1.043,.78]]},
'h3po4-50':{n:'Phosphoric Acid 50%',c:'Acids - Phosphoric',d:[[0,1.335,8.45],[20,1.329,5.80],[40,1.322,4.10],[60,1.314,3.05]]},
'h3po4-75':{n:'Phosphoric Acid 75%',c:'Acids - Phosphoric',d:[[0,1.579,58.5],[20,1.570,35.2],[40,1.560,22.8],[60,1.549,15.6]]},
'h3po4-85':{n:'Phosphoric Acid 85%',c:'Acids - Phosphoric',d:[[0,1.689,148],[20,1.679,82.5],[40,1.668,50.2],[60,1.656,32.8]]},
'acetic-50':{n:'Acetic Acid 50%',c:'Acids - Organic',d:[[0,1.044,1.52],[20,1.041,1.22],[40,1.037,1.00],[60,1.032,.84]]},
'acetic-100':{n:'Acetic Acid 100%',c:'Acids - Organic',d:[[0,1.067,1.31],[20,1.049,1.16],[40,1.031,1.04],[60,1.012,.93]]},
'citric-10':{n:'Citric Acid 10%',c:'Acids - Organic',d:[[0,1.038,1.48],[20,1.036,1.18],[40,1.033,.96],[60,1.030,.80]]},
'citric-50':{n:'Citric Acid 50%',c:'Acids - Organic',d:[[0,1.265,125],[20,1.260,68],[40,1.255,42],[60,1.250,28]]},
'formic-50':{n:'Formic Acid 50%',c:'Acids - Organic',d:[[0,1.121,1.75],[20,1.117,1.38],[40,1.112,1.12],[60,1.106,.93]]},
'lactic-50':{n:'Lactic Acid 50%',c:'Acids - Organic',d:[[0,1.115,38],[20,1.112,22],[40,1.109,14],[60,1.106,9.5]]},
'lactic-88':{n:'Lactic Acid 88%',c:'Acids - Organic',d:[[0,1.205,185],[20,1.200,95],[40,1.195,55],[60,1.190,35]]},
'naoh-10':{n:'Sodium Hydroxide 10%',c:'Bases - NaOH',d:[[0,1.109,2.15],[20,1.107,1.65],[40,1.104,1.30],[60,1.101,1.05]]},
'naoh-20':{n:'Sodium Hydroxide 20%',c:'Bases - NaOH',d:[[0,1.219,4.85],[20,1.216,3.42],[40,1.212,2.52],[60,1.207,1.93]]},
'naoh-30':{n:'Sodium Hydroxide 30%',c:'Bases - NaOH',d:[[0,1.328,12.5],[20,1.324,8.15],[40,1.318,5.58],[60,1.312,4.02]]},
'naoh-50':{n:'Sodium Hydroxide 50%',c:'Bases - NaOH',d:[[0,1.530,125],[20,1.525,52],[40,1.518,25],[60,1.510,14]]},
'koh-10':{n:'Potassium Hydroxide 10%',c:'Bases - KOH',d:[[0,1.092,2.05],[20,1.090,1.58],[40,1.087,1.25],[60,1.083,1.01]]},
'koh-30':{n:'Potassium Hydroxide 30%',c:'Bases - KOH',d:[[0,1.283,10.8],[20,1.279,7.25],[40,1.273,5.05],[60,1.267,3.72]]},
'koh-50':{n:'Potassium Hydroxide 50%',c:'Bases - KOH',d:[[0,1.487,98.5],[20,1.481,45.2],[40,1.473,23.8],[60,1.465,13.8]]},
'nh4oh-10':{n:'Ammonium Hydroxide 10%',c:'Bases - Ammonia',d:[[0,.976,1.35],[20,.972,1.08],[40,.967,.88],[60,.961,.73]]},
'nh4oh-25':{n:'Ammonium Hydroxide 25%',c:'Bases - Ammonia',d:[[0,.935,1.85],[20,.928,1.38],[40,.921,1.05],[60,.914,.82]]},
'nh4oh-28':{n:'Ammonium Hydroxide 28%',c:'Bases - Ammonia',d:[[0,.926,1.68],[20,.920,1.34],[40,.913,1.09],[60,.905,.90]]},
'lime-slurry':{n:'Lime Slurry 30%',c:'Bases - Lime',d:[[0,1.285,285],[20,1.280,135],[40,1.275,75],[60,1.270,45]]},
'nacn-1':{n:'Sodium Cyanide 1%',c:'Mining - Cyanide',d:[[0,1.008,1.05],[20,1.007,1.01],[40,1.006,.88],[60,1.004,.76]]},
'nacn-5':{n:'Sodium Cyanide 5%',c:'Mining - Cyanide',d:[[0,1.042,1.32],[20,1.040,1.12],[40,1.037,.96],[60,1.034,.83]]},
'nacn-10':{n:'Sodium Cyanide 10%',c:'Mining - Cyanide',d:[[0,1.087,1.75],[20,1.084,1.42],[40,1.080,1.18],[60,1.076,.99]]},
'coal-slurry-30':{n:'Coal Slurry 30%',c:'Mining - Slurries',d:[[0,1.125,15.5],[20,1.122,8.2],[40,1.118,5.1],[60,1.114,3.5]]},
'coal-slurry-50':{n:'Coal Slurry 50%',c:'Mining - Slurries',d:[[0,1.215,45],[20,1.211,22.5],[40,1.206,13.2],[60,1.201,8.5]]},
'ore-slurry-30':{n:'Ore Slurry 30%',c:'Mining - Slurries',d:[[0,1.185,18.5],[20,1.181,9.8],[40,1.176,6.2],[60,1.171,4.2]]},
'ore-slurry-50':{n:'Ore Slurry 50%',c:'Mining - Slurries',d:[[0,1.325,58],[20,1.320,28.5],[40,1.314,16.8],[60,1.308,10.8]]},
'tailings-slurry':{n:'Tailings Slurry 40%',c:'Mining - Slurries',d:[[0,1.245,32.5],[20,1.240,16.2],[40,1.234,9.8],[60,1.228,6.5]]},
'xanthate':{n:'Xanthate Solution',c:'Mining - Flotation',d:[[0,1.025,1.35],[20,1.022,1.10],[40,1.019,.91],[60,1.015,.77]]},
'frother-mibc':{n:'Frother (MIBC)',c:'Mining - Flotation',d:[[0,.995,2.15],[20,.991,1.62],[40,.986,1.28],[60,.981,1.03]]},
'crude-light':{n:'Crude Oil (Light)',c:'Petroleum',d:[[0,.855,35],[20,.840,18],[40,.825,10.5],[60,.810,6.8],[80,.795,4.8]]},
'crude-heavy':{n:'Crude Oil (Heavy)',c:'Petroleum',d:[[0,.950,850],[20,.935,320],[40,.920,145],[60,.905,75],[80,.890,42]]},
'diesel':{n:'Diesel Fuel',c:'Petroleum',d:[[0,.855,5.5],[20,.845,3.2],[40,.835,2.1],[60,.825,1.5],[80,.815,1.1]]},
'gasoline':{n:'Gasoline',c:'Petroleum',d:[[0,.745,.65],[20,.735,.55],[40,.725,.47],[60,.715,.42]]},
'kerosene':{n:'Kerosene',c:'Petroleum',d:[[0,.820,2.71],[20,.810,1.64],[40,.800,1.20],[60,.790,.94]]},
'naphtha':{n:'Naphtha',c:'Petroleum',d:[[0,.745,.78],[20,.735,.64],[40,.725,.54],[60,.715,.47]]},
'fuel-oil-2':{n:'Fuel Oil #2',c:'Petroleum',d:[[0,.865,7.4],[20,.855,4.3],[40,.845,2.8],[60,.835,2.0]]},
'fuel-oil-6':{n:'Fuel Oil #6',c:'Petroleum',d:[[20,.985,900],[40,.975,280],[60,.965,115],[80,.955,55]]},
'benzene':{n:'Benzene',c:'Aromatics',d:[[0,.899,.912],[20,.879,.652],[40,.858,.492],[60,.837,.392]]},
'toluene':{n:'Toluene',c:'Aromatics',d:[[0,.885,.772],[20,.867,.590],[40,.849,.471],[60,.830,.387]]},
'xylene':{n:'Xylene',c:'Aromatics',d:[[0,.880,.812],[20,.864,.631],[40,.848,.503],[60,.831,.415]]},
'styrene':{n:'Styrene',c:'Aromatics',d:[[0,.924,.968],[20,.906,.762],[40,.888,.615],[60,.869,.507]]},
'ethylbenzene':{n:'Ethylbenzene',c:'Aromatics',d:[[0,.882,.784],[20,.867,.620],[40,.851,.504],[60,.835,.420]]},
'ethanol':{n:'Ethanol',c:'Alcohols',d:[[0,.806,1.773],[20,.789,1.200],[40,.772,.834],[60,.754,.592]]},
'methanol':{n:'Methanol',c:'Alcohols',d:[[0,.810,.820],[20,.792,.597],[40,.774,.456],[60,.755,.362]]},
'isopropanol':{n:'Isopropanol',c:'Alcohols',d:[[0,.802,4.52],[20,.785,2.43],[40,.768,1.49],[60,.750,1.01]]},
'butanol':{n:'n-Butanol',c:'Alcohols',d:[[0,.820,5.18],[20,.810,2.95],[40,.799,1.82],[60,.788,1.20]]},
'ethylene-glycol':{n:'Ethylene Glycol',c:'Glycols',d:[[0,1.130,57],[20,1.116,20],[40,1.101,9.1],[60,1.087,4.8]]},
'propylene-glycol':{n:'Propylene Glycol',c:'Glycols',d:[[0,1.050,243],[20,1.038,60.5],[40,1.025,18],[60,1.012,7.5]]},
'glycerin':{n:'Glycerin',c:'Glycols',d:[[0,1.273,12100],[20,1.264,1490],[40,1.252,284],[60,1.239,81.3]]},
'acetone':{n:'Acetone',c:'Solvents',d:[[0,.812,.399],[20,.791,.316],[40,.769,.260],[60,.747,.218]]},
'mek':{n:'MEK',c:'Solvents',d:[[0,.823,.515],[20,.805,.423],[40,.786,.354],[60,.767,.301]]},
'ethyl-acetate':{n:'Ethyl Acetate',c:'Solvents',d:[[0,.924,.523],[20,.901,.455],[40,.877,.400],[60,.853,.356]]},
'dmso':{n:'DMSO',c:'Solvents',d:[[20,1.100,2.00],[40,1.085,1.40],[60,1.070,1.05],[80,1.055,.82]]},
'dmf':{n:'DMF',c:'Solvents',d:[[0,.962,1.18],[20,.948,.92],[40,.934,.75],[60,.920,.62]]},
'thf':{n:'THF',c:'Solvents',d:[[0,.897,.62],[20,.883,.48],[40,.868,.39],[60,.853,.33]]},
'nmp':{n:'NMP',c:'Solvents',d:[[0,1.045,2.15],[20,1.033,1.67],[40,1.020,1.35],[60,1.007,1.12]]},
'trichloroethylene':{n:'Trichloroethylene',c:'Chlorinated',d:[[0,1.492,.707],[20,1.464,.570],[40,1.436,.473],[60,1.407,.401]]},
'perchloroethylene':{n:'Perchloroethylene',c:'Chlorinated',d:[[0,1.646,1.132],[20,1.623,.908],[40,1.599,.747],[60,1.574,.629]]},
'chloroform':{n:'Chloroform',c:'Chlorinated',d:[[0,1.526,.700],[20,1.489,.580],[40,1.451,.492],[60,1.413,.426]]},
'methylene-chloride':{n:'Methylene Chloride',c:'Chlorinated',d:[[0,1.342,.533],[20,1.326,.449],[40,1.309,.387],[60,1.291,.339]]},
'carbon-tet':{n:'Carbon Tetrachloride',c:'Chlorinated',d:[[0,1.632,1.329],[20,1.594,.969],[40,1.556,.739],[60,1.518,.585]]},
'alum-8':{n:'Alum 8%',c:'Wastewater - Coagulants',d:[[0,1.085,2.15],[20,1.082,1.62],[40,1.079,1.28],[60,1.076,1.04]]},
'alum-48':{n:'Alum 48%',c:'Wastewater - Coagulants',d:[[0,1.545,185],[20,1.540,95],[40,1.535,55],[60,1.530,35]]},
'ferric-chloride-38':{n:'Ferric Chloride 38%',c:'Wastewater - Coagulants',d:[[0,1.455,22],[20,1.450,13.5],[40,1.445,9.2],[60,1.440,6.5]]},
'ferric-sulfate-45':{n:'Ferric Sulfate 45%',c:'Wastewater - Coagulants',d:[[0,1.525,35],[20,1.520,21],[40,1.515,14],[60,1.510,10]]},
'pac-18':{n:'PAC 18%',c:'Wastewater - Coagulants',d:[[0,1.245,12.5],[20,1.240,8.2],[40,1.235,5.8],[60,1.230,4.2]]},
'hypochlorite-12':{n:'Sodium Hypochlorite 12%',c:'Wastewater - Disinfection',d:[[0,1.165,3.5],[20,1.160,2.5],[40,1.155,1.9],[60,1.150,1.5]]},
'hypochlorite-15':{n:'Sodium Hypochlorite 15%',c:'Wastewater - Disinfection',d:[[0,1.205,4.8],[20,1.200,3.2],[40,1.195,2.3],[60,1.190,1.8]]},
'h2o2-35':{n:'Hydrogen Peroxide 35%',c:'Wastewater - Disinfection',d:[[0,1.132,1.58],[20,1.128,1.25],[40,1.124,1.00],[60,1.120,.82]]},
'h2o2-50':{n:'Hydrogen Peroxide 50%',c:'Wastewater - Disinfection',d:[[0,1.195,1.95],[20,1.190,1.48],[40,1.185,1.15],[60,1.180,.92]]},
'peracetic-15':{n:'Peracetic Acid 15%',c:'Wastewater - Disinfection',d:[[0,1.065,2.85],[20,1.062,2.12],[40,1.059,1.65],[60,1.056,1.32]]},
'polymer-anionic':{n:'Anionic Polymer 0.5%',c:'Wastewater - Polymers',d:[[0,1.008,425],[20,1.006,185],[40,1.004,95],[60,1.002,55]]},
'polymer-cationic':{n:'Cationic Polymer 0.5%',c:'Wastewater - Polymers',d:[[0,1.010,485],[20,1.008,215],[40,1.006,105],[60,1.004,62]]},
'urea-32':{n:'Urea Solution 32%',c:'Fertilizers',d:[[0,1.320,5.8],[20,1.315,3.5],[40,1.310,2.4],[60,1.305,1.8]]},
'ammonium-nitrate-80':{n:'Ammonium Nitrate 80% (Ambient 0-60Â°C)',c:'Fertilizers',d:[[0,1.385,25],[20,1.380,13],[40,1.375,8.2],[60,1.370,5.5]]},
'phosphoric-54':{n:'Phosphoric Acid 54%',c:'Fertilizers',d:[[0,1.350,12.5],[20,1.345,7.8],[40,1.340,5.2],[60,1.335,3.8]]},
'map-solution':{n:'MAP Solution',c:'Fertilizers',d:[[0,1.285,18.5],[20,1.280,11.2],[40,1.275,7.4],[60,1.270,5.2]]},
'dap-solution':{n:'DAP Solution',c:'Fertilizers',d:[[0,1.195,12.5],[20,1.190,8.2],[40,1.185,5.8],[60,1.180,4.2]]},
'milk-whole':{n:'Whole Milk',c:'Food - Dairy',d:[[0,1.035,2.82],[10,1.033,2.43],[20,1.032,2.13],[30,1.030,1.89]]},
'milk-skim':{n:'Skim Milk',c:'Food - Dairy',d:[[0,1.036,2.15],[10,1.034,1.88],[20,1.033,1.65],[30,1.031,1.48]]},
'cream-heavy':{n:'Heavy Cream',c:'Food - Dairy',d:[[0,1.012,12.5],[10,1.010,9.8],[20,1.008,8.2],[30,1.006,6.9]]},
'whey':{n:'Whey',c:'Food - Dairy',d:[[0,1.025,1.85],[20,1.023,1.42],[40,1.020,1.13],[60,1.017,.93]]},
'condensed-milk':{n:'Condensed Milk',c:'Food - Dairy',d:[[20,1.285,2800],[30,1.280,1250],[40,1.275,625],[50,1.270,350]]},
'sucrose-50':{n:'Sucrose 50%',c:'Food - Sugars',d:[[0,1.230,42],[20,1.225,24],[40,1.220,15],[60,1.215,10]]},
'sucrose-67':{n:'Sucrose 67%',c:'Food - Sugars',d:[[0,1.325,425],[20,1.320,185],[40,1.315,95],[60,1.310,55]]},
'glucose-70':{n:'Glucose Syrup 70%',c:'Food - Sugars',d:[[0,1.355,2800],[20,1.350,950],[40,1.345,425],[60,1.340,215]]},
'hfcs-77':{n:'HFCS 77%',c:'Food - Sugars',d:[[20,1.415,7500],[30,1.410,3200],[40,1.405,1450],[50,1.400,720]]},
'molasses':{n:'Molasses',c:'Food - Sugars',d:[[20,1.415,8500],[30,1.410,3850],[40,1.405,1850],[50,1.400,950]]},
'vegetable-oil':{n:'Vegetable Oil',c:'Food - Oils',d:[[0,.927,125],[20,.919,69],[40,.911,42],[60,.903,27]]},
'olive-oil':{n:'Olive Oil',c:'Food - Oils',d:[[0,.920,138],[20,.912,84],[40,.904,54],[60,.896,36]]},
'canola-oil':{n:'Canola Oil',c:'Food - Oils',d:[[0,.923,112],[20,.915,65],[40,.907,40],[60,.899,26]]},
'coconut-oil':{n:'Coconut Oil',c:'Food - Oils',d:[[30,.915,42],[40,.909,32],[60,.897,20],[80,.885,14]]},
'sae-10':{n:'SAE 10 Oil',c:'Lubricants',d:[[0,.925,385],[20,.915,130],[40,.905,58],[60,.895,30],[80,.885,18]]},
'sae-30':{n:'SAE 30 Oil',c:'Lubricants',d:[[0,.920,1300],[20,.910,440],[40,.900,175],[60,.890,82],[80,.880,43]]},
'sae-50':{n:'SAE 50 Oil',c:'Lubricants',d:[[0,.915,3500],[20,.905,1050],[40,.895,380],[60,.885,165],[80,.875,82]]},
'hydraulic-32':{n:'Hydraulic ISO 32',c:'Lubricants',d:[[0,.880,240],[20,.870,80],[40,.860,32],[60,.850,16],[80,.840,9.5]]},
'hydraulic-46':{n:'Hydraulic ISO 46',c:'Lubricants',d:[[0,.885,385],[20,.875,110],[40,.865,46],[60,.855,23],[80,.845,13]]},
'hydraulic-68':{n:'Hydraulic ISO 68',c:'Lubricants',d:[[0,.890,625],[20,.880,185],[40,.870,68],[60,.860,33],[80,.850,18]]},
'gear-80w90':{n:'Gear Oil 80W-90',c:'Lubricants',d:[[0,.905,4200],[20,.895,1250],[40,.885,450],[60,.875,195],[80,.865,95]]},
'turbine-oil':{n:'Turbine Oil',c:'Lubricants',d:[[0,.880,240],[20,.870,80],[40,.860,32],[60,.850,16],[80,.840,9.5]]},
'compressor-oil':{n:'Compressor Oil',c:'Lubricants',d:[[0,.892,450],[20,.882,155],[40,.872,65],[60,.862,32],[80,.852,17]]},
'transformer-oil':{n:'Transformer Oil',c:'Lubricants',d:[[0,.890,75],[20,.880,28],[40,.870,13],[60,.860,7.5],[80,.850,5.0]]},
'silicone-350':{n:'Silicone Oil 350cSt',c:'Specialty',d:[[0,.975,550],[20,.970,350],[40,.965,235],[60,.960,168]]},
'castor-oil':{n:'Castor Oil',c:'Specialty',d:[[0,.969,2420],[20,.961,986],[40,.952,451],[60,.943,231]]},
'honey':{n:'Honey',c:'Food Processing',d:[[20,1.420,10000],[30,1.415,3500],[40,1.410,1500],[50,1.405,750]]},
'maple-syrup':{n:'Maple Syrup',c:'Food Processing',d:[[20,1.330,2200],[30,1.325,1050],[40,1.320,550],[50,1.315,320]]},
'corn-syrup':{n:'Corn Syrup',c:'Food Processing',d:[[20,1.420,15000],[30,1.415,6500],[40,1.410,3200],[50,1.405,1750]]},
'chocolate':{n:'Chocolate (Molten)',c:'Food Processing',d:[[40,1.275,12000],[50,1.270,4500],[60,1.265,2200],[70,1.260,1200]]},
'beer':{n:'Beer',c:'Beverages',d:[[0,1.015,2.1],[5,1.013,1.8],[10,1.011,1.6],[20,1.008,1.4]]},
'wine':{n:'Wine',c:'Beverages',d:[[0,.997,2.0],[10,.995,1.6],[20,.993,1.4],[30,.990,1.2]]},
// ========== REFRIGERANTS (#16) ==========
'r134a':{n:'R-134a (HFC)',c:'Refrigerants',d:[[-40,1.418,0.54],[-20,1.358,0.40],[0,1.295,0.30],[20,1.226,0.22],[40,1.147,0.16]]},
'r410a':{n:'R-410A',c:'Refrigerants',d:[[-40,1.304,0.48],[-20,1.238,0.35],[0,1.166,0.26],[20,1.086,0.19],[40,0.992,0.14]]},
'r22':{n:'R-22 (HCFC)',c:'Refrigerants',d:[[-40,1.453,0.42],[-20,1.387,0.32],[0,1.316,0.24],[20,1.239,0.18],[40,1.152,0.14]]},
'r404a':{n:'R-404A',c:'Refrigerants',d:[[-40,1.312,0.45],[-20,1.246,0.34],[0,1.175,0.25],[20,1.096,0.18],[40,1.004,0.13]]},
'r407c':{n:'R-407C',c:'Refrigerants',d:[[-40,1.336,0.50],[-20,1.273,0.37],[0,1.205,0.28],[20,1.130,0.21],[40,1.045,0.15]]},
'r717':{n:'R-717 (Ammonia)',c:'Refrigerants',d:[[-40,0.690,0.35],[-20,0.665,0.27],[0,0.639,0.21],[20,0.610,0.16],[40,0.578,0.12]]},
'r744':{n:'R-744 (CO2)',c:'Refrigerants',d:[[-40,1.155,0.18],[-20,1.032,0.12],[0,0.927,0.09],[20,0.773,0.06]]},
'r1234yf':{n:'R-1234yf (HFO)',c:'Refrigerants',d:[[-20,1.267,0.38],[0,1.195,0.28],[20,1.115,0.21],[40,1.023,0.15]]},
// ========== CRYOGENICS (#17) ==========
'ln2':{n:'Liquid Nitrogen',c:'Cryogenics',d:[[-210,0.867,0.28],[-200,0.808,0.21],[-196,0.808,0.16]]},
'lox':{n:'Liquid Oxygen',c:'Cryogenics',d:[[-200,1.226,0.32],[-190,1.188,0.24],[-183,1.141,0.19]]},
'lar':{n:'Liquid Argon',c:'Cryogenics',d:[[-200,1.468,0.38],[-190,1.408,0.28],[-186,1.395,0.25]]},
'lng':{n:'LNG (Methane)',c:'Cryogenics',d:[[-170,0.450,0.19],[-162,0.422,0.12],[-150,0.395,0.09]]},
'lhe':{n:'Liquid Helium',c:'Cryogenics',d:[[-271,0.145,0.004],[-269,0.125,0.003],[-268,0.120,0.003]]},
// ========== PHARMACEUTICAL (#18) ==========
'wfi':{n:'WFI (Water for Injection)',c:'Pharmaceutical',d:[[20,0.998,1.002],[40,0.992,0.653],[60,0.983,0.467],[80,0.972,0.355]]},
'peg200':{n:'PEG 200',c:'Pharmaceutical',d:[[20,1.124,65],[40,1.115,35],[60,1.106,20],[80,1.097,12]]},
'peg400':{n:'PEG 400',c:'Pharmaceutical',d:[[20,1.128,105],[40,1.118,52],[60,1.108,28],[80,1.098,16]]},
'peg600':{n:'PEG 600',c:'Pharmaceutical',d:[[20,1.126,165],[40,1.116,78],[60,1.106,42],[80,1.096,24]]},
'propylene-glycol-usp':{n:'Propylene Glycol USP',c:'Pharmaceutical',d:[[20,1.036,56],[40,1.023,17],[60,1.010,7.2],[80,0.997,3.8]]},
'ethanol-usp':{n:'Ethanol USP 95%',c:'Pharmaceutical',d:[[20,0.810,1.52],[40,0.788,0.83],[60,0.765,0.52]]},
'glycerin-usp':{n:'Glycerin USP',c:'Pharmaceutical',d:[[20,1.261,1490],[40,1.248,284],[60,1.235,81],[80,1.222,34]]},
'mineral-oil-usp':{n:'Mineral Oil USP',c:'Pharmaceutical',d:[[20,0.845,32],[40,0.835,15],[60,0.825,8.5],[80,0.815,5.2]]},
'sodium-chloride-09':{n:'Saline 0.9% (NS)',c:'Pharmaceutical',d:[[20,1.005,1.02],[37,1.003,0.78]]},
'dextrose-5':{n:'Dextrose 5% (D5W)',c:'Pharmaceutical',d:[[20,1.018,1.12],[37,1.015,0.85]]},
// ========== BATTERY INDUSTRY (#19) ==========
'nmp-battery':{n:'NMP (Battery Grade)',c:'Battery - Solvents',d:[[20,1.028,1.67],[40,1.015,1.15],[60,1.002,0.85],[80,0.989,0.65]]},
'dmc':{n:'DMC (Dimethyl Carbonate)',c:'Battery - Solvents',d:[[0,1.085,0.72],[20,1.063,0.59],[40,1.041,0.49]]},
'emc':{n:'EMC (Ethyl Methyl Carbonate)',c:'Battery - Solvents',d:[[0,1.020,0.78],[20,1.007,0.65],[40,0.993,0.54]]},
'dec':{n:'DEC (Diethyl Carbonate)',c:'Battery - Solvents',d:[[0,0.985,0.85],[20,0.969,0.75],[40,0.953,0.62]]},
'ec-pc':{n:'EC/PC (50:50)',c:'Battery - Electrolyte',d:[[20,1.282,3.8],[40,1.265,2.5],[60,1.248,1.7]]},
'lipf6-electrolyte':{n:'LiPF6 1M Electrolyte',c:'Battery - Electrolyte',d:[[20,1.195,4.2],[40,1.180,2.8],[60,1.165,1.9]]},
'h2so4-battery':{n:'Battery Acid (H2SO4 37%)',c:'Battery - Electrolyte',d:[[0,1.280,3.8],[20,1.275,2.5],[40,1.270,1.8]]},
'koh-electrolyte':{n:'KOH 30% (Alkaline)',c:'Battery - Electrolyte',d:[[20,1.279,7.25],[40,1.273,5.05],[60,1.267,3.72]]},
// ========== PULP & PAPER (#20) ==========
'black-liquor':{n:'Black Liquor (15% DS)',c:'Pulp & Paper',d:[[60,1.058,5.2],[80,1.052,3.1],[100,1.046,2.0]]},
'black-liquor-50':{n:'Black Liquor (50% DS)',c:'Pulp & Paper',d:[[80,1.220,85],[100,1.210,42],[120,1.200,22]]},
'green-liquor':{n:'Green Liquor',c:'Pulp & Paper',d:[[60,1.155,4.8],[80,1.148,3.2],[100,1.141,2.3]]},
'white-liquor':{n:'White Liquor',c:'Pulp & Paper',d:[[60,1.128,3.5],[80,1.122,2.4],[100,1.116,1.8]]},
'tall-oil':{n:'Tall Oil',c:'Pulp & Paper',d:[[40,0.965,125],[60,0.955,55],[80,0.945,28],[100,0.935,16]]},
'turpentine':{n:'Turpentine',c:'Pulp & Paper',d:[[20,0.865,1.49],[40,0.850,1.08],[60,0.835,0.82]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: MINING INDUSTRY - Complete Coverage
// Per Â§17: Controlled Expansion Protocol with full taxonomy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Mining - Leaching & Extraction
'h2so4-raffinate':{n:'Raffinate (Hâ‚‚SOâ‚„ bearing)',c:'Mining - Leaching',d:[[20,1.045,1.35],[40,1.040,0.98],[60,1.035,0.75]]},
'pls-copper':{n:'Pregnant Leach Solution (Cu)',c:'Mining - Leaching',d:[[20,1.085,1.42],[40,1.078,1.02],[60,1.071,0.78]]},
'barren-leach':{n:'Barren Leach Solution',c:'Mining - Leaching',d:[[20,1.025,1.18],[40,1.020,0.88],[60,1.015,0.68]]},
'heap-leach':{n:'Heap Leach Solution',c:'Mining - Leaching',d:[[20,1.055,1.28],[40,1.048,0.95],[60,1.041,0.72]]},
'sxew-organic':{n:'SX-EW Organic Phase',c:'Mining - Leaching',d:[[20,0.875,12.5],[40,0.865,6.8],[60,0.855,4.2]]},
'lix-extractant':{n:'LIX Extractant Solution',c:'Mining - Leaching',d:[[20,0.895,18.5],[40,0.885,9.2],[60,0.875,5.5]]},

// Mining - Gold Processing
'cyanide-barren':{n:'Barren Cyanide Solution',c:'Mining - Cyanide',d:[[15,1.012,1.25],[25,1.008,1.05],[35,1.004,0.88]]},
'cyanide-pregnant':{n:'Pregnant Cyanide Solution',c:'Mining - Cyanide',d:[[15,1.018,1.32],[25,1.014,1.10],[35,1.010,0.92]]},
'cil-slurry':{n:'CIL Slurry (Carbon-in-Leach)',c:'Mining - Cyanide',d:[[25,1.350,85],[35,1.340,55],[45,1.330,38]]},
'cip-slurry':{n:'CIP Slurry (Carbon-in-Pulp)',c:'Mining - Cyanide',d:[[25,1.380,120],[35,1.368,78],[45,1.356,52]]},
'strip-solution':{n:'Carbon Strip Solution (NaOH/NaCN)',c:'Mining - Cyanide',d:[[80,1.085,0.85],[90,1.078,0.72],[100,1.071,0.62]]},
'elution-solution':{n:'Elution Solution',c:'Mining - Cyanide',d:[[90,1.065,0.68],[100,1.058,0.58],[110,1.051,0.50]]},
'smbs-solution':{n:'SMBS Solution (Cyanide Destruction)',c:'Mining - Cyanide',d:[[20,1.095,1.42],[40,1.085,1.02],[60,1.075,0.78]]},
'caro-acid':{n:'Caro\'s Acid (Hâ‚‚SOâ‚…)',c:'Mining - Cyanide',d:[[20,1.420,8.5],[30,1.410,5.8],[40,1.400,4.2]]},

// Mining - Flotation Reagents
'collector-xanthate':{n:'Xanthate Collector (5%)',c:'Mining - Flotation',d:[[20,1.025,1.35],[30,1.020,1.12],[40,1.015,0.95]]},
'collector-dtp':{n:'DTP Collector',c:'Mining - Flotation',d:[[20,1.085,2.85],[30,1.078,2.15],[40,1.071,1.68]]},
'collector-pax':{n:'PAX (Potassium Amyl Xanthate)',c:'Mining - Flotation',d:[[20,1.045,1.55],[30,1.040,1.25],[40,1.035,1.02]]},
'frother-pine':{n:'Pine Oil Frother',c:'Mining - Flotation',d:[[20,0.925,45],[30,0.918,28],[40,0.911,18]]},
'frother-dowfroth':{n:'Dowfroth 250',c:'Mining - Flotation',d:[[20,0.948,8.5],[30,0.942,5.8],[40,0.936,4.2]]},
'depressant-cmc':{n:'CMC Depressant (2%)',c:'Mining - Flotation',d:[[20,1.008,125],[30,1.005,78],[40,1.002,52]]},
'depressant-starch':{n:'Starch Depressant (1%)',c:'Mining - Flotation',d:[[20,1.005,85],[30,1.003,55],[40,1.001,38]]},
'activator-cuso4':{n:'Copper Sulfate Activator (5%)',c:'Mining - Flotation',d:[[20,1.055,1.28],[30,1.050,1.05],[40,1.045,0.88]]},
'ph-modifier-cao':{n:'Lime Milk (CaO) pH Modifier',c:'Mining - Flotation',d:[[20,1.185,125],[30,1.178,82],[40,1.171,55]]},

// Mining - Slurries & Tailings
'copper-conc-slurry':{n:'Copper Concentrate Slurry (65%)',c:'Mining - Slurries',d:[[20,1.850,450],[30,1.835,285],[40,1.820,185]]},
'zinc-conc-slurry':{n:'Zinc Concentrate Slurry (60%)',c:'Mining - Slurries',d:[[20,1.720,380],[30,1.708,245],[40,1.696,162]]},
'lead-conc-slurry':{n:'Lead Concentrate Slurry (70%)',c:'Mining - Slurries',d:[[20,2.150,520],[30,2.130,335],[40,2.110,218]]},
'iron-ore-slurry':{n:'Iron Ore Slurry (55%)',c:'Mining - Slurries',d:[[20,1.680,285],[30,1.668,185],[40,1.656,125]]},
'magnetite-slurry':{n:'Magnetite Slurry (60%)',c:'Mining - Slurries',d:[[20,1.920,420],[30,1.905,275],[40,1.890,182]]},
'bauxite-slurry':{n:'Bauxite Slurry (45%)',c:'Mining - Slurries',d:[[40,1.485,185],[60,1.470,115],[80,1.455,75]]},
'red-mud-slurry':{n:'Red Mud Slurry (35%)',c:'Mining - Slurries',d:[[40,1.285,145],[60,1.272,92],[80,1.259,62]]},
'phosphate-slurry':{n:'Phosphate Rock Slurry (55%)',c:'Mining - Slurries',d:[[20,1.620,265],[30,1.608,172],[40,1.596,115]]},
'gold-tailings':{n:'Gold Tailings Slurry (45%)',c:'Mining - Slurries',d:[[20,1.425,165],[30,1.415,108],[40,1.405,72]]},
'thickener-uf':{n:'Thickener Underflow (55%)',c:'Mining - Slurries',d:[[20,1.580,385],[30,1.568,252],[40,1.556,168]]},
'cyclone-uf':{n:'Cyclone Underflow (65%)',c:'Mining - Slurries',d:[[20,1.720,485],[30,1.705,318],[40,1.690,212]]},
'cyclone-of':{n:'Cyclone Overflow (25%)',c:'Mining - Slurries',d:[[20,1.185,28],[30,1.178,19],[40,1.171,13]]},

// Mining - Acid Mine Drainage & Treatment
'amd-drainage':{n:'Acid Mine Drainage',c:'Mining - AMD',d:[[10,1.025,1.45],[20,1.022,1.12],[30,1.019,0.88]]},
'amd-treated':{n:'Treated AMD Effluent',c:'Mining - AMD',d:[[15,1.008,1.18],[25,1.005,0.95],[35,1.002,0.78]]},
'fecl3-amd':{n:'Ferric Chloride (AMD Treatment)',c:'Mining - AMD',d:[[20,1.425,2.85],[30,1.415,2.12],[40,1.405,1.65]]},
'limestone-slurry':{n:'Limestone Slurry (AMD Treatment)',c:'Mining - AMD',d:[[20,1.285,125],[30,1.275,82],[40,1.265,55]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: CHEMICAL INDUSTRY - Comprehensive
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Acids - Hydrofluoric (CRITICAL - FLUORIDE_ACID REGIME)
'hf-48':{n:'Hydrofluoric Acid 48%',c:'Acids - Hydrofluoric',d:[[20,1.155,1.85],[30,1.148,1.52],[40,1.141,1.28]]},
'hf-70':{n:'Hydrofluoric Acid 70%',c:'Acids - Hydrofluoric',d:[[20,1.265,2.45],[30,1.255,1.98],[40,1.245,1.62]]},
'hf-anhydrous':{n:'Anhydrous Hydrofluoric Acid',c:'Acids - Hydrofluoric',d:[[0,1.002,0.52],[20,0.988,0.40],[40,0.974,0.32]]},
'ammonium-bifluoride':{n:'Ammonium Bifluoride 30%',c:'Acids - Hydrofluoric',d:[[20,1.085,1.55],[30,1.078,1.28],[40,1.071,1.08]]},
'fluosilicic-25':{n:'Fluosilicic Acid 25%',c:'Acids - Hydrofluoric',d:[[20,1.225,2.15],[30,1.215,1.72],[40,1.205,1.42]]},

// Acids - Chromic & Specialty
'chromic-acid-10':{n:'Chromic Acid 10%',c:'Acids - Chromic',d:[[20,1.075,1.28],[40,1.068,0.92],[60,1.061,0.72]]},
'chromic-acid-40':{n:'Chromic Acid 40%',c:'Acids - Chromic',d:[[20,1.385,2.85],[40,1.372,1.95],[60,1.359,1.42]]},
'perchloric-70':{n:'Perchloric Acid 70%',c:'Acids - Specialty',d:[[20,1.664,1.85],[30,1.655,1.52],[40,1.646,1.28]]},
'chlorosulfonic':{n:'Chlorosulfonic Acid',c:'Acids - Specialty',d:[[20,1.752,3.15],[30,1.742,2.45],[40,1.732,1.95]]},
'sulfamic-acid':{n:'Sulfamic Acid 20%',c:'Acids - Specialty',d:[[20,1.125,1.65],[40,1.115,1.18],[60,1.105,0.88]]},
'oxalic-acid-10':{n:'Oxalic Acid 10%',c:'Acids - Organic',d:[[20,1.045,1.35],[40,1.038,0.98],[60,1.031,0.75]]},
'tartaric-acid':{n:'Tartaric Acid 30%',c:'Acids - Organic',d:[[20,1.142,4.25],[40,1.132,2.65],[60,1.122,1.78]]},
'maleic-acid':{n:'Maleic Acid 40%',c:'Acids - Organic',d:[[40,1.225,8.5],[60,1.212,4.8],[80,1.199,2.9]]},
'gluconic-acid':{n:'Gluconic Acid 50%',c:'Acids - Organic',d:[[20,1.235,125],[40,1.222,52],[60,1.209,25]]},

// Bases - Specialty
'sodium-silicate':{n:'Sodium Silicate 40%',c:'Bases - Specialty',d:[[20,1.385,185],[40,1.372,85],[60,1.359,42]]},
'sodium-aluminate':{n:'Sodium Aluminate 45%',c:'Bases - Specialty',d:[[40,1.485,125],[60,1.470,62],[80,1.455,35]]},
'barium-hydroxide':{n:'Barium Hydroxide 10%',c:'Bases - Specialty',d:[[40,1.095,1.85],[60,1.088,1.35],[80,1.081,1.02]]},
'lithium-hydroxide':{n:'Lithium Hydroxide 10%',c:'Bases - Specialty',d:[[20,1.105,1.52],[40,1.098,1.12],[60,1.091,0.85]]},
'tetramethylammonium':{n:'TMAH 25%',c:'Bases - Specialty',d:[[20,0.985,2.85],[30,0.980,2.25],[40,0.975,1.82]]},

// Chlor-Alkali Products
'chlorine-water':{n:'Chlorine Water (Saturated)',c:'Chlor-Alkali',d:[[0,1.008,1.92],[10,1.005,1.52],[20,1.002,1.22]]},
'sodium-hypochlorite-10':{n:'Sodium Hypochlorite 10%',c:'Chlor-Alkali',d:[[15,1.155,1.75],[25,1.148,1.42],[35,1.141,1.18]]},
'sodium-hypochlorite-15':{n:'Sodium Hypochlorite 15%',c:'Chlor-Alkali',d:[[15,1.225,2.15],[25,1.215,1.72],[35,1.205,1.42]]},
'sodium-chlorate-40':{n:'Sodium Chlorate 40%',c:'Chlor-Alkali',d:[[40,1.285,1.55],[60,1.272,1.15],[80,1.259,0.88]]},
'sodium-chlorite':{n:'Sodium Chlorite 25%',c:'Chlor-Alkali',d:[[20,1.185,1.82],[30,1.178,1.48],[40,1.171,1.22]]},
'chlorine-dioxide':{n:'Chlorine Dioxide Solution',c:'Chlor-Alkali',d:[[5,1.015,1.45],[15,1.012,1.18],[25,1.009,0.98]]},
'hcl-synthesis':{n:'HCl (Synthesis Grade)',c:'Chlor-Alkali',d:[[20,1.185,1.82],[30,1.178,1.48],[40,1.171,1.22]]},
'cell-liquor':{n:'Chlor-Alkali Cell Liquor',c:'Chlor-Alkali',d:[[70,1.285,1.85],[80,1.275,1.52],[90,1.265,1.28]]},

// Inorganic Salts & Solutions
'ferric-chloride-40':{n:'Ferric Chloride 40%',c:'Chemicals - Inorganic',d:[[20,1.425,2.85],[40,1.408,1.85],[60,1.391,1.28]]},
'ferrous-sulfate-25':{n:'Ferrous Sulfate 25%',c:'Chemicals - Inorganic',d:[[20,1.225,2.15],[40,1.212,1.52],[60,1.199,1.12]]},
'ferrous-chloride':{n:'Ferrous Chloride 30%',c:'Chemicals - Inorganic',d:[[20,1.285,2.45],[40,1.272,1.72],[60,1.259,1.25]]},
'aluminum-sulfate-50':{n:'Aluminum Sulfate 50%',c:'Chemicals - Inorganic',d:[[20,1.335,8.5],[40,1.320,4.5],[60,1.305,2.8]]},
'aluminum-chloride':{n:'Aluminum Chloride 30%',c:'Chemicals - Inorganic',d:[[20,1.245,2.85],[40,1.232,1.95],[60,1.219,1.42]]},
'zinc-sulfate-30':{n:'Zinc Sulfate 30%',c:'Chemicals - Inorganic',d:[[20,1.325,3.85],[40,1.312,2.52],[60,1.299,1.75]]},
'zinc-chloride-50':{n:'Zinc Chloride 50%',c:'Chemicals - Inorganic',d:[[20,1.585,8.5],[40,1.568,4.8],[60,1.551,2.9]]},
'copper-sulfate-20':{n:'Copper Sulfate 20%',c:'Chemicals - Inorganic',d:[[20,1.215,2.45],[40,1.205,1.72],[60,1.195,1.28]]},
'nickel-sulfate':{n:'Nickel Sulfate 25%',c:'Chemicals - Inorganic',d:[[40,1.285,3.25],[60,1.272,2.15],[80,1.259,1.52]]},
'manganese-sulfate':{n:'Manganese Sulfate 30%',c:'Chemicals - Inorganic',d:[[20,1.325,3.52],[40,1.312,2.35],[60,1.299,1.65]]},
'ammonium-sulfate-40':{n:'Ammonium Sulfate 40%',c:'Chemicals - Inorganic',d:[[20,1.185,2.15],[40,1.175,1.55],[60,1.165,1.15]]},
'ammonium-chloride':{n:'Ammonium Chloride 25%',c:'Chemicals - Inorganic',d:[[20,1.075,1.42],[40,1.068,1.05],[60,1.061,0.82]]},
'sodium-sulfate-sat':{n:'Sodium Sulfate (Saturated)',c:'Chemicals - Inorganic',d:[[30,1.285,1.72],[40,1.278,1.42],[50,1.271,1.18]]},
'sodium-sulfide-15':{n:'Sodium Sulfide 15%',c:'Chemicals - Inorganic',d:[[40,1.125,1.85],[60,1.115,1.35],[80,1.105,1.02]]},
'sodium-thiosulfate':{n:'Sodium Thiosulfate 40%',c:'Chemicals - Inorganic',d:[[20,1.325,3.85],[40,1.312,2.52],[60,1.299,1.75]]},
'sodium-bisulfite-40':{n:'Sodium Bisulfite 40%',c:'Chemicals - Inorganic',d:[[20,1.325,3.15],[40,1.312,2.15],[60,1.299,1.55]]},
'sodium-metabisulfite':{n:'Sodium Metabisulfite 30%',c:'Chemicals - Inorganic',d:[[20,1.245,2.65],[40,1.235,1.85],[60,1.225,1.35]]},
'potassium-permanganate':{n:'Potassium Permanganate 5%',c:'Chemicals - Inorganic',d:[[20,1.032,1.15],[30,1.028,0.98],[40,1.024,0.84]]},
'hydrogen-peroxide-35':{n:'Hydrogen Peroxide 35%',c:'Chemicals - Oxidizers',d:[[20,1.132,1.12],[30,1.125,0.95],[40,1.118,0.82]]},
'hydrogen-peroxide-50':{n:'Hydrogen Peroxide 50%',c:'Chemicals - Oxidizers',d:[[20,1.195,1.25],[30,1.185,1.05],[40,1.175,0.88]]},
'hydrogen-peroxide-70':{n:'Hydrogen Peroxide 70%',c:'Chemicals - Oxidizers',d:[[20,1.288,1.42],[30,1.278,1.18],[40,1.268,0.98]]},
'peracetic-acid-15':{n:'Peracetic Acid 15%',c:'Chemicals - Oxidizers',d:[[20,1.085,1.55],[30,1.078,1.28],[40,1.071,1.08]]},
'sodium-persulfate':{n:'Sodium Persulfate 25%',c:'Chemicals - Oxidizers',d:[[20,1.185,1.82],[40,1.175,1.35],[60,1.165,1.02]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: EXPLOSIVES & ENERGETICS INDUSTRY
// Per Â§12.4: Compatibility â‰  safety, near-zero leakage tolerance
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ammonium Nitrate & Derivatives
'an-solution-80':{n:'Ammonium Nitrate Solution 80%',c:'Explosives - AN',d:[[80,1.385,2.85],[100,1.368,1.95],[120,1.351,1.42]]},
'an-solution-93':{n:'Ammonium Nitrate Solution 93%',c:'Explosives - AN',d:[[110,1.425,3.25],[120,1.412,2.45],[130,1.399,1.92]]},
'anfo-emulsion':{n:'ANFO Emulsion Base',c:'Explosives - AN',d:[[40,1.285,185],[60,1.272,92],[80,1.259,52]]},
'emulsion-matrix':{n:'Emulsion Explosive Matrix',c:'Explosives - AN',d:[[40,1.325,285],[60,1.310,145],[80,1.295,82]]},
'an-melt':{n:'AN Melt (Molten)',c:'Explosives - AN',d:[[170,1.452,2.15],[180,1.445,1.82],[190,1.438,1.55]]},
'urea-an':{n:'UAN Solution (32% N)',c:'Explosives - AN',d:[[10,1.285,4.25],[20,1.280,3.15],[30,1.275,2.45]]},
'calcium-an':{n:'Calcium Ammonium Nitrate Solution',c:'Explosives - AN',d:[[40,1.425,8.5],[60,1.408,4.8],[80,1.391,2.9]]},

// Nitric Acid - Explosives Grade
'hno3-95':{n:'Nitric Acid 95% (Explosives)',c:'Explosives - Nitration',d:[[20,1.498,1.95],[30,1.488,1.62],[40,1.478,1.35]]},
'hno3-98':{n:'Nitric Acid 98% (Fuming)',c:'Explosives - Nitration',d:[[20,1.512,2.15],[30,1.502,1.78],[40,1.492,1.48]]},
'hno3-100':{n:'Nitric Acid 100% (Anhydrous)',c:'Explosives - Nitration',d:[[20,1.522,2.25],[30,1.512,1.85],[40,1.502,1.52]]},
'rfna':{n:'Red Fuming Nitric Acid',c:'Explosives - Nitration',d:[[20,1.548,1.85],[30,1.538,1.55],[40,1.528,1.32]]},
'wfna':{n:'White Fuming Nitric Acid',c:'Explosives - Nitration',d:[[20,1.512,1.72],[30,1.502,1.45],[40,1.492,1.22]]},
'mixed-acid':{n:'Mixed Acid (HNOâ‚ƒ/Hâ‚‚SOâ‚„)',c:'Explosives - Nitration',d:[[30,1.685,3.85],[40,1.672,2.85],[50,1.659,2.15]]},
'spent-acid':{n:'Spent Nitration Acid',c:'Explosives - Nitration',d:[[40,1.625,3.25],[60,1.608,2.25],[80,1.591,1.65]]},

// Nitro Compounds (EXTREME CAUTION)
'nitroglycerine-10':{n:'Nitroglycerin Solution 10%',c:'Explosives - Nitro',d:[[15,1.128,12.5],[20,1.125,9.8],[25,1.122,7.8]]},
'deta-100':{n:'Diethylenetriamine',c:'Explosives - Amines',d:[[20,0.955,7.25],[40,0.942,4.15],[60,0.929,2.65]]},
'teta':{n:'Triethylenetetramine',c:'Explosives - Amines',d:[[20,0.982,28.5],[40,0.968,14.2],[60,0.954,8.2]]},
'cyclonite-slurry':{n:'RDX Slurry (Water)',c:'Explosives - Nitro',d:[[20,1.425,85],[30,1.415,55],[40,1.405,38]]},

// Initiator Systems
'lead-azide-slurry':{n:'Lead Azide Slurry',c:'Explosives - Initiators',d:[[20,1.85,125],[25,1.84,95],[30,1.83,75]]},
'silver-azide':{n:'Silver Azide Solution',c:'Explosives - Initiators',d:[[20,1.52,28],[25,1.51,22],[30,1.50,18]]},
'mercury-fulminate':{n:'Mercury Fulminate Slurry',c:'Explosives - Initiators',d:[[15,2.15,185],[20,2.14,145],[25,2.13,115]]},
'tetrazene-slurry':{n:'Tetrazene Slurry',c:'Explosives - Initiators',d:[[20,1.62,95],[25,1.61,75],[30,1.60,58]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: FERTILIZER INDUSTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Nitrogen Fertilizers
'uan-28':{n:'UAN Solution 28%',c:'Fertilizers - Nitrogen',d:[[0,1.265,5.85],[10,1.260,4.25],[20,1.255,3.25]]},
'uan-30':{n:'UAN Solution 30%',c:'Fertilizers - Nitrogen',d:[[0,1.285,6.85],[10,1.280,4.95],[20,1.275,3.75]]},
'uan-32':{n:'UAN Solution 32%',c:'Fertilizers - Nitrogen',d:[[10,1.295,5.45],[20,1.290,4.05],[30,1.285,3.15]]},
'urea-solution-40':{n:'Urea Solution 40%',c:'Fertilizers - Nitrogen',d:[[20,1.112,1.75],[40,1.105,1.28],[60,1.098,0.98]]},
'urea-solution-70':{n:'Urea Melt 70%',c:'Fertilizers - Nitrogen',d:[[80,1.285,8.5],[100,1.272,4.8],[120,1.259,2.9]]},
'aqua-ammonia-20':{n:'Aqua Ammonia 20%',c:'Fertilizers - Nitrogen',d:[[0,0.925,2.85],[10,0.918,2.15],[20,0.911,1.68]]},
'anhydrous-ammonia':{n:'Anhydrous Ammonia (Liquid)',c:'Fertilizers - Nitrogen',d:[[-33,0.682,0.28],[-20,0.665,0.22],[0,0.640,0.18]]},
'ammonium-nitrate-sol':{n:'Ammonium Nitrate 80% (Hot 80-120Â°C)',c:'Fertilizers - Nitrogen',d:[[80,1.385,2.85],[100,1.368,1.95],[120,1.351,1.42]]},
'ammonium-nitrate-95':{n:'Ammonium Nitrate 95% (Melt 120-140Â°C)',c:'Fertilizers - Nitrogen',d:[[120,1.425,3.85],[130,1.412,2.82],[140,1.399,2.15]]},
'calcium-nitrate-50':{n:'Calcium Nitrate 50%',c:'Fertilizers - Nitrogen',d:[[20,1.385,4.25],[40,1.372,2.85],[60,1.359,2.02]]},
'calcium-nitrate-sat':{n:'Calcium Nitrate (Saturated)',c:'Fertilizers - Nitrogen',d:[[40,1.425,5.85],[60,1.408,3.65],[80,1.391,2.45]]},

// Phosphate Fertilizers
'phosphoric-wpa':{n:'Wet Process Phosphoric Acid 54%',c:'Fertilizers - Phosphate',d:[[40,1.685,28.5],[60,1.668,15.2],[80,1.651,8.8]]},
'superphosphoric':{n:'Superphosphoric Acid 72%',c:'Fertilizers - Phosphate',d:[[60,1.852,85],[80,1.832,42],[100,1.812,24]]},
'map-slurry':{n:'MAP Slurry (Monoammonium Phosphate)',c:'Fertilizers - Phosphate',d:[[80,1.425,125],[100,1.408,65],[120,1.391,38]]},
'dap-slurry':{n:'DAP Slurry (Diammonium Phosphate)',c:'Fertilizers - Phosphate',d:[[80,1.385,115],[100,1.368,58],[120,1.351,32]]},
'tsp-slurry':{n:'TSP Slurry (Triple Super Phosphate)',c:'Fertilizers - Phosphate',d:[[60,1.625,185],[80,1.608,95],[100,1.591,52]]},
'phosphate-rock-slurry':{n:'Phosphate Rock Slurry 60%',c:'Fertilizers - Phosphate',d:[[25,1.720,285],[40,1.705,175],[60,1.690,105]]},
'gypsum-slurry':{n:'Phosphogypsum Slurry 40%',c:'Fertilizers - Phosphate',d:[[30,1.385,125],[50,1.372,72],[70,1.359,45]]},
'defluorinated-acid':{n:'Defluorinated Phosphoric Acid',c:'Fertilizers - Phosphate',d:[[60,1.625,35],[80,1.608,19],[100,1.591,11]]},

// Potash Fertilizers
'potassium-chloride-sat':{n:'Potassium Chloride (Saturated)',c:'Fertilizers - Potash',d:[[20,1.185,1.42],[40,1.175,1.05],[60,1.165,0.82]]},
'potash-brine':{n:'Potash Brine',c:'Fertilizers - Potash',d:[[20,1.225,1.72],[40,1.215,1.28],[60,1.205,0.98]]},
'sylvinite-slurry':{n:'Sylvinite Slurry 50%',c:'Fertilizers - Potash',d:[[20,1.485,185],[40,1.470,95],[60,1.455,55]]},
'potassium-sulfate-sol':{n:'Potassium Sulfate Solution',c:'Fertilizers - Potash',d:[[20,1.095,1.35],[40,1.088,1.02],[60,1.081,0.78]]},
'polyhalite-slurry':{n:'Polyhalite Slurry',c:'Fertilizers - Potash',d:[[25,1.385,145],[40,1.372,85],[60,1.359,52]]},

// NPK & Complex Fertilizers
'npk-slurry':{n:'NPK Slurry (15-15-15)',c:'Fertilizers - Complex',d:[[80,1.485,185],[100,1.468,95],[120,1.451,55]]},
'npk-melt':{n:'NPK Melt (Hot)',c:'Fertilizers - Complex',d:[[110,1.525,125],[120,1.512,75],[130,1.499,48]]},
'compound-fert-slurry':{n:'Compound Fertilizer Slurry',c:'Fertilizers - Complex',d:[[70,1.425,165],[90,1.408,85],[110,1.391,48]]},
'kieserite-slurry':{n:'Kieserite Slurry',c:'Fertilizers - Complex',d:[[40,1.325,125],[60,1.312,72],[80,1.299,45]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: ANIMAL FEED INDUSTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Feed Acids
'propionic-acid':{n:'Propionic Acid 100%',c:'Animal Feed - Acids',d:[[20,0.992,1.18],[40,0.978,0.82],[60,0.964,0.62]]},
'propionic-50':{n:'Propionic Acid 50%',c:'Animal Feed - Acids',d:[[20,1.012,1.42],[40,1.002,1.02],[60,0.992,0.78]]},
'formic-85':{n:'Formic Acid 85%',c:'Animal Feed - Acids',d:[[20,1.195,1.72],[40,1.182,1.22],[60,1.169,0.92]]},
'formic-propionic':{n:'Formic/Propionic Blend',c:'Animal Feed - Acids',d:[[20,1.065,1.35],[40,1.055,0.98],[60,1.045,0.75]]},
'feed-acid-blend':{n:'Feed Acid Blend (Multi)',c:'Animal Feed - Acids',d:[[20,1.085,1.55],[40,1.075,1.12],[60,1.065,0.85]]},
'butyric-acid':{n:'Butyric Acid',c:'Animal Feed - Acids',d:[[20,0.958,1.62],[40,0.945,1.15],[60,0.932,0.85]]},
'sorbic-acid-sol':{n:'Sorbic Acid Solution',c:'Animal Feed - Acids',d:[[20,1.015,1.28],[40,1.008,0.95],[60,1.001,0.72]]},

// Feed Additives & Supplements
'molasses':{n:'Molasses',c:'Animal Feed - Additives',d:[[30,1.425,2850],[40,1.415,1450],[50,1.405,785]]},
'molasses-dilute':{n:'Molasses (Diluted 50%)',c:'Animal Feed - Additives',d:[[25,1.215,285],[40,1.205,145],[55,1.195,78]]},
'corn-steep-liquor':{n:'Corn Steep Liquor',c:'Animal Feed - Additives',d:[[25,1.185,125],[40,1.175,65],[55,1.165,38]]},
'fish-oil':{n:'Fish Oil',c:'Animal Feed - Oils',d:[[20,0.925,65],[40,0.912,32],[60,0.899,18]]},
'fish-solubles':{n:'Fish Solubles',c:'Animal Feed - Additives',d:[[20,1.115,185],[35,1.105,95],[50,1.095,52]]},
'blood-meal-slurry':{n:'Blood Meal Slurry',c:'Animal Feed - Protein',d:[[25,1.085,85],[40,1.075,45],[55,1.065,28]]},
'meat-bone-slurry':{n:'Meat & Bone Meal Slurry',c:'Animal Feed - Protein',d:[[30,1.125,125],[45,1.115,65],[60,1.105,38]]},
'whey-permeate':{n:'Whey Permeate',c:'Animal Feed - Dairy',d:[[10,1.035,2.15],[20,1.030,1.65],[30,1.025,1.28]]},
'whey-concentrate':{n:'Whey Protein Concentrate',c:'Animal Feed - Dairy',d:[[20,1.085,8.5],[35,1.075,4.8],[50,1.065,2.9]]},
'lysine-50':{n:'L-Lysine Solution 50%',c:'Animal Feed - Amino Acids',d:[[20,1.185,12.5],[35,1.175,6.8],[50,1.165,4.2]]},
'methionine-40':{n:'DL-Methionine Solution 40%',c:'Animal Feed - Amino Acids',d:[[20,1.125,8.5],[35,1.115,4.8],[50,1.105,3.0]]},
'threonine-sol':{n:'L-Threonine Solution',c:'Animal Feed - Amino Acids',d:[[20,1.095,5.5],[35,1.085,3.2],[50,1.075,2.1]]},
'tryptophan-sol':{n:'L-Tryptophan Solution',c:'Animal Feed - Amino Acids',d:[[25,1.065,3.85],[40,1.055,2.45],[55,1.045,1.65]]},
'choline-chloride-70':{n:'Choline Chloride 70%',c:'Animal Feed - Vitamins',d:[[20,1.115,18.5],[35,1.105,9.8],[50,1.095,5.8]]},
'vitamin-premix':{n:'Vitamin Premix (Liquid)',c:'Animal Feed - Vitamins',d:[[20,1.045,25],[35,1.038,14],[50,1.031,8.5]]},
'mineral-premix':{n:'Mineral Premix (Liquid)',c:'Animal Feed - Minerals',d:[[20,1.285,85],[35,1.272,48],[50,1.259,29]]},
'trace-mineral-sol':{n:'Trace Mineral Solution',c:'Animal Feed - Minerals',d:[[20,1.145,3.85],[35,1.135,2.52],[50,1.125,1.75]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: PULP & PAPER INDUSTRY - Extended
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pulping Chemicals
'kraft-cooking-liquor':{n:'Kraft Cooking Liquor',c:'Pulp & Paper - Cooking',d:[[100,1.095,2.85],[120,1.085,2.05],[140,1.075,1.52]]},
'sulfite-cooking-liquor':{n:'Sulfite Cooking Liquor',c:'Pulp & Paper - Cooking',d:[[80,1.045,3.15],[100,1.038,2.25],[120,1.031,1.68]]},
'anthraquinone-sol':{n:'Anthraquinone Solution',c:'Pulp & Paper - Cooking',d:[[60,1.085,4.85],[80,1.075,2.95],[100,1.065,1.95]]},
'sodium-sulfite-30':{n:'Sodium Sulfite 30%',c:'Pulp & Paper - Cooking',d:[[40,1.285,2.45],[60,1.272,1.72],[80,1.259,1.28]]},
'sodium-hydrosulfite':{n:'Sodium Hydrosulfite Solution',c:'Pulp & Paper - Cooking',d:[[25,1.125,2.15],[40,1.115,1.55],[55,1.105,1.15]]},

// Bleaching Chemicals
'chlorine-dioxide-bleach':{n:'Chlorine Dioxide (Bleaching)',c:'Pulp & Paper - Bleaching',d:[[10,1.018,1.25],[20,1.015,1.02],[30,1.012,0.85]]},
'sodium-hypochlorite-bleach':{n:'Sodium Hypochlorite (Bleach)',c:'Pulp & Paper - Bleaching',d:[[20,1.185,1.95],[30,1.175,1.55],[40,1.165,1.25]]},
'hydrogen-peroxide-bleach':{n:'Hydrogen Peroxide (Bleaching)',c:'Pulp & Paper - Bleaching',d:[[30,1.125,1.02],[40,1.118,0.85],[50,1.111,0.72]]},
'ozone-water':{n:'Ozone in Water',c:'Pulp & Paper - Bleaching',d:[[5,1.002,1.82],[10,1.001,1.55],[15,1.000,1.35]]},
'peracetic-bleach':{n:'Peracetic Acid (Bleaching)',c:'Pulp & Paper - Bleaching',d:[[25,1.075,1.45],[35,1.068,1.18],[45,1.061,0.98]]},
'oxygen-delignification':{n:'Oxygen Delignification Liquor',c:'Pulp & Paper - Bleaching',d:[[90,1.045,1.55],[100,1.038,1.28],[110,1.031,1.08]]},

// Recovery & Chemical Recovery
'weak-black-liquor':{n:'Weak Black Liquor (10% DS)',c:'Pulp & Paper - Recovery',d:[[70,1.038,3.85],[80,1.032,2.65],[90,1.026,1.92]]},
'strong-black-liquor':{n:'Strong Black Liquor (65% DS)',c:'Pulp & Paper - Recovery',d:[[100,1.285,125],[110,1.272,72],[120,1.259,45]]},
'smelt':{n:'Smelt (Molten)',c:'Pulp & Paper - Recovery',d:[[800,1.985,8.5],[850,1.965,6.2],[900,1.945,4.8]]},
'dissolving-tank-liquor':{n:'Dissolving Tank Green Liquor',c:'Pulp & Paper - Recovery',d:[[80,1.165,3.85],[90,1.155,2.85],[100,1.145,2.15]]},
'causticizer-overflow':{n:'Causticizer Overflow',c:'Pulp & Paper - Recovery',d:[[80,1.145,2.85],[90,1.138,2.15],[100,1.131,1.68]]},
'lime-mud-slurry':{n:'Lime Mud Slurry 35%',c:'Pulp & Paper - Recovery',d:[[50,1.285,185],[70,1.272,95],[90,1.259,55]]},
'dregs-slurry':{n:'Dregs Slurry',c:'Pulp & Paper - Recovery',d:[[60,1.185,125],[80,1.172,72],[100,1.159,45]]},

// Paper Machine Chemicals
'starch-slurry':{n:'Starch Slurry (Coating)',c:'Pulp & Paper - Coating',d:[[45,1.085,185],[55,1.075,95],[65,1.065,52]]},
'starch-cooked':{n:'Cooked Starch',c:'Pulp & Paper - Coating',d:[[60,1.045,125],[70,1.038,72],[80,1.031,45]]},
'latex-coating':{n:'Latex Coating',c:'Pulp & Paper - Coating',d:[[25,1.015,185],[35,1.010,95],[45,1.005,55]]},
'clay-coating':{n:'Clay Coating Slurry',c:'Pulp & Paper - Coating',d:[[30,1.485,385],[40,1.470,215],[50,1.455,125]]},
'calcium-carbonate-coat':{n:'Calcium Carbonate Coating',c:'Pulp & Paper - Coating',d:[[30,1.525,425],[40,1.510,235],[50,1.495,138]]},
'titanium-dioxide-slurry':{n:'TiOâ‚‚ Slurry',c:'Pulp & Paper - Coating',d:[[25,1.685,285],[35,1.668,165],[45,1.651,102]]},
'sizing-agent':{n:'Sizing Agent (ASA)',c:'Pulp & Paper - Sizing',d:[[40,0.985,8.5],[50,0.978,5.2],[60,0.971,3.4]]},
'sizing-akd':{n:'AKD Sizing Emulsion',c:'Pulp & Paper - Sizing',d:[[25,0.995,28],[35,0.988,16],[45,0.981,10]]},
'rosin-size':{n:'Rosin Size Emulsion',c:'Pulp & Paper - Sizing',d:[[30,1.015,45],[40,1.008,26],[50,1.001,16]]},
'retention-aid':{n:'Retention Aid Polymer',c:'Pulp & Paper - Additives',d:[[25,1.005,185],[35,1.002,95],[45,0.999,55]]},
'wet-strength-resin':{n:'Wet Strength Resin',c:'Pulp & Paper - Additives',d:[[30,1.025,125],[40,1.018,72],[50,1.011,45]]},
'dry-strength-resin':{n:'Dry Strength Resin',c:'Pulp & Paper - Additives',d:[[30,1.015,95],[40,1.008,55],[50,1.001,35]]},
'defoamer':{n:'Defoamer',c:'Pulp & Paper - Additives',d:[[25,0.925,125],[40,0.915,65],[55,0.905,38]]},
'biocide-paper':{n:'Biocide (Paper Machine)',c:'Pulp & Paper - Additives',d:[[20,1.045,1.85],[35,1.038,1.35],[50,1.031,1.02]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: WASTEWATER TREATMENT - Complete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Coagulants & Flocculants
'alum-liquid':{n:'Liquid Alum (Aluminum Sulfate)',c:'Wastewater - Coagulants',d:[[15,1.325,12.5],[25,1.315,8.2],[35,1.305,5.6]]},
'pac-10':{n:'Polyaluminum Chloride 10%',c:'Wastewater - Coagulants',d:[[15,1.125,2.45],[25,1.118,1.82],[35,1.111,1.42]]},
'pac-18':{n:'Polyaluminum Chloride 18%',c:'Wastewater - Coagulants',d:[[15,1.225,4.25],[25,1.215,3.05],[35,1.205,2.28]]},
'ferric-sulfate':{n:'Ferric Sulfate Solution',c:'Wastewater - Coagulants',d:[[15,1.525,8.5],[25,1.512,5.8],[35,1.499,4.2]]},
'ferric-chloride-ww':{n:'Ferric Chloride (Wastewater)',c:'Wastewater - Coagulants',d:[[15,1.425,3.25],[25,1.412,2.35],[35,1.399,1.78]]},
'ferrous-chloride-ww':{n:'Ferrous Chloride (Wastewater)',c:'Wastewater - Coagulants',d:[[15,1.285,2.85],[25,1.275,2.12],[35,1.265,1.62]]},
'poly-dadmac':{n:'PolyDADMAC',c:'Wastewater - Polymers',d:[[20,1.045,185],[30,1.038,115],[40,1.031,75]]},
'cationic-polymer':{n:'Cationic Polymer (High MW)',c:'Wastewater - Polymers',d:[[20,1.015,285],[30,1.010,175],[40,1.005,112]]},
'anionic-polymer':{n:'Anionic Polymer (High MW)',c:'Wastewater - Polymers',d:[[20,1.012,315],[30,1.008,195],[40,1.004,125]]},
'nonionic-polymer':{n:'Nonionic Polymer',c:'Wastewater - Polymers',d:[[20,1.008,265],[30,1.004,165],[40,1.000,108]]},
'emulsion-polymer':{n:'Emulsion Polymer (Dewatering)',c:'Wastewater - Polymers',d:[[15,1.025,425],[25,1.018,265],[35,1.011,172]]},
'polymer-makeup':{n:'Polymer Solution (Diluted)',c:'Wastewater - Polymers',d:[[20,1.002,85],[30,0.999,55],[40,0.996,38]]},

// Disinfection
'sodium-hypochlorite-ww':{n:'Sodium Hypochlorite (Disinfection)',c:'Wastewater - Disinfection',d:[[10,1.195,2.15],[20,1.185,1.72],[30,1.175,1.42]]},
'calcium-hypochlorite':{n:'Calcium Hypochlorite Solution',c:'Wastewater - Disinfection',d:[[20,1.085,1.55],[30,1.078,1.25],[40,1.071,1.02]]},
'chloramine':{n:'Chloramine Solution',c:'Wastewater - Disinfection',d:[[15,1.012,1.35],[25,1.008,1.12],[35,1.004,0.95]]},
'uv-system-water':{n:'UV System Feed Water',c:'Wastewater - Disinfection',d:[[15,1.002,1.18],[25,0.999,0.95],[35,0.996,0.78]]},
'ozone-contact':{n:'Ozone Contact Water',c:'Wastewater - Disinfection',d:[[10,1.001,1.42],[20,0.999,1.12],[30,0.997,0.92]]},
'peracetic-ww':{n:'Peracetic Acid (Disinfection)',c:'Wastewater - Disinfection',d:[[15,1.075,1.65],[25,1.068,1.35],[35,1.061,1.12]]},
'chlorine-dioxide-ww':{n:'Chlorine Dioxide (Disinfection)',c:'Wastewater - Disinfection',d:[[10,1.015,1.35],[20,1.012,1.12],[30,1.009,0.95]]},

// pH Adjustment
'caustic-ww':{n:'Caustic Soda (pH Adjustment)',c:'Wastewater - pH Control',d:[[15,1.325,8.5],[25,1.315,5.8],[35,1.305,4.2]]},
'lime-slurry-ww':{n:'Lime Slurry (pH Adjustment)',c:'Wastewater - pH Control',d:[[20,1.125,95],[30,1.115,62],[40,1.105,42]]},
'soda-ash':{n:'Soda Ash Solution',c:'Wastewater - pH Control',d:[[20,1.115,1.85],[30,1.108,1.45],[40,1.101,1.18]]},
'sulfuric-ww':{n:'Sulfuric Acid (pH Adjustment)',c:'Wastewater - pH Control',d:[[20,1.285,2.45],[30,1.275,1.82],[40,1.265,1.42]]},
'hydrochloric-ww':{n:'Hydrochloric Acid (pH Adjustment)',c:'Wastewater - pH Control',d:[[20,1.145,1.75],[30,1.138,1.42],[40,1.131,1.18]]},
'co2-sat-water':{n:'COâ‚‚ Saturated Water',c:'Wastewater - pH Control',d:[[10,1.005,1.35],[20,1.002,1.08],[30,0.999,0.88]]},

// Nutrient Removal
'alum-nutrient':{n:'Alum (Phosphorus Removal)',c:'Wastewater - Nutrient',d:[[15,1.325,12.5],[25,1.315,8.2],[35,1.305,5.6]]},
'ferric-nutrient':{n:'Ferric Chloride (P Removal)',c:'Wastewater - Nutrient',d:[[15,1.425,3.25],[25,1.412,2.35],[35,1.399,1.78]]},
'methanol-denitrification':{n:'Methanol (Denitrification)',c:'Wastewater - Nutrient',d:[[10,0.798,0.72],[20,0.791,0.58],[30,0.784,0.48]]},
'glycerol-denitrification':{n:'Glycerol (Denitrification)',c:'Wastewater - Nutrient',d:[[20,1.261,1412],[30,1.255,612],[40,1.249,282]]},
'acetic-denitrification':{n:'Acetic Acid (Denitrification)',c:'Wastewater - Nutrient',d:[[20,1.049,1.22],[30,1.042,0.98],[40,1.035,0.80]]},
'molasses-carbon':{n:'Molasses (Carbon Source)',c:'Wastewater - Nutrient',d:[[25,1.415,2450],[35,1.405,1250],[45,1.395,675]]},

// Sludge Processing
'primary-sludge':{n:'Primary Sludge (4%)',c:'Wastewater - Sludge',d:[[15,1.025,125],[25,1.020,85],[35,1.015,58]]},
'was-sludge':{n:'Waste Activated Sludge (1%)',c:'Wastewater - Sludge',d:[[15,1.008,45],[25,1.005,32],[35,1.002,24]]},
'thickened-sludge':{n:'Thickened Sludge (5%)',c:'Wastewater - Sludge',d:[[15,1.035,185],[25,1.028,125],[35,1.021,85]]},
'digested-sludge':{n:'Digested Sludge (3%)',c:'Wastewater - Sludge',d:[[30,1.018,95],[35,1.015,72],[40,1.012,55]]},
'dewatered-cake-return':{n:'Centrate/Filtrate Return',c:'Wastewater - Sludge',d:[[25,1.005,1.45],[35,1.002,1.15],[45,0.999,0.92]]},
'polymer-conditioned':{n:'Polymer Conditioned Sludge',c:'Wastewater - Sludge',d:[[20,1.025,285],[30,1.018,185],[40,1.011,125]]},

// Odor Control
'sodium-hypochlorite-odor':{n:'Sodium Hypochlorite (Odor)',c:'Wastewater - Odor',d:[[15,1.185,1.85],[25,1.175,1.48],[35,1.165,1.22]]},
'hydrogen-peroxide-odor':{n:'Hydrogen Peroxide (Odor)',c:'Wastewater - Odor',d:[[20,1.115,1.15],[30,1.108,0.95],[40,1.101,0.80]]},
'ferrous-odor':{n:'Ferrous Chloride (Hâ‚‚S Control)',c:'Wastewater - Odor',d:[[20,1.285,2.45],[30,1.275,1.82],[40,1.265,1.42]]},
'ferric-odor':{n:'Ferric Chloride (Hâ‚‚S Control)',c:'Wastewater - Odor',d:[[20,1.425,2.85],[30,1.412,2.12],[40,1.399,1.65]]},
'caustic-odor':{n:'Caustic Soda (Scrubber)',c:'Wastewater - Odor',d:[[20,1.285,5.85],[30,1.275,4.15],[40,1.265,3.05]]},
'bleach-scrubber':{n:'Hypochlorite Scrubber Solution',c:'Wastewater - Odor',d:[[20,1.145,1.72],[30,1.138,1.38],[40,1.131,1.15]]},
'nitrate-odor':{n:'Calcium Nitrate (Odor Control)',c:'Wastewater - Odor',d:[[15,1.385,4.85],[25,1.372,3.45],[35,1.359,2.55]]},

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 EXPANSION: SPECIALTY CHEMICALS & INDUSTRIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Semiconductor & Electronics
'hf-electronic':{n:'HF (Electronic Grade)',c:'Semiconductor',d:[[20,1.155,1.85],[25,1.150,1.62],[30,1.145,1.42]]},
'buffered-oxide-etch':{n:'Buffered Oxide Etch (BOE)',c:'Semiconductor',d:[[20,1.125,2.15],[25,1.120,1.85],[30,1.115,1.62]]},
'piranha-solution':{n:'Piranha Solution',c:'Semiconductor',d:[[80,1.685,2.85],[90,1.672,2.25],[100,1.659,1.85]]},
'sc1-clean':{n:'SC-1 Clean (RCA)',c:'Semiconductor',d:[[70,1.025,0.85],[75,1.022,0.75],[80,1.019,0.68]]},
'sc2-clean':{n:'SC-2 Clean (RCA)',c:'Semiconductor',d:[[70,1.085,0.95],[75,1.080,0.85],[80,1.075,0.75]]},
'ipa-electronic':{n:'IPA (Electronic Grade)',c:'Semiconductor',d:[[20,0.786,2.42],[30,0.778,1.82],[40,0.770,1.42]]},
'acetone-electronic':{n:'Acetone (Electronic Grade)',c:'Semiconductor',d:[[20,0.791,0.32],[30,0.782,0.28],[40,0.773,0.24]]},
'nmp':{n:'N-Methylpyrrolidone (NMP)',c:'Semiconductor',d:[[25,1.028,1.65],[40,1.018,1.15],[60,1.005,0.78]]},
'dmso':{n:'Dimethyl Sulfoxide (DMSO)',c:'Semiconductor',d:[[20,1.100,2.00],[30,1.092,1.55],[40,1.084,1.22]]},
'cmp-slurry':{n:'CMP Slurry',c:'Semiconductor',d:[[20,1.085,8.5],[25,1.080,6.2],[30,1.075,4.6]]},
'photoresist-developer':{n:'Photoresist Developer (TMAH)',c:'Semiconductor',d:[[20,0.985,1.42],[25,0.982,1.22],[30,0.979,1.05]]},
'photoresist-stripper':{n:'Photoresist Stripper',c:'Semiconductor',d:[[50,1.025,1.85],[60,1.018,1.42],[70,1.011,1.12]]},

// Metal Finishing & Plating
'chrome-plating':{n:'Chrome Plating Solution',c:'Metal Finishing',d:[[50,1.285,2.15],[55,1.278,1.85],[60,1.271,1.62]]},
'nickel-plating':{n:'Nickel Plating (Watts)',c:'Metal Finishing',d:[[50,1.185,1.75],[55,1.178,1.52],[60,1.171,1.32]]},
'copper-plating-acid':{n:'Copper Plating (Acid)',c:'Metal Finishing',d:[[25,1.185,2.15],[35,1.175,1.72],[45,1.165,1.42]]},
'copper-plating-alkaline':{n:'Copper Plating (Alkaline)',c:'Metal Finishing',d:[[40,1.125,3.25],[50,1.115,2.45],[60,1.105,1.92]]},
'zinc-plating-acid':{n:'Zinc Plating (Acid)',c:'Metal Finishing',d:[[25,1.145,1.85],[35,1.138,1.48],[45,1.131,1.22]]},
'zinc-plating-alkaline':{n:'Zinc Plating (Alkaline)',c:'Metal Finishing',d:[[25,1.185,3.85],[35,1.175,2.85],[45,1.165,2.18]]},
'tin-plating':{n:'Tin Plating Solution',c:'Metal Finishing',d:[[20,1.285,3.25],[30,1.272,2.42],[40,1.259,1.88]]},
'gold-plating':{n:'Gold Plating (Cyanide)',c:'Metal Finishing',d:[[55,1.085,1.42],[60,1.080,1.25],[65,1.075,1.12]]},
'silver-plating':{n:'Silver Plating (Cyanide)',c:'Metal Finishing',d:[[25,1.095,1.55],[35,1.088,1.28],[45,1.081,1.08]]},
'anodizing-sulfuric':{n:'Anodizing Solution (Sulfuric)',c:'Metal Finishing',d:[[20,1.125,1.42],[25,1.120,1.25],[30,1.115,1.12]]},
'anodizing-chromic':{n:'Anodizing Solution (Chromic)',c:'Metal Finishing',d:[[35,1.085,1.65],[40,1.080,1.42],[45,1.075,1.25]]},
'passivation-nitric':{n:'Passivation Solution (Nitric)',c:'Metal Finishing',d:[[25,1.185,1.55],[35,1.175,1.25],[45,1.165,1.02]]},
'passivation-citric':{n:'Passivation Solution (Citric)',c:'Metal Finishing',d:[[50,1.055,1.35],[60,1.048,1.08],[70,1.041,0.88]]},
'phosphating':{n:'Phosphating Solution',c:'Metal Finishing',d:[[60,1.045,1.25],[70,1.038,1.02],[80,1.031,0.85]]},
'pickling-sulfuric':{n:'Pickling (Sulfuric)',c:'Metal Finishing',d:[[60,1.125,1.42],[70,1.118,1.15],[80,1.111,0.95]]},
'pickling-hydrochloric':{n:'Pickling (Hydrochloric)',c:'Metal Finishing',d:[[40,1.085,1.28],[50,1.078,1.05],[60,1.071,0.88]]},
'bright-dip':{n:'Bright Dip Solution',c:'Metal Finishing',d:[[25,1.685,4.25],[35,1.668,3.05],[45,1.651,2.28]]},
'degreaser-alkaline':{n:'Alkaline Degreaser',c:'Metal Finishing',d:[[60,1.045,1.42],[70,1.038,1.12],[80,1.031,0.92]]}
};
// Vapor Pressure Data (bar abs) for Cavitation (#7)
const VP={
'water':[[0,0.006],[20,0.023],[40,0.074],[60,0.199],[80,0.474],[100,1.014]],
'methanol':[[0,0.040],[20,0.127],[40,0.352],[60,0.843]],
'ethanol':[[0,0.016],[20,0.059],[40,0.178],[60,0.467]],
'acetone':[[0,0.095],[20,0.246],[40,0.563]],
'benzene':[[0,0.032],[20,0.100],[40,0.268],[60,0.624]],
'toluene':[[0,0.009],[20,0.029],[40,0.079],[60,0.187]],
'gasoline':[[0,0.035],[20,0.070],[40,0.130]],
'diesel':[[20,0.001],[40,0.003],[60,0.008]],
'default':[[0,0.005],[20,0.020],[40,0.060],[60,0.150],[80,0.350],[100,0.800]]
};
// i18n Multi-Language System (#22)
const I18N={
en:{title:'Industrial Fluid Properties Calculator',subtitle:'Mining â€¢ Chemicals â€¢ Explosives â€¢ Fertilizers â€¢ Feed â€¢ Pulp/Paper â€¢ Wastewater â€¢ Pharma',search:'Search Fluids',selectFluid:'Select Fluid',available:'available',temp:'Temperature',calculate:'Run Assessment',printPdf:'Print / Save PDF',reynolds:'Reynolds Number & Flow Regime',flowRate:'Flow Rate',pipeDia:'Pipe Diameter',calcRe:'Calculate Reynolds Number',laminar:'LAMINAR FLOW',transition:'TRANSITIONAL FLOW',turbulent:'TURBULENT FLOW',cavitation:'Cavitation Risk Assessment',suctionP:'Suction Pressure (bar abs)',npshr:'Pump NPSH Required (m)',calcCav:'Assess Cavitation Risk',safe:'âœ“ SAFE - No Cavitation Risk',warning:'âš  WARNING - Marginal',danger:'âœ— DANGER - Cavitation Likely',sgLabel:'Specific Gravity',viscLabel:'Dynamic Viscosity',densLabel:'Density',kvLabel:'Kinematic Viscosity',matCompat:'Material Compatibility',sealRec:'Seal Recommendations',hazards:'Chemical Hazards',fluidProps:'Fluid Properties',viscTemp:'Viscosity-Temperature Data',lifecycle:'Material Lifecycle Analysis',excellent:'Excellent Compatibility',good:'Good Compatibility',notRec:'Not Recommended',assumptions:'Assumptions',material:'Material',rating:'Rating',corrRate:'Corrosion Rate',serviceLife:'Service Life',tco:'10-Year TCO',recommendation:'Recommendation',references:'Reference List',assessmentId:'Assessment ID',tempC:'Temp (Â°C)',regime:'Regime',sealState:'Seal State',materials:'Materials'},
es:{title:'Calculadora de Propiedades de Fluidos',subtitle:'MinerÃ­a â€¢ PetrÃ³leo â€¢ Tratamiento de Aguas â€¢ Alimentos â€¢ FarmacÃ©utica â€¢ BaterÃ­as',search:'Buscar Fluidos',selectFluid:'Seleccionar Fluido',available:'disponibles',temp:'Temperatura',calculate:'Ejecutar EvaluaciÃ³n',printPdf:'Imprimir / Guardar PDF',reynolds:'NÃºmero de Reynolds y RÃ©gimen de Flujo',flowRate:'Caudal',pipeDia:'DiÃ¡metro de TuberÃ­a',calcRe:'Calcular Reynolds',laminar:'FLUJO LAMINAR',transition:'FLUJO TRANSICIONAL',turbulent:'FLUJO TURBULENTO',cavitation:'EvaluaciÃ³n de Riesgo de CavitaciÃ³n',suctionP:'PresiÃ³n de SucciÃ³n (bar abs)',npshr:'NPSH Requerido (m)',calcCav:'Evaluar CavitaciÃ³n',safe:'âœ“ SEGURO - Sin Riesgo',warning:'âš  ADVERTENCIA - Marginal',danger:'âœ— PELIGRO - CavitaciÃ³n Probable',sgLabel:'Gravedad EspecÃ­fica',viscLabel:'Viscosidad DinÃ¡mica',densLabel:'Densidad',kvLabel:'Viscosidad CinemÃ¡tica',matCompat:'Compatibilidad de Materiales',sealRec:'Recomendaciones de Sellos',hazards:'Peligros QuÃ­micos',fluidProps:'Propiedades del Fluido',viscTemp:'Datos Viscosidad-Temperatura',lifecycle:'AnÃ¡lisis de Ciclo de Vida',excellent:'Excelente Compatibilidad',good:'Buena Compatibilidad',notRec:'No Recomendado',assumptions:'Supuestos',material:'Material',rating:'ClasificaciÃ³n',corrRate:'Tasa de CorrosiÃ³n',serviceLife:'Vida Ãštil',tco:'TCO 10 AÃ±os',recommendation:'RecomendaciÃ³n',references:'Referencias',assessmentId:'ID de EvaluaciÃ³n',tempC:'Temp (Â°C)',regime:'RÃ©gimen',sealState:'Estado de Sello',materials:'Materiales'},
zh:{title:'å·¥ä¸šæµä½“ç‰¹æ€§è®¡ç®—å™¨',subtitle:'é‡‡çŸ¿ â€¢ çŸ³æ²¹å¤©ç„¶æ°” â€¢ æ±¡æ°´å¤„ç† â€¢ é£Ÿå“ â€¢ åˆ¶è¯ â€¢ ç”µæ± ',search:'æœç´¢æµä½“',selectFluid:'é€‰æ‹©æµä½“',available:'å¯ç”¨',temp:'æ¸©åº¦',calculate:'è¿è¡Œè¯„ä¼°',printPdf:'æ‰“å°/ä¿å­˜PDF',reynolds:'é›·è¯ºæ•°ä¸æµæ€',flowRate:'æµé‡',pipeDia:'ç®¡é“ç›´å¾„',calcRe:'è®¡ç®—é›·è¯ºæ•°',laminar:'å±‚æµ',transition:'è¿‡æ¸¡æµ',turbulent:'æ¹æµ',cavitation:'æ±½èš€é£é™©è¯„ä¼°',suctionP:'å¸å…¥å‹åŠ› (bar)',npshr:'æ³µæ‰€éœ€NPSH (m)',calcCav:'è¯„ä¼°æ±½èš€é£é™©',safe:'âœ“ å®‰å…¨ - æ— æ±½èš€é£é™©',warning:'âš  è­¦å‘Š - ä¸´ç•Œ',danger:'âœ— å±é™© - å¯èƒ½æ±½èš€',sgLabel:'æ¯”é‡',viscLabel:'åŠ¨åŠ›ç²˜åº¦',densLabel:'å¯†åº¦',kvLabel:'è¿åŠ¨ç²˜åº¦',matCompat:'ææ–™å…¼å®¹æ€§',sealRec:'å¯†å°æ¨è',hazards:'åŒ–å­¦å±å®³',fluidProps:'æµä½“ç‰¹æ€§',viscTemp:'ç²˜åº¦-æ¸©åº¦æ•°æ®',lifecycle:'ææ–™ç”Ÿå‘½å‘¨æœŸåˆ†æ',excellent:'ä¼˜ç§€å…¼å®¹æ€§',good:'è‰¯å¥½å…¼å®¹æ€§',notRec:'ä¸æ¨è',assumptions:'å‡è®¾æ¡ä»¶',material:'ææ–™',rating:'è¯„çº§',corrRate:'è…èš€ç‡',serviceLife:'ä½¿ç”¨å¯¿å‘½',tco:'10å¹´æ€»æˆæœ¬',recommendation:'æ¨è',references:'å‚è€ƒæ–‡çŒ®',assessmentId:'è¯„ä¼°ç¼–å·',tempC:'æ¸©åº¦(Â°C)',regime:'åŒ–å­¦ç¯å¢ƒ',sealState:'å¯†å°çŠ¶æ€',materials:'ææ–™'},
de:{title:'Industrieller FlÃ¼ssigkeitsrechner',subtitle:'Bergbau â€¢ Ã–l & Gas â€¢ Abwasser â€¢ Lebensmittel â€¢ Pharma â€¢ Batterie',search:'FlÃ¼ssigkeiten suchen',selectFluid:'FlÃ¼ssigkeit auswÃ¤hlen',available:'verfÃ¼gbar',temp:'Temperatur',calculate:'Bewertung starten',printPdf:'Drucken / PDF speichern',reynolds:'Reynolds-Zahl & StrÃ¶mungsregime',flowRate:'Volumenstrom',pipeDia:'Rohrdurchmesser',calcRe:'Reynolds berechnen',laminar:'LAMINARE STRÃ–MUNG',transition:'ÃœBERGANGSSTRÃ–MUNG',turbulent:'TURBULENTE STRÃ–MUNG',cavitation:'Kavitationsrisiko-Bewertung',suctionP:'Saugdruck (bar abs)',npshr:'Pumpe NPSH erforderlich (m)',calcCav:'Kavitation bewerten',safe:'âœ“ SICHER - Kein Risiko',warning:'âš  WARNUNG - Grenzwertig',danger:'âœ— GEFAHR - Kavitation wahrscheinlich',sgLabel:'Spezifisches Gewicht',viscLabel:'Dynamische ViskositÃ¤t',densLabel:'Dichte',kvLabel:'Kinematische ViskositÃ¤t',matCompat:'MaterialvertrÃ¤glichkeit',sealRec:'Dichtungsempfehlungen',hazards:'Chemische Gefahren',fluidProps:'Fluideigenschaften',viscTemp:'ViskositÃ¤t-Temperatur-Daten',lifecycle:'Material-Lebenszyklusanalyse',excellent:'Ausgezeichnete VertrÃ¤glichkeit',good:'Gute VertrÃ¤glichkeit',notRec:'Nicht empfohlen',assumptions:'Annahmen',material:'Material',rating:'Bewertung',corrRate:'Korrosionsrate',serviceLife:'Lebensdauer',tco:'10-Jahres-TCO',recommendation:'Empfehlung',references:'Referenzen',assessmentId:'Bewertungs-ID',tempC:'Temp (Â°C)',regime:'Regime',sealState:'Dichtungszustand',materials:'Materialien'},
ar:{title:'Ø­Ø§Ø³Ø¨Ø© Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©',subtitle:'Ø§Ù„ØªØ¹Ø¯ÙŠÙ† â€¢ Ø§Ù„ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª â€¢ Ø§Ù„Ù…ØªÙØ¬Ø±Ø§Øª â€¢ Ø§Ù„Ø£Ø³Ù…Ø¯Ø© â€¢ Ø§Ù„Ø£Ø¹Ù„Ø§Ù â€¢ Ø§Ù„ÙˆØ±Ù‚ â€¢ Ø§Ù„Ù…ÙŠØ§Ù‡ â€¢ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©',search:'Ø¨Ø­Ø« Ø§Ù„Ø³ÙˆØ§Ø¦Ù„',selectFluid:'Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù„',available:'Ù…ØªØ§Ø­',temp:'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©',calculate:'ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',printPdf:'Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF',reynolds:'Ø±Ù‚Ù… Ø±ÙŠÙ†ÙˆÙ„Ø¯Ø² ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ØªØ¯ÙÙ‚',flowRate:'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ¯ÙÙ‚',pipeDia:'Ù‚Ø·Ø± Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨',calcRe:'Ø­Ø³Ø§Ø¨ Ø±ÙŠÙ†ÙˆÙ„Ø¯Ø²',laminar:'ØªØ¯ÙÙ‚ ØµÙØ§Ø¦Ø­ÙŠ',transition:'ØªØ¯ÙÙ‚ Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ',turbulent:'ØªØ¯ÙÙ‚ Ù…Ø¶Ø·Ø±Ø¨',cavitation:'ØªÙ‚ÙŠÙŠÙ… Ù…Ø®Ø§Ø·Ø± Ø§Ù„ØªÙƒÙ‡Ù',suctionP:'Ø¶ØºØ· Ø§Ù„Ø³Ø­Ø¨ (Ø¨Ø§Ø±)',npshr:'NPSH Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ù…)',calcCav:'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙƒÙ‡Ù',safe:'âœ“ Ø¢Ù…Ù† - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø±',warning:'âš  ØªØ­Ø°ÙŠØ± - Ø­Ø¯ÙŠ',danger:'âœ— Ø®Ø·Ø± - ØªÙƒÙ‡Ù Ù…Ø­ØªÙ…Ù„',sgLabel:'Ø§Ù„Ø«Ù‚Ù„ Ø§Ù„Ù†ÙˆØ¹ÙŠ',viscLabel:'Ø§Ù„Ù„Ø²ÙˆØ¬Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©',densLabel:'Ø§Ù„ÙƒØ«Ø§ÙØ©',kvLabel:'Ø§Ù„Ù„Ø²ÙˆØ¬Ø© Ø§Ù„Ø­Ø±ÙƒÙŠØ©',matCompat:'ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…ÙˆØ§Ø¯',sealRec:'ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø­Ø´ÙˆØ§Øª',hazards:'Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©',fluidProps:'Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø³Ø§Ø¦Ù„',viscTemp:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø²ÙˆØ¬Ø©-Ø§Ù„Ø­Ø±Ø§Ø±Ø©',lifecycle:'ØªØ­Ù„ÙŠÙ„ Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ù…ÙˆØ§Ø¯',excellent:'ØªÙˆØ§ÙÙ‚ Ù…Ù…ØªØ§Ø²',good:'ØªÙˆØ§ÙÙ‚ Ø¬ÙŠØ¯',notRec:'ØºÙŠØ± Ù…ÙˆØµÙ‰ Ø¨Ù‡',assumptions:'Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª',material:'Ø§Ù„Ù…Ø§Ø¯Ø©',rating:'Ø§Ù„ØªØµÙ†ÙŠÙ',corrRate:'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ¢ÙƒÙ„',serviceLife:'Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ',tco:'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© 10 Ø³Ù†ÙˆØ§Øª',recommendation:'Ø§Ù„ØªÙˆØµÙŠØ©',references:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹',assessmentId:'Ø±Ù‚Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',tempC:'Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)',regime:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ',sealState:'Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø´Ùˆ',materials:'Ø§Ù„Ù…ÙˆØ§Ø¯'}
};
let curLang='en';
// API Structure (#21) - Data export format
const API={
version:'5.0',
getFluid:function(id){
const f=F[id];
if(!f)return null;
return{id:id,name:f.n,category:f.c,dataPoints:f.d.map(d=>({tempC:d[0],sg:d[1],viscosity_cP:d[2]}))};
},
calcProps:function(id,tempC){
const f=F[id];
if(!f)return null;
const p=interp(tempC,f.d);
return{fluidId:id,tempC:tempC,sg:p.sg,viscosity_cP:p.visc,density_kgm3:p.sg*1000,kinematicVisc_cSt:(p.visc/1000)/(p.sg*1000)*1e6,extrapolated:p.ex};
},
listFluids:function(){return Object.keys(F).map(k=>({id:k,name:F[k].n,category:F[k].c}));},
listCategories:function(){const c={};Object.values(F).forEach(f=>{c[f.c]=(c[f.c]||0)+1});return c;}
};
window.FluidAPI=API;
const H={
'h2so4':{name:'Sulfuric Acid',psn:'SULFURIC ACID',signal:'DANGER',pictograms:['â˜ ï¸','ğŸ”¥'],ghsClasses:['Skin Corrosion 1A','Serious Eye Damage 1'],hStatements:['H314: Causes severe skin burns and eye damage'],ppe:['Chemical resistant gloves','Face shield','Chemical goggles','Acid-resistant apron','Respirator'],firstAid:'Flush with water 15+ min. Do NOT neutralize. Seek medical attention.',disposal:'Neutralize with sodium carbonate. Hazardous waste.',aicis:'Assessed - Corrosive',un:'1830',erg:'137',twa:'1 mg/mÂ³',stel:'3 mg/mÂ³'},
'hcl':{name:'Hydrochloric Acid',psn:'HYDROCHLORIC ACID',signal:'DANGER',pictograms:['â˜ ï¸','ğŸ’¨'],ghsClasses:['Skin Corrosion 1B','Serious Eye Damage 1','STOT SE 3'],hStatements:['H314: Severe burns','H335: Respiratory irritation'],ppe:['Acid-resistant gloves','Face shield','Respirator for fumes'],firstAid:'Rinse with water. Remove contaminated clothing.',disposal:'Neutralize with lime. Hazardous waste.',aicis:'Assessed - Corrosive',un:'1789',erg:'157',twa:'5 ppm (ceiling)',stel:'N/A'},
'hno3':{name:'Nitric Acid',psn:'NITRIC ACID',signal:'DANGER',pictograms:['â˜ ï¸','â­•','ğŸ”¥'],ghsClasses:['Oxidizing Liquid 3','Skin Corrosion 1A'],hStatements:['H272: May intensify fire','H314: Severe burns'],ppe:['Chemical gloves','Face shield','Full protection','NOx respirator'],firstAid:'Flush 15+ min. Immediate medical attention.',disposal:'Neutralize cautiously. Oxidizer hazard.',aicis:'Assessed - Corrosive & Oxidizing',un:'2031',erg:'157',twa:'2 ppm (NOx)',stel:'4 ppm (NOx)'},
'h3po4':{name:'Phosphoric Acid',psn:'PHOSPHORIC ACID SOLUTION',signal:'DANGER',pictograms:['â˜ ï¸'],ghsClasses:['Skin Corrosion 1B','Serious Eye Damage 1'],hStatements:['H314: Severe burns'],ppe:['Chemical gloves','Safety goggles','Lab coat'],firstAid:'Rinse with water. Seek medical attention.',disposal:'Neutralize. Hazardous waste.',aicis:'Reported - Corrosive',un:'1805',erg:'154',twa:'1 mg/mÂ³',stel:'3 mg/mÂ³'},
'naoh':{name:'Sodium Hydroxide',psn:'SODIUM HYDROXIDE SOLUTION',signal:'DANGER',pictograms:['â˜ ï¸'],ghsClasses:['Skin Corrosion 1A','Serious Eye Damage 1'],hStatements:['H314: Severe burns'],ppe:['Alkali-resistant gloves','Face shield','Protective clothing'],firstAid:'Flush immediately. DO NOT neutralize.',disposal:'Neutralize with dilute acid. Hazardous waste.',aicis:'Reported - Corrosive',un:'1823',erg:'154',twa:'2 mg/mÂ³ (ceiling)',stel:'N/A'},
'koh':{name:'Potassium Hydroxide',psn:'POTASSIUM HYDROXIDE SOLUTION',signal:'DANGER',pictograms:['â˜ ï¸'],ghsClasses:['Skin Corrosion 1A','Serious Eye Damage 1'],hStatements:['H314: Severe burns'],ppe:['Alkali-resistant gloves','Face shield','Chemical goggles'],firstAid:'Flush immediately. DO NOT neutralize.',disposal:'Neutralize with dilute acid. Hazardous waste.',aicis:'Reported - Corrosive',un:'1813',erg:'154',twa:'2 mg/mÂ³ (ceiling)',stel:'N/A'},
'nh4oh':{name:'Ammonium Hydroxide',psn:'AMMONIA SOLUTION',signal:'DANGER',pictograms:['â˜ ï¸','ğŸŸ'],ghsClasses:['Skin Corrosion 1B','Aquatic Acute 1'],hStatements:['H314: Severe burns','H400: Aquatic toxicity'],ppe:['Chemical gloves','Face shield','Ammonia respirator'],firstAid:'Flush with water. Seek medical attention.',disposal:'Neutralize. Hazardous waste.',aicis:'Reported - Corrosive',un:'2672',erg:'154',twa:'25 ppm',stel:'35 ppm'},
'cyanide':{name:'Sodium Cyanide',psn:'SODIUM CYANIDE',signal:'DANGER',pictograms:['â˜ ï¸','ğŸ’€','ğŸŸ'],ghsClasses:['Acute Toxicity 2 (all routes)','Aquatic Acute 1'],hStatements:['H300/310/330: Fatal','H410: Aquatic toxicity'],ppe:['Full face respirator','Full body protection','Safety shower nearby'],firstAid:'IMMEDIATELY remove. Cyanide antidote. Emergency services.',disposal:'Oxidize with bleach/H2O2. Extremely hazardous.',aicis:'Assessed - Acute Toxicity 2',un:'1689',erg:'157',twa:'5 mg/mÂ³ (as CN)',stel:'N/A (immediately dangerous)'},
'benzene':{name:'Benzene',psn:'BENZENE',signal:'DANGER',pictograms:['ğŸ”¥','â˜ ï¸','âš ï¸'],ghsClasses:['Flammable 2','Carcinogen 1A','Mutagen 1B','STOT RE 1','Aspiration 1'],hStatements:['H225: Flammable','H350: Cancer','H340: Genetic defects'],ppe:['Nitrile gloves','Organic vapor respirator','Fire-resistant clothing'],firstAid:'Remove from exposure. Do NOT induce vomiting.',disposal:'Flammable hazardous waste. Carcinogen protocols.',aicis:'Assessed - CMR 1',un:'1114',erg:'130',twa:'1 ppm',stel:'5 ppm (short-term)'},
'toluene':{name:'Toluene',psn:'TOLUENE',signal:'DANGER',pictograms:['ğŸ”¥','âš ï¸'],ghsClasses:['Flammable 2','Skin Irritation 2','STOT SE 3','Aspiration 1'],hStatements:['H225: Flammable','H336: Drowsiness'],ppe:['Chemical gloves','Organic vapor respirator'],firstAid:'Remove from exposure. Do NOT induce vomiting.',disposal:'Flammable hazardous waste.',aicis:'Reported - Flammable',un:'1294',erg:'130',twa:'50 ppm',stel:'150 ppm'},
'methanol':{name:'Methanol',psn:'METHANOL',signal:'DANGER',pictograms:['ğŸ”¥','â˜ ï¸'],ghsClasses:['Flammable 2','Acute Toxicity 3','STOT SE 1'],hStatements:['H225: Flammable','H301/311: Toxic','H370: Eye damage'],ppe:['Chemical gloves','Safety goggles','Organic vapor respirator'],firstAid:'Immediate medical attention for ingestion.',disposal:'Flammable hazardous waste.',aicis:'Assessed - Toxic',un:'1230',erg:'131',twa:'200 ppm',stel:'250 ppm'},
'ethylene-glycol':{name:'Ethylene Glycol',psn:'N/A (not regulated)',signal:'WARNING',pictograms:['âš ï¸'],ghsClasses:['Acute Toxicity 4','STOT RE 2'],hStatements:['H302: Harmful if swallowed','H373: Organ damage'],ppe:['Chemical gloves','Safety glasses'],firstAid:'Medical attention for ingestion. Kidney damage risk.',disposal:'Hazardous waste.',aicis:'Reported',un:'N/A',erg:'N/A',twa:'25 ppm (ceiling)',stel:'N/A'},
'hypochlorite':{name:'Sodium Hypochlorite',psn:'HYPOCHLORITE SOLUTION',signal:'DANGER',pictograms:['â˜ ï¸','ğŸŸ'],ghsClasses:['Skin Corrosion 1B','Aquatic Acute 1'],hStatements:['H314: Severe burns','H400: Aquatic toxicity','EUH031: Toxic gas with acids'],ppe:['Acid-resistant gloves','Face shield','Chlorine respirator'],firstAid:'Flush 15+ min. Chlorine gas: fresh air.',disposal:'Neutralize with thiosulfate. Do not release to water.',aicis:'Reported - Corrosive',un:'1791',erg:'154',twa:'0.5 ppm (Cl2)',stel:'1 ppm (Cl2)'},
'h2o2':{name:'Hydrogen Peroxide',psn:'HYDROGEN PEROXIDE SOLUTION',signal:'DANGER',pictograms:['â­•','â˜ ï¸'],ghsClasses:['Oxidizing Liquid 1','Skin Corrosion 1A'],hStatements:['H271: Fire/explosion risk','H314: Severe burns'],ppe:['Chemical gloves','Face shield','Protective clothing'],firstAid:'Flush copiously 15+ min. Immediate medical attention.',disposal:'Dilute and neutralize. Oxidizing hazardous waste.',aicis:'Reported - Oxidizer',un:'2014',erg:'140',twa:'1 ppm',stel:'2 ppm'},
'diesel':{name:'Diesel Fuel',psn:'DIESEL FUEL',signal:'DANGER',pictograms:['ğŸ”¥','âš ï¸'],ghsClasses:['Flammable 3','Aspiration 1','Skin Irritation 2'],hStatements:['H226: Flammable','H304: Fatal if aspirated'],ppe:['Chemical gloves','Safety glasses'],firstAid:'Do NOT induce vomiting. Aspiration hazard.',disposal:'Flammable hazardous waste.',aicis:'Reported - Flammable',un:'1202',erg:'128',twa:'100 mg/mÂ³ (vapor)',stel:'N/A'},
'gasoline':{name:'Gasoline',psn:'GASOLINE',signal:'DANGER',pictograms:['ğŸ”¥','âš ï¸','â˜ ï¸'],ghsClasses:['Flammable 1','Carcinogen 1B','Aspiration 1'],hStatements:['H224: Extremely flammable','H350: Cancer risk'],ppe:['Chemical gloves','Fire-resistant clothing'],firstAid:'Do NOT induce vomiting. Move from ignition sources.',disposal:'Flammable hazardous waste.',aicis:'Assessed - CMR',un:'1203',erg:'128',twa:'300 ppm',stel:'500 ppm'},
'milk':{name:'Milk Products',psn:'N/A',signal:'NONE',pictograms:[],ghsClasses:['Not hazardous'],hStatements:['Not a hazardous substance'],ppe:['Food-grade gloves','Hairnet'],firstAid:'Standard food hygiene.',disposal:'Wastewater treatment or composting.',aicis:'Food product',un:'N/A',erg:'N/A',twa:'N/A',stel:'N/A'},
'vegetable-oil':{name:'Vegetable Oils',psn:'N/A',signal:'NONE',pictograms:[],ghsClasses:['Not hazardous'],hStatements:['Not hazardous. Slippery.'],ppe:['Food-grade gloves','Slip-resistant footwear'],firstAid:'No specific first aid.',disposal:'Recycle. Do not pour down drain.',aicis:'Food product',un:'N/A',erg:'N/A',twa:'N/A',stel:'N/A'},
'glycerin':{name:'Glycerin',psn:'N/A',signal:'NONE',pictograms:[],ghsClasses:['Not hazardous'],hStatements:['Not hazardous'],ppe:['Gloves','Safety glasses'],firstAid:'Rinse with water.',disposal:'Biodegradable.',aicis:'Reported - Low hazard',un:'N/A',erg:'N/A',twa:'10 mg/mÂ³ (mist)',stel:'N/A'},
'lubricants':{name:'Lubricating Oils',psn:'N/A',signal:'WARNING',pictograms:['âš ï¸'],ghsClasses:['Aspiration Hazard 1 (low visc)','Skin Irritation 2'],hStatements:['H304: May be fatal if aspirated'],ppe:['Oil-resistant gloves','Safety glasses'],firstAid:'Do NOT induce vomiting. Wash with soap.',disposal:'Recycle used oil.',aicis:'Reported',un:'N/A',erg:'N/A',twa:'5 mg/mÂ³ (oil mist)',stel:'10 mg/mÂ³'},
'slurry':{name:'Mineral Slurries',psn:'N/A (varies)',signal:'WARNING',pictograms:['âš ï¸'],ghsClasses:['Eye Irritation 2','Skin Irritation 2'],hStatements:['H315/319: Irritation'],ppe:['Chemical gloves','Safety goggles','Dust mask'],firstAid:'Rinse eyes/skin with water.',disposal:'Settle solids. Industrial waste.',aicis:'Varies',un:'N/A',erg:'N/A',twa:'10 mg/mÂ³ (dust)',stel:'N/A'},
// V89: CRITICAL MISSING HAZARD DATA
'ammonium-nitrate':{name:'Ammonium Nitrate',psn:'AMMONIUM NITRATE',signal:'DANGER',pictograms:['â­•','ğŸ’¥','âš ï¸'],ghsClasses:['Oxidizing Solid 3','Acute Toxicity 4','Eye Irritation 2'],hStatements:['H272: May intensify fire; oxidizer','H302: Harmful if swallowed','H319: Causes serious eye irritation','H412: Harmful to aquatic life'],ppe:['Chemical resistant gloves','Safety goggles','Face shield','Fire-resistant clothing','Dust mask'],firstAid:'Move to fresh air. Flush eyes/skin 15+ min. Medical attention if inhaled.',disposal:'Do NOT mix with organic materials, fuels, or reducing agents. Hazardous waste - oxidizer protocols.',aicis:'Assessed - Oxidizer, Security Sensitive',un:'1942 (>0.2% combustible) / 2067 (fertilizer grade)',erg:'140',twa:'N/A',stel:'N/A',specialWarnings:['THERMAL DECOMPOSITION: Decomposes >200Â°C releasing toxic NOx gases','EXPLOSION RISK: Confined heating or contamination with fuels/organics can cause detonation','STORAGE: Keep away from heat, reducing agents, organics, and fuels','REGULATORY: Subject to security-sensitive ammonium nitrate (SSAN) regulations in many jurisdictions']},
'hf':{name:'Hydrofluoric Acid',psn:'HYDROFLUORIC ACID',signal:'DANGER',pictograms:['â˜ ï¸','ğŸ’€','âš ï¸'],ghsClasses:['Acute Toxicity 1 (dermal)','Acute Toxicity 2 (inhalation)','Skin Corrosion 1A'],hStatements:['H300/310/330: Fatal if swallowed, skin contact, or inhaled','H314: Causes severe skin burns and eye damage'],ppe:['Neoprene or butyl rubber gloves (NOT latex)','Full face shield','Chemical splash suit','SCBA for concentrated HF','Emergency shower and eyewash MANDATORY'],firstAid:'IMMEDIATELY flush with water 15+ min. Apply 2.5% CALCIUM GLUCONATE GEL to affected skin. Seek IMMEDIATE medical attention - systemic fluoride poisoning can be fatal even from small skin exposure. Monitor cardiac function (hypocalcemia risk).',disposal:'Neutralize with calcium hydroxide (NOT sodium hydroxide). Fluoride hazardous waste - licensed disposal only.',aicis:'Assessed - Acute Toxicity 1/2, Corrosive',un:'1790',erg:'157',twa:'0.5 ppm (ceiling)',stel:'2 ppm (15 min)',specialWarnings:['DELAYED SYMPTOMS: Burns may not be immediately painful - tissue destruction continues subcutaneously','SYSTEMIC TOXICITY: Fluoride ions bind calcium causing hypocalcemia, cardiac arrhythmia, death','ANTIDOTE: Calcium gluconate gel (2.5%) must be available wherever HF is used','INCOMPATIBLE: Glass, concrete, many metals - use HDPE, PP, PTFE, or Hastelloy-C']},
'oleum':{name:'Oleum (Fuming Sulfuric Acid)',psn:'OLEUM / FUMING SULFURIC ACID',signal:'DANGER',pictograms:['â˜ ï¸','ğŸ”¥','ğŸ’¨'],ghsClasses:['Skin Corrosion 1A','Serious Eye Damage 1','STOT SE 1','Acute Toxicity 2 (inhalation)'],hStatements:['H314: Causes severe skin burns and eye damage','H330: Fatal if inhaled','H335: May cause respiratory irritation'],ppe:['Acid-resistant full body suit','Full face SCBA','Double gloves (butyl + neoprene)','Emergency shower MANDATORY'],firstAid:'EVACUATE area if fuming. Do NOT use water directly on concentrated spills (violent reaction). For skin contact: brush off excess, then flush copiously. Immediate medical attention.',disposal:'Dilute SLOWLY into large excess of ice water. Neutralize. Extremely hazardous waste.',aicis:'Assessed - Corrosive, Toxic',un:'1831',erg:'137',twa:'0.1 mg/mÂ³ (SOâ‚ƒ)',stel:'N/A',specialWarnings:['FUMING: Releases SOâ‚ƒ fumes on contact with air - respiratory hazard','WATER REACTIVE: Violent exothermic reaction with water - adds water TO acid slowly','DEHYDRATING: Chars organic materials on contact','TEMPERATURE: Freezes at 10-35Â°C depending on SOâ‚ƒ content - handling procedures critical']}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V17.7 EXPANSION: BITUMEN & HEAVY OIL - Parliament Session 14
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const F_BITUMEN={
'bitumen-pen-40-50':{n:'Bitumen Penetration 40/50',c:'Bitumen - Road Grade',d:[[120,1.015,8500],[140,1.005,1850],[160,0.995,520],[180,0.985,185]]},
'bitumen-pen-60-70':{n:'Bitumen Penetration 60/70',c:'Bitumen - Road Grade',d:[[110,1.018,12500],[130,1.008,2850],[150,0.998,780],[170,0.988,245]]},
'bitumen-pen-80-100':{n:'Bitumen Penetration 80/100',c:'Bitumen - Road Grade',d:[[100,1.020,18500],[120,1.010,3850],[140,1.000,980],[160,0.990,295]]},
'bitumen-pen-160-220':{n:'Bitumen Penetration 160/220',c:'Bitumen - Soft Grade',d:[[80,1.022,28500],[100,1.012,5850],[120,1.002,1380],[140,0.992,395]]},
'bitumen-emulsion-crs':{n:'Bitumen Emulsion CRS-2',c:'Bitumen - Emulsion',d:[[25,1.015,125],[40,1.008,65],[55,1.001,38],[70,0.994,22]]},
'bitumen-emulsion-css':{n:'Bitumen Emulsion CSS-1',c:'Bitumen - Emulsion',d:[[25,1.012,85],[40,1.005,48],[55,0.998,28],[70,0.991,17]]},
'cutback-mc-70':{n:'Cutback Bitumen MC-70',c:'Bitumen - Cutback',d:[[25,0.985,185],[40,0.975,95],[55,0.965,52],[70,0.955,32]]},
'cutback-mc-250':{n:'Cutback Bitumen MC-250',c:'Bitumen - Cutback',d:[[40,0.988,425],[55,0.978,185],[70,0.968,92],[85,0.958,52]]},
'polymer-modified-bitumen':{n:'Polymer Modified Bitumen (PMB)',c:'Bitumen - Modified',d:[[140,1.008,3500],[160,0.998,850],[180,0.988,285],[200,0.978,125]]},
'crumb-rubber-bitumen':{n:'Crumb Rubber Modified Bitumen',c:'Bitumen - Modified',d:[[150,1.012,4500],[170,1.002,1050],[190,0.992,345],[210,0.982,145]]},
'dilbit':{n:'Diluted Bitumen (Dilbit)',c:'Petroleum - Heavy',d:[[20,0.945,285],[40,0.932,125],[60,0.919,62],[80,0.906,35]]},
'synbit':{n:'Synthetic Bitumen (Synbit)',c:'Petroleum - Heavy',d:[[20,0.928,185],[40,0.915,92],[60,0.902,48],[80,0.889,28]]},
'heavy-crude-api-10':{n:'Heavy Crude Oil (API 10)',c:'Petroleum - Heavy',d:[[20,0.998,4500],[40,0.985,1250],[60,0.972,425],[80,0.959,185]]},
'heavy-crude-api-15':{n:'Heavy Crude Oil (API 15)',c:'Petroleum - Heavy',d:[[20,0.968,1850],[40,0.955,625],[60,0.942,245],[80,0.929,115]]},
'extra-heavy-crude':{n:'Extra Heavy Crude (API <10)',c:'Petroleum - Heavy',d:[[40,1.008,8500],[60,0.995,2450],[80,0.982,850],[100,0.969,345]]},
'tar-sand-bitumen':{n:'Tar Sand Bitumen Extract',c:'Bitumen - Extraction',d:[[80,1.025,125000],[100,1.012,28500],[120,0.999,6850],[140,0.986,1950]]},
'asphalt-cement-ac20':{n:'Asphalt Cement AC-20',c:'Bitumen - Road Grade',d:[[120,1.015,9500],[140,1.005,2150],[160,0.995,585],[180,0.985,195]]},
'asphalt-cement-ac10':{n:'Asphalt Cement AC-10',c:'Bitumen - Road Grade',d:[[100,1.018,15500],[120,1.008,3650],[140,0.998,885],[160,0.988,275]]},
'vacuum-residue':{n:'Vacuum Residue',c:'Petroleum - Refinery',d:[[150,1.025,18500],[180,1.008,3850],[210,0.991,980],[240,0.974,325]]},
'atmospheric-residue':{n:'Atmospheric Residue',c:'Petroleum - Refinery',d:[[100,0.985,2850],[130,0.968,725],[160,0.951,235],[190,0.934,95]]}
};
// Merge bitumen fluids into main F object
Object.assign(F,F_BITUMEN);

const M={
// V6.2: 4-AXIS MATERIAL CLASSIFICATION SYSTEM
// Axis A: Chemical Resistance | Axis B: Mechanical Stability | Axis C: Degradation Mode | Axis D: Time/Stress Sensitivity
materialProps:{
'316SS':{chemRes:'EXCELLENT',mechStab:'HIGH',failMode:'Pitting/SCC',timeSens:'Stress-activated',maxTemp:400,amphoteric:false},
'304SS':{chemRes:'GOOD',mechStab:'HIGH',failMode:'Pitting/SCC',timeSens:'Stress-activated',maxTemp:400,amphoteric:false},
'Duplex-SS':{chemRes:'EXCELLENT',mechStab:'VERY HIGH',failMode:'Pitting/SCC',timeSens:'Stress-activated',maxTemp:300,amphoteric:false},
'Hastelloy-C':{chemRes:'EXCELLENT',mechStab:'HIGH',failMode:'Pitting',timeSens:'Time-independent',maxTemp:500,amphoteric:false},
'Inconel-625':{chemRes:'EXCELLENT',mechStab:'VERY HIGH',failMode:'Pitting',timeSens:'Time-independent',maxTemp:650,amphoteric:false},
'Monel-400':{chemRes:'EXCELLENT',mechStab:'HIGH',failMode:'SCC in HF',timeSens:'Stress-activated',maxTemp:450,amphoteric:false},
'Titanium':{chemRes:'EXCELLENT',mechStab:'HIGH',failMode:'Hydrogen embrittlement',timeSens:'Transient-sensitive',maxTemp:300,amphoteric:false,alkaliSensitive:true},
'Carbon-Steel':{chemRes:'LIMITED',mechStab:'HIGH',failMode:'General corrosion/SCC',timeSens:'Stress-activated',maxTemp:400,amphoteric:false,sccInCaustic:true},
'Aluminum':{chemRes:'LIMITED',mechStab:'MEDIUM',failMode:'Pitting/dissolution',timeSens:'Time-independent',maxTemp:150,amphoteric:true},
'Bronze':{chemRes:'GOOD',mechStab:'HIGH',failMode:'Dezincification',timeSens:'Time-independent',maxTemp:250,amphoteric:false},
'PTFE':{chemRes:'EXCELLENT',mechStab:'CONDITIONAL',failMode:'Creep/permeation',timeSens:'Time-dependent',maxTemp:260,amphoteric:false},
'PEEK':{chemRes:'EXCELLENT',mechStab:'HIGH',failMode:'Stress cracking',timeSens:'Time-dependent',maxTemp:250,amphoteric:false},
'PVDF':{chemRes:'EXCELLENT',mechStab:'CONDITIONAL',failMode:'Creep/permeation',timeSens:'Time-dependent',maxTemp:140,amphoteric:false},
'PP':{chemRes:'GOOD',mechStab:'LIMITED',failMode:'Stress cracking/softening',timeSens:'Time-dependent',maxTemp:90,amphoteric:false},
'PVC':{chemRes:'LIMITED',mechStab:'LIMITED',failMode:'Plasticizer extraction/embrittlement',timeSens:'Time-dependent',maxTemp:60,amphoteric:false},
'CPVC':{chemRes:'GOOD',mechStab:'LIMITED',failMode:'Stress cracking',timeSens:'Time-dependent',maxTemp:90,amphoteric:false},
'HDPE':{chemRes:'GOOD',mechStab:'LIMITED',failMode:'Stress cracking/creep',timeSens:'Time-dependent',maxTemp:80,amphoteric:false},
'UHMWPE':{chemRes:'EXCELLENT',mechStab:'HIGH',failMode:'Creep under load',timeSens:'Time-dependent',maxTemp:80,amphoteric:false},
'FKM':{chemRes:'EXCELLENT',mechStab:'LIMITED',failMode:'Swelling/hardening',timeSens:'Time-dependent',maxTemp:200,isElastomer:true},
'EPDM':{chemRes:'GOOD',mechStab:'LIMITED',failMode:'Swelling/extraction',timeSens:'Time-dependent',maxTemp:150,isElastomer:true},
'NBR':{chemRes:'LIMITED',mechStab:'LIMITED',failMode:'Swelling/hardening',timeSens:'Time-dependent',maxTemp:100,isElastomer:true},
'Kalrez':{chemRes:'EXCELLENT',mechStab:'MEDIUM',failMode:'Compression set',timeSens:'Time-dependent',maxTemp:300,isElastomer:true}
},
// V6.2: CHEMISTRY CLASS TAGS FOR AUTOMATIC EXCLUSION RULES
chemistryTags:{
'caustic':['STRONG_BASE','AMPHOTERIC_ACTIVE','SCC_RISK'],
'sulfuric-conc':['STRONG_ACID','DEHYDRATING','OXIDIZER_WEAK'],
'sulfuric-dilute':['STRONG_ACID'],
'nitric':['STRONG_ACID','STRONG_OXIDIZER','PASSIVATING'],
'hydrochloric':['STRONG_ACID','HALOGENATED','PITTING_RISK'],
'phosphoric':['STRONG_ACID'],
'oxidizer':['STRONG_OXIDIZER','PASSIVATING'],
'ammonia':['STRONG_BASE','SCC_RISK'],
'chlorinated':['HALOGENATED','SOLVENT'],
'aromatic':['SOLVENT','ELASTOMER_ATTACK'],
'cyanide':['TOXIC','ALKALINE']
},
// V6.2: NEGATIVE KNOWLEDGE BASE - What fails and why
failureKnowledge:[
{material:'PVC',fluidClass:'STRONG_BASE',failMode:'Plasticizer extraction',trigger:['Temp>40C','Conc>40%'],severity:'Delayed catastrophic'},
{material:'PVC',fluidClass:'STRONG_ACID',failMode:'Embrittlement',trigger:['Temp>50C'],severity:'Gradual degradation'},
{material:'Aluminum',fluidClass:'STRONG_BASE',failMode:'Amphoteric dissolution',trigger:['Any concentration'],severity:'Rapid attack'},
{material:'Aluminum',fluidClass:'STRONG_ACID',failMode:'Dissolution',trigger:['Most acids'],severity:'Rapid attack'},
{material:'Titanium',fluidClass:'STRONG_BASE',failMode:'Hydrogen embrittlement',trigger:['Temp>50C','High concentration'],severity:'Delayed catastrophic'},
{material:'Titanium',fluidClass:'DEHYDRATING',failMode:'Pyrophoric reaction risk',trigger:['Conc H2SO4'],severity:'Immediate hazard'},
{material:'Carbon-Steel',fluidClass:'STRONG_BASE',failMode:'Caustic SCC',trigger:['Temp>50C','Residual stress'],severity:'Sudden failure'},
{material:'Carbon-Steel',fluidClass:'STRONG_OXIDIZER',failMode:'Accelerated general corrosion',trigger:['Any'],severity:'Rapid attack'},
{material:'EPDM',fluidClass:'SOLVENT',failMode:'Swelling/dissolution',trigger:['Aromatic solvents'],severity:'Rapid degradation'},
{material:'NBR',fluidClass:'STRONG_OXIDIZER',failMode:'Oxidative degradation',trigger:['Any oxidizer'],severity:'Rapid degradation'},
{material:'PP',fluidClass:'SOLVENT',failMode:'Stress cracking',trigger:['Aromatic solvents'],severity:'Delayed cracking'},
{material:'316SS',fluidClass:'HALOGENATED',failMode:'Pitting/crevice corrosion',trigger:['Chlorides>50ppm','Temp>50C'],severity:'Localized attack'},
{material:'304SS',fluidClass:'HALOGENATED',failMode:'SCC',trigger:['Chlorides','Temp>50C'],severity:'Sudden failure'}
],
materials:{'316SS':{name:'316 Stainless Steel',type:'Metal'},'304SS':{name:'304 Stainless Steel',type:'Metal'},'Duplex-SS':{name:'Duplex SS 2205',type:'Metal'},'Hastelloy-C':{name:'Hastelloy C-276',type:'Metal'},'Inconel-625':{name:'Inconel 625',type:'Metal'},'Monel-400':{name:'Monel 400',type:'Metal'},'Titanium':{name:'Titanium',type:'Metal'},'Carbon-Steel':{name:'Carbon Steel',type:'Metal'},'Aluminum':{name:'Aluminum',type:'Metal'},'Bronze':{name:'Aluminum Bronze',type:'Metal'},'PTFE':{name:'PTFE (Teflon)',type:'Plastic'},'PEEK':{name:'PEEK',type:'Plastic'},'PVDF':{name:'PVDF (Kynar)',type:'Plastic'},'PP':{name:'Polypropylene',type:'Plastic'},'PVC':{name:'PVC',type:'Plastic'},'CPVC':{name:'CPVC',type:'Plastic'},'HDPE':{name:'HDPE',type:'Plastic'},'UHMWPE':{name:'UHMWPE',type:'Plastic'},'FKM':{name:'Viton (FKM)',type:'Elastomer'},'EPDM':{name:'EPDM',type:'Elastomer'},'NBR':{name:'Nitrile (Buna-N)',type:'Elastomer'},'Kalrez':{name:'Kalrez (FFKM)',type:'Elastomer'}},
compat:{
'water':{excellent:['316SS','304SS','Duplex-SS','PTFE','PVDF','PP','PVC','EPDM','FKM','PEEK','UHMWPE'],good:['Carbon-Steel','Aluminum','NBR','HDPE','Bronze','Inconel-625','Monel-400'],poor:[]},
'sulfuric-dilute':{excellent:['PTFE','PVDF','Hastelloy-C','Duplex-SS'],good:['316SS','PP','FKM','Kalrez','PEEK'],poor:['304SS','Carbon-Steel','Aluminum','NBR','EPDM','Bronze']},
'sulfuric-conc':{excellent:['PTFE','Kalrez'],good:['Carbon-Steel','FKM','PVDF'],poor:['316SS','304SS','Aluminum','Titanium','PP','NBR','EPDM','Hastelloy-C','Duplex-SS','Bronze']},
'hydrochloric':{excellent:['PTFE','PVDF','Hastelloy-C','Titanium','Kalrez','Monel-400'],good:['PP','FKM','CPVC','PEEK'],poor:['316SS','304SS','Carbon-Steel','Aluminum','NBR','EPDM','Duplex-SS','Bronze']},
'nitric':{excellent:['PTFE','Titanium','316SS','Duplex-SS'],good:['304SS','PVDF','FKM','Kalrez','Inconel-625'],poor:['Carbon-Steel','Hastelloy-C','Aluminum','NBR','EPDM','Monel-400','Bronze']},
'phosphoric':{excellent:['PTFE','Hastelloy-C','316SS','Titanium','Duplex-SS','Inconel-625'],good:['PVDF','PP','FKM','Kalrez','CPVC','PEEK'],poor:['Carbon-Steel','Aluminum','NBR','Bronze']},
'caustic':{excellent:['PTFE','PVDF','316SS','Carbon-Steel','Duplex-SS','Inconel-625','Monel-400'],good:['304SS','Hastelloy-C','PP','EPDM','FKM'],poor:['Aluminum','Titanium','PVC','Bronze']},
'ammonia':{excellent:['316SS','304SS','PTFE','PVDF','Duplex-SS','Inconel-625'],good:['Carbon-Steel','PP','EPDM','FKM'],poor:['Aluminum','NBR','PVC','Bronze','Monel-400']},
'cyanide':{excellent:['316SS','PTFE','PVDF','Hastelloy-C','Duplex-SS'],good:['304SS','PP','FKM','EPDM','Inconel-625'],poor:['Aluminum','NBR','Carbon-Steel','Bronze']},
'petroleum':{excellent:['316SS','304SS','Carbon-Steel','Aluminum','NBR','FKM','Duplex-SS','Bronze'],good:['PTFE','PP','PEEK','UHMWPE'],poor:['EPDM','PVC']},
'aromatic':{excellent:['316SS','304SS','PTFE','FKM','Kalrez','Duplex-SS','Inconel-625'],good:['Hastelloy-C','PVDF','PEEK'],poor:['NBR','EPDM','PP','PVC','HDPE','UHMWPE']},
'alcohol':{excellent:['316SS','304SS','PTFE','PVDF','PP','EPDM','FKM','Duplex-SS','PEEK'],good:['Aluminum','PVC','NBR','Bronze'],poor:[]},
'chlorinated':{excellent:['PTFE','FKM','Kalrez','Hastelloy-C','Inconel-625'],good:['316SS','304SS','PVDF','Duplex-SS'],poor:['NBR','EPDM','PP','PVC','Aluminum','HDPE','Bronze']},
'slurry':{excellent:['316SS','Hastelloy-C','PTFE','HDPE','Duplex-SS','UHMWPE'],good:['304SS','PVDF','PP','FKM','Bronze'],poor:[]},
'oxidizer':{excellent:['PTFE','PVDF','316SS','Titanium','Duplex-SS'],good:['304SS','PP','FKM','Inconel-625'],poor:['Carbon-Steel','Aluminum','Hastelloy-C','NBR','EPDM','Bronze','Monel-400']},
'food':{excellent:['316SS','304SS','PTFE','PVDF','PP','EPDM','FKM','PEEK'],good:['HDPE','NBR','UHMWPE'],poor:[]},
'glycol':{excellent:['316SS','304SS','PTFE','PVDF','PP','EPDM','FKM','Duplex-SS','PEEK'],good:['Carbon-Steel','Aluminum','NBR','Bronze'],poor:[]},
'bitumen':{excellent:['316SS','304SS','Carbon-Steel','PTFE','PEEK','FKM','Kalrez'],good:['Duplex-SS','PVDF','NBR','Bronze','UHMWPE'],poor:['EPDM','PVC','PP','Aluminum']}},
corrosion:{
'water':{'316SS':[.001,.01],'304SS':[.005,.02],'Duplex-SS':[.0005,.005],'Hastelloy-C':[.0005,.002],'Inconel-625':[.0005,.002],'Monel-400':[.001,.005],'Titanium':[.0001,.001],'Carbon-Steel':[.05,.15],'Aluminum':[.01,.05],'Bronze':[.005,.02],'PTFE':[0,0],'PEEK':[0,0],'PVDF':[0,0],'PP':[0,0],'PVC':[0,0],'CPVC':[0,0],'HDPE':[0,0],'UHMWPE':[0,0],'FKM':[0,0],'EPDM':[0,0],'NBR':[0,.01],'Kalrez':[0,0]},
'sulfuric-dilute':{'316SS':[.05,.15],'304SS':[.2,.8],'Duplex-SS':[.02,.08],'Hastelloy-C':[.01,.05],'Inconel-625':[.02,.08],'Monel-400':[.5,2],'Titanium':[.05,.2],'Carbon-Steel':[1,5],'Aluminum':[.5,2],'Bronze':[.2,1],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.01,.05],'PVC':[.1,.5],'CPVC':[.05,.2],'HDPE':[.05,.2],'UHMWPE':[.02,.1],'FKM':[0,.01],'EPDM':[.5,2],'NBR':[.5,2],'Kalrez':[0,0]},
'sulfuric-conc':{'316SS':[.1,.5],'304SS':[.5,2],'Duplex-SS':[.1,.4],'Hastelloy-C':[.5,2],'Inconel-625':[.3,1],'Monel-400':[1,5],'Titanium':[1,5],'Carbon-Steel':[.1,.5],'Aluminum':[2,10],'Bronze':[1,5],'PTFE':[0,0],'PEEK':[0,.02],'PVDF':[.01,.05],'PP':[.5,2],'PVC':[1,5],'CPVC':[.5,2],'HDPE':[1,5],'UHMWPE':[.5,2],'FKM':[.02,.1],'EPDM':[2,10],'NBR':[2,10],'Kalrez':[0,.01]},
'hydrochloric':{'316SS':[.5,2],'304SS':[1,5],'Duplex-SS':[.2,1],'Hastelloy-C':[.02,.1],'Inconel-625':[.05,.2],'Monel-400':[.01,.05],'Titanium':[.01,.05],'Carbon-Steel':[5,20],'Aluminum':[5,20],'Bronze':[.5,2],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.01,.05],'PVC':[.05,.2],'CPVC':[.02,.1],'HDPE':[.02,.1],'UHMWPE':[.01,.05],'FKM':[.01,.05],'EPDM':[1,5],'NBR':[1,5],'Kalrez':[0,.01]},
'nitric':{'316SS':[.01,.05],'304SS':[.02,.1],'Duplex-SS':[.01,.04],'Hastelloy-C':[.1,.5],'Inconel-625':[.02,.1],'Monel-400':[.5,2],'Titanium':[.001,.01],'Carbon-Steel':[2,10],'Aluminum':[.01,.05],'Bronze':[.5,2],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.05,.2],'PVC':[.1,.5],'CPVC':[.05,.2],'HDPE':[.1,.5],'UHMWPE':[.05,.2],'FKM':[.01,.05],'EPDM':[.5,2],'NBR':[.5,2],'Kalrez':[0,.01]},
'phosphoric':{'316SS':[.02,.1],'304SS':[.05,.2],'Duplex-SS':[.01,.05],'Hastelloy-C':[.01,.05],'Inconel-625':[.01,.05],'Monel-400':[.02,.1],'Titanium':[.01,.05],'Carbon-Steel':[1,5],'Aluminum':[.5,2],'Bronze':[.1,.5],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.02,.1],'PVC':[.05,.2],'CPVC':[.02,.1],'HDPE':[.05,.2],'UHMWPE':[.02,.1],'FKM':[.01,.05],'EPDM':[.2,1],'NBR':[.2,1],'Kalrez':[0,.01]},
'caustic':{'316SS':[.01,.05],'304SS':[.02,.1],'Duplex-SS':[.01,.04],'Hastelloy-C':[.005,.02],'Inconel-625':[.005,.02],'Monel-400':[.005,.02],'Titanium':[.5,2],'Carbon-Steel':[.05,.2],'Aluminum':[1,5],'Bronze':[.02,.1],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.01,.05],'PVC':[.05,.2],'CPVC':[.02,.1],'HDPE':[.02,.1],'UHMWPE':[.01,.05],'FKM':[.01,.05],'EPDM':[0,.02],'NBR':[.05,.2],'Kalrez':[0,.01]},
'ammonia':{'316SS':[.01,.05],'304SS':[.02,.1],'Duplex-SS':[.01,.04],'Hastelloy-C':[.005,.02],'Inconel-625':[.005,.02],'Monel-400':[.5,2],'Titanium':[.01,.05],'Carbon-Steel':[.1,.5],'Aluminum':[.05,.2],'Bronze':[.5,2],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.01,.05],'PVC':[.05,.2],'CPVC':[.02,.1],'HDPE':[.02,.1],'UHMWPE':[.01,.05],'FKM':[.02,.1],'EPDM':[0,.02],'NBR':[.1,.5],'Kalrez':[0,.01]},
'cyanide':{'316SS':[.01,.05],'304SS':[.02,.1],'Duplex-SS':[.01,.04],'Hastelloy-C':[.005,.02],'Inconel-625':[.005,.02],'Monel-400':[.01,.05],'Titanium':[.01,.05],'Carbon-Steel':[.1,.5],'Aluminum':[.2,1],'Bronze':[.05,.2],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.01,.05],'PVC':[.02,.1],'CPVC':[.01,.05],'HDPE':[.02,.1],'UHMWPE':[.01,.05],'FKM':[0,.02],'EPDM':[.02,.1],'NBR':[.1,.5],'Kalrez':[0,.01]},
'petroleum':{'316SS':[.001,.01],'304SS':[.002,.02],'Duplex-SS':[.001,.008],'Hastelloy-C':[.0005,.005],'Inconel-625':[.0005,.005],'Monel-400':[.001,.01],'Titanium':[.001,.01],'Carbon-Steel':[.01,.05],'Aluminum':[.005,.02],'Bronze':[.002,.01],'PTFE':[0,0],'PEEK':[0,0],'PVDF':[.01,.05],'PP':[.1,.5],'PVC':[.2,1],'CPVC':[.1,.5],'HDPE':[.1,.5],'UHMWPE':[.05,.2],'FKM':[0,.01],'EPDM':[.2,1],'NBR':[0,.02],'Kalrez':[0,0]},
'aromatic':{'316SS':[.001,.01],'304SS':[.002,.02],'Duplex-SS':[.001,.008],'Hastelloy-C':[.0005,.005],'Inconel-625':[.0005,.005],'Monel-400':[.001,.01],'Titanium':[.001,.01],'Carbon-Steel':[.01,.05],'Aluminum':[.01,.05],'Bronze':[.005,.02],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[.02,.1],'PP':[.5,2],'PVC':[1,5],'CPVC':[.5,2],'HDPE':[.5,2],'UHMWPE':[.2,1],'FKM':[0,.02],'EPDM':[1,5],'NBR':[.5,2],'Kalrez':[0,.01]},
'alcohol':{'316SS':[.001,.01],'304SS':[.002,.02],'Duplex-SS':[.001,.008],'Hastelloy-C':[.0005,.005],'Inconel-625':[.0005,.005],'Monel-400':[.001,.01],'Titanium':[.001,.01],'Carbon-Steel':[.02,.1],'Aluminum':[.01,.05],'Bronze':[.005,.02],'PTFE':[0,0],'PEEK':[0,0],'PVDF':[0,0],'PP':[0,.02],'PVC':[.05,.2],'CPVC':[.02,.1],'HDPE':[.02,.1],'UHMWPE':[.01,.05],'FKM':[0,.02],'EPDM':[0,.02],'NBR':[.05,.2],'Kalrez':[0,0]},
'chlorinated':{'316SS':[.02,.1],'304SS':[.05,.2],'Duplex-SS':[.01,.05],'Hastelloy-C':[.01,.05],'Inconel-625':[.01,.05],'Monel-400':[.02,.1],'Titanium':[.02,.1],'Carbon-Steel':[.5,2],'Aluminum':[.5,2],'Bronze':[.1,.5],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.02],'PP':[.5,2],'PVC':[.5,2],'CPVC':[.2,1],'HDPE':[.5,2],'UHMWPE':[.2,1],'FKM':[0,.02],'EPDM':[1,5],'NBR':[.5,2],'Kalrez':[0,.01]},
'slurry':{'316SS':[.1,.5],'304SS':[.2,1],'Duplex-SS':[.08,.3],'Hastelloy-C':[.05,.2],'Inconel-625':[.05,.2],'Monel-400':[.1,.5],'Titanium':[.05,.2],'Carbon-Steel':[.5,2],'Aluminum':[.3,1],'Bronze':[.1,.5],'PTFE':[.05,.2],'PEEK':[.02,.1],'PVDF':[.05,.2],'PP':[.1,.5],'PVC':[.2,1],'CPVC':[.1,.5],'HDPE':[.05,.2],'UHMWPE':[.02,.1],'FKM':[.05,.2],'EPDM':[.1,.5],'NBR':[.1,.5],'Kalrez':[.02,.1]},
'oxidizer':{'316SS':[.02,.1],'304SS':[.05,.2],'Duplex-SS':[.02,.08],'Hastelloy-C':[.01,.05],'Inconel-625':[.01,.05],'Monel-400':[.5,2],'Titanium':[.005,.02],'Carbon-Steel':[.5,2],'Aluminum':[.02,.1],'Bronze':[.1,.5],'PTFE':[0,0],'PEEK':[0,.01],'PVDF':[0,.01],'PP':[.1,.5],'PVC':[.2,1],'CPVC':[.1,.5],'HDPE':[.1,.5],'UHMWPE':[.05,.2],'FKM':[.02,.1],'EPDM':[.2,1],'NBR':[.2,1],'Kalrez':[0,.01]},
'food':{'316SS':[.001,.005],'304SS':[.002,.01],'Duplex-SS':[.001,.004],'Hastelloy-C':[.0005,.002],'Inconel-625':[.0005,.002],'Monel-400':[.001,.005],'Titanium':[.0005,.002],'Carbon-Steel':[.02,.1],'Aluminum':[.01,.05],'Bronze':[.005,.02],'PTFE':[0,0],'PEEK':[0,0],'PVDF':[0,0],'PP':[0,.01],'PVC':[0,.02],'CPVC':[0,.01],'HDPE':[0,.01],'UHMWPE':[0,.005],'FKM':[0,.01],'EPDM':[0,.01],'NBR':[0,.02],'Kalrez':[0,0]},
'glycol':{'316SS':[.001,.01],'304SS':[.002,.02],'Duplex-SS':[.001,.008],'Hastelloy-C':[.0005,.005],'Inconel-625':[.0005,.005],'Monel-400':[.001,.01],'Titanium':[.001,.01],'Carbon-Steel':[.02,.1],'Aluminum':[.01,.05],'Bronze':[.005,.02],'PTFE':[0,0],'PEEK':[0,0],'PVDF':[0,0],'PP':[0,.02],'PVC':[.02,.1],'CPVC':[.01,.05],'HDPE':[.01,.05],'UHMWPE':[.005,.02],'FKM':[0,.01],'EPDM':[0,.02],'NBR':[.02,.1],'Kalrez':[0,0]},
'bitumen':{'316SS':[.001,.01],'304SS':[.002,.02],'Duplex-SS':[.001,.008],'Hastelloy-C':[.0005,.005],'Inconel-625':[.0005,.005],'Monel-400':[.001,.01],'Titanium':[.001,.01],'Carbon-Steel':[.01,.05],'Aluminum':[.1,.5],'Bronze':[.005,.02],'PTFE':[0,0],'PEEK':[0,0],'PVDF':[.01,.05],'PP':[.2,1],'PVC':[.5,2],'CPVC':[.2,1],'HDPE':[.1,.5],'UHMWPE':[.02,.1],'FKM':[0,.01],'EPDM':[.5,2],'NBR':[0,.02],'Kalrez':[0,0]}
},
costs:{
'316SS':{price:4.50,wall:3.0},'304SS':{price:3.60,wall:3.0},'Duplex-SS':{price:8.50,wall:2.5},'Hastelloy-C':{price:85,wall:2.5},'Inconel-625':{price:75,wall:2.5},'Monel-400':{price:45,wall:2.5},'Titanium':{price:95,wall:2.0},'Carbon-Steel':{price:1.20,wall:4.0},'Aluminum':{price:3.00,wall:3.0},'Bronze':{price:12,wall:3.0},'PTFE':{price:28,wall:3.0},'PEEK':{price:120,wall:2.5},'PVDF':{price:22,wall:3.0},'PP':{price:3.50,wall:4.0},'PVC':{price:2.50,wall:4.0},'CPVC':{price:4.00,wall:4.0},'HDPE':{price:2.80,wall:4.0},'UHMWPE':{price:8.50,wall:4.0},'FKM':{price:18,wall:2.0},'EPDM':{price:8.00,wall:2.0},'NBR':{price:6.00,wall:2.0},'Kalrez':{price:350,wall:1.5}
}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V84: 4-LAYER FAILURE-MODE-FIRST COMPATIBILITY ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE PRINCIPLE: Material compatibility is governed by FAILURE MECHANISMS
// The engine answers: "What kills this material in this chemistry at this temperature?"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LAYER 1: CHEMICAL IDENTITY & REACTIVITY TRAITS
// Every fluid tagged with orthogonal chemical behavior traits
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FLUID_TRAIT_RULES={
  // Sulfuric Acid - concentration dependent behavior
  'h2so4':{
    getTraits:(conc,temp)=>{
      if(conc>=80)return{acidBase:'acid',oxidizing:temp>100?'mild':'none',reducing:'none',waterActivity:'dehydrating',electrochemical:'passivating_carbon_steel',organic:false,phaseRisk:['heat_evolving'],attacksAmphoteric:false,attacksNickel:true};
      if(conc>=50)return{acidBase:'acid',oxidizing:'none',reducing:'moderate',waterActivity:'aqueous',electrochemical:'depassivating',organic:false,phaseRisk:['heat_evolving'],attacksAmphoteric:false,attacksNickel:false};
      return{acidBase:'acid',oxidizing:'none',reducing:'strong',waterActivity:'aqueous',electrochemical:'depassivating',organic:false,phaseRisk:[],attacksAmphoteric:false,attacksNickel:false};
    }
  },
  // Hydrochloric Acid - always reducing, attacks passive films
  'hcl':{
    getTraits:(conc,temp)=>({acidBase:'acid',oxidizing:'none',reducing:'strong',waterActivity:'aqueous',electrochemical:'depassivating',organic:false,phaseRisk:['gas_evolving'],attacksAmphoteric:true,chloride:true,attacksStainless:conc>20||temp>40,attacksTitanium:false})
  },
  // Nitric Acid - concentration-dependent oxidizing power
  'hno3':{
    getTraits:(conc,temp)=>{
      let ox='mild';
      if(conc>=65)ox='strong';
      else if(conc>=40)ox='moderate';
      return{acidBase:'acid',oxidizing:ox,reducing:'none',waterActivity:'aqueous',electrochemical:'passivating',organic:false,phaseRisk:['nox_evolving'],attacksAmphoteric:false,attacksNickelAlloys:conc>=40,passivatesAluminum:conc<40&&temp<30,passivates316SS:conc<=70&&temp<=50};
    }
  },
  // Phosphoric Acid
  'h3po4':{
    getTraits:(conc,temp)=>({acidBase:'acid',oxidizing:'none',reducing:'mild',waterActivity:'aqueous',electrochemical:'mild_passivating',organic:false,phaseRisk:[],attacksAmphoteric:false})
  },
  // Hydrofluoric Acid - attacks glass, silicon, passivates stainless poorly
  'hf':{
    getTraits:(conc,temp)=>({acidBase:'acid',oxidizing:'none',reducing:'strong',waterActivity:'aqueous',electrochemical:'depassivating',organic:false,phaseRisk:['toxic','bone_seeking'],attacksAmphoteric:true,attacksGlass:true,attacksSilicon:true})
  },
  // Chromic Acid - extreme oxidizer
  'chromic':{
    getTraits:(conc,temp)=>({acidBase:'acid',oxidizing:'extreme',reducing:'none',waterActivity:'aqueous',electrochemical:'passivating',organic:false,phaseRisk:['carcinogenic'],attacksAmphoteric:false,attacksNickelAlloys:true,attacksOrganics:true})
  },
  // Sodium Hydroxide
  'naoh':{
    getTraits:(conc,temp)=>({acidBase:'base',oxidizing:'none',reducing:'none',waterActivity:conc>50?'dehydrating':'aqueous',electrochemical:'passivating',organic:false,phaseRisk:['crystallizing'],attacksAmphoteric:conc>=5,attacksGlass:conc>=30&&temp>60,causticSCC:conc>=25&&temp>=50})
  },
  // Potassium Hydroxide
  'koh':{
    getTraits:(conc,temp)=>({acidBase:'base',oxidizing:'none',reducing:'none',waterActivity:'aqueous',electrochemical:'passivating',organic:false,phaseRisk:['crystallizing'],attacksAmphoteric:conc>=5,causticSCC:conc>=25&&temp>=50})
  },
  // Ammonia/Ammonium Hydroxide
  'nh4oh':{
    getTraits:(conc,temp)=>({acidBase:'base',oxidizing:'none',reducing:'mild',waterActivity:'aqueous',electrochemical:'complexing',organic:false,phaseRisk:['gas_evolving'],attacksAmphoteric:false,attacksCopper:true,causticSCC:false})
  },
  // Hydrogen Peroxide
  'h2o2':{
    getTraits:(conc,temp)=>{
      let ox='mild';
      if(conc>=50)ox='strong';
      else if(conc>=30)ox='moderate';
      return{acidBase:'neutral',oxidizing:ox,reducing:'none',waterActivity:'aqueous',electrochemical:'passivating',organic:false,phaseRisk:['decomposing','oxygen_evolving'],attacksAmphoteric:false,attacksOrganics:conc>=30,attacksNickelAlloys:conc>=30};
    }
  },
  // Sodium Hypochlorite
  'hypochlorite':{
    getTraits:(conc,temp)=>({acidBase:'base',oxidizing:'moderate',reducing:'none',waterActivity:'aqueous',electrochemical:'passivating',organic:false,phaseRisk:['gas_evolving_if_acidified','chlorine_release'],chloride:true,attacksOrganics:true})
  },
  // Chloride salts
  'nacl':{
    getTraits:(conc,temp)=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'aqueous',electrochemical:'pitting_agent',organic:false,phaseRisk:['crystallizing'],chloride:true,pittingRisk:conc>3&&temp>25})
  },
  'cacl2':{
    getTraits:(conc,temp)=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'hygroscopic',electrochemical:'pitting_agent',organic:false,phaseRisk:['crystallizing'],chloride:true,pittingRisk:temp>30})
  },
  // Cyanide
  'cyanide':{
    getTraits:(conc,temp)=>({acidBase:'base',oxidizing:'none',reducing:'mild',waterActivity:'aqueous',electrochemical:'complexing',organic:false,phaseRisk:['toxic','gas_evolving_if_acidified'],attacksAmphoteric:false,attacksCopper:true})
  },
  // Aromatics
  'benzene':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'non_aqueous',electrochemical:'inert',organic:true,phaseRisk:['carcinogenic'],swellsElastomers:true,swellsThermoplastics:true,extractsPlasticizer:true})},
  'toluene':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'non_aqueous',electrochemical:'inert',organic:true,phaseRisk:[],swellsElastomers:true,swellsThermoplastics:true})},
  'xylene':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'non_aqueous',electrochemical:'inert',organic:true,phaseRisk:[],swellsElastomers:true,swellsThermoplastics:true})},
  // Ketones
  'acetone':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'aqueous',electrochemical:'inert',organic:true,phaseRisk:[],swellsElastomers:true,extractsPlasticizer:true,attacksFKM:true})},
  'mek':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'non_aqueous',electrochemical:'inert',organic:true,phaseRisk:[],swellsElastomers:true,extractsPlasticizer:true,attacksFKM:true})},
  // Alcohols
  'methanol':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'mild',waterActivity:'aqueous',electrochemical:'mild_depassivating',organic:true,phaseRisk:[],swellsElastomers:false})},
  'ethanol':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'aqueous',electrochemical:'inert',organic:true,phaseRisk:[],swellsElastomers:false})},
  // Chlorinated solvents
  'chlorinated':{getTraits:()=>({acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'non_aqueous',electrochemical:'inert',organic:true,phaseRisk:['hydrolysis_to_HCl'],swellsElastomers:true,extractsPlasticizer:true,chloride:false})}
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LAYER 2: MATERIAL FAILURE MODE TAXONOMY
// Every material declares HOW IT DIES - failure mechanisms, not corrosion rates
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAT_FAILURE_MODES={
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // METALS - Failure by corrosion mechanisms
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  '316SS':{
    type:'metal',class:'austenitic_stainless',
    failureModes:{
      'pitting':{triggers:['chloride>50ppm','oxidizer+chloride'],tempThreshold:30,severity:'localized',timeframe:'months'},
      'crevice_corrosion':{triggers:['chloride','stagnant_conditions','gasket_interface'],tempThreshold:25,severity:'localized',timeframe:'months'},
      'SCC':{triggers:['chloride+tensile_stress','caustic+tensile_stress'],tempThreshold:50,severity:'catastrophic',timeframe:'years'},
      'intergranular_corrosion':{triggers:['sensitization','oxidizing_acid+sensitized'],tempThreshold:425,severity:'structural',timeframe:'years'},
      'general_corrosion':{triggers:['reducing_acid','HCl>20%','H2SO4_hot_dilute'],tempThreshold:null,severity:'uniform',timeframe:'months'},
      'passive_film_breakdown':{triggers:['reducing_acid','high_chloride','low_pH+chloride'],tempThreshold:40,severity:'accelerating',timeframe:'weeks'}
    },
    strengths:['oxidizing_acids_dilute','nitric_to_70%','passivating_environments','neutral_aqueous','phosphoric'],
    industryStandard:['nitric_acid_storage','food_grade','pharmaceutical']
  },
  '304SS':{
    type:'metal',class:'austenitic_stainless',
    failureModes:{
      'pitting':{triggers:['chloride>25ppm'],tempThreshold:25,severity:'localized',timeframe:'months'},
      'crevice_corrosion':{triggers:['any_chloride','any_halide'],tempThreshold:20,severity:'localized',timeframe:'weeks'},
      'SCC':{triggers:['chloride+stress'],tempThreshold:40,severity:'catastrophic',timeframe:'years'},
      'intergranular_corrosion':{triggers:['oxidizing_acid','welding_sensitization'],tempThreshold:50,severity:'structural',timeframe:'years'},
      'general_corrosion':{triggers:['reducing_acid','any_acid>moderate_conc'],tempThreshold:null,severity:'uniform',timeframe:'months'}
    },
    strengths:['dilute_oxidizing_acid','atmospheric','water'],
    limitations:'Lower Mo content than 316SS - less chloride resistance'
  },
  'Hastelloy-C':{
    type:'metal',class:'nickel_alloy',
    failureModes:{
      'oxidation_attack':{triggers:['strong_oxidizer','nitric_acid>40%','chromic_acid','peroxide>30%'],tempThreshold:30,severity:'accelerating',timeframe:'days'},
      'localized_corrosion':{triggers:['oxidizing_environment','ferric_chloride','cupric_chloride'],tempThreshold:40,severity:'pitting',timeframe:'weeks'},
      'passive_film_instability':{triggers:['oxidizing_acid'],tempThreshold:50,severity:'accelerating',timeframe:'weeks'}
    },
    strengths:['reducing_acids','HCl_all_conc','H2SO4_to_70%','mixed_acids_reducing','wet_chlorine','phosphoric'],
    designedFor:'REDUCING acid service - Ni-Mo-Cr chemistry optimized for non-oxidizing environments',
    contraindicated:['nitric_acid','chromic_acid','hydrogen_peroxide>15%','ferric_salts','cupric_salts']
  },
  'Titanium':{
    type:'metal',class:'reactive_metal',
    failureModes:{
      'hydrogen_embrittlement':{triggers:['reducing_acid','cathodic_conditions','HF','galvanic_couple_in_acid'],tempThreshold:40,severity:'catastrophic',timeframe:'months'},
      'crevice_corrosion':{triggers:['hot_brine>70C','high_chloride+elevated_temp'],tempThreshold:70,severity:'localized',timeframe:'months'},
      'pyrophoric_reaction':{triggers:['red_fuming_nitric','anhydrous_methanol+halide','dry_chlorine'],tempThreshold:null,severity:'catastrophic',timeframe:'immediate'},
      'caustic_attack':{triggers:['strong_base>30%','NaOH','KOH','hot_caustic'],tempThreshold:50,severity:'accelerating',timeframe:'weeks'}
    },
    strengths:['oxidizing_acids','nitric_all_conc','wet_chlorine','hypochlorite','seawater','chlor_alkali'],
    designedFor:'OXIDIZING environments - TiO2 passive film is gold standard',
    industryStandard:['chlor_alkali','bleach_production','nitric_acid_service'],
    contraindicated:['strong_caustic','NaOH>30%','KOH>30%','reducing_acids','HF']
  },
  'Carbon-Steel':{
    type:'metal',class:'ferrous',
    failureModes:{
      'general_corrosion':{triggers:['any_acid','any_oxidizer','aerated_water','seawater'],tempThreshold:null,severity:'uniform',timeframe:'months'},
      'SCC':{triggers:['caustic>30%','H2S','nitrate_solution','amine'],tempThreshold:50,severity:'catastrophic',timeframe:'years'},
      'hydrogen_embrittlement':{triggers:['acid+high_hardness','H2S','cathodic_overprotection'],tempThreshold:null,severity:'catastrophic',timeframe:'months'},
      'erosion_corrosion':{triggers:['high_velocity','slurry','two_phase_flow'],tempThreshold:null,severity:'accelerating',timeframe:'months'}
    },
    strengths:['concentrated_H2SO4>93%','anhydrous_ammonia','dry_chlorine','caustic<50%_ambient'],
    limitations:'No passive film - relies on specific chemistry or inhibitors'
  },
  'Aluminum':{
    type:'metal',class:'amphoteric',
    failureModes:{
      'general_dissolution':{triggers:['strong_base_pH>9','strong_acid_reducing_pH<4'],tempThreshold:null,severity:'rapid',timeframe:'hours'},
      'pitting':{triggers:['chloride','halide','heavy_metal_ion'],tempThreshold:25,severity:'localized',timeframe:'weeks'},
      'passivation_breakdown':{triggers:['oxidizing_acid>40%','high_pH>8.5'],tempThreshold:30,severity:'accelerating',timeframe:'days'},
      'galvanic_corrosion':{triggers:['contact_with_noble_metal','copper_contamination'],tempThreshold:null,severity:'rapid',timeframe:'days'}
    },
    strengths:['dilute_nitric<40%','concentrated_nitric_cold_fumeless','glacial_acetic','anhydrous_ammonia','atmospheric'],
    passivationWindow:'Stable Al2O3 film in pH 4-8.5 and dilute oxidizers',
    hardLimit:'NEVER use above 40% HNO3 or in any strong base'
  },
  'Duplex-SS':{
    type:'metal',class:'duplex_stainless',
    failureModes:{
      'pitting':{triggers:['chloride>200ppm','oxidizer+chloride'],tempThreshold:50,severity:'localized',timeframe:'months'},
      'crevice_corrosion':{triggers:['chloride','stagnant_conditions'],tempThreshold:40,severity:'localized',timeframe:'months'},
      'SCC':{triggers:['chloride+high_stress','H2S'],tempThreshold:60,severity:'catastrophic',timeframe:'years'},
      'sigma_phase':{triggers:['temp_300-550C_prolonged'],tempThreshold:300,severity:'embrittlement',timeframe:'months'}
    },
    strengths:['chloride_environments','seawater','oxidizing_acids','caustic','sour_service'],
    designedFor:'High chloride and sour environments - superior to 316SS'
  },
  'Monel-400':{
    type:'metal',class:'nickel_copper',
    failureModes:{
      'SCC':{triggers:['HF+stress','aerated_HF'],tempThreshold:null,severity:'catastrophic',timeframe:'months'},
      'sulfidation':{triggers:['H2S>260C','sulfur_compounds'],tempThreshold:260,severity:'accelerating',timeframe:'months'},
      'oxidation':{triggers:['air>500C'],tempThreshold:500,severity:'scaling',timeframe:'months'}
    },
    strengths:['HF_all_concentrations','seawater','reducing_acids','caustic','brine'],
    designedFor:'HF service - industry standard',
    industryStandard:['HF_alkylation','hydrofluoric_acid_production']
  },
  'Inconel-625':{
    type:'metal',class:'nickel_superalloy',
    failureModes:{
      'pitting':{triggers:['high_chloride+oxidizer'],tempThreshold:70,severity:'localized',timeframe:'months'},
      'oxidation':{triggers:['temp>980C'],tempThreshold:980,severity:'scaling',timeframe:'months'},
      'age_hardening_embrittlement':{triggers:['650-850C_prolonged'],tempThreshold:650,severity:'structural',timeframe:'years'}
    },
    strengths:['high_temp_oxidation','seawater','reducing_acids','oxidizing_acids','caustic','high_temp_steam'],
    designedFor:'High temperature and aggressive environments'
  },
  'Bronze':{
    type:'metal',class:'copper_alloy',
    failureModes:{
      'dezincification':{triggers:['stagnant_water','low_flow'],tempThreshold:30,severity:'selective',timeframe:'years'},
      'ammonia_SCC':{triggers:['ammonia','amine','NH3>1ppm'],tempThreshold:null,severity:'catastrophic',timeframe:'months'},
      'acid_attack':{triggers:['mineral_acid','oxidizing_acid'],tempThreshold:null,severity:'general',timeframe:'weeks'}
    },
    strengths:['seawater','neutral_water','petroleum','dilute_sulfuric','phosphoric'],
    limitations:'NO ammonia, NO amines, NO oxidizing acids'
  },
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PLASTICS - Failure by degradation mechanisms
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  'PTFE':{
    type:'plastic',class:'fluoropolymer',
    failureModes:{
      'cold_flow':{triggers:['high_mechanical_load','sustained_compression'],tempThreshold:150,severity:'dimensional',timeframe:'months'},
      'permeation':{triggers:['small_molecules','HF','fluorine'],tempThreshold:100,severity:'minor',timeframe:'ongoing'},
      'thermal_degradation':{triggers:['temp>260C'],tempThreshold:260,severity:'toxic_fumes',timeframe:'immediate'}
    },
    strengths:['universal_chemical_resistance','all_acids','all_bases','all_solvents','all_oxidizers'],
    limitations:'Mechanical properties - creep under load, not structural'
  },
  'PVDF':{
    type:'plastic',class:'fluoropolymer',
    failureModes:{
      'stress_cracking':{triggers:['strong_base>20%','amine','caustic+stress'],tempThreshold:40,severity:'cracking',timeframe:'weeks'},
      'swelling':{triggers:['ketone','ester','strong_amine'],tempThreshold:30,severity:'dimensional',timeframe:'days'},
      'thermal_softening':{triggers:['temp>140C'],tempThreshold:140,severity:'structural',timeframe:'immediate'}
    },
    strengths:['acids','oxidizers','chlorine','halogens','most_solvents'],
    limitations:'Not for strong bases >20% or amines'
  },
  'PP':{
    type:'plastic',class:'polyolefin',
    failureModes:{
      'oxidative_degradation':{triggers:['strong_oxidizer','UV','ozone'],tempThreshold:25,severity:'embrittlement',timeframe:'months'},
      'stress_cracking':{triggers:['aromatic_solvent','chlorinated_solvent','surfactant'],tempThreshold:30,severity:'cracking',timeframe:'weeks'},
      'thermal_softening':{triggers:['temp>80C'],tempThreshold:80,severity:'structural',timeframe:'immediate'},
      'swelling':{triggers:['hydrocarbon','aromatic'],tempThreshold:40,severity:'dimensional',timeframe:'days'}
    },
    strengths:['dilute_acids','dilute_bases','aqueous_salt','water'],
    limitations:'Poor oxidizer resistance, poor solvent resistance, low temp limit'
  },
  'PVC':{
    type:'plastic',class:'vinyl',
    failureModes:{
      'plasticizer_extraction':{triggers:['aromatic','ketone','ester','chlorinated_solvent'],tempThreshold:25,severity:'embrittlement',timeframe:'weeks'},
      'dehydrochlorination':{triggers:['strong_base','amine','heat'],tempThreshold:40,severity:'degradation',timeframe:'months'},
      'thermal_softening':{triggers:['temp>60C'],tempThreshold:60,severity:'structural',timeframe:'immediate'},
      'stress_cracking':{triggers:['solvent+mechanical_stress'],tempThreshold:30,severity:'cracking',timeframe:'weeks'}
    },
    strengths:['dilute_acids','dilute_bases','water','aqueous_salts'],
    limitations:'60Â°C max, no solvents, no strong bases'
  },
  'CPVC':{
    type:'plastic',class:'vinyl',
    failureModes:{
      'stress_cracking':{triggers:['aromatic','ester','ketone'],tempThreshold:40,severity:'cracking',timeframe:'weeks'},
      'thermal_softening':{triggers:['temp>95C'],tempThreshold:95,severity:'structural',timeframe:'immediate'},
      'chemical_attack':{triggers:['strong_base>50%'],tempThreshold:50,severity:'degradation',timeframe:'months'}
    },
    strengths:['acids','chlorine','hot_water','dilute_oxidizers','hypochlorite'],
    limitations:'No aromatics, esters, ketones'
  },
  'HDPE':{
    type:'plastic',class:'polyolefin',
    failureModes:{
      'environmental_stress_cracking':{triggers:['surfactant','detergent','wetting_agent'],tempThreshold:30,severity:'cracking',timeframe:'months'},
      'swelling':{triggers:['hydrocarbon','aromatic','chlorinated_solvent'],tempThreshold:40,severity:'dimensional',timeframe:'weeks'},
      'oxidative_degradation':{triggers:['strong_oxidizer'],tempThreshold:25,severity:'embrittlement',timeframe:'months'},
      'thermal_softening':{triggers:['temp>80C'],tempThreshold:80,severity:'structural',timeframe:'immediate'}
    },
    strengths:['dilute_acids','dilute_bases','water','aqueous'],
    limitations:'No hydrocarbons, no oxidizers, 80Â°C max'
  },
  'PEEK':{
    type:'plastic',class:'high_performance',
    failureModes:{
      'stress_cracking':{triggers:['concentrated_sulfuric','concentrated_nitric'],tempThreshold:100,severity:'cracking',timeframe:'weeks'},
      'thermal_degradation':{triggers:['temp>250C'],tempThreshold:250,severity:'structural',timeframe:'immediate'},
      'hydrolysis':{triggers:['steam>200C_prolonged'],tempThreshold:200,severity:'degradation',timeframe:'months'}
    },
    strengths:['acids','bases','solvents','hydrocarbons','high_temp','steam<180C','radiation'],
    designedFor:'High performance applications requiring chemical and thermal resistance'
  },
  'UHMWPE':{
    type:'plastic',class:'polyolefin',
    failureModes:{
      'oxidative_degradation':{triggers:['strong_oxidizer','chlorine','ozone'],tempThreshold:25,severity:'embrittlement',timeframe:'months'},
      'thermal_softening':{triggers:['temp>80C'],tempThreshold:80,severity:'structural',timeframe:'immediate'},
      'swelling':{triggers:['aromatic_hydrocarbon','chlorinated_solvent'],tempThreshold:40,severity:'dimensional',timeframe:'weeks'},
      'creep':{triggers:['sustained_high_load'],tempThreshold:60,severity:'dimensional',timeframe:'months'}
    },
    strengths:['abrasion_resistance','slurry','dilute_acids','dilute_bases','water'],
    designedFor:'Abrasive slurry service and wear applications'
  },
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ELASTOMERS - Failure by degradation/swelling mechanisms
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  'FKM':{
    type:'elastomer',class:'fluoroelastomer',
    failureModes:{
      'swelling':{triggers:['ketone','ester','amine','low_MW_ester','MEK','acetone'],tempThreshold:null,severity:'seal_failure',timeframe:'days'},
      'hardening':{triggers:['amine','ammonia','steam>150C'],tempThreshold:60,severity:'embrittlement',timeframe:'months'},
      'compression_set':{triggers:['high_temp_cycling','steam'],tempThreshold:150,severity:'seal_failure',timeframe:'months'}
    },
    strengths:['hydrocarbon','aromatic','chlorinated_solvent','mineral_acid','petroleum','fuel','oil'],
    limitations:'NO ketones, NO amines, NO steam >150Â°C'
  },
  'EPDM':{
    type:'elastomer',class:'ethylene_propylene',
    failureModes:{
      'swelling':{triggers:['hydrocarbon','aromatic','petroleum','mineral_oil','fuel'],tempThreshold:null,severity:'seal_failure',timeframe:'hours'},
      'oxidative_degradation':{triggers:['strong_oxidizer','ozone','chlorine'],tempThreshold:25,severity:'cracking',timeframe:'weeks'}
    },
    strengths:['water','steam','dilute_acid','dilute_base','ketone','alcohol','glycol','brake_fluid'],
    limitations:'NO petroleum, NO aromatics, NO oils'
  },
  'NBR':{
    type:'elastomer',class:'nitrile',
    failureModes:{
      'swelling':{triggers:['aromatic','ketone','ester','chlorinated_solvent','strong_acid'],tempThreshold:null,severity:'seal_failure',timeframe:'days'},
      'oxidative_degradation':{triggers:['oxidizer','ozone','UV','weathering'],tempThreshold:25,severity:'cracking',timeframe:'months'},
      'hardening':{triggers:['oxidizing_acid','strong_acid'],tempThreshold:40,severity:'embrittlement',timeframe:'months'}
    },
    strengths:['petroleum','aliphatic_hydrocarbon','mineral_oil','dilute_acid','water'],
    limitations:'Poor ozone resistance, no aromatics, no ketones'
  },
  'Kalrez':{
    type:'elastomer',class:'perfluoroelastomer',
    failureModes:{
      'amine_attack':{triggers:['strong_amine','hydrazine','ethylene_diamine'],tempThreshold:100,severity:'degradation',timeframe:'months'},
      'compression_set':{triggers:['extreme_temp_cycling>300C'],tempThreshold:275,severity:'seal_failure',timeframe:'years'}
    },
    strengths:['universal','all_acids','all_bases','all_solvents','steam','oxidizers','amines<100C'],
    limitations:'Cost, strong amines at high temp'
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LAYER 3: TEMPERATURE-ACTIVATED FAILURE MODE RULES
// Temperature is a FAILURE MODE ACTIVATOR, not a gradual score modifier
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TEMP_ACTIVATION={
  // Metals - SCC and embrittlement thresholds
  'SCC_austenitic':{materials:['316SS','304SS'],temp:50,mode:'SCC',conditions:'chloride or caustic + tensile stress',consequence:'Sudden brittle failure without warning'},
  'SCC_carbon_steel':{materials:['Carbon-Steel'],temp:50,mode:'SCC',conditions:'caustic>30% or nitrate or amine',consequence:'Intergranular cracking, catastrophic failure'},
  'H2_embrittlement_steel':{materials:['Carbon-Steel'],temp:null,mode:'hydrogen_embrittlement',conditions:'acid + high hardness or H2S',consequence:'Delayed cracking, brittle failure'},
  'H2_embrittlement_Ti':{materials:['Titanium'],temp:40,mode:'hydrogen_embrittlement',conditions:'reducing acid or cathodic protection',consequence:'Hydride formation, embrittlement'},
  'pitting_activation_316':{materials:['316SS'],temp:30,mode:'pitting',conditions:'chloride>50ppm',consequence:'Localized perforation'},
  'pitting_activation_304':{materials:['304SS'],temp:25,mode:'pitting',conditions:'chloride>25ppm',consequence:'Localized perforation'},
  'crevice_Ti':{materials:['Titanium'],temp:70,mode:'crevice_corrosion',conditions:'hot concentrated brine',consequence:'Under-deposit attack'},
  'passivation_Al_breakdown':{materials:['Aluminum'],temp:30,mode:'passivation_breakdown',conditions:'oxidizing acid>40%',consequence:'Runaway pitting corrosion'},
  // Plastics - softening/degradation thresholds (HARD LIMITS)
  'PVC_softening':{materials:['PVC'],temp:60,mode:'thermal_softening',conditions:'any',consequence:'Structural failure, deformation'},
  'PP_softening':{materials:['PP','HDPE'],temp:80,mode:'thermal_softening',conditions:'any',consequence:'Structural failure, deformation'},
  'CPVC_softening':{materials:['CPVC'],temp:95,mode:'thermal_softening',conditions:'any',consequence:'Structural failure'},
  'PVDF_softening':{materials:['PVDF'],temp:140,mode:'thermal_softening',conditions:'any',consequence:'Structural failure'},
  'PTFE_creep':{materials:['PTFE'],temp:150,mode:'cold_flow',conditions:'mechanical load',consequence:'Dimensional instability, seal extrusion'},
  // Elastomers - degradation acceleration
  'EPDM_oxidation':{materials:['EPDM'],temp:25,mode:'oxidative_degradation',conditions:'oxidizer present',consequence:'Surface cracking, hardening'},
  'NBR_hardening':{materials:['NBR'],temp:40,mode:'hardening',conditions:'acid or oxidizer',consequence:'Loss of elasticity, cracking'},
  'FKM_set':{materials:['FKM'],temp:150,mode:'compression_set',conditions:'cycling or steam',consequence:'Permanent deformation, seal failure'},
  // Plasticizer extraction acceleration
  'PVC_extraction':{materials:['PVC'],temp:40,mode:'plasticizer_extraction',conditions:'organic solvent',consequence:'Embrittlement, cracking'}
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LAYER 4: COMPATIBILITY ENGINE - Classification & Resolution
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function evaluateCompatibilityV84(materialId,fluidKey,tempC,concentration){
  const mat=MAT_FAILURE_MODES[materialId];
  if(!mat)return{classification:'UNKNOWN',reason:'No failure mode data for material',confidence:0,excluded:false,tempActivations:[],failureModes:[],activeTriggers:[],mitigations:[],monitoring:[],rationale:[],chemicalResistance:'unknown',industrialSuitability:'unknown'};

  // Get fluid traits
  const traits=getFluidTraitsV84(fluidKey,concentration,tempC);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V84 FIX #2: SEPARATE CHEMICAL RESISTANCE FROM INDUSTRIAL SUITABILITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const result={
    classification:'OK',
    chemicalResistance:'excellent',  // excellent | limited | none
    industrialSuitability:'acceptable', // acceptable | conditional | prohibited
    excluded:false,  // V84 FIX #1: Hard exclusion flag
    exclusionReason:'',
    failureModes:[],
    activeTriggers:[],
    tempActivations:[],
    mitigations:[],
    monitoring:[],
    confidence:{dataQuality:0.85,tempCoverage:0.90,concCoverage:0.85,fieldHistory:0.80,failureModeClarity:0.90},
    rationale:[]
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V84 FIX #5: DESIGN INTENT CHECK - "DESIGNED FOR" OVERRIDES CORROSION RATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const DESIGN_INTENT={
    '316SS':'oxidizing','304SS':'oxidizing',
    'Hastelloy-C':'reducing',
    'Titanium':'oxidizing',
    'Carbon-Steel':'general',
    'Aluminum':'passivating'
  };
  const matIntent=DESIGN_INTENT[materialId]||'general';

  // Rule: If fluid is strong oxidizer and material designed for reducing â†’ PROHIBITED
  if((traits.oxidizing==='strong'||traits.oxidizing==='extreme')&&matIntent==='reducing'){
    return hardExclude(materialId,'design_intent_mismatch',
      `${materialId} designed for REDUCING service, not oxidizing`,
      `Alloy chemistry optimized for ${matIntent} environments - destabilizes in oxidizing conditions`,
      'Use Titanium or 316SS for oxidizing service');
  }

  // Rule: If fluid is strong reducer and material designed for oxidizing (Titanium specific)
  if(traits.reducing==='strong'&&traits.acidBase==='acid'&&matIntent==='oxidizing'&&materialId==='Titanium'){
    return hardExclude(materialId,'design_intent_mismatch',
      'Titanium designed for OXIDIZING service - hydrogen embrittlement in reducers',
      'TiOâ‚‚ passive film requires oxidizing environment; reducing acids cause hydride formation',
      'Use Hastelloy-C for reducing acid service');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V84 FIX #4: GLOBAL ELASTOMER OXIDIZER RULE
  // Elastomers are PROHIBITED in strong oxidizers unless explicitly certified
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if(mat.type==='elastomer'&&(traits.oxidizing==='strong'||traits.oxidizing==='extreme'||traits.attacksOrganics)){
    // Only Kalrez (FFKM) and PTFE-based materials may be conditional
    if(materialId==='Kalrez'){
      result.chemicalResistance='limited';
      result.industrialSuitability='conditional';
      result.classification='CONDITIONAL';
      result.failureModes.push('oxidative_stress');
      result.mitigations.push('Verify FFKM grade certified for specific oxidizer');
      result.mitigations.push('Reduce temperature to extend service life');
      result.monitoring.push('Visual inspection quarterly');
      result.rationale.push('[V84] Kalrez FFKM may resist oxidizers but requires grade verification');
    }else{
      // ALL OTHER ELASTOMERS: HARD EXCLUDE
      return hardExclude(materialId,'elastomer_oxidizer_prohibition',
        'Elastomers prohibited in strong oxidizers - chain scission failure',
        'Oxidative attack cleaves polymer backbone (C-C bonds) â†’ rapid embrittlement, cracking, catastrophic seal failure',
        'Use Kalrez (FFKM) with verified grade, or PTFE for static sealing',
        'RULE-CHEM-104');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HARD EXCLUSION GATES - These REMOVE materials entirely (V84 FIX #1)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Gate 1: Amphoteric metals in base
  if(materialId==='Aluminum'&&traits.attacksAmphoteric){
    return hardExclude(materialId,'amphoteric_dissolution',
      'Aluminum dissolves in alkaline solutions (pH>9)',
      'Al + OHâ» + Hâ‚‚O â†’ Al(OH)â‚„â» + Hâ‚‚ - amphoteric metal reacts with base',
      'Use 316SS, Hastelloy-C, or carbon steel for caustic service',
      'RULE-CHEM-101');
  }

  // V90 FIX #1: Aluminum POLICY RESTRICTION for oxidizer/fertilizer service
  // This is POLICY-DRIVEN, not purely corrosion-driven
  const v90Flags = getFluidBehaviorProfile(fluidKey, tempC).flags;
  const isOxidizerOrEnergetic = v90Flags.includes('OXIDIZER_STRONG') || v90Flags.includes('OXIDIZER_ADJACENT') || v90Flags.includes('ENERGETIC');
  const isFertilizerIndustry = v90Flags.includes('FERTILIZER_INDUSTRY');

  if(materialId==='Aluminum' && (isOxidizerOrEnergetic || isFertilizerIndustry)){
    // Aluminum + nitrates + moisture + heat â†’ pitting risk
    // Industry policy restricts Aluminum due to:
    // - Contamination sensitivity
    // - Decomposition catalysis concerns
    // - Fire/explosion risk in upset conditions
    result.chemicalResistance = 'limited';
    result.industrialSuitability = 'conditional';
    result.classification = 'CONDITIONAL';
    result.failureModes.push('industry_policy_restriction');
    result.activeTriggers.push('Oxidizer/fertilizer safety policy');
    result.rationale.push('[V90 POLICY] Aluminum restricted in oxidizer/fertilizer service: contamination sensitivity, decomposition catalysis, fire/explosion risk in upset conditions. Most fertilizer standards avoid Aluminum.');
    result.mitigations.push('Use 316SS or carbon steel (with purity controls) instead');
    result.monitoring.push('If Aluminum used: strict contamination control, temperature monitoring, no stagnation');

    // Add audit entry
    addAuditEntry('RULE-REG-402', materialId, fluidKey, tempC, 'CONDITIONAL', 'Industry-restricted due to oxidizer/fertilizer safety policy');
  }

  // Gate 2: Aluminum in oxidizing acid - V84 FIX #6: Passivation â‰  Permission
  if(materialId==='Aluminum'&&traits.oxidizing!=='none'&&traits.acidBase==='acid'){
    // Passivation-dependent materials need ALL conditions met
    const concOK=concentration<40;
    const tempOK=tempC<30;
    const noContaminants=!traits.chloride&&!fluidKey.includes('chloride');

    if(!concOK||!tempOK||!noContaminants){
      return hardExclude(materialId,'passivation_conditions_violated',
        'Aluminum passivation requires: conc<40%, temp<30Â°C, no chlorides',
        `Current: ${concentration}% @ ${tempC}Â°C ${traits.chloride?'+ chlorides':''} - Alâ‚‚Oâ‚ƒ film unstable`,
        'Use Titanium (stable passive film) or 316SS');
    }
    // Even if conditions met, still CONDITIONAL not OK
    result.chemicalResistance='limited';
    result.industrialSuitability='conditional';
    result.classification='CONDITIONAL';
    result.failureModes.push('passivation_dependent');
    result.mitigations.push('Monitor for any chloride contamination');
    result.mitigations.push('Never exceed 40% concentration');
    result.monitoring.push('Temperature monitoring mandatory');
  }

  // Gate 3: Carbon steel in oxidizers (except conc H2SO4)
  if(materialId==='Carbon-Steel'&&(traits.oxidizing==='strong'||traits.oxidizing==='moderate')){
    const isPassivatingH2SO4=fluidKey.includes('h2so4')&&concentration>=93;
    if(!isPassivatingH2SO4){
      return hardExclude(materialId,'no_passive_film',
        'Carbon steel lacks passive film protection in oxidizers',
        'Fe â†’ FeÂ²âº/FeÂ³âº rapid dissolution in oxidizing environment - no self-healing oxide layer',
        'Use 316SS (passive film) or Titanium (superior passive film)');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V15.2 FIX: Â§12.2 FLUORIDE ACIDS (HF) - EXPLICIT HARD GATES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const isHF = fluidKey.includes('hf-') || fluidKey === 'hf' || fluidKey.includes('fluoride') || 
               fluidKey.includes('bifluoride') || fluidKey.includes('ammonium-fluoride');
  
  // V15 Â§12.2: Ferrous metals FAIL in HF
  if (isHF && (materialId === 'Carbon-Steel' || materialId === '304SS')) {
    return hardExclude(materialId, 'HF_ferrous_attack',
      'V15 Â§12.2: Ferrous metals FAIL in HF service',
      'HF rapidly attacks iron-based alloys - produces soluble FeFâ‚‚/FeFâ‚ƒ, no protective film forms',
      'Use Hastelloy-C, Monel, or high-Ni alloys (>60% Ni)', 'RULE-HF-001');
  }

  // V15 Â§12.2: Titanium CONDITIONAL or FAIL in HF
  if (isHF && materialId === 'Titanium') {
    if (concentration >= 5 || tempC >= 25) {
      return hardExclude(materialId, 'HF_titanium_attack',
        'V15 Â§12.2: Titanium FAIL in HF >5% or >25Â°C',
        'HF dissolves TiOâ‚‚ passive film - Ti + 4HF â†’ TiFâ‚„ + 2Hâ‚‚ - violent reaction at higher conc/temp',
        'Use Hastelloy-C or Monel for HF service', 'RULE-HF-002');
    }
    // Below threshold: CONDITIONAL
    result.classification = 'CONDITIONAL';
    result.failureModes.push('HF_conditional');
    result.rationale.push('[V15 Â§12.2] Titanium CONDITIONAL in dilute HF <5% at <25Â°C - passive film marginally stable');
    result.mitigations.push('Strict concentration and temperature control');
    result.monitoring.push('Continuous HF concentration monitoring required');
  }

  // V15 Â§12.2: Elastomers FAIL unless explicitly rated
  const elastomers = ['FKM', 'EPDM', 'NBR', 'Neoprene', 'Silicone'];
  if (isHF && elastomers.includes(materialId)) {
    // Only Kalrez (FFKM) and some specialized compounds resist HF
    if (materialId !== 'Kalrez') {
      return hardExclude(materialId, 'HF_elastomer_attack',
        'V15 Â§12.2: Elastomers FAIL in HF unless explicitly rated',
        'HF attacks most elastomer compounds - only FFKM (Kalrez) and specialized compounds suitable',
        'Use Kalrez (FFKM) or PTFE for HF elastomer service', 'RULE-HF-003');
    }
  }

  // V15 Â§12.2: 316SS - CONDITIONAL in HF with strict limits
  if (isHF && materialId === '316SS') {
    if (concentration >= 10 || tempC >= 40) {
      return hardExclude(materialId, 'HF_316SS_limit',
        'V15 Â§12.2: 316SS exceeds HF service limits',
        '316SS only suitable for dilute HF <10% at <40Â°C - pitting attack above limits',
        'Use Hastelloy-C or Monel for concentrated HF', 'RULE-HF-004');
    }
    result.classification = 'CONDITIONAL';
    result.failureModes.push('HF_conditional');
    result.rationale.push('[V15 Â§12.2] 316SS CONDITIONAL in dilute HF <10% at <40Â°C');
    result.mitigations.push('Monthly thickness monitoring required');
  }

  // Gate 4: FKM in ketones/amines
  if(materialId==='FKM'&&(traits.attacksFKM||fluidKey.includes('acetone')||fluidKey.includes('mek')||fluidKey.includes('amine'))){
    return hardExclude(materialId,'chemical_attack',
      'FKM incompatible with ketones and amines',
      'Polar solvents cause severe swelling and chemical attack on fluoroelastomer backbone',
      'Use EPDM for ketones, Kalrez for universal service');
  }

  // Gate 5: EPDM in hydrocarbons
  if(materialId==='EPDM'&&(fluidKey.includes('benzene')||fluidKey.includes('toluene')||fluidKey.includes('petroleum')||fluidKey.includes('oil')||fluidKey.includes('fuel')||fluidKey.includes('diesel')||fluidKey.includes('gasoline'))){
    return hardExclude(materialId,'solvent_swelling',
      'EPDM swells rapidly in hydrocarbons/aromatics',
      'Non-polar hydrocarbon absorbs into EPDM matrix â†’ 50-200% volume swell â†’ seal extrusion',
      'Use FKM (Viton) for hydrocarbon service, NBR for petroleum');
  }

  // Gate 6: NBR in aromatics/ketones
  if(materialId==='NBR'&&(traits.extractsPlasticizer||fluidKey.includes('benzene')||fluidKey.includes('toluene')||fluidKey.includes('acetone'))){
    return hardExclude(materialId,'solvent_attack',
      'NBR incompatible with aromatics and ketones',
      'Aromatic solvents extract plasticizers and swell nitrile rubber',
      'Use FKM for aromatics, EPDM for ketones');
  }

  // V90 FIX #3: Carbon Steel FERTILIZER ENGINEERING NOTE
  // Carbon steel CAN be used for ammonium nitrate, but ONLY under controlled conditions
  const v90CSFlags = getFluidBehaviorProfile(fluidKey, tempC).flags;
  const v90CSIsFertilizer = v90CSFlags.includes('FERTILIZER_INDUSTRY') || v90CSFlags.includes('OXIDIZER_ADJACENT');

  if(materialId === 'Carbon-Steel' && v90CSIsFertilizer) {
    // Don't exclude, but add mandatory engineering constraints
    result.industrialSuitability = 'conditional';
    result.classification = 'CONDITIONAL';
    result.failureModes.push('contamination_sensitive');
    result.failureModes.push('purity_dependent');
    result.activeTriggers.push('Fertilizer industry constraints');
    result.rationale.push('[V90 POLICY] Carbon steel acceptable in fertilizer/oxidizer service ONLY under controlled conditions: no chlorides, no copper contamination, strict temperature control, no acidic impurities, no stagnation zones. Not suitable for upset or storage without monitoring.');
    result.mitigations.push('Maintain strict purity control - chlorides, copper, acidic impurities');
    result.mitigations.push('Temperature monitoring mandatory - thermal decomposition risk');
    result.mitigations.push('Avoid stagnation zones - localized corrosion');
    result.mitigations.push('Not suitable for long-term storage without inspection program');
    result.monitoring.push('Periodic inspection for localized corrosion');
    result.monitoring.push('Water quality monitoring if moisture present');

    // Add audit entry
    addAuditEntry('RULE-REG-402', materialId, fluidKey, tempC, 'CONDITIONAL', 'Carbon steel requires fertilizer purity and contamination controls');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V84 FIX #3: TEMPERATURE MODE SWITCHES (NOT GRADUAL PENALTIES)
  // Temperature ACTIVATES or DEACTIVATES failure modes - no interpolation
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const TEMP_MODES={
    // Stainless steel in chloride
    'SS_chloride':{
      materials:['316SS','304SS'],
      trigger:()=>traits.chloride,
      T1:25,T2:50,
      failureMode:'pitting_SCC',
      lowAction:()=>{result.chemicalResistance='limited';result.industrialSuitability='conditional';result.classification='CONDITIONAL';result.failureModes.push('pitting_risk');result.mitigations.push('Limit chloride to <50ppm');},
      midAction:()=>{result.chemicalResistance='limited';result.industrialSuitability='conditional';result.classification='CONDITIONAL';result.failureModes.push('pitting','crevice_attack');result.tempActivations.push({mode:'SCC_activation',threshold:50,actual:tempC});result.mitigations.push('Avoid crevices','Consider duplex upgrade');result.monitoring.push('UT inspection annually');},
      highAction:()=>{return hardExclude(materialId,'SCC_threshold_exceeded','SCC threshold exceeded: chloride + >50Â°C','Stress corrosion cracking active above 50Â°C in chloride environments','Use duplex stainless, Hastelloy-C, or Titanium','RULE-SCC-302');}
    },
    // Stainless steel in oxidizing acid at high temp
    'SS_oxidizing_acid':{
      materials:['316SS','304SS'],
      trigger:()=>traits.oxidizing!=='none'&&traits.acidBase==='acid',
      T1:25,T2:50,
      failureMode:'passive_film_instability',
      lowAction:()=>{/* OK at low temp */},
      midAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('passive_film_instability');result.mitigations.push('Monitor corrosion rate');},
      highAction:()=>{result.chemicalResistance='limited';result.industrialSuitability='conditional';result.classification='CONDITIONAL';result.failureModes.push('accelerated_corrosion');result.monitoring.push('UT thickness survey every 6 months');}
    },
    // Caustic + carbon steel
    'CS_caustic':{
      materials:['Carbon-Steel'],
      trigger:()=>traits.acidBase==='base'&&concentration>=25,
      T1:40,T2:50,
      failureMode:'caustic_SCC',
      lowAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('caustic_embrittlement_risk');result.mitigations.push('PWHT mandatory for welds');},
      midAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('SCC_zone');result.tempActivations.push({mode:'Caustic_SCC',threshold:50,actual:tempC});result.mitigations.push('Stress relief all welds','Limit hardness <200 BHN');result.monitoring.push('AE monitoring recommended');},
      highAction:()=>{return hardExclude(materialId,'caustic_SCC_zone','Caustic SCC zone: >50Â°C + >25% alkali','Carbon steel suffers intergranular SCC in hot caustic - catastrophic failure mode','Use 316SS or Hastelloy-C','RULE-SCC-301');}
    },
    // Plastic thermal limits (HARD)
    'PVC_thermal':{materials:['PVC'],trigger:()=>true,T1:50,T2:60,failureMode:'thermal_softening',
      lowAction:()=>{},midAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('approaching_softening_point');result.mitigations.push('Consider CPVC upgrade');},
      highAction:()=>{return hardExclude(materialId,'thermal_limit_exceeded','PVC max temp 60Â°C exceeded','Polymer softening causes structural failure','Use CPVC (95Â°C), PP (80Â°C), or PVDF (140Â°C)','RULE-TEMP-201');}
    },
    'PP_thermal':{materials:['PP','HDPE'],trigger:()=>true,T1:60,T2:80,failureMode:'thermal_softening',
      lowAction:()=>{},midAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('elevated_temp_zone');},
      highAction:()=>{return hardExclude(materialId,'thermal_limit_exceeded',`${materialId} max temp 80Â°C exceeded`,'Polymer softening causes structural failure','Use PVDF (140Â°C) or PTFE (200Â°C)');}
    },
    'CPVC_thermal':{materials:['CPVC'],trigger:()=>true,T1:80,T2:95,failureMode:'thermal_softening',
      lowAction:()=>{},midAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('elevated_temp_zone');},
      highAction:()=>{return hardExclude(materialId,'thermal_limit_exceeded','CPVC max temp 95Â°C exceeded','Polymer softening causes structural failure','Use PVDF (140Â°C) or PTFE (200Â°C)');}
    },
    'PVDF_thermal':{materials:['PVDF'],trigger:()=>true,T1:120,T2:140,failureMode:'thermal_softening',
      lowAction:()=>{},midAction:()=>{result.classification='CONDITIONAL';result.failureModes.push('elevated_temp_zone');},
      highAction:()=>{return hardExclude(materialId,'thermal_limit_exceeded','PVDF max temp 140Â°C exceeded','Polymer softening causes structural failure','Use PTFE or metal construction');}
    }
  };

  // Apply temperature mode switches
  for(const[ruleId,rule]of Object.entries(TEMP_MODES)){
    if(!rule.materials.includes(materialId))continue;
    if(!rule.trigger())continue;

    // Temperature mode logic - NO interpolation
    if(tempC<rule.T1){
      rule.lowAction();
    }else if(tempC<rule.T2){
      rule.midAction();
    }else{
      const excl=rule.highAction();
      if(excl&&excl.excluded)return excl; // Hard exclusion from highAction
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDATED OK CONDITIONS - Industry standards
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // 316SS in nitric acid â‰¤70% at â‰¤50Â°C - INDUSTRY STANDARD
  if(materialId==='316SS'&&fluidKey.includes('hno3')&&concentration<=70&&tempC<=50){
    result.classification='OK';
    result.chemicalResistance='excellent';
    result.industrialSuitability='acceptable';
    result.rationale.push('[INDUSTRY STANDARD] 316SS is the standard material for nitric acid storage up to 70%/50Â°C');
    result.confidence.fieldHistory=0.95;
    return finalizeResult(result);
  }

  // Titanium in nitric acid - GOLD STANDARD
  if(materialId==='Titanium'&&fluidKey.includes('hno3')&&concentration<=70&&tempC<=60){
    result.classification='OK';
    result.chemicalResistance='excellent';
    result.industrialSuitability='acceptable';
    result.rationale.push('[GOLD STANDARD] Titanium is the premium choice for nitric acid - TiOâ‚‚ passive film highly stable');
    result.confidence.fieldHistory=0.98;
    return finalizeResult(result);
  }

  // Titanium in hypochlorite - designed for this
  if(materialId==='Titanium'&&fluidKey.includes('hypochlorite')){
    result.classification='OK';
    result.chemicalResistance='excellent';
    result.industrialSuitability='acceptable';
    result.rationale.push('[INDUSTRY STANDARD] Titanium is the standard for chlor-alkali and bleach service');
    result.confidence.fieldHistory=0.95;
    return finalizeResult(result);
  }

  // Hastelloy-C in HCl - designed for this
  if(materialId==='Hastelloy-C'&&fluidKey.includes('hcl')){
    result.classification='OK';
    result.chemicalResistance='excellent';
    result.industrialSuitability='acceptable';
    result.rationale.push('[DESIGN APPLICATION] Hastelloy C-276 designed for HCl service - Ni-Mo chemistry optimized for reducing acids');
    result.confidence.fieldHistory=0.95;
    return finalizeResult(result);
  }

  // PTFE - universal chemical resistance (mechanical limits only)
  if(materialId==='PTFE'&&tempC<200){
    result.classification='OK';
    result.chemicalResistance='excellent';
    result.industrialSuitability='acceptable';
    result.rationale.push('[UNIVERSAL] PTFE provides universal chemical resistance');
    if(tempC>150){
      result.failureModes.push('cold_flow_risk');
      result.mitigations.push('Consider mechanical support or backup rings above 150Â°C');
    }
    return finalizeResult(result);
  }

  // Kalrez - near-universal but expensive
  if(materialId==='Kalrez'&&tempC<260){
    result.classification=traits.oxidizing==='extreme'?'CONDITIONAL':'OK';
    result.chemicalResistance=traits.oxidizing==='extreme'?'limited':'excellent';
    result.industrialSuitability=traits.oxidizing==='extreme'?'conditional':'acceptable';
    result.rationale.push('[PREMIUM] Kalrez FFKM provides near-universal elastomer resistance');
    return finalizeResult(result);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V84 FIX #8: CONFIDENCE SCORE ENFORCEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return finalizeResultWithConfidenceEnforcement(result);
}

// V84 FIX #1: Hard exclusion - material removed entirely, cannot appear as CONDITIONAL
// V89: RULE ID REGISTRY - Traceable decision codes for audit compliance
const RULE_REGISTRY = {
  // Chemical Incompatibility Rules (100-199)
  'RULE-CHEM-101': {name: 'Amphoteric Dissolution', category: 'Chemical', severity: 'CATASTROPHIC'},
  'RULE-CHEM-102': {name: 'Strong Acid Attack', category: 'Chemical', severity: 'SEVERE'},
  'RULE-CHEM-103': {name: 'Strong Base Attack', category: 'Chemical', severity: 'SEVERE'},
  'RULE-CHEM-104': {name: 'Oxidizer Degradation', category: 'Chemical', severity: 'SEVERE'},
  'RULE-CHEM-105': {name: 'Reducing Acid Attack', category: 'Chemical', severity: 'SEVERE'},
  'RULE-CHEM-106': {name: 'Halide Pitting', category: 'Chemical', severity: 'HIGH'},
  'RULE-CHEM-107': {name: 'Dehydrating Agent', category: 'Chemical', severity: 'CATASTROPHIC'},

  // Thermal Failure Rules (200-299)
  'RULE-TEMP-201': {name: 'Polymer Softening', category: 'Thermal', severity: 'CATASTROPHIC'},
  'RULE-TEMP-202': {name: 'Elastomer Degradation', category: 'Thermal', severity: 'HIGH'},
  'RULE-TEMP-203': {name: 'SCC Activation', category: 'Thermal', severity: 'CATASTROPHIC'},
  'RULE-TEMP-204': {name: 'Hydrogen Embrittlement', category: 'Thermal', severity: 'CATASTROPHIC'},
  'RULE-TEMP-205': {name: 'Creep Initiation', category: 'Thermal', severity: 'HIGH'},

  // Stress Corrosion Rules (300-399)
  'RULE-SCC-301': {name: 'Caustic SCC', category: 'SCC', severity: 'CATASTROPHIC'},
  'RULE-SCC-302': {name: 'Chloride SCC', category: 'SCC', severity: 'CATASTROPHIC'},
  'RULE-SCC-303': {name: 'Nitrate SCC', category: 'SCC', severity: 'CATASTROPHIC'},
  'RULE-SCC-304': {name: 'Amine SCC', category: 'SCC', severity: 'CATASTROPHIC'},

  // Regulatory/Industry Rules (400-499)
  'RULE-REG-401': {name: 'Oxidizer Seal Prohibition', category: 'Regulatory', severity: 'HIGH'},
  'RULE-REG-402': {name: 'Energetic Fluid Protocol', category: 'Regulatory', severity: 'HIGH'},
  'RULE-REG-403': {name: 'Food Grade Requirement', category: 'Regulatory', severity: 'MEDIUM'},

  // Confidence/Data Rules (500-599)
  'RULE-CONF-501': {name: 'Conditional Material Cap', category: 'Confidence', severity: 'MEDIUM'},
  'RULE-CONF-502': {name: 'Oxidizer-Adjacent Penalty', category: 'Confidence', severity: 'MEDIUM'},
  'RULE-CONF-503': {name: 'Temperature Penalty', category: 'Confidence', severity: 'LOW'},
  'RULE-CONF-504': {name: 'Missing Data Penalty', category: 'Confidence', severity: 'MEDIUM'}
};

// V89: STANDARDS COMPLIANCE METADATA
const COMPLIANCE_FRAMEWORK = {
  version: 'V89',
  releaseDate: '2026-01-25',
  standards: {
    'ISO_27001': {
      name: 'ISO/IEC 27001:2022',
      scope: 'Information Security Management',
      status: 'ALIGNED',
      notes: 'Audit trail, data integrity controls, access logging'
    },
    'API_RP_581': {
      name: 'API RP 581',
      scope: 'Risk-Based Inspection',
      status: 'COMPATIBLE',
      notes: 'Corrosion rate estimation, remaining life calculation methodology'
    },
    'IEC_62443': {
      name: 'IEC 62443',
      scope: 'Industrial Cybersecurity',
      status: 'PARTIAL',
      notes: 'Applicable if deployed in OT network - security headers, input validation'
    },
    'GHS_REV7': {
      name: 'GHS Revision 7',
      scope: 'Hazard Classification',
      status: 'COMPLIANT',
      notes: 'Pictograms, H-statements, signal words per UN GHS'
    }
  },
  functionalSafety: {
    silLevel: 'SIL 0',
    classification: 'ADVISORY TOOL',
    disclaimer: 'CERTA is NOT a Safety Instrumented System (SIS). It provides engineering screening guidance only. Material selection decisions affecting safety-critical systems require independent qualification testing, certified inspection, and engineering sign-off per IEC 61511 / IEC 61508.',
    prohibited: [
      'Final material selection without verification testing',
      'Safety-critical system design without engineering review',
      'Regulatory compliance certification',
      'Replacement for manufacturer datasheets'
    ]
  },
  auditCapabilities: {
    decisionTrace: true,
    ruleIdTagging: true,
    jsonExport: true,
    checksumValidation: true,
    sessionLogging: true
  }
};

// V89: Audit trail storage for current session
let auditTrail = [];

function addAuditEntry(ruleId, material, fluid, temp, decision, details) {
  const entry = {
    timestamp: new Date().toISOString(),
    ruleId: ruleId,
    ruleName: RULE_REGISTRY[ruleId]?.name || 'Unknown Rule',
    category: RULE_REGISTRY[ruleId]?.category || 'General',
    severity: RULE_REGISTRY[ruleId]?.severity || 'MEDIUM',
    material: material,
    fluid: fluid,
    temperature: temp,
    decision: decision,
    details: details
  };
  auditTrail.push(entry);
  return entry;
}

function clearAuditTrail() {
  auditTrail = [];
}

function getAuditTrail() {
  return [...auditTrail];
}

function hardExclude(matId, failureMode, summary, mechanism, recommendation, ruleId = 'RULE-CHEM-102') {
  // V89: Add to audit trail
  addAuditEntry(ruleId, matId, curFluid || 'unknown', curTemp || 20, 'EXCLUDED', summary);

  return {
    classification: 'EXCLUDED',
    excluded: true,
    exclusionReason: summary,
    ruleId: ruleId,  // V89: Traceable rule ID
    ruleName: RULE_REGISTRY[ruleId]?.name || failureMode,
    chemicalResistance: 'none',
    industrialSuitability: 'prohibited',
    failureModes: [failureMode],
    activeTriggers: [summary],
    tempActivations: [],
    mitigations: [recommendation],
    monitoring: [],
    rationale: [`[${ruleId}] ${mechanism}`],
    confidence: {dataQuality: 0.95, tempCoverage: 0.95, concCoverage: 0.95, fieldHistory: 0.90, failureModeClarity: 0.98},
    confidenceScore: 95
  };
}

// V84: Renamed from hardFail for clarity
const hardFail=hardExclude;

// V84 FIX #8: Confidence enforcement with classification downgrades
function finalizeResultWithConfidenceEnforcement(result){
  const w={dataQuality:0.25,tempCoverage:0.20,concCoverage:0.20,fieldHistory:0.15,failureModeClarity:0.20};
  result.confidenceScore=Math.round(Object.entries(w).reduce((sum,[k,v])=>sum+(result.confidence[k]||0.5)*v,0)*100);

  // V84 FIX #8: Confidence enforcement rules
  if(result.confidenceScore<40){
    // Force CONDITIONAL or worse at very low confidence
    if(result.classification==='OK'){
      result.classification='CONDITIONAL';
      result.rationale.push('[CONFIDENCE] Low confidence (<40%) forces CONDITIONAL classification');
    }
    result.industrialSuitability='conditional';
  }else if(result.confidenceScore<60){
    // Suppress "Recommended" and add warnings
    result.rationale.push('[CONFIDENCE] Moderate confidence (40-60%) - verify with manufacturer data');
  }

  // V84: Sync classification with industrial suitability
  if(result.industrialSuitability==='prohibited'&&result.classification!=='EXCLUDED'){
    result.classification='NOT_RECOMMENDED';
  }else if(result.industrialSuitability==='conditional'&&result.classification==='OK'){
    result.classification='CONDITIONAL';
  }

  // Remove duplicates
  result.failureModes=[...new Set(result.failureModes)];
  result.mitigations=[...new Set(result.mitigations)];
  result.monitoring=[...new Set(result.monitoring)];
  return result;
}

// Legacy wrapper
function finalizeResult(result){
  return finalizeResultWithConfidenceEnforcement(result);
}

// Helper: Get fluid traits from key
function getFluidTraitsV84(fluidKey,concentration,tempC){
  const fk=fluidKey.toLowerCase();
  let traits={acidBase:'neutral',oxidizing:'none',reducing:'none',waterActivity:'aqueous',electrochemical:'inert',organic:false,phaseRisk:[],attacksAmphoteric:false,chloride:false,swellsElastomers:false,attacksNickelAlloys:false,attacksOrganics:false,attacksFKM:false,attacksGlass:false};

  // Match against trait rules
  Object.entries(FLUID_TRAIT_RULES).forEach(([key,rule])=>{
    if(fk.includes(key)){
      const t=rule.getTraits(concentration,tempC);
      traits={...traits,...t};
    }
  });

  // Additional pattern matching
  if(fk.includes('chloride')||fk.includes('brine')||fk.includes('seawater'))traits.chloride=true;
  if(fk.includes('caustic')||fk.includes('naoh')||fk.includes('koh'))traits.attacksAmphoteric=concentration>=5;
  if(fk.includes('aromatic')||fk.includes('benzene')||fk.includes('toluene')||fk.includes('xylene'))traits.swellsElastomers=true;
  if(fk.includes('petroleum')||fk.includes('oil')||fk.includes('diesel')||fk.includes('gasoline')||fk.includes('fuel'))traits.swellsElastomers=true;
  if(fk.includes('ketone')||fk.includes('acetone')||fk.includes('mek')){traits.attacksFKM=true;traits.extractsPlasticizer=true;}
  if(fk.includes('chromate')||fk.includes('dichromate')||fk.includes('permanganate'))traits.oxidizing='extreme';
  if(fk.includes('perchlorate')||fk.includes('chlorate'))traits.oxidizing='strong';

  return traits;
}

// Helper: Check if conditions string matches traits
function checkConditionsV84(condStr,traits,concentration,fluidKey){
  if(!condStr||condStr==='any')return true;
  const c=condStr.toLowerCase();
  if(c.includes('chloride')&&traits.chloride)return true;
  if(c.includes('caustic')&&traits.acidBase==='base'&&concentration>=25)return true;
  if(c.includes('acid')&&traits.acidBase==='acid')return true;
  if(c.includes('oxidizer')&&traits.oxidizing!=='none')return true;
  if(c.includes('reducing')&&traits.reducing!=='none')return true;
  if(c.includes('stress'))return true; // Assume stress present in industrial equipment
  if(c.includes('solvent')&&traits.organic)return true;
  return false;
}

const S={
'Solidifying':[{type:'Packed Gland (Heated)',priority:'RECOMMENDED - INDUSTRY STANDARD',sealless:false,reason:'Simple, robust, proven for 100+ years in bitumen service. Tolerates solidification, easy to maintain. Requires heated stuffing box.',specs:'Up to 10 bar, 250Â°C with steam/thermal fluid jacket',materials:'Graphite/PTFE braided packing, lantern ring for steam',apiPlan:'Traditional - API 676 compliant'},{type:'Single Mechanical Seal + External Flush',priority:'ALTERNATIVE - CONTINUOUS SERVICE ONLY',sealless:false,reason:'Acceptable for continuous operation with proper flush and heating. NOT for intermittent service.',specs:'Up to 20 bar. REQUIRES Plan 32 external flush AND heated seal chamber.',materials:'WC/SiC faces, FKM/FFKM, heated flush fluid',apiPlan:'API 682 Plan 32 + heating jacket'},{type:'Double Seal + Heated Barrier',priority:'CONDITIONAL - IF ZERO LEAKAGE REQUIRED',sealless:false,reason:'For applications requiring zero emissions. Complex, expensive. Requires heated barrier fluid system.',specs:'Up to 30 bar. Barrier fluid must be heated above solidification point.',materials:'WC/SiC faces, compatible elastomers, heated reservoir',apiPlan:'API 682 Plan 53A with thermal management'}],
'General':[{type:'Single Mechanical Seal',priority:'STANDARD',sealless:false,reason:'Cost-effective for clean, non-hazardous fluids.',specs:'Up to 20 bar, 200Â°C',materials:'Carbon/Ceramic, NBR/FKM',apiPlan:'API 682 Plan 11'},{type:'Cartridge Seal',priority:'RECOMMENDED',sealless:false,reason:'Pre-assembled, easy installation.',specs:'Up to 25 bar, 250Â°C',materials:'Various',apiPlan:'API 682 Cartridge'},{type:'Magnetic Drive Pump',priority:'OPTIONAL',sealless:true,reason:'Zero maintenance, zero emissions.',specs:'Up to 16 bar, 150Â°C',materials:'316SS or lined, ceramic bearings',apiPlan:'API 685'}],
'Corrosive':[{type:'Magnetic Drive Pump',priority:'STRONGLY RECOMMENDED',sealless:true,reason:'Eliminates seal corrosion. Zero leakage.',specs:'Up to 16 bar, 120Â°C',materials:'Full PTFE lining, ceramic bearings',apiPlan:'API 685'},{type:'Double Seal - Plan 53B',priority:'RECOMMENDED',sealless:false,reason:'Dual containment with barrier fluid.',specs:'Up to 30 bar, 250Â°C',materials:'SiC, Kalrez, Hastelloy',apiPlan:'API 682 Plan 53B'},{type:'PTFE Bellows Seal',priority:'ACCEPTABLE',sealless:false,reason:'No metal springs in process.',specs:'Up to 15 bar, 200Â°C',materials:'PTFE bellows, SiC/Carbon',apiPlan:'API 682 Plan 11'}],
'Toxic':[{type:'Magnetic Drive Pump',priority:'CRITICAL - REQUIRED',sealless:true,reason:'Zero emissions. Prevents toxic exposure.',specs:'Up to 20 bar, 150Â°C',materials:'PTFE/PVDF lined, Hastelloy',apiPlan:'API 685'},{type:'Canned Motor Pump',priority:'CRITICAL - ALTERNATIVE',sealless:true,reason:'Complete containment. No external seals.',specs:'Up to 40 bar, 250Â°C',materials:'PTFE/ceramic lining',apiPlan:'API 685 Type II'},{type:'Double Seal - Plan 53B/54',priority:'ACCEPTABLE',sealless:false,reason:'Leak detection with alarm.',specs:'Up to 40 bar, 300Â°C',materials:'High-integrity',apiPlan:'API 682 Plan 53B/54'}],
'Flammable':[{type:'Magnetic Drive Pump',priority:'STRONGLY RECOMMENDED',sealless:true,reason:'Zero VOC emissions. Environmental compliance.',specs:'Up to 16 bar, 150Â°C. ATEX Zone 1.',materials:'Conductive PTFE, Carbon/SiC',apiPlan:'API 685'},{type:'Double Seal - Plan 53A',priority:'RECOMMENDED',sealless:false,reason:'Pressurized barrier prevents vapor escape.',specs:'Up to 40 bar, 300Â°C',materials:'SiC, FKM/FFKM',apiPlan:'API 682 Plan 53A'},{type:'Gas Seal (Dry)',priority:'ACCEPTABLE',sealless:false,reason:'Non-contacting for high speed.',specs:'Up to 200 bar, 350Â°C',materials:'Carbon/SiC',apiPlan:'API 682 Category 3'}],
'Slurry':[{type:'Dual Seal - Plan 32',priority:'RECOMMENDED',sealless:false,reason:'Clean barrier protects from abrasives.',specs:'Up to 30 bar, 150Â°C',materials:'Tungsten carbide',apiPlan:'API 682 Plan 32/52'},{type:'Expeller Seal',priority:'RECOMMENDED',sealless:false,reason:'Mechanical solids expulsion. Mining proven.',specs:'Up to 10 bar, 100Â°C',materials:'Abrasion-resistant alloys',apiPlan:'Industry standard'},{type:'Packed Gland',priority:'ACCEPTABLE',sealless:false,reason:'Simple, robust, tolerates solids.',specs:'Up to 8 bar, 120Â°C',materials:'Graphite/PTFE packing',apiPlan:'Traditional'}],
'Food':[{type:'Magnetic Drive Pump',priority:'STRONGLY RECOMMENDED',sealless:true,reason:'Zero contamination. CIP/SIP compatible.',specs:'Up to 16 bar, 140Â°C',materials:'316L, FDA/3A compliant',apiPlan:'EHEDG/3-A'},{type:'Sanitary Single Seal',priority:'RECOMMENDED',sealless:false,reason:'CIP-compatible. Minimal dead space.',specs:'Up to 16 bar, 140Â°C',materials:'316L, FDA elastomers',apiPlan:'EHEDG Doc 2'},{type:'Canned Motor Pump',priority:'ACCEPTABLE',sealless:true,reason:'Hermetic for sterile/aseptic.',specs:'Up to 25 bar, 150Â°C',materials:'316L, ceramic bearings',apiPlan:'FDA/USDA approved'}],
'Oxidizer':[{type:'Magnetic Drive Pump',priority:'RECOMMENDED',sealless:true,reason:'No elastomer exposure to oxidizers.',specs:'Up to 16 bar, 120Â°C',materials:'PTFE/PVDF, ceramic bearings',apiPlan:'API 685'},{type:'Canned Motor Pump',priority:'RECOMMENDED',sealless:true,reason:'Complete containment. No shaft seal. Oxidizer-compatible.',specs:'Up to 40 bar, 250Â°C',materials:'PTFE/ceramic lining, Hastelloy shell',apiPlan:'API 685 Type II'},{type:'Double Seal - Plan 53B',priority:'CONDITIONAL',sealless:false,reason:'Inert barrier isolates oxidizer. Use only if sealless not feasible.',specs:'Up to 30 bar, 200Â°C',materials:'PTFE/Kalrez',apiPlan:'API 682 Plan 53B'}]
};
const R=[
{id:'perry',num:1,title:"Perry's Handbook",apa:"Green, D.W. (2019). Perry's Chemical Engineers' Handbook, 9th ed. McGraw-Hill.",mla:"Green, Don W. Perry's Chemical Engineers' Handbook. 9th ed., McGraw-Hill, 2019.",chicago:"Green, Don W. Perry's Handbook. 9th ed. McGraw-Hill, 2019.",harvard:"Green, D.W. (2019) Perry's Handbook. 9th edn. McGraw-Hill.",ieee:"D.W. Green, Perry's Handbook, 9th ed. McGraw-Hill, 2019."},
{id:'crc',num:2,title:"CRC Handbook",apa:"Rumble, J.R. (2023). CRC Handbook of Chemistry and Physics, 104th ed. CRC Press.",mla:"Rumble, John R. CRC Handbook. 104th ed., CRC Press, 2023.",chicago:"Rumble, John R. CRC Handbook. 104th ed. CRC Press, 2023.",harvard:"Rumble, J.R. (2023) CRC Handbook. 104th edn. CRC Press.",ieee:"J.R. Rumble, CRC Handbook, 104th ed. CRC Press, 2023."},
{id:'nist',num:3,title:"NIST WebBook",apa:"Linstrom, P.J. (2023). NIST Chemistry WebBook. doi:10.18434/T4D303",mla:"Linstrom, Peter J. NIST Chemistry WebBook. NIST, 2023.",chicago:"Linstrom, P.J. NIST Chemistry WebBook. NIST, 2023.",harvard:"Linstrom, P.J. (2023) NIST WebBook. NIST.",ieee:"P.J. Linstrom, NIST WebBook, NIST, 2023."},
{id:'api682',num:4,title:"API 682 - Seals",apa:"API. (2014). API Standard 682, 4th ed. API.",mla:"API. API Standard 682. 4th ed., API, 2014.",chicago:"API. API Standard 682. 4th ed. API, 2014.",harvard:"API (2014) API 682. 4th edn. API.",ieee:"API, API 682, 4th ed. API, 2014."},
{id:'api685',num:5,title:"API 685 - Sealless",apa:"API. (2011). API Standard 685, 2nd ed. API.",mla:"API. API Standard 685. 2nd ed., API, 2011.",chicago:"API. API Standard 685. 2nd ed. API, 2011.",harvard:"API (2011) API 685. 2nd edn. API.",ieee:"API, API 685, 2nd ed. API, 2011."},
{id:'ghs',num:6,title:"UN GHS Rev.7",apa:"UN. (2017). Globally Harmonized System, 7th rev. ed. UN.",mla:"UN. Globally Harmonized System. 7th rev. ed., UN, 2017.",chicago:"UN. GHS. 7th rev. ed. UN, 2017.",harvard:"UN (2017) GHS. 7th rev. edn. UN.",ieee:"UN, GHS, 7th rev. ed. UN, 2017."},
{id:'aicis',num:7,title:"AICIS Australia",apa:"AICIS. (2024). Australian Industrial Chemicals Introduction Scheme. Australian Government. industrialchemicals.gov.au",mla:"AICIS. Australian Industrial Chemicals Introduction Scheme. Australian Government, 2024.",chicago:"AICIS. Australian Industrial Chemicals Introduction Scheme. Canberra: Australian Government, 2024.",harvard:"AICIS (2024) Australian Industrial Chemicals Introduction Scheme. Canberra: Australian Government.",ieee:"AICIS, 'Australian Industrial Chemicals Introduction Scheme,' Australian Government, 2024. [Online]. Available: industrialchemicals.gov.au"},
{id:'cole',num:8,title:"Cole-Parmer Compat.",apa:"Cole-Parmer. (2024). Chemical Compatibility Database. coleparmer.com",mla:"Cole-Parmer. Chemical Compatibility. 2024.",chicago:"Cole-Parmer. Chemical Compatibility. 2024.",harvard:"Cole-Parmer (2024) Chemical Compatibility.",ieee:"Cole-Parmer, Chemical Compatibility, 2024."},
{id:'nace',num:9,title:"NACE Corrosion Data",apa:"NACE International. (2019). Corrosion Data Survey: Metals Section, 7th ed. NACE.",mla:"NACE International. Corrosion Data Survey. 7th ed., NACE, 2019.",chicago:"NACE. Corrosion Data Survey. 7th ed. NACE, 2019.",harvard:"NACE (2019) Corrosion Data Survey. 7th edn. NACE.",ieee:"NACE, Corrosion Data Survey, 7th ed. NACE, 2019."},
{id:'asm',num:10,title:"ASM Handbook Vol.13",apa:"ASM International. (2018). ASM Handbook Vol.13: Corrosion. ASM International.",mla:"ASM International. ASM Handbook Vol.13. ASM International, 2018.",chicago:"ASM. ASM Handbook Vol.13. ASM International, 2018.",harvard:"ASM (2018) ASM Handbook Vol.13. ASM International.",ieee:"ASM, ASM Handbook Vol.13, ASM International, 2018."},
{id:'meps',num:11,title:"MEPS Steel Prices",apa:"MEPS International. (2024). World Steel Prices. meps.co.uk",mla:"MEPS International. World Steel Prices. 2024.",chicago:"MEPS. World Steel Prices. 2024.",harvard:"MEPS (2024) World Steel Prices.",ieee:"MEPS, World Steel Prices, 2024."},
{id:'plastics',num:12,title:"Plastics Technology",apa:"Gardner Business Media. (2024). Plastics Technology Pricing. ptonline.com",mla:"Gardner Business Media. Plastics Technology Pricing. 2024.",chicago:"Gardner. Plastics Technology Pricing. 2024.",harvard:"Gardner (2024) Plastics Technology Pricing.",ieee:"Gardner, Plastics Technology Pricing, 2024."},
{id:'swa-hcis',num:13,title:"Safe Work Australia HCIS",apa:"Safe Work Australia. (2024). Hazardous Chemical Information System (HCIS). Australian Government. hcis.safeworkaustralia.gov.au",mla:"Safe Work Australia. Hazardous Chemical Information System. Australian Government, 2024.",chicago:"Safe Work Australia. Hazardous Chemical Information System. Canberra: Australian Government, 2024.",harvard:"Safe Work Australia (2024) Hazardous Chemical Information System. Canberra: Australian Government.",ieee:"Safe Work Australia, 'Hazardous Chemical Information System,' Australian Government, 2024. [Online]. Available: hcis.safeworkaustralia.gov.au"},
{id:'swa-wes',num:14,title:"Safe Work Australia WES",apa:"Safe Work Australia. (2024). Workplace Exposure Standards for Airborne Contaminants. Australian Government. safeworkaustralia.gov.au",mla:"Safe Work Australia. Workplace Exposure Standards. Australian Government, 2024.",chicago:"Safe Work Australia. Workplace Exposure Standards. Canberra: Australian Government, 2024.",harvard:"Safe Work Australia (2024) Workplace Exposure Standards. Canberra: Australian Government.",ieee:"Safe Work Australia, 'Workplace Exposure Standards,' Australian Government, 2024."},
{id:'nicnas',num:15,title:"NICNAS Legacy Data",apa:"NICNAS. (2020). National Industrial Chemicals Notification and Assessment Scheme (Legacy). Australian Government.",mla:"NICNAS. National Industrial Chemicals Notification and Assessment Scheme. Australian Government, 2020.",chicago:"NICNAS. National Industrial Chemicals Notification and Assessment Scheme. Canberra: Australian Government, 2020.",harvard:"NICNAS (2020) National Industrial Chemicals Notification and Assessment Scheme. Canberra: Australian Government.",ieee:"NICNAS, 'National Industrial Chemicals Notification and Assessment Scheme,' Australian Government, 2020."},
{id:'adg',num:16,title:"Australian Dangerous Goods Code",apa:"National Transport Commission. (2024). Australian Dangerous Goods Code, 7.8 ed. NTC Australia.",mla:"National Transport Commission. Australian Dangerous Goods Code. 7.8 ed., NTC Australia, 2024.",chicago:"NTC. Australian Dangerous Goods Code. 7.8 ed. Melbourne: NTC Australia, 2024.",harvard:"NTC (2024) Australian Dangerous Goods Code. 7.8 edn. Melbourne: NTC Australia.",ieee:"NTC, Australian Dangerous Goods Code, 7.8 ed. NTC Australia, 2024."},
{id:'astm-g31',num:17,title:"ASTM G31 Corrosion Testing",apa:"ASTM International. (2021). ASTM G31-21, Standard Guide for Laboratory Immersion Corrosion Testing. ASTM.",mla:"ASTM International. ASTM G31-21. ASTM, 2021.",chicago:"ASTM. ASTM G31-21. West Conshohocken: ASTM, 2021.",harvard:"ASTM (2021) ASTM G31-21. ASTM.",ieee:"ASTM, ASTM G31-21, ASTM, 2021."},
{id:'asme-b73',num:18,title:"ASME B73.1 Chemical Pumps",apa:"ASME. (2022). ASME B73.1-2022, Specification for Horizontal End Suction Centrifugal Pumps. ASME.",mla:"ASME. ASME B73.1-2022. ASME, 2022.",chicago:"ASME. ASME B73.1-2022. New York: ASME, 2022.",harvard:"ASME (2022) ASME B73.1-2022. ASME.",ieee:"ASME, ASME B73.1-2022, ASME, 2022."},
{id:'iso-21049',num:19,title:"ISO 21049 Mechanical Seals",apa:"ISO. (2018). ISO 21049:2018, Pumps - Shaft-sealing systems for centrifugal and rotary pumps. ISO.",mla:"ISO. ISO 21049:2018. ISO, 2018.",chicago:"ISO. ISO 21049:2018. Geneva: ISO, 2018.",harvard:"ISO (2018) ISO 21049:2018. ISO.",ieee:"ISO, ISO 21049:2018, ISO, 2018."},
{id:'shell-dep',num:20,title:"Shell DEP Bitumen/Heavy Oil",apa:"Shell Global Solutions. (2020). Design and Engineering Practice for Bitumen and Heavy Oil Systems. Shell.",mla:"Shell Global Solutions. DEP Bitumen Systems. Shell, 2020.",chicago:"Shell. DEP Bitumen Systems. The Hague: Shell, 2020.",harvard:"Shell (2020) DEP Bitumen Systems. Shell.",ieee:"Shell, DEP Bitumen Systems, Shell, 2020."},
{id:'astm-d4',num:21,title:"ASTM D4 Bitumen Penetration",apa:"ASTM International. (2023). ASTM D4-23, Standard Test Method for Bitumen Penetration. ASTM.",mla:"ASTM International. ASTM D4-23. ASTM, 2023.",chicago:"ASTM. ASTM D4-23. West Conshohocken: ASTM, 2023.",harvard:"ASTM (2023) ASTM D4-23. ASTM.",ieee:"ASTM, ASTM D4-23, ASTM, 2023."},
{id:'api-rp14e',num:22,title:"API RP 14E Velocity Limits",apa:"API. (2020). API RP 14E, Recommended Practice for Design and Installation of Offshore Production Platform Piping Systems. API.",mla:"API. API RP 14E. 7th ed., API, 2020.",chicago:"API. API RP 14E. 7th ed. Washington: API, 2020.",harvard:"API (2020) API RP 14E. 7th edn. API.",ieee:"API, API RP 14E, 7th ed. API, 2020."}
];
let curFluid='water',curTemp=20,selMats=['316SS','Carbon-Steel','PTFE','FKM'];
var lastReynolds=null,lastCavitation=null,lastCalcData=null,docIdCounter=0;

// ============================================================
// FLUID BEHAVIOR PROFILE SYSTEM (v5.8 Architecture)
// Implements chemistry-aware classification per engineering directive
// ============================================================
function getFluidBehaviorProfile(fluidKey,tempC){
const fk=fluidKey||'';
const flags=[];
// Extract concentrations
let sulfConc=0,nitricConc=0,hclConc=0,naohConc=0,peroxConc=0;
const sulfMatch=fk.match(/h2so4-(\d+)/i);if(sulfMatch)sulfConc=parseInt(sulfMatch[1],10);
const nitricMatch=fk.match(/hno3-(\d+)/i);if(nitricMatch)nitricConc=parseInt(nitricMatch[1],10);
const hclMatch=fk.match(/hcl-(\d+)/i);if(hclMatch)hclConc=parseInt(hclMatch[1],10);
const naohMatch=fk.match(/naoh-(\d+)|koh-(\d+)/i);if(naohMatch)naohConc=parseInt(naohMatch[1]||naohMatch[2],10);
const peroxMatch=fk.match(/peroxide.*?(\d+)|h2o2.*?(\d+)/i);if(peroxMatch)peroxConc=parseInt(peroxMatch[1]||peroxMatch[2],10);
// === BEHAVIOR FLAGS ===
// OXIDIZER_STRONG: Nitric â‰¥65%, Peroxides â‰¥30%, chromate, oleum
if((fk.includes('hno3')&&nitricConc>=65)||(fk.includes('peroxide')&&peroxConc>=30)||fk.includes('chromate')||fk.includes('perchlorate')||fk.includes('oleum'))flags.push('OXIDIZER_STRONG');
else if(fk.includes('hno3')||fk.includes('peroxide')||fk.includes('hypochlorite'))flags.push('OXIDIZER_MILD');

// V88: OXIDIZER_ADJACENT - materials that can act as oxidizers under certain conditions
// Ammonium nitrate, chlorates, nitrates - these require process safety priority
if(fk.includes('ammonium-nitrate')||fk.includes('nitrate')||fk.includes('chlorate')||fk.includes('bromate'))flags.push('OXIDIZER_ADJACENT');

// V88: ENERGETIC - thermally sensitive, explosive adjacency (UN Class 1/5 related)
// These require leak-free systems, safety-first material selection
if(fk.includes('ammonium-nitrate')||fk.includes('nitromethane')||fk.includes('peroxide')&&peroxConc>=50)flags.push('ENERGETIC');

// V88: FERTILIZER_INDUSTRY - specific regulatory requirements
if(fk.includes('ammonium')||fk.includes('urea')||fk.includes('phosphate-fert')||fk.includes('npk'))flags.push('FERTILIZER_INDUSTRY');

// DEHYDRATING: ONLY Sulfuric â‰¥90% and Oleum (NOT phosphoric - it's not dehydrating)
if((fk.includes('h2so4')&&sulfConc>=90)||fk.includes('oleum'))flags.push('DEHYDRATING');
// REDUCING_ACID: HCl, HBr, HI (NOT phosphoric - it's not reducing in the same way)
if(fk.includes('hcl')||fk.includes('hbr')||fk.includes('hydrobromic'))flags.push('REDUCING_ACID');
// PHOSPHORIC_ACID: Weak complexing acid - excellent for 316SS, Hastelloy, Titanium
if(fk.includes('h3po4')||fk.includes('phosphoric'))flags.push('PHOSPHORIC_ACID');
// ALKALI_STRONG: NaOH/KOH â‰¥30%
if((fk.includes('naoh')||fk.includes('koh'))&&naohConc>=30)flags.push('ALKALI_STRONG');
else if(fk.includes('naoh')||fk.includes('koh')||fk.includes('lime'))flags.push('ALKALI_MILD');
// ORGANIC_SOLVENT
if(fk.includes('benzene')||fk.includes('toluene')||fk.includes('xylene')||fk.includes('acetone')||fk.includes('mek')||fk.includes('ethanol')||fk.includes('methanol'))flags.push('ORGANIC_SOLVENT');
// AQUEOUS_SALT
if(fk.includes('nacl')||fk.includes('sodium-chloride')||fk.includes('calcium-chloride')||fk.includes('brine')||fk==='seawater')flags.push('AQUEOUS_SALT');
// VELOCITY_SENSITIVE: Sulfuric â‰¥70%, Slurries, HF
if((fk.includes('h2so4')&&sulfConc>=70)||fk.includes('slurry')||fk.includes('hf')||fk.includes('fluoride'))flags.push('VELOCITY_SENSITIVE');
// PASSIVATION_DEPENDENT: Carbon steel in sulfuric
if(fk.includes('h2so4')&&sulfConc>=70)flags.push('PASSIVATION_DEPENDENT');
// CONTAMINATION_SENSITIVE: Nitric, HF
if(fk.includes('hno3')||fk.includes('hf'))flags.push('CONTAMINATION_SENSITIVE');
// TOXIC_VOLATILE: HF, NH3, HCN
if(fk.includes('hf')||fk.includes('ammonia')||fk.includes('nh4oh')||fk.includes('cyanide'))flags.push('TOXIC_VOLATILE');
// TEMPERATURE_SENSITIVE: Polymers/elastomers at elevated temp (handled in material logic)
if(tempC>=60)flags.push('TEMPERATURE_ELEVATED');
if(tempC>=80)flags.push('TEMPERATURE_HIGH');
// Default for benign fluids
if(flags.length===0)flags.push('AQUEOUS_BENIGN');
return {flags,sulfConc,nitricConc,hclConc,naohConc,peroxConc};
}

// Chemistry Risk Factor - cumulative multiplier per directive
function getChemistryRiskFactor(profile){
let factor=1.0;
const f=profile.flags;
if(f.includes('AQUEOUS_BENIGN')||f.includes('AQUEOUS_SALT'))factor*=1.00;
if(f.includes('REDUCING_ACID'))factor*=0.95;
if(f.includes('ALKALI_MILD'))factor*=0.98;
if(f.includes('ALKALI_STRONG'))factor*=0.92;
if(f.includes('OXIDIZER_MILD'))factor*=0.92;
if(f.includes('OXIDIZER_STRONG'))factor*=0.85;
if(f.includes('DEHYDRATING'))factor*=0.80;
if(f.includes('PASSIVATION_DEPENDENT'))factor*=0.80;
if(f.includes('VELOCITY_SENSITIVE'))factor*=0.85;
if(f.includes('CONTAMINATION_SENSITIVE'))factor*=0.90;
if(f.includes('TEMPERATURE_HIGH'))factor*=0.90;
if(f.includes('ORGANIC_SOLVENT'))factor*=0.95;
return Math.max(0.50,factor); // Floor at 50%
}

// Confidence Scoring Engine with Fluid Behavior Profile
// ARCHITECTURE: Compatibility (categorical) SEPARATE from Robustness (continuous)
// Compatibility = COMPATIBLE | CONDITIONAL | NOT_RECOMMENDED (binary/categorical)
// Robustness = Engineering score (0-100%) calculated ONLY if compatible
// Confidence = Data quality & applicability ONLY - NEVER increases recommendations

function calcConfidence(type,item,ctx){
const w={src:0.30,inp:0.25,range:0.25,safety:0.20};
let factors=[],total=0,warning='',conditional=false,notRecommended=false;
let compatibilityStatus='COMPATIBLE'; // Categorical: COMPATIBLE | CONDITIONAL | NOT_RECOMMENDED
let robustnessScore=100; // Only meaningful if compatible
let robustnessCap=100; // Chemistry-based ceiling
let hasSeverityMode=false; // Default for non-material types
let severityModes=[]; // Default empty array

if(type==='material'){
const fk=ctx.fluidKey||'';
const tempC=ctx.tempC||20;
// Get Fluid Behavior Profile
const profile=getFluidBehaviorProfile(fk,tempC);
const chemFactor=getChemistryRiskFactor(profile);
const f=profile.flags;

// V6.2: CROSS-VALIDATION AGAINST NEGATIVE KNOWLEDGE BASE
// Check if material/fluid combination has known failure mode
function checkFailureKnowledge(matId,fluidFlags,temp){
if(!M.failureKnowledge)return null;
const failures=M.failureKnowledge.filter(fk=>{
if(fk.material!==matId)return false;
// Check if fluid class matches any flag
const classMatch=fluidFlags.some(flag=>{
if(fk.fluidClass==='STRONG_BASE'&&(flag==='ALKALI_STRONG'))return true;
if(fk.fluidClass==='STRONG_ACID'&&(flag==='ACID_STRONG'||flag==='DEHYDRATING'||flag==='REDUCING_ACID'))return true;
if(fk.fluidClass==='STRONG_OXIDIZER'&&flag==='OXIDIZER_STRONG')return true;
if(fk.fluidClass==='HALOGENATED'&&flag==='HALOGENATED')return true;
if(fk.fluidClass==='SOLVENT'&&flag==='SOLVENT')return true;
if(fk.fluidClass==='DEHYDRATING'&&flag==='DEHYDRATING')return true;
return false;
});
if(!classMatch)return false;
// Check temperature triggers
const hasTempTrigger=fk.trigger.some(t=>{
if(t.includes('Temp>')&&temp>=parseInt(t.replace(/[^0-9]/g,'')))return true;
if(t.includes('Any'))return true;
return false;
});
return hasTempTrigger||fk.trigger.some(t=>!t.includes('Temp'));
});
return failures.length>0?failures[0]:null;
}

// Check 4-axis classification
function check4AxisClassification(matId,fluidFlags,temp){
const props=M.materialProps?M.materialProps[matId]:null;
if(!props)return{valid:true,issues:[]};
const issues=[];
// Check amphoteric materials in strong base
if(props.amphoteric&&fluidFlags.includes('ALKALI_STRONG')){
issues.push({axis:'A',issue:'Amphoteric material in strong base',severity:'CRITICAL'});
}
// Check alkali-sensitive materials
if(props.alkaliSensitive&&fluidFlags.includes('ALKALI_STRONG')&&temp>50){
issues.push({axis:'A',issue:'Hot alkali attack risk',severity:'HIGH'});
}
// Check SCC-prone materials
if(props.sccInCaustic&&fluidFlags.includes('ALKALI_STRONG')&&temp>50){
issues.push({axis:'D',issue:'Caustic SCC risk - stress-activated failure',severity:'HIGH'});
}
// Check temperature limits
if(props.maxTemp&&temp>props.maxTemp){
issues.push({axis:'B',issue:'Exceeds material temperature limit ('+props.maxTemp+'Â°C)',severity:'CRITICAL'});
}
// Check elastomer time-dependent degradation
if(props.isElastomer&&props.timeSens==='Time-dependent'){
issues.push({axis:'D',issue:'Time-dependent degradation - inspection intervals required',severity:'INFO'});
}
return{valid:issues.filter(i=>i.severity==='CRITICAL').length===0,issues:issues};
}

// Apply failure knowledge check
const failureCheck=checkFailureKnowledge(item,f,tempC);
const axisCheck=check4AxisClassification(item,f,tempC);

// === CHEMISTRY SEVERITY MODE DETECTION ===
// Per directive: If ANY severity mode active, suppress TCO/optimistic percentages
const isStrongOx=f.includes('OXIDIZER_STRONG');
const isMildOx=f.includes('OXIDIZER_MILD');
const isDehydrating=f.includes('DEHYDRATING');
const isVelocitySensitive=f.includes('VELOCITY_SENSITIVE');
const isPassivationDependent=f.includes('PASSIVATION_DEPENDENT');
const isReducingAcid=f.includes('REDUCING_ACID');
const isStrongAlkali=f.includes('ALKALI_STRONG');
const isToxicVolatile=f.includes('TOXIC_VOLATILE');
const isPhosphoricAcid=f.includes('PHOSPHORIC_ACID'); // V86: Phosphoric acid - distinct chemistry
const isHighTemp=tempC>=80;
const isElevatedTemp=tempC>=50;

// Severity mode triggers (per feedback item #2)
severityModes=[];
if(isStrongOx)severityModes.push('STRONG_OXIDIZER');
if(isDehydrating)severityModes.push('DEHYDRATING');
if(isReducingAcid)severityModes.push('REDUCING_ACID');
if(isStrongAlkali)severityModes.push('STRONG_BASE');
if(isToxicVolatile)severityModes.push('TOXIC_VOLATILE');
if(isHighTemp)severityModes.push('HIGH_TEMP');
if(isVelocitySensitive)severityModes.push('EROSION_CORROSION');

hasSeverityMode=severityModes.length>0;
const severeChemistry=isStrongOx||isDehydrating;
const highTemp=tempC>=50;
const severeConditions=severeChemistry&&tempC>=40;

// === MATERIAL-SPECIFIC EVALUATION ===
// Axis A: Chemical Compatibility (categorical)
// Axis B: Engineering Robustness (continuous, only if compatible)
let matPenalty=0,stabilityPenalty=0,sensitivityPenalty=0,mechPenalty=0;
let matWarning='';
let conditionsList=[]; // Explicit conditions for CONDITIONAL materials

// V6.2: APPLY NEGATIVE KNOWLEDGE BASE FIRST
// If failure knowledge exists for this material/fluid combo, apply it
if(failureCheck){
compatibilityStatus='NOT_RECOMMENDED';
notRecommended=true;
conditional=true;
matPenalty+=35;
robustnessCap=25;
matWarning='âš ï¸ NOT RECOMMENDED: Known failure mode - '+failureCheck.failMode+'. Severity: '+failureCheck.severity+'.';
conditionsList.push('Failure trigger: '+failureCheck.trigger.join(', '));
}
// V6.2: APPLY 4-AXIS CLASSIFICATION CHECKS
if(!notRecommended&&axisCheck.issues.length>0){
const criticalIssues=axisCheck.issues.filter(i=>i.severity==='CRITICAL');
const highIssues=axisCheck.issues.filter(i=>i.severity==='HIGH');
if(criticalIssues.length>0){
compatibilityStatus='NOT_RECOMMENDED';
notRecommended=true;
conditional=true;
matPenalty+=30;
robustnessCap=30;
matWarning='âš ï¸ NOT RECOMMENDED: '+criticalIssues.map(i=>i.issue).join('; ')+'.';
}else if(highIssues.length>0){
if(compatibilityStatus==='COMPATIBLE')compatibilityStatus='CONDITIONAL';
conditional=true;
matPenalty+=15;
robustnessCap=Math.min(robustnessCap,65);
matWarning='âš ï¸ CONDITIONAL: '+highIssues.map(i=>i.issue).join('; ')+'.';
conditionsList.push(...highIssues.map(i=>'Axis '+i.axis+': '+i.issue));
}}

// === ELASTOMER ENGINE (separate from metals per feedback #5) ===
const isElastomer=['FKM','EPDM','NBR','Kalrez','Neoprene','Silicone'].includes(item);
const isPolymer=['PTFE','PVDF','PP','PVC','CPVC','HDPE','PEEK','UHMWPE'].includes(item);

// RULEBOOK V3 Â§4: Global Temperature Overrides
const tempOver40 = tempC > 40;
const tempOver50 = tempC > 50;
const tempOver60 = tempC > 60;
const tempOver80 = tempC > 80;

if(isElastomer){
// Elastomers use degradation model, NOT corrosion rate
robustnessCap=85; // Elastomers inherently capped below metals

// RULEBOOK V3 Â§4: >60Â°C â†’ Elastomer confidence â‰¤70
if(tempOver60){
robustnessCap=Math.min(robustnessCap, 70);
matPenalty+=20;
conditionsList.push('RULEBOOK V3: Temperature >60Â°C - elastomer confidence capped at 70%');
if(!matWarning)matWarning='âš ï¸ CONDITIONAL: Temperature >60Â°C exceeds elastomer safe operating range. Verify grade compatibility.';
conditional=true;
compatibilityStatus='CONDITIONAL';
}

if(isStrongOx||isDehydrating){
robustnessCap=Math.min(robustnessCap, 70); // Oxidizers/strong acids degrade elastomers
matPenalty+=15;
compatibilityStatus='CONDITIONAL';
conditional=true;
conditionsList.push('Verify elastomer grade rated for '+severityModes.join('/')+ ' service');
matWarning='âš ï¸ CONDITIONAL: Elastomers subject to oxidative attack/swelling. Verify grade compatibility.';}
if(isHighTemp){
mechPenalty+=15;
conditionsList.push('Temperature '+tempC+'Â°C may accelerate aging');
if(!matWarning)matWarning='âš ï¸ Verify temperature rating. Accelerated aging above 80Â°C.';}
if(isReducingAcid&&item!=='Kalrez'){
robustnessCap=65;matPenalty+=10;
conditionsList.push('HCl may cause swelling/permeation');}}

// RULEBOOK V3 Â§4: >80Â°C â†’ Metals + fluoropolymers only
if(tempOver80 && !['PTFE','PVDF','PEEK'].includes(item) && isPolymer){
compatibilityStatus='NOT_RECOMMENDED';
notRecommended=true;
conditional=true;
robustnessCap=30;
matWarning='âš ï¸ NOT RECOMMENDED: RULEBOOK V3 Â§4 - Temperature >80Â°C requires metals or fluoropolymers only.';
}

// --- DEHYDRATING AGENTS (Conc H2SO4, Oleum) ---
if(isDehydrating){
if(item==='Hastelloy-C'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=35;stabilityPenalty=25;robustnessCap=50;
matWarning='âš ï¸ NOT RECOMMENDED: Nickel alloys suffer accelerated attack (0.5-2 mm/yr) in concentrated Hâ‚‚SOâ‚„/oleum. Passive film unstable.';
notRecommended=true;conditional=true;}
else if(item==='Carbon-Steel'||item==='Cast-Iron'){
compatibilityStatus='CONDITIONAL';
stabilityPenalty=20;sensitivityPenalty=25;robustnessCap=60;
conditionsList.push('Velocity MUST be <0.5 m/s','Temperature excursions prohibited','Continuous monitoring required');
matWarning='âš ï¸ CONDITIONAL: Velocity-critical passivation. Valid ONLY if: velocity <0.5 m/s, no thermal cycling, continuous operation.';
conditional=true;}
else if(item==='316SS'){
compatibilityStatus='CONDITIONAL';
matPenalty=22;sensitivityPenalty=18;robustnessCap=60;
conditionsList.push('Velocity <1.5 m/s','No weld sensitization','Chloride <50 ppm');
matWarning='âš ï¸ CONDITIONAL: Limited service. Sensitive to velocity, temperature excursions, and weld defects. Valid only within strict parameters.';
conditional=true;}
else if(item==='304SS'){
compatibilityStatus='CONDITIONAL';
matPenalty=28;sensitivityPenalty=22;robustnessCap=55;
conditionsList.push('Inferior to 316SS','Avoid above 40Â°C','No crevices');
matWarning='âš ï¸ CONDITIONAL: Inferior to 316SS. Service severely limited in concentrated sulfuric. Use 316SS minimum.';
conditional=true;}
else if(item==='Titanium'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=30;robustnessCap=40;
matWarning='âš ï¸ NOT RECOMMENDED: Titanium attacked by reducing concentrated acids. Hydrogen embrittlement risk.';
notRecommended=true;conditional=true;}
else if(item==='Aluminum'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=35;robustnessCap=30;
matWarning='âš ï¸ NOT RECOMMENDED: Rapidly attacked. No protective film forms in concentrated sulfuric.';
notRecommended=true;conditional=true;}
else if(item==='PTFE'){
robustnessCap=90; // PTFE excellent but mechanical limits
mechPenalty=highTemp?12:5;
conditionsList.push('Verify lining integrity','Check for permeation at temperature');
matWarning='âš ï¸ Chemically excellent. Verify lining integrity - permeation and creep possible at elevated temperature.';}
else if(item==='PVDF'){
robustnessCap=85;mechPenalty=highTemp?10:3;}
}
// --- STRONG OXIDIZERS (Nitric â‰¥65%, Peroxides, Chromates) ---
else if(isStrongOx){
// Per feedback #6: Carbon steel logic must be chemistry-specific
if(item==='Carbon-Steel'||item==='Cast-Iron'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=30;robustnessCap=35;
matWarning='âš ï¸ NOT RECOMMENDED: Rapid attack in oxidizing acids. No passivation possible.';
notRecommended=true;conditional=true;}
else if(item==='Hastelloy-C'){
compatibilityStatus='CONDITIONAL';
matPenalty=18;stabilityPenalty=12;robustnessCap=60;
conditionsList.push('Not optimal for oxidizers','Consider 316SS or Titanium instead');
matWarning='âš ï¸ CONDITIONAL: Hastelloy designed for reducing acids. Passive film less stable in oxidizing environment. Consider alternatives.';
conditional=true;}
else if(item==='316SS'){
compatibilityStatus='CONDITIONAL';
matPenalty=severeConditions?25:18;stabilityPenalty=15;
robustnessCap=severeConditions?55:65;
conditionsList.push('Passive film sensitive to upsets','No chloride contamination','Welds/crevices vulnerable');
matWarning='âš ï¸ CONDITIONAL: Passive film marginally stable in strong oxidizers. Welds and crevices vulnerable. Verify field data.';
conditional=true;}
else if(item==='304SS'){
compatibilityStatus='CONDITIONAL';
matPenalty=severeConditions?32:24;stabilityPenalty=18;
robustnessCap=severeConditions?50:58;
conditionsList.push('Inferior to 316SS','Concentration-sensitive','Avoid >50Â°C');
matWarning='âš ï¸ CONDITIONAL: Inferior to 316SS in oxidizing acids. Acceptable only at low concentration/temperature.';
conditional=true;}
else if(item==='Aluminum'){
compatibilityStatus='CONDITIONAL';
matPenalty=22;sensitivityPenalty=18;robustnessCap=60;
conditionsList.push('Concentration <40%','Temperature <30Â°C','No chloride');
matWarning='âš ï¸ CONDITIONAL: Aluminum passivates in dilute nitric but sensitive to concentration, temperature, and impurities.';
conditional=true;}
else if(item==='Titanium'){
// Titanium EXCELLENT in oxidizers
robustnessCap=95;matPenalty=0;
matWarning='âœ“ Excellent: Titanium outstanding in oxidizing acids. Industry standard for nitric service.';}
else if(item==='PTFE'||item==='PVDF'||item==='PEEK'){
robustnessCap=92;mechPenalty=highTemp?8:2;
matWarning='âœ“ Chemically excellent. Verify mechanical integrity at temperature.';}
}
// --- PHOSPHORIC ACID (Hâ‚ƒPOâ‚„ all concentrations) ---
// V86: Phosphoric is a weak complexing acid - NOT dehydrating, NOT reducing like HCl
// Industry standard materials: 316SS (excellent), Hastelloy-C (excellent), Titanium (excellent)
else if(isPhosphoricAcid){
if(item==='316SS'){
robustnessCap=95;matPenalty=0;
matWarning='âœ“ Excellent: 316SS industry standard for phosphoric acid to 85% at all temperatures.';}
else if(item==='304SS'){
robustnessCap=88;matPenalty=5;
conditionsList.push('316SS preferred for long-term service');
matWarning='âœ“ Good: 304SS suitable for phosphoric acid. 316SS preferred for demanding service.';}
else if(item==='Hastelloy-C'){
robustnessCap=95;matPenalty=0;
matWarning='âœ“ Excellent: Hastelloy C-276 outstanding in phosphoric acid including hot concentrated solutions.';}
else if(item==='Titanium'){
robustnessCap=92;matPenalty=2;
conditionsList.push('Verify for concentrated hot service');
matWarning='âœ“ Excellent: Titanium resistant to phosphoric acid. Verify at >60Â°C concentrated service.';}
else if(item==='Carbon-Steel'||item==='Cast-Iron'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=25;robustnessCap=35;
matWarning='âš ï¸ NOT RECOMMENDED: Carbon steel rapidly attacked by phosphoric acid at all concentrations.';
notRecommended=true;conditional=true;}
else if(item==='Aluminum'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=28;robustnessCap=30;
matWarning='âš ï¸ NOT RECOMMENDED: Aluminum attacked by phosphoric acid. No passivation.';
notRecommended=true;conditional=true;}
else if(item==='PTFE'||item==='PVDF'||item==='PP'||item==='HDPE'){
robustnessCap=90;mechPenalty=highTemp?10:3;
matWarning='âœ“ Excellent: Polymer chemically resistant to phosphoric acid. Verify mechanical limits.';}
else if(item==='FKM'||item==='Kalrez'){
robustnessCap=88;mechPenalty=5;
matWarning='âœ“ Good: Fluoroelastomers suitable for phosphoric acid service.';}
else if(item==='EPDM'||item==='NBR'){
compatibilityStatus='CONDITIONAL';
matPenalty=15;robustnessCap=60;
conditionsList.push('Limited resistance','Verify elastomer grade');
matWarning='âš ï¸ CONDITIONAL: Limited resistance to phosphoric acid. Verify specific grade.';
conditional=true;}
}
// --- REDUCING ACIDS (HCl, HBr) ---
else if(isReducingAcid){
const hclConc=profile.hclConc||20;
if(item==='Titanium'){
if(hclConc>=20){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=25;robustnessCap=40;
matWarning='âš ï¸ NOT RECOMMENDED: Titanium severely attacked by HCl â‰¥20%. Hydrogen embrittlement.';
notRecommended=true;}else{
compatibilityStatus='CONDITIONAL';
matPenalty=15;robustnessCap=55;
conditionsList.push('HCl <20% only','No fluoride contamination');
matWarning='âš ï¸ CONDITIONAL: Limited to dilute HCl (<20%). Higher concentrations cause rapid attack.';}
conditional=true;}
else if(item==='316SS'||item==='304SS'){
compatibilityStatus='CONDITIONAL';
matPenalty=hclConc>=20?22:14;robustnessCap=hclConc>=20?50:65;
conditionsList.push('Pitting likely','Chloride stress cracking risk','Verify with coupons');
matWarning='âš ï¸ CONDITIONAL: Stainless steels have limited HCl resistance. Pitting and stress cracking likely. Field testing required.';
conditional=true;}
else if(item==='Carbon-Steel'||item==='Cast-Iron'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=28;robustnessCap=30;
matWarning='âš ï¸ NOT RECOMMENDED: Rapid uniform attack in HCl at all concentrations.';
notRecommended=true;conditional=true;}
else if(item==='Hastelloy-C'){
// Hastelloy EXCELLENT in reducing acids
robustnessCap=95;matPenalty=0;
matWarning='âœ“ Excellent: Hastelloy C-276 outstanding in reducing acids including HCl.';}
}
// --- STRONG ALKALI (NaOH/KOH â‰¥30%) ---
else if(isStrongAlkali){
if(item==='Aluminum'){
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=35;robustnessCap=25;
matWarning='âš ï¸ NOT RECOMMENDED: Aluminum rapidly attacked by strong alkalis. Amphoteric dissolution.';
notRecommended=true;conditional=true;}
else if(item==='Titanium'){
// V6.2: Titanium attacked by hot alkalis - hydrogen embrittlement
compatibilityStatus='NOT_RECOMMENDED';
matPenalty=30;robustnessCap=30;
matWarning='âš ï¸ NOT RECOMMENDED: Titanium attacked by hot alkalis; hydrogen embrittlement risk.';
notRecommended=true;conditional=true;}
else if(item==='Carbon-Steel'||item==='Cast-Iron'){
// Carbon steel GOOD in non-oxidizing bases (per feedback #6)
robustnessCap=85;
conditionsList.push('Velocity <3 m/s','Temperature <80Â°C','Stress-relieved welds');
if(highTemp){
compatibilityStatus='CONDITIONAL';
matPenalty=10;robustnessCap=70;
// V6.2: Enhanced SCC warning with specific stress sources
matWarning='âš ï¸ CONDITIONAL: Caustic stress cracking (SCC) risk above 50Â°C. Requires: stress-relieved welds, avoid cold-worked zones, minimize residual tensile stress.';
conditional=true;}}
// V6.2: PVC CONDITIONAL in strong alkalis - plasticizer extraction, thermal limits
else if(item==='PVC'){
compatibilityStatus='CONDITIONAL';
matPenalty=20;robustnessCap=55;
conditionsList.push('â‰¤40Â°C only','â‰¤40% concentration','Low stress','Short-term exposure');
matWarning='âš ï¸ CONDITIONAL: PVC limited in strong caustic. Plasticizer extraction, thermal softening, long-term embrittlement above 40Â°C.';
conditional=true;}
else if(item==='CPVC'){
// V6.2: CPVC better than PVC but still limited
compatibilityStatus='CONDITIONAL';
matPenalty=15;robustnessCap=65;
conditionsList.push('â‰¤60Â°C','Monitor for stress cracking');
matWarning='âš ï¸ CONDITIONAL: CPVC acceptable to ~60Â°C. Monitor for environmental stress cracking.';
conditional=true;}
else if(item==='HDPE'||item==='PP'){
robustnessCap=isHighTemp?60:80;
mechPenalty=isHighTemp?18:8;
conditionsList.push('Verify temperature rating','Stress cracking possible');
if(isHighTemp){
compatibilityStatus='CONDITIONAL';
matWarning='âš ï¸ CONDITIONAL: Verify temperature rating. Environmental stress cracking possible.';
conditional=true;}}
else if(item==='316SS'||item==='304SS'){
robustnessCap=90;matPenalty=highTemp?8:3;
matWarning='âœ“ Good: Stainless steels resistant to caustic at moderate temperatures.';}
}
// --- VELOCITY-SENSITIVE MATERIALS (per feedback) ---
if(isVelocitySensitive&&!notRecommended){
if(item==='Carbon-Steel'||item==='Cast-Iron'){
sensitivityPenalty=Math.max(sensitivityPenalty,20);
robustnessCap=Math.min(robustnessCap,60);
if(compatibilityStatus==='COMPATIBLE')compatibilityStatus='CONDITIONAL';
conditionsList.push('Velocity-sensitive chemistry','Verify flow <1 m/s');
if(!matWarning)matWarning='âš ï¸ CONDITIONAL: Velocity-sensitive chemistry. Flow rate verification required.';
conditional=true;}}

// --- TEMPERATURE CHECKS FOR POLYMERS ---
if((isElastomer||isPolymer)&&f.includes('TEMPERATURE_HIGH')&&!notRecommended){
mechPenalty+=15;
robustnessCap=Math.min(robustnessCap,70);
if(compatibilityStatus==='COMPATIBLE')compatibilityStatus='CONDITIONAL';
conditionsList.push('High temperature may accelerate degradation');
if(!matWarning)matWarning='âš ï¸ CONDITIONAL: Verify temperature rating. Risk of accelerated aging/permeation.';
conditional=true;}

// --- POLYMER MECHANICAL UNCERTAINTY IN SEVERE CHEMISTRY (V6.2) ---
if(isPolymer&&(isStrongOx||isDehydrating)&&!notRecommended&&!conditional){
// PTFE/PVDF are chemically excellent but have mechanical uncertainty
if(!matWarning)matWarning='Chemically inert. Uncertainty: mechanical integrity, creep, permeation.';
}

// V90 FIX #2: PVC POLICY DOWNGRADE for oxidizer-adjacent/fertilizer fluids
// Even at low temps, PVC has operational risks: brittle failure, fire load, static discharge
const v90ItemFlags = getFluidBehaviorProfile(curFluid, curTemp).flags;
const v90IsOxidizer = v90ItemFlags.includes('OXIDIZER_STRONG') || v90ItemFlags.includes('OXIDIZER_ADJACENT') || v90ItemFlags.includes('OXIDIZER_MODERATE');
const v90IsFertilizer = v90ItemFlags.includes('FERTILIZER_INDUSTRY');

if(item === 'PVC' && (v90IsOxidizer || v90IsFertilizer) && !notRecommended && !conditional) {
  // Downgrade from Excellent â†’ Good (at minimum)
  compatibilityStatus = 'CONDITIONAL';
  conditional = true;
  robustnessCap = Math.min(robustnessCap, 70);
  matPenalty += 15;
  conditionsList.push('Oxidizer service', 'Fire load consideration', 'Static control required');
  matWarning = 'âš ï¸ CONDITIONAL: PVC not preferred for oxidizer/fertilizer service. Risks: brittle failure, fire load, poor thermal excursion performance, static discharge. Consider PTFE, PVDF, or 316SS.';
  addAuditEntry('RULE-REG-402', item, curFluid, curTemp, 'CONDITIONAL', 'PVC downgraded for oxidizer/fertilizer policy');
}

// --- ELASTOMER OXIDIZER CHECK ---
if(isElastomer&&isStrongOx&&!notRecommended&&item!=='Kalrez'){
mechPenalty+=12;
robustnessCap=Math.min(robustnessCap,65);
matWarning=(matWarning||'')+(matWarning?' | ':'âš ï¸ ')+'Oxidizer may cause elastomer degradation/hardening.';}

// === CALCULATE BASE ROBUSTNESS (per feedback #7) ===
// Robustness = Chemical resistance + Passivation stability + Sensitivity to upsets + Fabrication risk + Industry precedent
const totalPenalty=matPenalty+Math.floor(stabilityPenalty*0.8)+Math.floor(sensitivityPenalty*0.7)+Math.floor(mechPenalty*0.6);
robustnessScore=Math.max(30,Math.min(robustnessCap,100-totalPenalty));

// === CONFIDENCE SCORE (Data quality only - per feedback #3) ===
// CONFIDENCE â‰  SAFETY â‰  PERFORMANCE
// Confidence = Source Authority + Input Completeness + Applicability Range
// Confidence NEVER increases a recommendation, only downgrades/warns
const srcBase=92;const srcPenalty=hasSeverityMode?Math.floor(totalPenalty*0.4):Math.floor(totalPenalty*0.25);
const srcScore=Math.max(55,srcBase-srcPenalty);
const chemNote=severeConditions?' - HIGH UNCERTAINTY ('+severityModes.join(', ')+')':'';
factors.push({name:'Data Source (NACE/ASM)',score:srcScore,note:'Authoritative databases'+chemNote});
// Input Completeness
const inpScore=ctx.tempDefined?88:60;
factors.push({name:'Input Completeness',score:inpScore,note:ctx.tempDefined?'Temperature specified':'Using default temperature'});
// Range Match (Applicability)
const rangeBase=ctx.inRange?95:65;
const rangePenalty=severeConditions?Math.floor(totalPenalty*0.5):Math.floor(totalPenalty*0.3);
const rangeScore=Math.max(50,rangeBase-rangePenalty);
factors.push({name:'Applicability Range',score:rangeScore,note:ctx.inRange?'Within range'+(severeConditions?' (verify with field data)':''):'Outside typical range'});
// Safety Margin - based on compatibility STATUS not score
const safetyBase=ctx.rating==='excellent'?95:ctx.rating==='good'?80:ctx.rating==='poor'?40:70;
const safetyPenalty=notRecommended?35:conditional?20:severeConditions?15:Math.floor(totalPenalty*0.2);
const safetyScore=Math.max(40,safetyBase-safetyPenalty);
factors.push({name:'Safety Margin',score:safetyScore,note:compatibilityStatus+(severeConditions?' - extreme chemistry':'')});
// Base total before chemistry factor
let baseTotal=srcScore*w.src+inpScore*w.inp+rangeScore*w.range+safetyScore*w.safety;
// Apply Chemistry Risk Factor (cumulative multiplier)
total=baseTotal*chemFactor;
// === CONFIDENCE CAPS (per directive) ===
// Per feedback #3: Confidence may NEVER increase recommendation
// NOT RECOMMENDED materials: max 70% (reduced from 75%)
if(notRecommended)total=Math.min(total,70);
// CONDITIONAL materials: max 80% (reduced from 85%)
else if(conditional)total=Math.min(total,80);
// Any severity mode active: max 88%
else if(hasSeverityMode)total=Math.min(total,88);
// Severe chemistry (oxidizer/dehydrating): max 85%
if(severeChemistry)total=Math.min(total,85);
warning=matWarning;
// Store conditions list for UI display
if(conditionsList.length>0&&!warning.includes('Valid only if')){
warning+=(warning?' | ':'')+'Conditions: '+conditionsList.slice(0,3).join('; ');}
}else if(type==='seal'){
// Data Source - API standards
const srcScore=ctx.hasAPI?94:78;factors.push({name:'Data Source (API 682/685)',score:srcScore,note:ctx.hasAPI?'API standard referenced':'Industry practice'});
// Input Completeness
const inpScore=ctx.tempDefined&&ctx.viscDefined?90:70;factors.push({name:'Input Completeness',score:inpScore,note:'Fluid properties calculated'});
// Range Match - seal type matches fluid category
const rangeScore=ctx.categoryMatch?92:70;factors.push({name:'Application Match',score:rangeScore,note:ctx.categoryMatch?'Seal type matches fluid':'General recommendation'});
// Safety - priority level
const safetyScore=ctx.priority.includes('CRITICAL')?98:ctx.priority.includes('STRONGLY')?90:ctx.priority.includes('RECOMMENDED')?85:75;factors.push({name:'Safety Assessment',score:safetyScore,note:ctx.priority});
total=srcScore*w.src+inpScore*w.inp+rangeScore*w.range+safetyScore*w.safety;
}else if(type==='cavitation'){
// Data Source - vapor pressure from CRC/Perry
const srcScore=90;factors.push({name:'Data Source (CRC/Perry)',score:srcScore,note:'Thermodynamic property data'});
// Input Completeness - all cavitation inputs provided
const inpScore=ctx.allInputs?95:65;factors.push({name:'Input Completeness',score:inpScore,note:ctx.allInputs?'All parameters specified':'Some defaults used'});
// Range Match
const rangeScore=ctx.tempInRange?92:60;factors.push({name:'Temperature Range',score:rangeScore,note:ctx.tempInRange?'Within data range':'Extrapolated'});
// Safety Margin
const safetyScore=ctx.margin>50?98:ctx.margin>20?85:ctx.margin>10?70:45;factors.push({name:'Safety Margin ('+safeToFixed(ctx.margin, 0, '0')+'%)',score:safetyScore,note:ctx.margin>50?'Excellent margin':ctx.margin>10?'Acceptable margin':'Low margin'});
total=srcScore*w.src+inpScore*w.inp+rangeScore*w.range+safetyScore*w.safety;
}
const score=Math.round(total);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V87 UNIVERSAL CONFIDENCE CAPS (From Universal Rulebook)
// These caps override ALL other calculations - ONLY for material type
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cappedScore = score;
let capReason = '';

// Only apply material-specific caps for material type
if (type === 'material') {
  // Re-check material types for cap logic (already defined above but need scope access)
  const capIsElastomer = ['FKM','EPDM','NBR','Kalrez','Neoprene','Silicone'].includes(item);
  const capIsPolymer = ['PTFE','PVDF','PP','PVC','CPVC','HDPE','PEEK','UHMWPE'].includes(item);
  const capTempC = ctx.tempC || 20;
  const capIsHighTemp = capTempC >= 80;
  const capIsElevatedTemp = capTempC >= 40;
  const capProfile = getFluidBehaviorProfile(ctx.fluidKey || '', capTempC);
  const capFlags = capProfile.flags;
  const capIsStrongOx = capFlags.includes('OXIDIZER_STRONG');
  const capIsMildOx = capFlags.includes('OXIDIZER_MILD');
  const capIsOxidizerAdjacent = capFlags.includes('OXIDIZER_ADJACENT');
  const capIsEnergetic = capFlags.includes('ENERGETIC');
  const capIsFertilizer = capFlags.includes('FERTILIZER_INDUSTRY');

  // V88: Apply confidence decay penalties FIRST (from feedback doc)
  // Temp >40Â°C â†’ -5
  if (capIsElevatedTemp && cappedScore > 20) {
    cappedScore -= 5;
    capReason = 'Temp >40Â°C penalty';
  }

  // Oxidizer-adjacent â†’ -10
  if (capIsOxidizerAdjacent && cappedScore > 20) {
    cappedScore -= 10;
    capReason = capReason ? capReason + ' + oxidizer-adjacent' : 'Oxidizer-adjacent penalty';
  }

  // Fertilizer/explosive industry â†’ -10
  if ((capIsFertilizer || capIsEnergetic) && cappedScore > 20) {
    cappedScore -= 10;
    capReason = capReason ? capReason + ' + industry hazard' : 'Industry hazard penalty';
  }

  // Rule 1: CONDITIONAL material â†’ Max 85%
  if (conditional && cappedScore > 85) {
    cappedScore = 85;
    capReason = capReason ? capReason + ' + CONDITIONAL cap' : 'CONDITIONAL material cap';
  }

  // Rule 2: Elastomer in oxidizer â†’ Max 75%
  if (capIsElastomer && (capIsStrongOx || capIsMildOx || capIsOxidizerAdjacent) && cappedScore > 75) {
    cappedScore = 75;
    capReason = capReason ? capReason + ' + elastomer-oxidizer cap' : 'Elastomer in oxidizer cap';
  }

  // Rule 3: Polymer above service temp warning â†’ Max 70%
  if (capIsPolymer && capIsHighTemp && cappedScore > 70) {
    cappedScore = 70;
    capReason = capReason ? capReason + ' + polymer-temp cap' : 'Polymer high-temp cap';
  }

  // Rule 3b: PVC at >40Â°C with aggressive chemistry â†’ Max 75%
  if (item === 'PVC' && capIsElevatedTemp && cappedScore > 75) {
    cappedScore = 75;
    capReason = capReason ? capReason + ' + PVC temp limit' : 'PVC >40Â°C limit';
  }

  // V90: PVC in oxidizer/fertilizer â†’ Max 70%
  if (item === 'PVC' && (capIsOxidizerAdjacent || capIsFertilizer || capIsEnergetic) && cappedScore > 70) {
    cappedScore = 70;
    capReason = capReason ? capReason + ' + PVC oxidizer policy' : 'PVC oxidizer/fertilizer policy cap';
  }

  // V90: Aluminum in oxidizer/fertilizer â†’ Max 65% (policy-driven, not corrosion)
  if (item === 'Aluminum' && (capIsOxidizerAdjacent || capIsFertilizer || capIsEnergetic) && cappedScore > 65) {
    cappedScore = 65;
    capReason = capReason ? capReason + ' + Al oxidizer policy' : 'Aluminum oxidizer/fertilizer policy cap';
  }

  // Rule 4: Missing concentration data â†’ Max 60%
  if (ctx.missingConcentration && cappedScore > 60) {
    cappedScore = 60;
    capReason = capReason ? capReason + ' + missing data cap' : 'Missing concentration data cap';
  }

  // Rule 5: Any warning flag â†’ Subtract 10%
  if (warning && warning.length > 0) {
    cappedScore = Math.max(cappedScore - 10, 20);
    capReason = capReason ? capReason + ' + warning penalty' : 'Warning penalty';
  }

  // Rule 6: NOT_RECOMMENDED â†’ Max 40%
  if (notRecommended && cappedScore > 40) {
    cappedScore = 40;
    capReason = 'NOT_RECOMMENDED cap';
  }
}

// V90 FIX #4: CONFIDENCE MICRO-VARIATION
// Avoid flat 72%/69% bands that look algorithmic
// Introduce Â±2% variation based on: material type hash, data source factors, temp distance
if (type === 'material' && cappedScore > 50 && cappedScore < 95) {
  // Generate deterministic micro-variation based on material + fluid combination
  const materialHash = item.split('').reduce((a, c) => a + c.charCodeAt(0), 0) % 5; // 0-4
  const fluidHash = (curFluid || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0) % 3; // 0-2
  const tempFactor = Math.abs(Math.floor((curTemp || 25) / 20) % 3) - 1; // -1, 0, or 1

  // Calculate micro-adjustment: -2 to +3 range
  const microAdjust = (materialHash - 2) + (fluidHash - 1) + tempFactor;

  // Apply micro-variation but respect caps
  const adjustedScore = cappedScore + microAdjust;

  // Ensure we don't exceed caps or go below floor
  if (conditional && adjustedScore > 85) {
    cappedScore = 85; // Respect CONDITIONAL cap
  } else if (notRecommended && adjustedScore > 40) {
    cappedScore = 40; // Respect NOT_RECOMMENDED cap
  } else {
    cappedScore = Math.max(45, Math.min(94, adjustedScore));
  }
}

const finalScore = cappedScore;
const level=finalScore>=90?'VERY HIGH':finalScore>=75?'HIGH':finalScore>=60?'MODERATE':'LOW';
const levelClass=finalScore>=90?'very-high':finalScore>=75?'high':finalScore>=60?'moderate':'low';
// CRITICAL FIX #2: Include severity mode flag and robustness cap for UI display
// V89: Build penalty breakdown for audit trail
const penaltyBreakdown = [];
if (type === 'material' && capReason) {
  if (capReason.includes('Temp >40')) penaltyBreakdown.push({rule: 'RULE-CONF-503', desc: 'Temperature >40Â°C', penalty: -5});
  if (capReason.includes('oxidizer-adjacent')) penaltyBreakdown.push({rule: 'RULE-CONF-502', desc: 'Oxidizer-adjacent fluid', penalty: -10});
  if (capReason.includes('industry hazard')) penaltyBreakdown.push({rule: 'RULE-CONF-502', desc: 'Fertilizer/energetic industry', penalty: -10});
  if (capReason.includes('CONDITIONAL cap')) penaltyBreakdown.push({rule: 'RULE-CONF-501', desc: 'CONDITIONAL material', penalty: 'cap 85%'});
  if (capReason.includes('elastomer-oxidizer')) penaltyBreakdown.push({rule: 'RULE-CONF-502', desc: 'Elastomer in oxidizer', penalty: 'cap 75%'});
  if (capReason.includes('polymer-temp')) penaltyBreakdown.push({rule: 'RULE-TEMP-201', desc: 'Polymer high-temp', penalty: 'cap 70%'});
  if (capReason.includes('PVC temp')) penaltyBreakdown.push({rule: 'RULE-TEMP-201', desc: 'PVC >40Â°C', penalty: 'cap 75%'});
  if (capReason.includes('missing data')) penaltyBreakdown.push({rule: 'RULE-CONF-504', desc: 'Missing concentration data', penalty: 'cap 60%'});
  if (capReason.includes('warning penalty')) penaltyBreakdown.push({rule: 'RULE-CONF-501', desc: 'Warning flag present', penalty: -10});
  if (capReason.includes('NOT_RECOMMENDED')) penaltyBreakdown.push({rule: 'RULE-CHEM-102', desc: 'NOT RECOMMENDED status', penalty: 'cap 40%'});
}

return {score:finalScore,level,levelClass,factors,warning,conditional,notRecommended:notRecommended||false,hasSeverityMode:hasSeverityMode||false,robustnessScore:robustnessScore||100,compatibilityStatus:compatibilityStatus||'COMPATIBLE',capReason:capReason,penaltyBreakdown:penaltyBreakdown};
}
function confBadgeHTML(conf,id){
// CRITICAL FIX #2: In severe chemistry, show categorical status + data confidence, NOT % next to material
const notRecTag=conf.notRecommended?'<span style="background:#dc2626;color:#fff;font-size:0.6rem;padding:1px 4px;border-radius:2px;margin-left:4px">NOT RECOMMENDED</span>':'';
const conditionalTag=(!conf.notRecommended&&conf.conditional)?'<span style="background:#92400e;color:#fef3c7;font-size:0.6rem;padding:1px 4px;border-radius:2px;margin-left:4px">CONDITIONAL</span>':'';
// For severe chemistry: Show categorical status instead of misleading %
if(conf.hasSeverityMode&&!conf.notRecommended&&!conf.conditional){
// COMPATIBLE in severe chemistry - show status badge + uncertainty driver (not %)
const uncertaintyDriver=conf.warning?conf.warning.split('.')[0]:'Verify field conditions';
return '<div class="conf-badge '+conf.levelClass+'" onclick="toggleConf(\''+id+'\')"><span style="background:#059669;color:white;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600">COMPATIBLE</span><span class="conf-info">â“˜</span></div><div style="font-size:0.7rem;color:#94a3b8;margin-top:2px">Uncertainty: '+uncertaintyDriver+'</div>'+(conf.warning?'<div class="conf-warning">'+conf.warning+'</div>':'')+'<div class="conf-breakdown" id="conf-'+id+'">'+conf.factors.map(f=>'<div class="conf-factor"><span class="conf-factor-name">'+f.name+'</span><span class="conf-factor-score '+(f.score>=85?'high':f.score>=65?'mid':'low')+'">'+f.score+'%</span></div>').join('')+'<div class="conf-disclaimer">Compatibility is categorical. Percentages indicate data quality ONLY - click â“˜ for details.</div></div>';
}
// NOT RECOMMENDED or CONDITIONAL: show status prominently, hide %
if(conf.notRecommended||conf.conditional){
const statusBadge=conf.notRecommended?'<span style="background:#dc2626;color:white;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600">NOT RECOMMENDED</span>':'<span style="background:#d97706;color:white;padding:2px 6px;border-radius:3px;font-size:0.65rem;font-weight:600">CONDITIONAL</span>';
const dataConfLabel=conf.score>=70?'MEDIUM':conf.score>=50?'LOW':'VERY LOW';
const dataConfColor=conf.score>=70?'#78350f':conf.score>=50?'#7f1d1d':'#450a0a';
return '<div class="conf-badge '+conf.levelClass+'" onclick="toggleConf(\''+id+'\')">'+statusBadge+'<span style="margin-left:6px;background:'+dataConfColor+';color:#fef3c7;padding:2px 6px;border-radius:3px;font-size:0.6rem">Data: '+dataConfLabel+'</span><span class="conf-info">â“˜</span></div>'+(conf.warning?'<div class="conf-warning">'+conf.warning+'</div>':'')+'<div class="conf-breakdown" id="conf-'+id+'">'+conf.factors.map(f=>'<div class="conf-factor"><span class="conf-factor-name">'+f.name+'</span><span class="conf-factor-score '+(f.score>=85?'high':f.score>=65?'mid':'low')+'">'+f.score+'%</span></div>').join('')+'<div class="conf-disclaimer">Data Confidence indicates source quality. Status reflects chemistry-specific compatibility.</div></div>';
}
// Standard case (no severity mode): Show traditional % badge
return '<div class="conf-badge '+conf.levelClass+'" onclick="toggleConf(\''+id+'\')"><span>'+conf.level+' ('+conf.score+'%)</span>'+notRecTag+conditionalTag+'<span class="conf-info">â“˜</span></div>'+(conf.warning?'<div class="conf-warning">'+conf.warning+'</div>':'')+'<div class="conf-breakdown" id="conf-'+id+'">'+conf.factors.map(f=>'<div class="conf-factor"><span class="conf-factor-name">'+f.name+'</span><span class="conf-factor-score '+(f.score>=85?'high':f.score>=65?'mid':'low')+'">'+f.score+'%</span></div>').join('')+'<div class="conf-disclaimer">Confidence indicates data robustness, not probability of failure.</div></div>';
}
function toggleConf(id){DOM.toggleClass('conf-'+id,'open');}
function drawChart(fk,tC){
const fl=F[fk],cv=document.getElementById('viscChart');if(!cv)return;
const ctx=cv.getContext('2d'),w=cv.width=cv.offsetWidth,h=cv.height=280;
const pad={l:60,r:20,t:25,b:45},plotW=w-pad.l-pad.r,plotH=h-pad.t-pad.b;
ctx.fillStyle='#1e293b';ctx.fillRect(0,0,w,h);
const data=fl.d,temps=data.map(d=>d[0]),viscs=data.map(d=>d[2]);
const minT=Math.min(...temps),maxT=Math.max(...temps),minV=Math.min(...viscs),maxV=Math.max(...viscs);
const useLog=maxV/minV>50;
const getY=v=>{if(useLog){const logMin=Math.log10(Math.max(minV,0.01)),logMax=Math.log10(maxV),logV=Math.log10(Math.max(v,0.01));return pad.t+plotH-(logV-logMin)/(logMax-logMin)*plotH;}return pad.t+plotH-(v-minV)/(maxV-minV)*plotH;};
const getX=t=>pad.l+(t-minT)/(maxT-minT)*plotW;
ctx.strokeStyle='#334155';ctx.lineWidth=1;
for(let i=0;i<=5;i++){const y=pad.t+i*plotH/5;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();const x=pad.l+i*plotW/5;ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,h-pad.b);ctx.stroke();}
ctx.strokeStyle='#64748b';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pad.l,pad.t);ctx.lineTo(pad.l,h-pad.b);ctx.lineTo(w-pad.r,h-pad.b);ctx.stroke();
ctx.fillStyle='#94a3b8';ctx.font='11px Segoe UI';ctx.textAlign='center';ctx.fillText('Temperature (Â°C)',w/2,h-8);
ctx.save();ctx.translate(14,h/2);ctx.rotate(-Math.PI/2);ctx.fillText('Viscosity (cP)'+(useLog?' [Log]':''),0,0);ctx.restore();
ctx.font='9px Segoe UI';
for(let i=0;i<=5;i++){const t=minT+(maxT-minT)*i/5;ctx.fillText(t.toFixed(0),getX(t),h-pad.b+12);}
for(let i=0;i<=5;i++){let v;if(useLog){const logMin=Math.log10(Math.max(minV,0.01)),logMax=Math.log10(maxV);v=Math.pow(10,logMin+(logMax-logMin)*(5-i)/5);}else{v=minV+(maxV-minV)*(5-i)/5;}ctx.textAlign='right';ctx.fillText(v>=100?v.toFixed(0):v.toFixed(1),pad.l-6,pad.t+i*plotH/5+3);}
ctx.strokeStyle='#3b82f6';ctx.lineWidth=3;ctx.beginPath();data.forEach((d,i)=>{const x=getX(d[0]),y=getY(d[2]);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();
ctx.fillStyle='#3b82f6';data.forEach(d=>{const x=getX(d[0]),y=getY(d[2]);ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();});
const curr=interp(tC,fl.d);
if(tC>=minT&&tC<=maxT){const cx=getX(tC),cy=getY(curr.visc);ctx.fillStyle='#ef4444';ctx.beginPath();ctx.arc(cx,cy,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='white';ctx.font='bold 9px Segoe UI';ctx.textAlign='center';ctx.fillText('â˜…',cx,cy+3);ctx.fillStyle='#fecaca';ctx.font='10px Segoe UI';ctx.fillText(safeToFixed(tC, 0, '0')+'Â°C: '+safeToFixed(curr.visc, 2, '0')+' cP',cx,cy-12);}
}
/* V16.1 FIX: toggleMat prevents selecting excluded materials per V15 Policy Â§15 */
function toggleMat(id){
  // V16.1: Check if material is excluded - prevent selection
  const btn = document.querySelector('.mat-btn[data-mat="'+id+'"]');
  if(btn && btn.classList.contains('excluded')) {
    // Material is excluded - do not allow selection
    console.warn('V15 Â§15: Cannot select excluded material:', id);
    return;
  }
  const idx=selMats.indexOf(id);
  if(idx>=0) selMats.splice(idx,1);
  else if(selMats.length<4) selMats.push(id);
  document.querySelectorAll('.mat-btn').forEach(el=>{
    // Only toggle selected state for non-excluded materials
    if(!el.classList.contains('excluded')) {
      el.classList.toggle('selected',selMats.includes(el.dataset.mat));
    }
  });
  calcLifecycle();
}
// V16.2 HARDENING: P1-A - Add try-catch wrapper (Agent 3: Safety & Compliance)
function calcLifecycle(){
try {
if(!curFluid||!document.getElementById('lifecycleResults'))return;
const fl=F[curFluid];
// V91: Null-safety guard for fluid data
if(!fl||!fl.d){DOM.setHTML('lifecycleResults','<div style="color:#fca5a5">Error: Invalid fluid data</div>');return;}

// V16.2: Temperature validation (P1-D)
if (typeof curTemp !== 'number' || isNaN(curTemp)) {
  DOM.setHTML('lifecycleResults','<div style="color:#fca5a5">Error: Invalid temperature</div>');
  return;
}
const tempValid = validateTemperature(curTemp);
if (!tempValid.valid) {
  DOM.setHTML('lifecycleResults','<div style="color:#fca5a5">Error: ' + tempValid.errors.join(', ') + '</div>');
  return;
}

// V16.3 REC-C3: TCO suppression for EXPLOSIVE_ENERGETIC per V15 Â§14
const regime = _currentFAO ? _currentFAO.primaryRegime : resolvePrimaryRegime(curFluid, curTemp).primary;
const suppressTCORegimes = ['UNKNOWN_RESTRICTED', 'EXPLOSIVE_ENERGETIC', 'FLUORIDE_ACID', 'TOXIC_SPECIAL'];
if (suppressTCORegimes.includes(regime)) {
  DOM.setHTML('lifecycleResults', 
    '<div style="background:#1e1b4b;border:2px solid #6366f1;padding:16px;border-radius:8px;margin-top:12px">' +
    '<div style="color:#a5b4fc;font-weight:bold;font-size:1rem;margin-bottom:8px">âš ï¸ TCO ANALYSIS SUPPRESSED</div>' +
    '<div style="color:#c7d2fe;font-size:0.9rem;line-height:1.5">' +
    '<strong>V15 Â§14:</strong> Cost-based lifecycle recommendations are not provided for <strong>' + 
    regime.replace(/_/g, ' ') + '</strong> fluids.<br><br>' +
    'Material selection must prioritize <strong>safety and containment</strong> over economics. ' +
    'Consult specialist engineer for material qualification.</div></div>');
  return;
}

const ck=getC(curFluid,fl.c),corr=getCorrosionWithWarning(ck),compat=getCompatWithWarning(ck);
// Use Fluid Behavior Profile for consistent chemistry classification
const profile=getFluidBehaviorProfile(curFluid,curTemp);
const f=profile.flags||[];
const isStrongOx=f.includes('OXIDIZER_STRONG');
const isDehydrating=f.includes('DEHYDRATING');
const isVelocitySensitive=f.includes('VELOCITY_SENSITIVE');
const isReducingAcid=f.includes('REDUCING_ACID');
// TCO suppression rule: OXIDIZER_STRONG OR DEHYDRATING at elevated temp
const severeChemistry=(isStrongOx||isDehydrating)&&curTemp>=40;
const useRobustnessMode=severeChemistry;
const modeLabel=isDehydrating?'Concentrated Hâ‚‚SOâ‚„/Dehydrating':isStrongOx?'Strong Oxidizer':'Reactive Chemistry';
// High-temp oxidizer flag for methodology note
const highTempOx=isStrongOx&&curTemp>=50;

// CRITICAL FIX #1: Calculate actual velocity from pipe diameter assumption
// Assumes DN50 (2") pipe for typical flow
const props=interp(curTemp,fl.d);
// V91: Null-safety for props
const dens=(props&&props.sg)?props.sg*1000:1000;
const visc=(props&&props.visc)?props.visc/1000:0.001; // PaÂ·s
// Velocity estimate based on typical industrial flow (5-10 mÂ³/h in DN50)
const pipeID=0.0508; // 50mm internal diameter
const flowRate=0.002; // 7.2 mÂ³/h typical
const velocity=safeDivide(flowRate, Math.PI*Math.pow(pipeID/2,2), 1); // ~1 m/s typical
const actualVelocity=SafeFormat.decimal(velocity,2,'1.00');

// V6.2: REFUSAL INTELLIGENCE SYSTEM
// Detect conditions where CERTA should refuse confident recommendations
const refusalConditions=[];
const isHighTempSevereChemistry=severeChemistry&&curTemp>=60;
const isExtremeTemp=curTemp>100||curTemp<-20;
const hasMixedOxidizer=isStrongOx&&(curFluid.includes('chlor')||curFluid.includes('hcl'));
const isSCCCondition=(curFluid.includes('caustic')||curFluid.includes('naoh')||curFluid.includes('koh'))&&curTemp>50;
const isElastomerLimit=curTemp>150;

if(isHighTempSevereChemistry)refusalConditions.push({type:'HIGH_TEMP_SEVERE',msg:'High temperature + severe chemistry combination',action:'Specialist corrosion engineer review required'});
if(isExtremeTemp)refusalConditions.push({type:'EXTREME_TEMP',msg:'Temperature outside typical material test ranges',action:'Verify material ratings at actual operating temperature'});
if(hasMixedOxidizer)refusalConditions.push({type:'MIXED_CHEMISTRY',msg:'Oxidizer + halide combination detected',action:'Pitting/crevice corrosion risk - metallurgist review recommended'});
if(isSCCCondition)refusalConditions.push({type:'SCC_RISK',msg:'Caustic SCC conditions present (T>50Â°C)',action:'Stress analysis and PWHT verification required for carbon steel'});
if(isElastomerLimit)refusalConditions.push({type:'ELASTOMER_LIMIT',msg:'Temperature exceeds typical elastomer limits',action:'FFKM (Kalrez) or metal seals only - verify with manufacturer'});

// V6.2: Expert Review Warning Banner
let refusalHTML='';
if(refusalConditions.length>0){
refusalHTML='<div style="margin-bottom:16px;padding:12px;background:linear-gradient(135deg,#7f1d1d,#450a0a);border:2px solid #dc2626;border-radius:8px">';
refusalHTML+='<div style="font-weight:bold;color:#fca5a5;font-size:1rem;margin-bottom:8px">ğŸš¨ EXPERT REVIEW FLAGS ('+refusalConditions.length+')</div>';
refusalHTML+='<div style="font-size:0.8rem;color:#fef2f2;margin-bottom:8px">The following conditions exceed standard screening confidence. CERTA provides guidance but <strong>specialist verification is required</strong>.</div>';
refusalConditions.forEach(r=>{
refusalHTML+='<div style="background:#991b1b;padding:8px;border-radius:4px;margin-bottom:6px;border-left:3px solid #f87171">';
refusalHTML+='<div style="color:#fecaca;font-weight:600;font-size:0.85rem">âš ï¸ '+r.msg+'</div>';
refusalHTML+='<div style="color:#fef3c7;font-size:0.75rem;margin-top:4px">â†’ '+r.action+'</div>';
refusalHTML+='</div>';
});
refusalHTML+='<div style="font-size:0.7rem;color:#fca5a5;margin-top:8px;font-style:italic">CERTA\'s recommendations remain valid as screening guidance. Final material selection requires engineering sign-off.</div>';
refusalHTML+='</div>';
}

// Velocity thresholds for conditional materials
const VELOCITY_LIMITS={
'Carbon-Steel':{limit:0.5,chem:'dehydrating'},    // Concentrated H2SO4
'Cast-Iron':{limit:0.5,chem:'dehydrating'},
'316SS':{limit:1.5,chem:'dehydrating'},
'304SS':{limit:1.0,chem:'dehydrating'}
};

// V16.1 FIX: Removed orphaned table header that was causing duplicate display
let html=refusalHTML;
const results=[];
const failedMaterials=[]; // Track materials that fail conditions

// V16.2: Auto-analyze all materials (removed manual selection grid)
Object.keys(M.materials).forEach(id=>{
const mat=M.materials[id],cost=M.costs[id];if(!mat||!cost)return;
const cr=corr[id]||[0,0],avgRate=(cr[0]+cr[1])/2,life=avgRate>0?(cost.wall/avgRate*0.7):50;
const replacements=Math.max(0,Math.ceil(10/life)-1),initCost=cost.price*10,tco=initCost*(1+replacements)+replacements*500;
let rating='fair';if(compat.excellent&&compat.excellent.includes(id))rating='excellent';else if(compat.good&&compat.good.includes(id))rating='good';else if(compat.poor&&compat.poor.includes(id))rating='poor';

// V7.2 CRITICAL: INTEGRATE HARD FAILURE GATE INTO LIFECYCLE
// This ensures consistency between Material Compatibility section and Lifecycle Comparison
const gateResult=checkHardFailureGate(curFluid,curTemp,id);
let status='COMPATIBLE';
let failReason='';
let conditionsFailed=false;

// GATE OVERRIDE: If gate failed, override status and rating
// V16.1 FIX: Per V15 Â§2.3, gate results have absolute precedence over compat ratings
if(!gateResult.passed){
// FATAL failures
if(gateResult.failures.length>0){
status='NOT_RECOMMENDED';
failReason=gateResult.failures.join('; ');
conditionsFailed=true;
failedMaterials.push({id,mat,reason:failReason});
// Override rating to poor for gate failures
rating='poor';
}
// CONDITIONAL materials - V16.1 FIX: Must override rating to 'conditional'
else if(gateResult.conditionals.length>0){
status='CONDITIONAL';
failReason=gateResult.conditionals.join('; ');
// V16.1: Gate CONDITIONAL overrides even excellent compat rating per V15 Â§2.3
rating='conditional';
}
// TEMP limits exceeded
else if(gateResult.tempLimits.length>0){
status='CONDITIONAL';
failReason=gateResult.tempLimits.join('; ');
// V16.1: Temp limits also result in conditional rating
rating='conditional';
}
}

// Check velocity conditions for dehydrating chemistry (legacy validation)
if(isDehydrating&&VELOCITY_LIMITS[id]&&status!=='NOT_RECOMMENDED'){
const limit=VELOCITY_LIMITS[id].limit;
if(velocity>limit){
status='FAILED';
failReason='Velocity '+actualVelocity+' m/s exceeds limit of '+limit+' m/s';
conditionsFailed=true;
failedMaterials.push({id,mat,reason:failReason});
rating='poor';
}}

// Legacy checks (now supplemental to gate - only apply if gate didn't catch)
if(isReducingAcid&&profile.hclConc>=20&&status==='COMPATIBLE'){
if(id==='Titanium'){
status='NOT_RECOMMENDED';
failReason='Severely attacked by HCl â‰¥20%';
rating='poor';
}}

// Calculate robustness score using behavior flags
let robustness=50;
if(rating==='excellent')robustness+=40;else if(rating==='good')robustness+=20;else if(rating==='poor')robustness-=20;
// Polymer stability bonus (chemically inert)
if(id==='PTFE'||id==='PVDF'||id==='PEEK')robustness+=15;
if(id==='Kalrez')robustness+=12;
// Metal-specific adjustments based on behavior flags
if(isDehydrating){
if(id==='Hastelloy-C')robustness-=40;
if(id==='Titanium')robustness-=30;
if(id==='Aluminum')robustness-=35;
if(id==='Carbon-Steel'||id==='Cast-Iron')robustness-=25;
if(id==='316SS')robustness-=20;
if(id==='304SS')robustness-=25;
}
if(isStrongOx){
if(id==='Titanium'){
robustness+=20;
// V6.2: Flag as industry standard for oxidizer service
}
if(id==='316SS'||id==='304SS')robustness-=20;
if(id==='Aluminum')robustness-=15;
if(id==='Carbon-Steel')robustness-=30;
}
if(isVelocitySensitive&&(id==='Carbon-Steel'||id==='Cast-Iron'))robustness-=15;

// FAILED conditions = robustness zeroed, NOT_RECOMMENDED = severely penalized
if(conditionsFailed)robustness=0;
else if(status==='NOT_RECOMMENDED')robustness=Math.min(robustness,20);

// CRITICAL FIX #3: Flag elastomers for separate table (they don't fail like metals)
const isElastomer=['FKM','EPDM','NBR','Kalrez','Neoprene','Silicone'].includes(id);
const isPolymerLining=['PTFE','PVDF','PP','PVC','CPVC','HDPE','PEEK','UHMWPE'].includes(id);
// Elastomers: use different degradation model
let elastomerBehavior='';
let inspectionInterval='';
if(isElastomer){
elastomerBehavior=(isStrongOx||isDehydrating)?'Oxidative attack/hardening risk':'Swelling/permeation possible';
inspectionInterval=(isStrongOx||isDehydrating)?'6 months':'12 months';
}else if(isPolymerLining){
elastomerBehavior=isDehydrating?'Permeation check required':'Chemically stable';
inspectionInterval='24 months';
}

results.push({id,mat,cost,cr,avgRate,life,replacements,initCost,tco,rating,robustness:Math.max(0,Math.min(100,robustness)),status,failReason,conditionsFailed,isElastomer,isPolymerLining,elastomerBehavior,inspectionInterval});
});
if(results.length===0){DOM.setHTML('lifecycleResults','<p style="color:#fca5a5">Select materials above to compare.</p>');return;}
// CRITICAL FIX #3: Separate structural materials from elastomers/sealing materials
const structuralMats=results.filter(r=>!r.isElastomer);
const elastomerMats=results.filter(r=>r.isElastomer);
// Sort: COMPATIBLE > CONDITIONAL > NOT_RECOMMENDED > FAILED
// Within each status: by robustness in extreme chemistries, otherwise by TCO
const statusOrder={'COMPATIBLE':0,'CONDITIONAL':1,'NOT_RECOMMENDED':2,'FAILED':3};
if(useRobustnessMode){
structuralMats.sort((a,b)=>{
const orderDiff=statusOrder[a.status]-statusOrder[b.status];
if(orderDiff!==0)return orderDiff;
return b.robustness-a.robustness;
});
elastomerMats.sort((a,b)=>{
const orderDiff=statusOrder[a.status]-statusOrder[b.status];
if(orderDiff!==0)return orderDiff;
return b.robustness-a.robustness;
});
}else{
structuralMats.sort((a,b)=>a.tco-b.tco);
elastomerMats.sort((a,b)=>a.tco-b.tco);
}
const maxTco=Math.max(...results.map(r=>r.tco));
const maxRob=Math.max(...results.filter(r=>r.robustness>0).map(r=>r.robustness))||100;

// TABLE A: Structural Materials (metals, plastics, linings)
if(structuralMats.length>0){
html+='<div style="margin-bottom:8px;font-weight:bold;color:#60a5fa;font-size:0.85rem">ğŸ“ Structural Materials (Vessels, Piping, Linings)</div>';
html+='<div class="table-scroll-wrapper"><table class="compare-table"><thead><tr><th>Material</th><th>Status</th><th>Corrosion</th><th>Service Life</th><th>'+(useRobustnessMode?'Robustness':'10-Year TCO')+'</th></tr></thead><tbody>';
structuralMats.forEach(r=>{
const statusBadge=r.conditionsFailed?'<span style="background:#dc2626;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">FAILED</span>':
r.status==='NOT_RECOMMENDED'?'<span style="background:#991b1b;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">NOT REC.</span>':
r.status==='CONDITIONAL'?'<span style="background:#d97706;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">CONDITIONAL</span>':
'<span style="background:#059669;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">COMPATIBLE</span>';
const failNote=r.failReason?'<br><span style="font-size:0.65rem;color:#fca5a5">'+r.failReason+'</span>':'';
if(useRobustnessMode){
html+='<tr style="'+(r.conditionsFailed?'opacity:0.6;background:#451a03':'')+'"><td><strong>'+r.mat.name+'</strong>'+failNote+'<br><span style="font-size:0.75rem;color:#64748b">'+r.mat.type+'</span></td><td>'+statusBadge+'</td><td>'+safeToFixed(r.cr[0], 2, '0')+'-'+safeToFixed(r.cr[1], 2, '0')+' mm/yr</td><td>'+(r.life>=50?'25+ yrs':safeToFixed(r.life, 1, '0')+' yrs')+'</td><td>'+(r.conditionsFailed?'<span style="color:#ef4444;font-weight:bold">N/A</span>':'<span style="font-weight:bold;color:'+(r.robustness>=80?'#34d399':r.robustness>=60?'#fbbf24':'#f87171')+'">'+r.robustness+'%</span><div class="cost-bar"><div class="cost-fill" style="width:'+((r.robustness/maxRob)*100)+'%;background:'+(r.robustness>=80?'#10b981':r.robustness>=60?'#f59e0b':'#ef4444')+'"></div></div>')+'</td></tr>';
}else{
// V16.1 FIX: Use statusBadge (from gate results) instead of rating badge per V15 Â§2.3 precedence
html+='<tr><td><strong>'+r.mat.name+'</strong><br><span style="font-size:0.75rem;color:#64748b">'+r.mat.type+'</span></td><td>'+statusBadge+'</td><td>'+safeToFixed(r.cr[0], 2, '0')+'-'+safeToFixed(r.cr[1], 2, '0')+' mm/yr</td><td>'+(r.life>=50?'25+ yrs':safeToFixed(r.life, 1, '0')+' yrs')+'<br><span style="font-size:0.75rem;color:#64748b">'+r.replacements+' repl/10yr</span></td><td>$'+safeToFixed(r.tco, 0, '0')+'/mÂ²<div class="cost-bar"><div class="cost-fill" style="width:'+((r.tco/maxTco)*100)+'%"></div></div></td></tr>';
}});
html+='</tbody></table></div>';
}

// TABLE B: Elastomers & Sealing Materials (different failure modes!)
if(elastomerMats.length>0){
html+='<div style="margin:16px 0 8px;font-weight:bold;color:#c084fc;font-size:0.85rem">ğŸ”© Sealing & Elastomer Materials</div>';
html+='<div style="background:#3b0764;padding:8px;border-radius:4px;margin-bottom:8px;font-size:0.75rem;color:#e9d5ff;border:1px solid #7c3aed">';
html+='<strong>âš ï¸ Note:</strong> Elastomers fail by swelling, hardening, cracking, and permeation â€” not by corrosion thickness loss. Service life estimates use degradation models, not corrosion rates.</div>';
html+='<div class="table-scroll-wrapper"><table class="compare-table"><thead><tr><th>Material</th><th>Status</th><th>Expected Behavior</th><th>Inspection Interval</th><th>Strategy</th></tr></thead><tbody>';
elastomerMats.forEach(r=>{
const statusBadge=r.status==='NOT_RECOMMENDED'?'<span style="background:#991b1b;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">NOT REC.</span>':
r.status==='CONDITIONAL'?'<span style="background:#d97706;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">CONDITIONAL</span>':
'<span style="background:#059669;color:white;padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600">COMPATIBLE</span>';
const behavior=r.elastomerBehavior||'Standard degradation';
const interval=r.inspectionInterval||'12 months';
const strategy=(isStrongOx||isDehydrating)?'Preventive replacement':'Condition-based';
html+='<tr><td><strong>'+r.mat.name+'</strong><br><span style="font-size:0.75rem;color:#64748b">'+r.mat.type+'</span></td><td>'+statusBadge+'</td><td><span style="font-size:0.8rem;color:#e9d5ff">'+behavior+'</span></td><td><span style="font-size:0.8rem;color:#fcd34d;font-weight:600">'+interval+'</span></td><td><span style="font-size:0.75rem;color:#94a3b8">'+strategy+'</span></td></tr>';
});
html+='</tbody></table></div>';
}

// V85 FIX: Filter for valid candidates ONLY - exclude NOT_RECOMMENDED AND FAILED
// Materials under SCC/hard failure must NEVER appear in economic recommendations
const validResults=structuralMats.filter(r=>!r.conditionsFailed && r.status!=='NOT_RECOMMENDED');
const best=validResults[0];
const worst=validResults[validResults.length-1];
// Collect ALL excluded materials (NOT_RECOMMENDED or FAILED)
const excludedMaterials=structuralMats.filter(r=>r.conditionsFailed || r.status==='NOT_RECOMMENDED');
// Show failed/excluded materials warning if any
if(excludedMaterials.length>0){
html+='<div style="margin-top:12px;padding:10px;background:#7f1d1d;border:1px solid #dc2626;border-radius:6px">';
html+='<div style="font-weight:bold;color:#fca5a5;margin-bottom:6px">ğŸš« EXCLUDED FROM ANALYSIS ('+excludedMaterials.length+')</div>';
html+='<div style="font-size:0.75rem;color:#fecaca;margin-bottom:8px">The following materials are <strong>prohibited</strong> under current conditions and excluded from lifecycle/TCO analysis:</div>';
excludedMaterials.forEach(em=>{
html+='<div style="font-size:0.8rem;color:#fecaca;margin-bottom:4px;padding:4px;background:#450a0a;border-radius:3px"><strong>'+em.mat.name+'</strong>: '+(em.failReason||'Chemical incompatibility')+'</div>';
});
html+='<div style="font-size:0.7rem;color:#f87171;margin-top:8px;font-style:italic">Binary failure modes (SCC, dissolution, embrittlement) override corrosion rate economics.</div>';
html+='</div>';
}
if(useRobustnessMode&&validResults.length>0){
// Extreme chemistry: Show robustness-based recommendation (FAILED excluded)
// CRITICAL V6.2: Industry-standard materials override TCO in severe chemistry
const industryStandard=validResults.find(r=>r.id==='Titanium'&&isStrongOx)||validResults.find(r=>r.id==='PTFE')||null;
const safeChoice=industryStandard||best;
// CRITICAL V6.2: CONDITIONAL materials NEVER get clean recommendation
const isBestConditional=safeChoice.status==='CONDITIONAL';
html+='<div class="rec-box" style="border-color:#f59e0b;background:#451a03"><div class="rec-title" style="color:#fcd34d">âš ï¸ '+modeLabel+' Mode - Material Selection</div>';
html+='<div style="font-size:0.85rem;color:#fef3c7;margin-bottom:8px">TCO analysis suppressed - '+(isDehydrating?'velocity/concentration sensitivity dominates in dehydrating acids':'corrosion rate uncertainty dominates in oxidizing environments')+'. <strong>Assumed velocity: '+actualVelocity+' m/s</strong></div>';
if(industryStandard&&industryStandard.status==='COMPATIBLE'){
html+='<div class="rec-item"><span class="rec-badge best">INDUSTRY STANDARD</span> <strong>'+industryStandard.mat.name+'</strong> - Proven in '+modeLabel+' service</div>';
}else if(isBestConditional){
html+='<div class="rec-item" style="background:#7c2d12;padding:8px;border-radius:4px"><span class="rec-badge" style="background:#d97706;color:white">CONDITIONAL USE</span> <strong>'+safeChoice.mat.name+'</strong> - '+safeChoice.failReason+'</div>';
html+='<div style="margin-top:8px;padding:8px;background:#1e3a5f;border-radius:4px;font-size:0.8rem;color:#93c5fd"><strong>Primary alternatives:</strong> Titanium (oxidizers), PTFE-lined systems, or specialty alloys</div>';
}else{
html+='<div class="rec-item"><span class="rec-badge best">SAFEST</span> <strong>'+safeChoice.mat.name+'</strong> - '+safeChoice.status+', '+safeChoice.robustness+'% robustness</div>';
}
if(validResults.length>1){
const conditionalMats=validResults.filter(r=>r.status==='CONDITIONAL'&&r.id!==safeChoice.id);
if(conditionalMats.length>0){
html+='<div style="margin-top:8px;font-size:0.8rem;color:#fde68a"><strong>Conditional options (require verification):</strong> '+conditionalMats.map(r=>r.mat.name).join(', ')+'</div>';
}}
html+='</div>';
}else if(validResults.length>0){
// V81 CRITICAL FIX: TCO mode must respect compatibility status
// CONDITIONAL materials CANNOT be "BEST VALUE" - find best COMPATIBLE material for TCO
const compatibleResults=validResults.filter(r=>r.status==='COMPATIBLE');
const conditionalResults=validResults.filter(r=>r.status==='CONDITIONAL');
const bestCompatible=compatibleResults.length>0?compatibleResults.reduce((a,b)=>a.tco<b.tco?a:b):null;
const bestConditional=conditionalResults.length>0?conditionalResults.reduce((a,b)=>a.tco<b.tco?a:b):null;
// Is the overall TCO best a CONDITIONAL material?
const isBestConditional=best.status==='CONDITIONAL';
if(isBestConditional){
// CONDITIONAL material has lowest TCO but cannot be recommended as "BEST VALUE"
html+='<div class="rec-box" style="border-color:#d97706;background:#451a03"><div class="rec-title" style="color:#fde68a">âš ï¸ TCO Analysis - Compatibility Constraint Applied</div>';
html+='<div style="font-size:0.8rem;color:#fef3c7;margin-bottom:8px;padding:6px;background:#7c2d12;border-radius:4px"><strong>Engineering Note:</strong> <em>'+best.mat.name+'</em> shows lowest TCO ($'+safeToFixed(best.tco, 0, '0')+'/mÂ²) but is CONDITIONAL for this chemistry. CONDITIONAL materials cannot be recommended as "BEST VALUE" due to unpredictable service life.</div>';
if(bestCompatible){
html+='<div class="rec-item"><span class="rec-badge best">BEST VALUE (COMPATIBLE)</span> <strong>'+bestCompatible.mat.name+'</strong> - '+bestCompatible.rating+' rating, $'+safeToFixed(bestCompatible.tco, 0, '0')+'/mÂ² over 10 years</div>';
}
html+='<div class="rec-item" style="background:#7c2d12;padding:8px;border-radius:4px;margin-top:8px"><span class="rec-badge" style="background:#d97706;color:white">CONDITIONAL (Lower TCO)</span> <strong>'+best.mat.name+'</strong> - '+best.failReason+'</div>';
html+='<div style="margin-top:8px;font-size:0.75rem;color:#fcd34d">Use CONDITIONAL material only with: (1) Independent corrosion testing, (2) Shortened inspection intervals, (3) Contingency budget for early replacement.</div>';
html+='</div>';
}else{
// Best TCO material is COMPATIBLE - standard recommendation
html+='<div class="rec-box"><div class="rec-title">ğŸ’¡ Recommendation for '+fl.n+'</div>';
html+='<div class="rec-item"><span class="rec-badge best">BEST VALUE</span> <strong>'+best.mat.name+'</strong> - '+best.rating+' rating, $'+safeToFixed(best.tco, 0, '0')+'/mÂ² over 10 years</div>';
if(validResults.length>1&&worst.tco>best.tco*2){html+='<div class="rec-item"><span class="rec-badge avoid">CAUTION</span> <strong>'+worst.mat.name+'</strong> - '+worst.rating+' rating, higher lifecycle cost</div>';}
// V81: Show CONDITIONAL alternatives with caveat if they exist
if(conditionalResults.length>0){
html+='<div style="margin-top:8px;padding:8px;background:#422006;border-radius:4px;border:1px solid #d97706"><div style="font-size:0.8rem;color:#fcd34d;margin-bottom:4px"><strong>âš ï¸ CONDITIONAL Alternatives (require verification):</strong></div>';
conditionalResults.forEach(r=>{html+='<div style="font-size:0.75rem;color:#fed7aa;margin:2px 0">â€¢ '+r.mat.name+' - $'+safeToFixed(r.tco, 0, '0')+'/mÂ² TCO - <em>'+r.failReason+'</em></div>';});
html+='</div>';
}
html+='</div>';
}
}
// Add methodology note
if(highTempOx){
html+='<div style="margin-top:12px;padding:10px;background:#7c2d12;border-radius:6px;font-size:0.75rem;color:#fed7aa;border:1px solid #c2410c"><strong style="color:#fdba74">âš ï¸ Oxidizer Analysis Note:</strong> At â‰¥65% nitric acid or equivalent strength oxidizers at elevated temperatures, passive film stability becomes highly unpredictable. Metals like 316SS/304SS may show acceptable lab corrosion rates but fail unpredictably in service due to crevice attack, weld sensitivity, and concentration cells. PTFE-lined or titanium systems recommended for critical applications.</div>';
}else{
html+='<div style="margin-top:12px;padding:10px;background:#1e293b;border-radius:6px;font-size:0.75rem;color:#94a3b8;border:1px solid #334155"><strong style="color:#60a5fa">âš ï¸ TCO Methodology:</strong> Initial cost Ã— area + (replacements Ã— labor). Polymers (PTFE/FKM) show higher $/mÂ² due to material cost despite zero corrosion. Metals may be economical for large vessels; polymers for linings and seals. Service life capped at 25 years per replacement cycle analysis.</div>';
}
DOM.setHTML('lifecycleResults',html);
// V16.2 HARDENING: P1-A - Close try-catch wrapper
} catch(err) {
  console.error('CERTA calcLifecycle() error:', err);
  DOM.setHTML('lifecycleResults','<div style="background:#7f1d1d;color:#fca5a5;padding:12px;border-radius:6px;font-size:0.85rem"><strong>âš ï¸ Lifecycle Calculation Error</strong><br>' + err.message + '</div>');
}
}
function interp(t,d){
// V91: Null-safety guard (fixes Lactic Acid 88%, Ammonium Hydroxide 28% crashes)
if(!d||!Array.isArray(d)||d.length===0)return{sg:1.0,visc:1.0,ex:true};
if(d.length===1)return{sg:d[0][1],visc:d[0][2],ex:t!==d[0][0]};
// Original logic preserved exactly per V13.3 Â§18.1
let l=d[0],u=d[d.length-1];for(let i=0;i<d.length-1;i++){if(t>=d[i][0]&&t<=d[i+1][0]){l=d[i];u=d[i+1];break;}}if(t<d[0][0])return{sg:d[0][1],visc:d[0][2],ex:true};if(t>d[d.length-1][0])return{sg:d[d.length-1][1],visc:d[d.length-1][2],ex:true};const f=(t-l[0])/(u[0]-l[0]);return{sg:l[1]+f*(u[1]-l[1]),visc:l[2]+f*(u[2]-l[2]),ex:false};}
function filter(){
// V16.1: Load all fluids alphabetically into select dropdown
const sel=document.getElementById('fluidSelect');
if(!sel)return;
sel.innerHTML='';

// Build flat array of all fluids
const allFluids=[];
Object.entries(F).forEach(([k,f])=>{
  allFluids.push({k:k, n:f.n});
});

// Sort alphabetically by name
allFluids.sort((a,b)=>a.n.localeCompare(b.n));

// Add as options
allFluids.forEach(f=>{
  const opt=document.createElement('option');
  opt.value=f.k;
  opt.textContent=f.n;
  sel.appendChild(opt);
});

DOM.setText('fluidCount','('+allFluids.length+')');
}
function getH(k){if(k.includes('bitumen')||k.includes('asphalt')||k.includes('tar-sand')||k.includes('dilbit')||k.includes('synbit')||k.includes('vacuum-residue')||k.includes('atmospheric-residue')||k.includes('heavy-crude')||k.includes('cutback'))return'bitumen';if(k.startsWith('h2so4')||k.includes('oleum'))return'h2so4';if(k.startsWith('hcl'))return'hcl';if(k.startsWith('hno3'))return'hno3';if(k.startsWith('h3po4')||k.includes('phosphoric'))return'h3po4';if(k.startsWith('naoh'))return'naoh';if(k.startsWith('koh'))return'koh';if(k.startsWith('nh4oh'))return'nh4oh';if(k.includes('cyanide')||k.startsWith('nacn'))return'cyanide';if(k==='benzene')return'benzene';if(k==='toluene'||k==='xylene'||k==='styrene'||k==='ethylbenzene')return'toluene';if(k==='methanol')return'methanol';if(k.includes('ethylene-glycol'))return'ethylene-glycol';if(k.includes('hypochlorite'))return'hypochlorite';if(k.includes('h2o2')||k.includes('peracetic'))return'h2o2';if(k.includes('ferric'))return'h2so4';if(k==='diesel'||k.includes('fuel-oil')||k==='kerosene')return'diesel';if(k==='gasoline'||k==='naphtha')return'gasoline';if(k.includes('milk')||k.includes('cream')||k.includes('whey')||k.includes('condensed'))return'milk';if(k.includes('vegetable')||k.includes('olive')||k.includes('canola')||k.includes('coconut'))return'vegetable-oil';if(k.includes('glycerin')||k.includes('propylene-glycol'))return'glycerin';if(k.includes('sae')||k.includes('hydraulic')||k.includes('gear')||k.includes('turbine')||k.includes('compressor')||k.includes('transformer')||k.includes('silicone'))return'lubricants';if(k.includes('slurry')||k.includes('tailings')||k.includes('ore'))return'slurry';return null;}
function getC(k,c){if(k==='water'||k==='seawater'||k==='process-water')return'water';if(k.startsWith('h2so4')){const n=parseInt(k.split('-')[1]);return n>=70?'sulfuric-conc':'sulfuric-dilute';}if(k.includes('oleum'))return'sulfuric-conc';if(k.startsWith('hcl'))return'hydrochloric';if(k.startsWith('hno3'))return'nitric';if(k.startsWith('h3po4')||k.includes('phosphoric'))return'phosphoric';if(k.startsWith('naoh')||k.startsWith('koh')||k.includes('lime'))return'caustic';if(k.startsWith('nh4oh')||k.includes('ammonia'))return'ammonia';if(k.includes('cyanide')||k.startsWith('nacn'))return'cyanide';if(c.includes('Bitumen')||k.includes('bitumen')||k.includes('asphalt')||k.includes('dilbit')||k.includes('synbit')||k.includes('tar-sand')||k.includes('cutback')||k.includes('vacuum-residue')||k.includes('atmospheric-residue'))return'bitumen';if(c.includes('Petroleum')||k==='diesel'||k==='gasoline'||k.includes('heavy-crude'))return'petroleum';if(c.includes('Aromatic')||k==='benzene'||k==='toluene'||k==='xylene')return'aromatic';if(c.includes('Alcohol')||k.includes('ethanol')||k.includes('methanol'))return'alcohol';if(c.includes('Chlorinated'))return'chlorinated';if(c.includes('Slurr')||k.includes('slurry'))return'slurry';if(k.includes('h2o2')||k.includes('peracetic')||k.includes('hypochlorite'))return'oxidizer';if(c.includes('Food')||c.includes('Dairy')||c.includes('Sugar')||c.includes('Beverage'))return'food';if(c.includes('Glycol')||k.includes('glycol')||k.includes('glycerin'))return'glycol';return'water';}
function getS(k,c){
// V88: Escalate seal selection for ENERGETIC/OXIDIZER_ADJACENT fluids
// Ammonium nitrate, nitrate solutions = require Oxidizer seals (leak-free priority)
if(k.includes('ammonium-nitrate')||k.includes('nitrate'))return'Oxidizer';
// V17.7: NCR-2026-008 - Bitumen/solidifying fluids require special seal handling
if(k.includes('bitumen')||k.includes('asphalt')||k.includes('tar-sand')||k.includes('dilbit')||k.includes('synbit')||k.includes('vacuum-residue')||k.includes('atmospheric-residue')||k.includes('heavy-crude')||k.includes('cutback')||c.includes('Bitumen'))return'Solidifying';
if(k.includes('cyanide')||k.startsWith('nacn'))return'Toxic';if(k==='benzene'||k==='gasoline'||k==='naphtha'||c.includes('Aromatic'))return'Flammable';if(k.startsWith('h2so4')||k.startsWith('hcl')||k.startsWith('hno3')||k.startsWith('h3po4')||k.includes('oleum'))return'Corrosive';if(k.startsWith('naoh')||k.startsWith('koh')||k.includes('lime'))return'Corrosive';if(k.includes('h2o2')||k.includes('hypochlorite')||k.includes('peracetic'))return'Oxidizer';if(c.includes('Slurr')||k.includes('slurry'))return'Slurry';if(c.includes('Food')||c.includes('Dairy')||c.includes('Sugar')||c.includes('Beverage'))return'Food';if(c.includes('Petroleum')&&!k.includes('gasoline'))return'Flammable';return'General';}

// ============================================================
// HARD FAILURE GATE SYSTEM - V7.2 Architecture
// Layer 1A: FATAL - Instant rejection for fundamental incompatibilities
// Layer 1B: CONDITIONAL - Temperature/concentration-dependent rules
// Layer 1C: TEMP - Maximum service temperature enforcement
// Layer 2: SCORING - Only executes if gate passes
// [MATERIALS] [CHEM ENG] [SCIENTIST] expertise layered
// ============================================================

const CHEM_ARCHETYPES={
  // 1. DEHYDRATING: Removes water from organic matter, chars tissue
  'DEHYDRATING':{
    fatal:['Hastelloy-C','Monel','Inconel','Bronze','Brass','Aluminum','Zinc','Copper'],
    conditional:['316SS','304SS','Carbon-Steel','Cast-Iron'],
    bonus:['PTFE','PVDF','Glass','Ceramic','Tantalum','Zirconium'],
    maxTemp:{'Carbon-Steel':50,'316SS':60,'PTFE':180,'PVDF':120,'Glass':250},
    rationale:'[CHEM ENG] Concentrated Hâ‚‚SOâ‚„/oleum dehydrates organics, chars tissue. Nickel alloys suffer >0.5mm/yr attack. Carbon steel forms fragile FeS film - velocity critical.'
  },
  // 2. V84: OXIDIZER SEVERITY TIERS - Chemistry-accurate concentration-based classification
  // MILD OXIDIZER: HNOâ‚ƒ<40%, Hâ‚‚Oâ‚‚<15% - Aluminum passivates well, 316SS excellent
  'OXIDIZER_MILD':{
    fatal:['Carbon-Steel','Cast-Iron','Copper','Bronze','Brass'],
    conditional:['304SS','Monel'],
    bonus:['Titanium','316SS','Aluminum','PTFE','PVDF','Glass','Tantalum','Zirconium'],
    maxTemp:{'316SS':70,'304SS':50,'Aluminum':40,'Titanium':150,'PTFE':150},
    rationale:'[MATERIALS] Mild oxidizers (HNOâ‚ƒ<40%, Hâ‚‚Oâ‚‚<15%): Aluminum forms stable Alâ‚‚Oâ‚ƒ passive film. 316SS excellent. Titanium gold standard.'
  },
  // MODERATE OXIDIZER: HNOâ‚ƒ 40-65%, Hâ‚‚Oâ‚‚ 15-30% - Aluminum borderline, 316SS good
  'OXIDIZER_MODERATE':{
    fatal:['Carbon-Steel','Cast-Iron','Copper','Bronze','Brass','Hastelloy-C','Monel'],
    conditional:['304SS','Aluminum'],
    bonus:['Titanium','316SS','PTFE','PVDF','Glass','Tantalum','Zirconium'],
    maxTemp:{'316SS':60,'304SS':40,'Aluminum':25,'Titanium':120,'PTFE':150},
    rationale:'[MATERIALS] Moderate oxidizers (HNOâ‚ƒ 40-65%): Aluminum passivation marginal above 40%. 316SS good to 60Â°C. Hastelloy-C NOT suitable for oxidizing acids.'
  },
  // STRONG OXIDIZER: HNOâ‚ƒâ‰¥65%, Hâ‚‚Oâ‚‚â‰¥30%, chromates - Hastelloy-C FAILS, Titanium excels
  'STRONG_OXIDIZER':{
    fatal:['Carbon-Steel','Cast-Iron','Copper','Bronze','Brass','Hastelloy-C','Monel','Inconel','Aluminum'],
    conditional:['316SS','304SS'],
    bonus:['Titanium','Zirconium','PTFE','PVDF','Glass','Tantalum'],
    maxTemp:{'316SS':40,'304SS':30,'Titanium':100,'PTFE':150},
    rationale:'[MATERIALS] Strong oxidizers (HNOâ‚ƒâ‰¥65%): Aluminum passivation breakdown causes pitting/runaway corrosion. Hastelloy-C (Ni-Mo) designed for REDUCING acids - unstable in oxidizing service. Titanium forms stable TiOâ‚‚.'
  },
  // 3. REDUCING_ACID: Attacks passive films, hydrogen evolution
  'REDUCING_ACID':{
    fatal:['Titanium','Carbon-Steel','Cast-Iron','Aluminum','Zinc'],
    conditional:['316SS','304SS','Monel'],
    bonus:['Hastelloy-C','Tantalum','PTFE','PVDF','Glass','Zirconium'],
    maxTemp:{'316SS':40,'Hastelloy-C':120,'PTFE':150},
    rationale:'[SCIENTIST] HCl/HBr provide Hâº without oxidizing power. Titanium suffers hydrogen embrittlement. Hastelloy-C excels due to Mo content.'
  },
  // 4. STRONG_BASE: Dissolves amphoteric metals, attacks silicates
  'STRONG_BASE':{
    fatal:['Aluminum','Zinc','Tin','Lead','Glass','Titanium'],
    conditional:['Carbon-Steel','Cast-Iron','316SS','304SS','PVC','CPVC'],
    bonus:['Hastelloy-C','Monel','Inconel','PTFE','PVDF','PP','HDPE','EPDM'],
    maxTemp:{'Carbon-Steel':50,'316SS':90,'PTFE':200,'PP':60,'HDPE':50,'PVC':40,'CPVC':60},
    rationale:'[MATERIALS] NaOH/KOHâ‰¥30% attacks amphoteric Al/Zn via aluminate/zincate formation. Carbon steel: caustic SCC above 50Â°C.'
  },
  // 5. HALOGENATED: Contains Cl/F/Br - stress cracking, pitting
  'HALOGENATED':{
    fatal:['Carbon-Steel','Cast-Iron','Aluminum'],
    conditional:['316SS','304SS','Monel','Inconel'],
    bonus:['Titanium','Hastelloy-C','PTFE','PVDF','Tantalum','Zirconium'],
    maxTemp:{'316SS':50,'304SS':40,'Titanium':100,'Hastelloy-C':120},
    rationale:'[SCIENTIST] Clâ»/Brâ» ions penetrate passive films causing pitting and chloride SCC. Titanium resistant via TiOâ‚‚. Hastelloy-C excels.'
  },
  // 6. ORGANIC_SOLVENT: Dissolves polymers, extracts plasticizers
  'ORGANIC_SOLVENT':{
    fatal:['PVC','ABS','Polycarbonate','NBR','Neoprene'],
    conditional:['EPDM','PP','HDPE','Silicone'],
    bonus:['316SS','304SS','PTFE','PVDF','FKM','Glass','Hastelloy-C'],
    maxTemp:{'FKM':150,'PTFE':200,'PVDF':100,'316SS':300},
    rationale:'[MATERIALS] Aromatics/ketones/chlorinated solvents dissolve or swell many polymers. PTFE/PVDF/FKM have excellent resistance.'
  },
  // 7. CRYOGENIC: Low temp embrittlement, thermal shock
  'CRYOGENIC':{
    fatal:['Carbon-Steel','Cast-Iron','Ferritic-SS','Martensitic-SS','PVC','CPVC','NBR'],
    conditional:['316SS','304SS','Aluminum'],
    bonus:['Inconel','Monel','Hastelloy-C','PTFE','Copper','9%Nickel-Steel'],
    maxTemp:{}, // Not applicable - this is minTemp
    minTemp:{'Carbon-Steel':-29,'304SS':-196,'316SS':-196,'Aluminum':-196,'PTFE':-200,'Inconel':-250},
    rationale:'[MATERIALS] Below DBTT, carbon steel suffers brittle fracture. Austenitic SS, Al, Cu maintain ductility. Impact testing per ASME required.'
  },
  // 8. HIGH_TEMP: Creep, oxidation, scaling, phase changes
  'HIGH_TEMP':{
    fatal:['PVC','CPVC','PP','HDPE','NBR','Neoprene','EPDM'],
    conditional:['PTFE','PVDF','FKM','Carbon-Steel','304SS','316SS'],
    bonus:['Inconel','Hastelloy-C','Ceramic','Glass','Tantalum'],
    maxTemp:{'PVC':60,'PP':80,'HDPE':80,'CPVC':90,'PTFE':260,'FKM':200,'PVDF':140,'316SS':400,'Inconel':900},
    rationale:'[MATERIALS] Polymers soften/degrade above Tg. Metals suffer creep, oxidation. ASME allowable stress curves apply.'
  },
  // 9. ABRASIVE_SLURRY: Erosion-corrosion, velocity-dependent wear
  'ABRASIVE_SLURRY':{
    fatal:[],
    conditional:['316SS','304SS','Carbon-Steel','PTFE'],
    bonus:['Ceramic','Tungsten-Carbide','UHMWPE','Hardened-Alloys','Rubber-Lined'],
    maxTemp:{},
    rationale:'[CHEM ENG] Particle impingement removes protective films. VelocityÂ²Ã—concentration drives wear. Ceramic/WC for severe duty.'
  },
  // 10. TOXIC_VOLATILE: Requires containment, zero-leak
  'TOXIC_VOLATILE':{
    fatal:[],
    conditional:['Carbon-Steel','Cast-Iron','PVC'],
    bonus:['316SS','304SS','Hastelloy-C','PTFE','Double-Contained'],
    maxTemp:{},
    rationale:'[CHEM ENG] Benzene, cyanides, HF require sealless pumps (API 685), double containment, and emission controls per EPA/OSHA.'
  },
  // 11. FOOD_PHARMA: FDA/USP compliance, cleanability
  'FOOD_PHARMA':{
    fatal:['Carbon-Steel','Cast-Iron','Lead','Cadmium','Brass'],
    conditional:['Aluminum','Copper','Bronze'],
    bonus:['316L','304L','PTFE','PVDF','Silicone','EPDM-FDA'],
    maxTemp:{'Silicone':200,'EPDM':120,'316L':400},
    rationale:'[SCIENTIST] FDA 21 CFR 177, USP Class VI, 3-A, EHEDG compliance. Surface finish Ra<0.8Î¼m. No leachables/extractables.'
  }
};

// Map fluid keys to chemistry archetypes
function getChemistryArchetype(fk,tC){
  const archetypes=[];
  const fl=F[fk];
  const cat=fl?fl.c:'';
  // Extract concentrations
  let sulfConc=0,hclConc=0,nitricConc=0,naohConc=0,peroxConc=0;
  const sulfMatch=fk.match(/h2so4-(\d+)/i);if(sulfMatch)sulfConc=parseInt(sulfMatch[1],10);
  const hclMatch=fk.match(/hcl-(\d+)/i);if(hclMatch)hclConc=parseInt(hclMatch[1],10);
  const nitricMatch=fk.match(/hno3-(\d+)/i);if(nitricMatch)nitricConc=parseInt(nitricMatch[1],10);
  const naohMatch=fk.match(/naoh-(\d+)|koh-(\d+)/i);if(naohMatch)naohConc=parseInt(naohMatch[1]||naohMatch[2],10);
  const peroxMatch=fk.match(/peroxide.*?(\d+)|h2o2.*?(\d+)/i);if(peroxMatch)peroxConc=parseInt(peroxMatch[1]||peroxMatch[2],10);

  // DEHYDRATING: Conc H2SO4 â‰¥80%, Oleum
  if((fk.includes('h2so4')&&sulfConc>=80)||fk.includes('oleum'))archetypes.push('DEHYDRATING');

  // V84: TIERED OXIDIZER CLASSIFICATION - Concentration-aware severity
  // Nitric acid tiering
  if(fk.includes('hno3')){
    if(nitricConc>=65)archetypes.push('STRONG_OXIDIZER');
    else if(nitricConc>=40)archetypes.push('OXIDIZER_MODERATE');
    else if(nitricConc>0)archetypes.push('OXIDIZER_MILD');
  }
  // Hydrogen peroxide tiering
  if(fk.includes('peroxide')||fk.includes('h2o2')){
    if(peroxConc>=30)archetypes.push('STRONG_OXIDIZER');
    else if(peroxConc>=15)archetypes.push('OXIDIZER_MODERATE');
    else if(peroxConc>0)archetypes.push('OXIDIZER_MILD');
  }
  // Strong oxidizers regardless of concentration
  if(fk.includes('chromate')||fk.includes('perchlorate')||fk.includes('peracetic'))archetypes.push('STRONG_OXIDIZER');
  // Hypochlorite is moderate oxidizer
  if(fk.includes('hypochlorite'))archetypes.push('OXIDIZER_MODERATE');

  // REDUCING_ACID: HCl, HBr, dilute H2SO4
  if(fk.includes('hcl')||(fk.includes('h2so4')&&sulfConc<70&&sulfConc>0))archetypes.push('REDUCING_ACID');
  // STRONG_BASE: NaOH/KOH â‰¥30%
  if((fk.includes('naoh')||fk.includes('koh'))&&naohConc>=30)archetypes.push('STRONG_BASE');
  // HALOGENATED: HCl, chlorinated solvents, HF, bleach
  if(fk.includes('hcl')||fk.includes('chloride')||cat.includes('Chlorinated')||fk.includes('hypochlorite'))archetypes.push('HALOGENATED');
  // ORGANIC_SOLVENT: Aromatics, ketones, esters
  if(cat.includes('Aromatic')||cat.includes('Chlorinated')||fk.includes('acetone')||fk.includes('mek')||fk.includes('toluene')||fk.includes('benzene')||fk.includes('xylene'))archetypes.push('ORGANIC_SOLVENT');
  // HIGH_TEMP: Above 80Â°C
  if(tC>=80)archetypes.push('HIGH_TEMP');
  // CRYOGENIC: Below -20Â°C
  if(tC<=-20)archetypes.push('CRYOGENIC');
  // ABRASIVE_SLURRY: Slurries, tailings
  if(fk.includes('slurry')||fk.includes('tailings')||cat.includes('Slurr'))archetypes.push('ABRASIVE_SLURRY');
  // TOXIC_VOLATILE: Cyanide, benzene, aromatic amines
  if(fk.includes('cyanide')||fk==='benzene'||fk.includes('aniline'))archetypes.push('TOXIC_VOLATILE');
  // FOOD_PHARMA: Food/dairy/pharma categories
  if(cat.includes('Food')||cat.includes('Dairy')||cat.includes('Pharma')||cat.includes('Beverage'))archetypes.push('FOOD_PHARMA');

  return archetypes.length>0?archetypes:['GENERAL'];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V86: 4-ENGINE MATERIALS SAFETY ARCHITECTURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRINCIPLE: Separate failure mechanisms from economics. Only Engine 4 can rank.
// Engine 1 (Chemical Failure) + Engine 2 (Thermal/Mechanical) = BINARY GATES
// Engine 3 (Corrosion/Wear) = mm/yr rates for sizing
// Engine 4 (Economic) = TCO ranking (ONLY if Engines 1-2 pass)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FAILURE MECHANISM MATRIX - The Authoritative Logic Source
// This matrix defines WHAT KILLS each material in each chemistry
// Keys: failure mechanisms (not corrosion rates)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FAILURE_MECHANISM_MATRIX={
  // METALS - Failure Mechanisms
  'Carbon-Steel':{
    SCC:{triggers:['NaOH','KOH','NH3','amine','carbonate'],tempThreshold:50,fatal:true,mechanism:'Caustic stress corrosion cracking - intergranular attack under tensile stress'},
    HydrogenEmbrittlement:{triggers:['HF','H2S','cathodic'],tempThreshold:null,fatal:true,mechanism:'Atomic hydrogen diffusion into lattice causing brittle fracture'},
    Oxidation:{triggers:['HNO3','chromate','permanganate'],tempThreshold:null,fatal:false,mechanism:'Accelerated uniform corrosion - passive film cannot form'},
    Depassivation:{triggers:['HCl','HBr','FeCl3'],tempThreshold:null,fatal:true,mechanism:'Active corrosion state - no protective film'}
  },
  'Titanium':{
    HydrogenEmbrittlement:{triggers:['HCl','HBr','H2SO4_dilute','cathodic'],tempThreshold:null,fatal:true,mechanism:'Hydrogen absorption causes titanium hydride formation - catastrophic embrittlement'},
    AlkaliAttack:{triggers:['NaOH','KOH'],concThreshold:30,tempThreshold:50,fatal:true,mechanism:'TiOâ‚‚ passive film dissolved by strong bases + Hâ‚‚ evolution'},
    Pyrophoric:{triggers:['red_fuming_HNO3','N2O4','dry_Cl2'],tempThreshold:null,fatal:true,mechanism:'Exothermic oxidation can become self-sustaining'},
    CreviceCorrosion:{triggers:['seawater','brine','chloride'],tempThreshold:80,fatal:false,mechanism:'Localized attack in stagnant chloride environments'}
  },
  'Hastelloy-C':{
    OxidizingAcidAttack:{triggers:['HNO3','chromate','perchlorate','permanganate'],concThreshold:40,fatal:true,mechanism:'Ni-Mo alloy designed for REDUCING service - unstable oxide in oxidizing conditions'},
    DehydratingAttack:{triggers:['H2SO4_conc','oleum'],tempThreshold:null,fatal:true,mechanism:'Concentrated Hâ‚‚SOâ‚„ attacks Ni-Cr-Mo matrix at elevated temperatures'}
  },
  '316SS':{
    ChlorideSCC:{triggers:['chloride','seawater','HCl'],tempThreshold:60,fatal:true,mechanism:'Transgranular stress corrosion cracking in chloride + tensile stress'},
    IGC:{triggers:['HNO3'],concThreshold:70,tempThreshold:null,fatal:false,mechanism:'Intergranular corrosion along sensitized grain boundaries'},
    Pitting:{triggers:['FeCl3','chloride','bromide'],tempThreshold:null,fatal:false,mechanism:'Localized breakdown of passive film'}
  },
  '304SS':{
    ChlorideSCC:{triggers:['chloride','seawater','HCl'],tempThreshold:50,fatal:true,mechanism:'Transgranular SCC - lower threshold than 316SS due to less Mo'},
    IGC:{triggers:['HNO3','oxidizing'],tempThreshold:null,fatal:false,mechanism:'Sensitization more severe than 316SS'},
    GeneralCorrosion:{triggers:['H2SO4','HCl'],concThreshold:10,fatal:false,mechanism:'Active corrosion in reducing acids'}
  },
  'Aluminum':{
    AmphotericDissolution:{triggers:['NaOH','KOH','NH4OH'],concThreshold:5,fatal:true,mechanism:'Dissolves as aluminate in alkaline conditions'},
    PassivationBreakdown:{triggers:['HNO3'],concThreshold:40,fatal:true,mechanism:'Alâ‚‚Oâ‚ƒ film unstable above 40% HNOâ‚ƒ - pitting/runaway corrosion'},
    Pitting:{triggers:['chloride','HCl'],tempThreshold:null,fatal:false,mechanism:'Chloride penetrates oxide film causing localized attack'},
    GalvanicCorrosion:{triggers:['seawater','brine'],tempThreshold:null,fatal:false,mechanism:'Anodic to most metals - accelerated in chloride'}
  },
  'Monel':{
    OxidizingAcidAttack:{triggers:['HNO3','chromate'],concThreshold:20,fatal:true,mechanism:'Ni-Cu alloy unstable in oxidizing environments'},
    SulfurAttack:{triggers:['H2S','sulfide'],tempThreshold:300,fatal:true,mechanism:'Forms low-melting Ni-S eutectic'}
  },
  // POLYMERS - Failure Mechanisms
  'PTFE':{
    ThermalDegradation:{triggers:['high_temp'],tempThreshold:260,fatal:true,mechanism:'Depolymerization releases toxic fluorine compounds'},
    Permeation:{triggers:['all'],tempThreshold:null,fatal:false,mechanism:'Permeable to many gases and small molecules - not a failure but design consideration'},
    Creep:{triggers:['mechanical_stress'],tempThreshold:100,fatal:false,mechanism:'Cold flow under sustained load'}
  },
  'PVDF':{
    ThermalDegradation:{triggers:['high_temp'],tempThreshold:140,fatal:true,mechanism:'Dehydrofluorination above max service temp'},
    AlkaliAttack:{triggers:['NaOH','KOH','amine'],concThreshold:30,tempThreshold:60,fatal:true,mechanism:'Strong bases cause dehydrofluorination - black discoloration'},
    SolventAttack:{triggers:['ketone','ester','DMF','NMP'],tempThreshold:null,fatal:true,mechanism:'Dissolved by polar aprotic solvents'}
  },
  'PP':{
    ThermalDegradation:{triggers:['high_temp'],tempThreshold:80,fatal:true,mechanism:'Softening and loss of mechanical properties'},
    OxidativeDegradation:{triggers:['HNO3','chromate','ozone'],tempThreshold:null,fatal:true,mechanism:'Chain scission by oxidizing agents'},
    SolventSwelling:{triggers:['aromatic','chlorinated'],tempThreshold:null,fatal:true,mechanism:'Swelling and softening in hydrocarbon solvents'}
  },
  'PVC':{
    ThermalDegradation:{triggers:['high_temp'],tempThreshold:60,fatal:true,mechanism:'Dehydrochlorination releases HCl'},
    SolventAttack:{triggers:['ketone','ester','aromatic','chlorinated'],tempThreshold:null,fatal:true,mechanism:'Dissolves in many organic solvents'},
    OxidativeDegradation:{triggers:['HNO3','chromate'],concThreshold:50,fatal:true,mechanism:'Degradation by strong oxidizers'}
  },
  'HDPE':{
    ThermalDegradation:{triggers:['high_temp'],tempThreshold:80,fatal:true,mechanism:'Softening and creep'},
    OxidativeDegradation:{triggers:['HNO3','chromate'],concThreshold:50,fatal:true,mechanism:'Oxidative chain scission'},
    Swelling:{triggers:['aromatic','chlorinated','hydrocarbon'],tempThreshold:null,fatal:false,mechanism:'Absorbs hydrocarbons causing swelling'}
  },
  // ELASTOMERS - Failure Mechanisms
  'FKM':{
    AmineAttack:{triggers:['amine','NH3','NH4OH','hydrazine'],tempThreshold:null,fatal:true,mechanism:'Amines attack fluoroelastomer backbone - rapid degradation'},
    AlkaliAttack:{triggers:['NaOH','KOH'],concThreshold:30,tempThreshold:null,fatal:true,mechanism:'Strong bases cause dehydrofluorination'},
    ThermalLimit:{triggers:['high_temp'],tempThreshold:200,fatal:true,mechanism:'Exceeds continuous service temperature'},
    Swelling:{triggers:['ketone','ester','ether'],tempThreshold:null,fatal:false,mechanism:'Volume swell >25% - seal failure likely'}
  },
  'EPDM':{
    HydrocarbonSwelling:{triggers:['aromatic','aliphatic','petroleum','oil'],tempThreshold:null,fatal:true,mechanism:'Massive swelling in hydrocarbon fluids - seal failure'},
    OxidativeDegradation:{triggers:['ozone','HNO3','chromate'],tempThreshold:null,fatal:true,mechanism:'Ozone cracking and oxidative attack'},
    ThermalLimit:{triggers:['high_temp'],tempThreshold:150,fatal:true,mechanism:'Exceeds continuous service temperature'}
  },
  'NBR':{
    OxidativeDegradation:{triggers:['HNO3','ozone','chromate','peroxide'],tempThreshold:null,fatal:true,mechanism:'Rapid degradation by oxidizers'},
    AromaticSwelling:{triggers:['aromatic','chlorinated','ketone'],tempThreshold:null,fatal:true,mechanism:'Excessive swelling in polar/aromatic solvents'},
    ThermalLimit:{triggers:['high_temp'],tempThreshold:100,fatal:true,mechanism:'Hardening and embrittlement'}
  },
  'Kalrez':{
    ThermalLimit:{triggers:['high_temp'],tempThreshold:300,fatal:true,mechanism:'Exceeds FFKM continuous service temperature'},
    AmineSwelling:{triggers:['amine'],tempThreshold:null,fatal:false,mechanism:'Some grades show minor swelling - verify grade'}
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENGINE 1: CHEMICAL FAILURE ENGINE
// Evaluates: SCC, Oxidation mismatch, Hâ‚‚ embrittlement, Amphoteric dissolution
// Output: FATAL (binary) or CONDITIONAL (with constraints)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runChemicalFailureEngine(fluidKey, tempC, materialId, concentration){
  const result = {
    passed: true,
    fatal: false,
    mechanisms: [],
    constraints: [],
    rationale: []
  };

  const matMechanisms = FAILURE_MECHANISM_MATRIX[materialId];
  if(!matMechanisms) return result; // Unknown material - pass to archetype engine

  const fk = fluidKey.toLowerCase();

  // Check each failure mechanism for this material
  for(const [mechName, mechDef] of Object.entries(matMechanisms)){
    let triggered = false;
    let triggerReason = '';

    // Check trigger chemicals
    for(const trigger of mechDef.triggers){
      if(trigger === 'all') continue; // Special case for permeation
      if(trigger === 'high_temp'){
        if(mechDef.tempThreshold && tempC > mechDef.tempThreshold){
          triggered = true;
          triggerReason = `Temperature ${tempC}Â°C exceeds limit ${mechDef.tempThreshold}Â°C`;
        }
      } else if(trigger === 'mechanical_stress' || trigger === 'cathodic'){
        // Context-dependent - flag as conditional
        continue;
      } else {
        // Enhanced trigger matching for chemical names
        const triggerLower = trigger.toLowerCase();
        let chemMatch = false;

        // Direct match
        if(fk.includes(triggerLower)) chemMatch = true;

        // Special pattern matching
        if(trigger === 'NaOH' && (fk.includes('naoh') || fk.includes('caustic-soda') || fk.includes('sodium-hydroxide'))) chemMatch = true;
        if(trigger === 'KOH' && (fk.includes('koh') || fk.includes('potassium-hydroxide'))) chemMatch = true;
        if(trigger === 'NH3' && (fk.includes('nh3') || fk.includes('ammonia') || fk.includes('nh4oh'))) chemMatch = true;
        if(trigger === 'HNO3' && fk.includes('hno3')) chemMatch = true;
        if(trigger === 'HCl' && fk.includes('hcl')) chemMatch = true;
        if(trigger === 'HBr' && fk.includes('hbr')) chemMatch = true;
        if(trigger === 'HF' && fk.includes('hf-')) chemMatch = true;
        if(trigger === 'H2S' && (fk.includes('h2s') || fk.includes('sulfide'))) chemMatch = true;
        if(trigger === 'H2SO4_dilute' && fk.includes('h2so4') && concentration < 70) chemMatch = true;
        if(trigger === 'H2SO4_conc' && fk.includes('h2so4') && concentration >= 80) chemMatch = true;
        if(trigger === 'chloride' && (fk.includes('chloride') || fk.includes('hcl') || fk.includes('seawater') || fk.includes('brine') || fk.includes('fecl'))) chemMatch = true;
        if(trigger === 'amine' && (fk.includes('amine') || fk.includes('mea') || fk.includes('dea') || fk.includes('mdea'))) chemMatch = true;
        if(trigger === 'carbonate' && fk.includes('carbonate')) chemMatch = true;
        if(trigger === 'chromate' && (fk.includes('chromate') || fk.includes('dichromate'))) chemMatch = true;
        if(trigger === 'permanganate' && fk.includes('permanganate')) chemMatch = true;
        if(trigger === 'perchlorate' && fk.includes('perchlorate')) chemMatch = true;
        if(trigger === 'peroxide' && (fk.includes('peroxide') || fk.includes('h2o2'))) chemMatch = true;
        if(trigger === 'ozone' && fk.includes('ozone')) chemMatch = true;
        if(trigger === 'ketone' && (fk.includes('ketone') || fk.includes('acetone') || fk.includes('mek') || fk.includes('mibk'))) chemMatch = true;
        if(trigger === 'ester' && (fk.includes('ester') || fk.includes('acetate'))) chemMatch = true;
        if(trigger === 'aromatic' && (fk.includes('benzene') || fk.includes('toluene') || fk.includes('xylene') || fk.includes('styrene'))) chemMatch = true;
        if(trigger === 'aliphatic' && (fk.includes('hexane') || fk.includes('heptane') || fk.includes('octane') || fk.includes('decane'))) chemMatch = true;
        if(trigger === 'petroleum' && (fk.includes('crude') || fk.includes('diesel') || fk.includes('gasoline') || fk.includes('kerosene') || fk.includes('fuel-oil'))) chemMatch = true;
        if(trigger === 'oil' && fk.includes('oil')) chemMatch = true;
        if(trigger === 'hydrazine' && fk.includes('hydrazine')) chemMatch = true;
        if(trigger === 'DMF' && fk.includes('dmf')) chemMatch = true;
        if(trigger === 'NMP' && fk.includes('nmp')) chemMatch = true;
        if(trigger === 'FeCl3' && (fk.includes('ferric-chloride') || fk.includes('fecl3'))) chemMatch = true;

        if(chemMatch){
          // Check concentration threshold if defined
          if(mechDef.concThreshold && concentration < mechDef.concThreshold){
            continue; // Below threshold
          }

          // Check temperature threshold if defined
          if(mechDef.tempThreshold !== null && mechDef.tempThreshold !== undefined){
            if(tempC <= mechDef.tempThreshold){
              // Below temp threshold - add as constraint (material OK if temp controlled)
              result.constraints.push({
                mechanism: mechName,
                constraint: `Temperature must stay below ${mechDef.tempThreshold}Â°C to avoid ${mechName}`,
                current: tempC,
                limit: mechDef.tempThreshold
              });
              continue;
            }
          }

          triggered = true;
          triggerReason = `${trigger} detected` + (mechDef.concThreshold ? ` at â‰¥${mechDef.concThreshold}%` : '') +
                          (mechDef.tempThreshold ? ` at >${mechDef.tempThreshold}Â°C` : '');
        }
      }
    }

    if(triggered){
      result.mechanisms.push({
        name: mechName,
        fatal: mechDef.fatal,
        trigger: triggerReason,
        mechanism: mechDef.mechanism
      });

      if(mechDef.fatal){
        result.passed = false;
        result.fatal = true;
        result.rationale.push(`[ENGINE 1 - CHEMICAL FAILURE] ${materialId}: ${mechName} - ${mechDef.mechanism}`);
      } else {
        result.rationale.push(`[ENGINE 1 - WARNING] ${materialId}: ${mechName} risk - ${mechDef.mechanism}`);
      }
    }
  }

  return result;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENGINE 2: THERMAL & MECHANICAL LIMITS ENGINE
// Evaluates: Polymer max temp, Elastomer hardening, Creep limits
// Output: FATAL (binary) or CONDITIONAL (derated)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THERMAL_LIMITS = {
  // Polymers - hard limits (softening/degradation)
  'PTFE': {max: 260, warning: 230, mode: 'degradation'},
  'PVDF': {max: 140, warning: 120, mode: 'dehydrofluorination'},
  'PP': {max: 80, warning: 60, mode: 'softening'},
  'PVC': {max: 60, warning: 50, mode: 'dehydrochlorination'},
  'CPVC': {max: 90, warning: 80, mode: 'softening'},
  'HDPE': {max: 80, warning: 60, mode: 'softening'},
  'PEEK': {max: 250, warning: 200, mode: 'degradation'},
  'UHMWPE': {max: 80, warning: 60, mode: 'softening'},
  // Elastomers - hardening/embrittlement
  'FKM': {max: 200, warning: 175, mode: 'hardening'},
  'EPDM': {max: 150, warning: 125, mode: 'hardening'},
  'NBR': {max: 100, warning: 80, mode: 'hardening'},
  'Neoprene': {max: 100, warning: 80, mode: 'hardening'},
  'Silicone': {max: 200, warning: 175, mode: 'reversion'},
  'Kalrez': {max: 300, warning: 275, mode: 'degradation'}
};

function runThermalMechanicalEngine(tempC, materialId){
  const result = {
    passed: true,
    fatal: false,
    derating: 1.0,
    warnings: [],
    rationale: []
  };

  const limits = THERMAL_LIMITS[materialId];
  if(!limits) return result; // Metal or unknown - no polymer limits

  if(tempC > limits.max){
    result.passed = false;
    result.fatal = true;
    result.rationale.push(`[ENGINE 2 - THERMAL FATAL] ${materialId}: ${tempC}Â°C exceeds max ${limits.max}Â°C - ${limits.mode} failure`);
  } else if(tempC > limits.warning){
    result.derating = 0.7; // 30% service life reduction
    result.warnings.push(`Temperature ${tempC}Â°C approaching limit ${limits.max}Â°C`);
    result.rationale.push(`[ENGINE 2 - THERMAL WARNING] ${materialId}: Operating at ${Math.round(tempC/limits.max*100)}% of thermal limit`);
  }

  return result;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENGINE 3: CORROSION & WEAR ENGINE
// Evaluates: mm/yr rates, erosion modifiers, velocity effects
// Output: Corrosion rate for sizing (does NOT gate, only informs Engine 4)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [Existing corrosion rate calculation functions remain - this engine uses them]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENGINE 4: ECONOMIC ENGINE (Only allowed to RANK, not GATE)
// Evaluates: TCO, lifecycle, availability
// Precondition: Only materials that PASSED Engines 1-2 reach this engine
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [Existing lifecycle calculation functions remain]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MASTER EVALUATOR: Orchestrates all 4 engines in correct sequence
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runMaterialEvaluation(fluidKey, tempC, materialId, concentration, velocity){
  const evaluation = {
    material: materialId,
    // Engine results
    engine1_chemical: null,
    engine2_thermal: null,
    engine3_corrosion: null,
    engine4_economic: null,
    // Final verdict
    gate: 'OK',
    passed: true,
    failureMechanisms: [],
    constraints: [],
    rationale: [],
    // Confidence (independent of pass/fail per rulebook)
    confidence: 85 // Base confidence - adjusted by data quality, not by gate result
  };

  // â•â•â• ENGINE 1: Chemical Failure (BINARY GATES) â•â•â•
  evaluation.engine1_chemical = runChemicalFailureEngine(fluidKey, tempC, materialId, concentration);

  if(evaluation.engine1_chemical.fatal){
    evaluation.gate = 'NOT_RECOMMENDED';
    evaluation.passed = false;
    evaluation.failureMechanisms = evaluation.engine1_chemical.mechanisms;
    evaluation.rationale = evaluation.engine1_chemical.rationale;
    // DO NOT proceed to economic engine - fatal chemical failure
    return evaluation;
  }

  // Add any non-fatal warnings
  if(evaluation.engine1_chemical.mechanisms.length > 0){
    evaluation.gate = 'CONDITIONAL';
    evaluation.failureMechanisms.push(...evaluation.engine1_chemical.mechanisms);
    evaluation.rationale.push(...evaluation.engine1_chemical.rationale);
  }

  // Add constraints
  evaluation.constraints.push(...evaluation.engine1_chemical.constraints);

  // â•â•â• ENGINE 2: Thermal/Mechanical (BINARY GATES) â•â•â•
  evaluation.engine2_thermal = runThermalMechanicalEngine(tempC, materialId);

  if(evaluation.engine2_thermal.fatal){
    evaluation.gate = 'NOT_RECOMMENDED';
    evaluation.passed = false;
    evaluation.rationale.push(...evaluation.engine2_thermal.rationale);
    // DO NOT proceed to economic engine - fatal thermal failure
    return evaluation;
  }

  if(evaluation.engine2_thermal.warnings.length > 0){
    if(evaluation.gate === 'OK') evaluation.gate = 'CONDITIONAL';
    evaluation.rationale.push(...evaluation.engine2_thermal.rationale);
  }

  // â•â•â• ENGINE 3: Corrosion/Wear (INFORMATIONAL) â•â•â•
  // This feeds into Engine 4 but does not gate
  // [Corrosion rates calculated in existing functions]

  // â•â•â• ENGINE 4: Economic (RANKING ONLY) â•â•â•
  // Only reached if Engines 1-2 passed
  // [TCO calculated in existing lifecycle functions]

  return evaluation;
}

// HARD FAILURE GATE CHECK
// V86: Now delegates to 4-Engine architecture first, then falls back to archetype rules
// Returns: {passed:bool, gate:'OK'|'CONDITIONAL'|'NOT_RECOMMENDED', failures:[], conditionals:[], tempLimits:[], rationales:[], failureMode:string}
function checkHardFailureGate(fk,tC,materialId){
  const archetypes=getChemistryArchetype(fk,tC);
  const result={passed:true,gate:'OK',failures:[],conditionals:[],tempLimits:[],rationales:[],archetypes:archetypes,failureMode:''};

  // V86: Extract concentration for all engines
  let nitricConc=0,peroxConc=0,sulfConc=0,naohConc=0,hclConc=0;
  const nitricMatch=fk.match(/hno3-(\d+)/i);if(nitricMatch)nitricConc=parseInt(nitricMatch[1],10);
  const peroxMatch=fk.match(/peroxide.*?(\d+)|h2o2.*?(\d+)/i);if(peroxMatch)peroxConc=parseInt(peroxMatch[1]||peroxMatch[2],10);
  const sulfMatch=fk.match(/h2so4-(\d+)/i);if(sulfMatch)sulfConc=parseInt(sulfMatch[1],10);
  const naohMatch=fk.match(/naoh-(\d+)|koh-(\d+)/i);if(naohMatch)naohConc=parseInt(naohMatch[1]||naohMatch[2],10);
  const hclMatch=fk.match(/hcl-(\d+)/i);if(hclMatch)hclConc=parseInt(hclMatch[1],10);

  // Determine primary concentration for engine evaluation
  const primaryConc = nitricConc || peroxConc || sulfConc || naohConc || hclConc || 0;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // V86: 4-ENGINE EVALUATION (Runs FIRST - before legacy concentration gates)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // ENGINE 1: Chemical Failure Engine
  const chemResult = runChemicalFailureEngine(fk, tC, materialId, primaryConc);

  if(chemResult.fatal){
    result.passed = false;
    result.gate = 'NOT_RECOMMENDED';
    result.failureMode = chemResult.mechanisms.map(m => m.name + ': ' + m.mechanism).join('; ');
    chemResult.mechanisms.forEach(mech => {
      result.failures.push({
        archetype: 'ENGINE1_CHEMICAL_FAILURE',
        material: materialId,
        severity: 'FATAL',
        message: `[FATAL] ${materialId}: ${mech.name} - ${mech.trigger}`,
        rationale: `[ENGINE 1] ${mech.mechanism}`
      });
    });
    result.rationales.push(...chemResult.rationale);
    return result; // Binary failure - do not proceed
  }

  // Add non-fatal chemical warnings
  if(chemResult.mechanisms.length > 0){
    result.gate = 'CONDITIONAL';
    chemResult.mechanisms.forEach(mech => {
      result.conditionals.push({
        archetype: 'ENGINE1_CHEMICAL_WARNING',
        material: materialId,
        severity: 'WARNING',
        message: `[WARNING] ${materialId}: ${mech.name} risk`,
        rationale: `[ENGINE 1] ${mech.mechanism}`
      });
    });
    result.rationales.push(...chemResult.rationale);
  }

  // Add constraints from chemical engine
  chemResult.constraints.forEach(c => {
    result.conditionals.push({
      archetype: 'ENGINE1_CONSTRAINT',
      material: materialId,
      severity: 'CONSTRAINT',
      message: `[CONSTRAINT] ${c.constraint}`,
      rationale: `Current: ${c.current}Â°C, Limit: ${c.limit}Â°C`
    });
  });

  // ENGINE 2: Thermal/Mechanical Engine
  const thermalResult = runThermalMechanicalEngine(tC, materialId);

  if(thermalResult.fatal){
    result.passed = false;
    result.gate = 'NOT_RECOMMENDED';
    result.failureMode = thermalResult.rationale.join('; ');
    result.failures.push({
      archetype: 'ENGINE2_THERMAL_FAILURE',
      material: materialId,
      severity: 'FATAL',
      message: `[FATAL] ${materialId}: Thermal limit exceeded at ${tC}Â°C`,
      rationale: thermalResult.rationale.join(' ')
    });
    result.rationales.push(...thermalResult.rationale);
    return result; // Binary failure - do not proceed
  }

  // Add thermal warnings
  if(thermalResult.warnings.length > 0){
    if(result.gate === 'OK') result.gate = 'CONDITIONAL';
    thermalResult.warnings.forEach(w => {
      result.tempLimits.push({
        archetype: 'ENGINE2_THERMAL_WARNING',
        material: materialId,
        severity: 'WARNING',
        message: `[WARNING] ${w}`,
        rationale: thermalResult.rationale.join(' ')
      });
    });
    result.rationales.push(...thermalResult.rationale);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LEGACY CONCENTRATION GATES (Kept for backwards compatibility + edge cases)
  // These only trigger if Engine 1 didn't already catch the failure
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // ALUMINUM: Hard fail in HNOâ‚ƒ â‰¥40% (passivation breakdown)
  if(materialId==='Aluminum'&&fk.includes('hno3')&&nitricConc>=40){
    result.passed=false;
    result.gate='NOT_RECOMMENDED';
    result.failureMode='Passivation breakdown - pitting and runaway corrosion above 40% HNOâ‚ƒ';
    result.failures.push({
      archetype:'CONCENTRATION_GATE',
      material:materialId,
      severity:'FATAL',
      message:'[FATAL] Aluminum NOT suitable for HNOâ‚ƒ â‰¥40%: Alâ‚‚Oâ‚ƒ passive film unstable, causes pitting and accelerating corrosion',
      rationale:'[MATERIALS] Aluminum passivation limit is ~40% HNOâ‚ƒ. Above this concentration, the oxide film becomes unstable leading to localized attack and potential runaway corrosion.'
    });
    result.rationales.push('[MATERIALS] Aluminum passivation limit is ~40% HNOâ‚ƒ. Above this concentration, the oxide film becomes unstable leading to localized attack and potential runaway corrosion.');
    return result;
  }

  // HASTELLOY-C: Hard fail in strong oxidizing acids (designed for REDUCING acids)
  if(materialId==='Hastelloy-C'&&(fk.includes('hno3')&&nitricConc>=40||fk.includes('chromate')||fk.includes('perchlorate'))){
    result.passed=false;
    result.gate='NOT_RECOMMENDED';
    result.failureMode='Ni-Mo alloy unstable in oxidizing acids - designed for HCl/Hâ‚‚SOâ‚„ reducing service';
    result.failures.push({
      archetype:'CHEMISTRY_MISMATCH',
      material:materialId,
      severity:'FATAL',
      message:'[FATAL] Hastelloy C-276 NOT suitable for oxidizing acids: Ni-Mo alloy designed for REDUCING acid service (HCl, Hâ‚‚SOâ‚„)',
      rationale:'[MATERIALS] Hastelloy C-276 (Ni-Mo-Cr) excels in reducing acids where Mo provides resistance. In oxidizing acids (HNOâ‚ƒ, chromates), the alloy suffers localized attack. Use Titanium or 316SS instead.'
    });
    result.rationales.push('[MATERIALS] Hastelloy C-276 (Ni-Mo-Cr) excels in reducing acids where Mo provides resistance. In oxidizing acids (HNOâ‚ƒ, chromates), the alloy suffers localized attack. Use Titanium or 316SS instead.');
    return result;
  }

  // 316SS: GOOD for nitric â‰¤70% at â‰¤40Â°C (industry standard), CONDITIONAL otherwise
  if(materialId==='316SS'&&fk.includes('hno3')){
    if(nitricConc<=70&&tC<=40){
      // This is the gold standard condition - should be GOOD, not CONDITIONAL
      result.gate='OK';
      return result; // Skip further archetype checks - this is validated
    }else if(nitricConc>70||tC>50){
      // High concentration or temperature - CONDITIONAL with explicit failure mode
      result.gate='CONDITIONAL';
      result.failureMode=nitricConc>70?'Intergranular corrosion risk above 70% HNOâ‚ƒ':'Passive film instability above 50Â°C in concentrated oxidizers';
      result.conditionals.push({
        archetype:'CONCENTRATION_TEMP_GATE',
        material:materialId,
        severity:'CONDITIONAL',
        message:'[CONDITIONAL] 316SS: '+(nitricConc>70?'Verify IGC resistance above 70% HNOâ‚ƒ':'Verify passive film stability above 50Â°C'),
        rationale:'[MATERIALS] 316SS widely used in nitric acid to 70% at ambient temperature. Above this, use 316L (low carbon) or consider Titanium.'
      });
      result.rationales.push('[MATERIALS] 316SS widely used in nitric acid to 70% at ambient temperature. Above this, use 316L (low carbon) or consider Titanium.');
    }
  }

  // TITANIUM: EXCELLENT for nitric (gold standard) - remove unwarranted warnings
  if(materialId==='Titanium'&&fk.includes('hno3')&&nitricConc<=70&&tC<=60){
    result.gate='OK';
    return result; // Titanium is gold standard for nitric acid - no warnings needed
  }

  // V85: TITANIUM: HARD FAIL in strong caustics (NaOH/KOH) - hydrogen embrittlement + alkali attack
  if(materialId==='Titanium'&&(fk.includes('naoh')||fk.includes('koh'))){
    if(naohConc>=30||tC>50){
      result.passed=false;
      result.gate='NOT_RECOMMENDED';
      result.failureMode='Hydrogen embrittlement + alkali attack in hot concentrated caustic';
      result.failures.push({
        archetype:'CAUSTIC_TITANIUM_GATE',
        material:materialId,
        severity:'FATAL',
        message:'[FATAL] Titanium NOT suitable for NaOH/KOH â‰¥30% or T>50Â°C: Hydrogen embrittlement and direct alkali attack on TiOâ‚‚ passive film',
        rationale:'[MATERIALS] Titanium relies on TiOâ‚‚ passive film which is attacked by strong bases. Hydrogen evolution in caustic causes embrittlement. Use Hastelloy, Monel, or Ni alloys instead.'
      });
      result.rationales.push('[MATERIALS] Titanium contraindicated in strong caustics - use Hastelloy C, Monel, or nickel alloys.');
      return result;
    }
  }

  // V85: CARBON STEEL: Temperature-based SCC gate for caustics (binary failure mode)
  if(materialId==='Carbon-Steel'&&(fk.includes('naoh')||fk.includes('koh'))){
    if(tC>50){
      result.passed=false;
      result.gate='NOT_RECOMMENDED';
      result.failureMode='Caustic stress corrosion cracking (SCC) - binary failure above 50Â°C';
      result.failures.push({
        archetype:'CAUSTIC_SCC_GATE',
        material:materialId,
        severity:'FATAL',
        message:'[FATAL] Carbon Steel PROHIBITED above 50Â°C in caustic: SCC is non-linear catastrophic failure regardless of corrosion rate',
        rationale:'[CHEM ENG] Caustic SCC is a binary failure mode - corrosion rate becomes irrelevant. Material may show low general corrosion but fail suddenly by intergranular cracking.'
      });
      result.rationales.push('[CHEM ENG] SCC overrides corrosion rate economics. Use 316SS (stress-relieved) or nickel alloys for hot caustic.');
      return result;
    }else if(tC>=40&&tC<=50){
      // Transitional zone - CONDITIONAL
      result.gate='CONDITIONAL';
      result.failureMode='SCC risk in transitional temperature zone (40-50Â°C)';
      result.conditionals.push({
        archetype:'CAUSTIC_SCC_GATE',
        material:materialId,
        severity:'CONDITIONAL',
        message:'[CONDITIONAL] Carbon Steel: SCC possible at 40-50Â°C with residual stress',
        rationale:'[CHEM ENG] 40-50Â°C is SCC transitional zone. Requires: PWHT, minimized residual stress, velocity <3 m/s.'
      });
      result.rationales.push('[CHEM ENG] Carbon steel usable below 50Â°C with stress relief, but risk increases rapidly. Verify PWHT status.');
    }
  }

  // V16.1 FIX: STAINLESS STEEL CHLORIDE PITTING - Per V15 Policy Â§12 Chemistry Rules
  // Chlorides cause pitting/crevice corrosion on austenitic stainless steels
  // Ferric chloride (FeCl3) is especially aggressive due to oxidizing + chloride combination
  const isChlorideEnv = fk.includes('chloride') || fk.includes('fecl') || fk.includes('brine') || fk.includes('seawater') || hclConc > 0;
  if((materialId==='316SS'||materialId==='304SS') && isChlorideEnv){
    // Temperature affects severity: <25Â°C = mild risk, 25-50Â°C = moderate, >50Â°C = SCC risk
    if(tC >= 50){
      // Above SCC threshold - could be fatal
      result.passed = false;
      result.gate = 'NOT_RECOMMENDED';
      result.failureMode = 'Chloride SCC threshold exceeded (â‰¥50Â°C)';
      result.failures.push({
        archetype: 'CHLORIDE_SCC_GATE',
        material: materialId,
        severity: 'FATAL',
        message: `[FATAL] ${materialId}: Chloride SCC threshold exceeded at ${tC}Â°C`,
        rationale: '[CHEM ENG] Austenitic stainless steels suffer transgranular stress corrosion cracking above ~50Â°C in chloride environments. Use duplex stainless, Hastelloy C, or Titanium.'
      });
      result.rationales.push('[CHEM ENG] Chloride SCC is a binary failure mode above 50Â°C. Use duplex, super-duplex, or Ni alloys.');
      return result;
    } else {
      // Below SCC threshold but pitting risk - CONDITIONAL
      result.gate = 'CONDITIONAL';
      result.failureMode = 'pitting_risk';
      const is304 = materialId === '304SS';
      result.conditionals.push({
        archetype: 'CHLORIDE_PITTING_GATE',
        material: materialId,
        severity: 'CONDITIONAL',
        message: `[CONDITIONAL] ${materialId}: Pitting/crevice corrosion risk in chloride environment`,
        rationale: `[CHEM ENG] ${is304 ? '304SS has lower Mo content than 316SS - more susceptible to pitting.' : '316SS has 2-3% Mo for improved chloride resistance but still vulnerable.'} Limit chloride to <${is304 ? '25' : '50'}ppm or use higher alloys.`
      });
      result.rationales.push(`[CHEM ENG] ${materialId} subject to localized corrosion (pitting, crevice) in chlorides. Consider duplex or Hastelloy for severe chloride duty.`);
    }
  }

  // Standard archetype processing
  archetypes.forEach(arch=>{
    const rules=CHEM_ARCHETYPES[arch];
    if(!rules)return;

    // Layer 1A: FATAL check
    if(rules.fatal&&rules.fatal.includes(materialId)){
      result.passed=false;
      result.gate='NOT_RECOMMENDED';
      result.failureMode=result.failureMode||getFailureModeForArchetype(arch,materialId);
      result.failures.push({
        archetype:arch,
        material:materialId,
        severity:'FATAL',
        message:'[FATAL] '+materialId+' fundamentally incompatible with '+arch+' chemistry',
        rationale:rules.rationale
      });
    }

    // Layer 1B: CONDITIONAL check - V84: Add explicit failure modes
    if(rules.conditional&&rules.conditional.includes(materialId)){
      if(result.gate!=='NOT_RECOMMENDED')result.gate='CONDITIONAL';
      result.failureMode=result.failureMode||getFailureModeForArchetype(arch,materialId);
      result.conditionals.push({
        archetype:arch,
        material:materialId,
        severity:'CONDITIONAL',
        message:'[CONDITIONAL] '+materialId+': '+getFailureModeForArchetype(arch,materialId),
        rationale:rules.rationale
      });
    }

    // Layer 1C: TEMP check
    if(rules.maxTemp&&rules.maxTemp[materialId]&&tC>rules.maxTemp[materialId]){
      result.passed=false;
      result.gate='NOT_RECOMMENDED';
      result.failureMode='Temperature exceeds material limit ('+rules.maxTemp[materialId]+'Â°C max)';
      result.tempLimits.push({
        archetype:arch,
        material:materialId,
        severity:'TEMP_EXCEEDED',
        limit:rules.maxTemp[materialId],
        actual:tC,
        message:'[TEMP] '+materialId+' max '+rules.maxTemp[materialId]+'Â°C in '+arch+' (actual: '+safeToFixed(tC, 0, '0')+'Â°C)',
        rationale:rules.rationale
      });
    }

    // Collect rationales for display
    if(rules.rationale&&!result.rationales.includes(rules.rationale)){
      result.rationales.push(rules.rationale);
    }
  });

  return result;
}

// V84: Get specific failure mode for material/archetype combination
function getFailureModeForArchetype(arch,matId){
  const modes={
    'STRONG_OXIDIZER':{'316SS':'Passive film instability in concentrated oxidizers','304SS':'Intergranular corrosion risk','Aluminum':'Passivation breakdown - pitting','FKM':'Oxidative degradation at elevated temp','EPDM':'Rapid oxidative attack'},
    'OXIDIZER_MODERATE':{'Aluminum':'Borderline passivation - verify for specific conditions','304SS':'Verify chromium oxide stability','Monel':'Ni-Cu alloy - poor oxidizer resistance'},
    'OXIDIZER_MILD':{'304SS':'Verify intergranular corrosion resistance','Monel':'Ni-Cu alloy - marginal in oxidizers'},
    'REDUCING_ACID':{'Titanium':'Hydrogen embrittlement risk','316SS':'Pitting/crevice corrosion in HCl','304SS':'Chloride SCC risk','Monel':'Verify in high-temp HCl'},
    'STRONG_BASE':{'Carbon-Steel':'Caustic SCC above 50Â°C with stress','316SS':'Caustic SCC possible at high temp/conc','304SS':'Caustic SCC possible at high temp/conc','PVC':'Plasticizer extraction','CPVC':'Chemical attack above 60Â°C','Titanium':'Hydrogen embrittlement + alkali attack in hot caustic','Aluminum':'Amphoteric dissolution - rapid attack','Glass':'Silicate dissolution by hydroxide ions'},
    'HALOGENATED':{'316SS':'Chloride pitting/crevice corrosion','304SS':'Chloride SCC - sudden failure','Monel':'Pitting in aerated solutions','Inconel':'Pitting in stagnant conditions'},
    'DEHYDRATING':{'Carbon-Steel':'Fragile FeS film - velocity critical','Cast-Iron':'Brittle sulfide film','316SS':'Accelerated general corrosion','304SS':'Rapid attack above 80% Hâ‚‚SOâ‚„'},
    'HIGH_TEMP':{'PTFE':'Creep/cold flow above 200Â°C','PVDF':'Softening above 140Â°C','FKM':'Hardening/compression set','Carbon-Steel':'Creep and oxidation','316SS':'Sensitization if >425Â°C'},
    'ABRASIVE_SLURRY':{'316SS':'Erosion-corrosion at high velocity','304SS':'Erosion-corrosion','Carbon-Steel':'Accelerated erosive wear','PTFE':'Abrasive wear - soft material'}
  };
  return modes[arch]&&modes[arch][matId]?modes[arch][matId]:'Verify suitability for '+arch+' service conditions';
}

// V84: Check all materials and categorize by gate result - includes material names
function runGateForAllMaterials(fk,tC,matList){
  // V84 FIX #1 & #9: Separate excluded from conditional/passed
  const results={passed:[],conditional:[],failed:[],excluded:[]};

  // Extract concentration from fluid key
  let conc=50; // default
  const concMatch=fk.match(/-(\d+)/);
  if(concMatch)conc=parseInt(concMatch[1],10);

  matList.forEach(m=>{
    // V84: Use new engine with hard exclusion support
    const v84result=evaluateCompatibilityV84(m,fk,tC,conc);
    const matName=M.materials[m]?M.materials[m].name:m;

    // V84: Handle EXCLUDED materials separately - they never appear elsewhere
    if(v84result.excluded||v84result.classification==='EXCLUDED'){
      results.excluded.push({
        matId:m,
        matName:matName,
        exclusionReason:v84result.exclusionReason||v84result.activeTriggers[0]||'Hard failure',
        failureMode:v84result.failureModes[0]||'',
        mechanism:v84result.rationale[0]||'',
        alternative:v84result.mitigations[0]||'',
        chemicalResistance:v84result.chemicalResistance,
        industrialSuitability:v84result.industrialSuitability
      });
      return; // V84 FIX #1: EXCLUDED materials skip all other processing
    }

    // Convert V84 result to gate format for non-excluded materials
    const gate={
      passed:v84result.classification==='OK',
      gate:v84result.classification,
      chemicalResistance:v84result.chemicalResistance,
      industrialSuitability:v84result.industrialSuitability,
      failures:[],
      conditionals:v84result.classification==='CONDITIONAL'?[{
        archetype:'V84_ENGINE',
        material:m,
        severity:'CONDITIONAL',
        message:'[CONDITIONAL] '+matName+': '+v84result.failureModes.join(', '),
        rationale:v84result.rationale.join(' ')
      }]:[],
      tempLimits:v84result.tempActivations.map(ta=>({
        archetype:'TEMP_ACTIVATION',
        material:m,
        maxTemp:ta.threshold,
        actualTemp:ta.actual,
        message:'[TEMP] '+matName+' '+ta.mode+' activated at '+ta.threshold+'Â°C (actual: '+ta.actual+'Â°C)'
      })),
      rationales:v84result.rationale,
      archetypes:['V84_HARD_EXCLUSION_ENGINE'],
      failureMode:v84result.failureModes.length>0?v84result.failureModes.join(', '):'',
      mitigations:v84result.mitigations,
      monitoring:v84result.monitoring,
      confidenceScore:v84result.confidenceScore
    };

    // V84: Only OK or CONDITIONAL can reach here (EXCLUDED already returned)
    if(v84result.classification==='CONDITIONAL'){
      results.conditional.push({matId:m,matName:matName,gate:gate});
    }else{
      results.passed.push({matId:m,matName:matName,gate:gate});
    }
  });

  // V84: For backward compatibility, put excluded in failed array too
  results.failed=results.excluded.map(e=>({
    matId:e.matId,
    matName:e.matName,
    gate:{
      passed:false,
      gate:'EXCLUDED',
      failureMode:e.failureMode,
      failures:[{archetype:'HARD_EXCLUSION',material:e.matId,severity:'EXCLUDED',message:e.exclusionReason,rationale:e.mechanism}],
      mitigations:[e.alternative],
      confidenceScore:95,
      chemicalResistance:e.chemicalResistance,
      industrialSuitability:e.industrialSuitability
    }
  }));

  return results;
}

// V84 FIX #9: Generate gate banner with EXCLUDED MATERIALS section
function gateFailureBannerHTML(archetypes,failedMats,conditionalMats,tempLimits,rationales,excludedMats){
  let h='<div class="gate-banner">';
  h+='<div class="gate-header">âš ï¸ V84 COMPATIBILITY ENGINE - HARD EXCLUSION ACTIVE</div>';
  h+='<div class="gate-archetypes">Engine: Design Intent + Temperature Mode + Confidence Enforcement</div>';

  // V84 FIX #9: EXCLUDED MATERIALS SECTION (Critical for trust)
  if(excludedMats&&excludedMats.length>0){
    h+='<div class="gate-section excluded"><div class="gate-label">ğŸš« EXCLUDED MATERIALS - PROHIBITED ('+excludedMats.length+')</div>';
    h+='<div class="gate-excluded-intro">The following materials are <strong>prohibited</strong> due to non-mitigable chemical failure:</div>';
    excludedMats.filter(em=>em&&em.matName).forEach(em=>{
      h+='<div class="gate-excluded-item">';
      h+='<div class="gate-excluded-name">â€¢ <strong>'+(em.matName||'Unknown')+'</strong></div>';
      h+='<div class="gate-excluded-mode">Failure: '+(em.failureMode||'Chemical incompatibility')+'</div>';
      h+='<div class="gate-excluded-reason">'+(em.exclusionReason||'Hard failure')+'</div>';
      if(em.alternative)h+='<div class="gate-excluded-alt">Alternative: '+em.alternative+'</div>';
      h+='</div>';
    });
    h+='</div>';
  }

  // CONDITIONAL materials
  if(conditionalMats&&conditionalMats.length>0){
    h+='<div class="gate-section conditional"><div class="gate-label">âš¡ CONDITIONAL ('+conditionalMats.length+')</div>';
    conditionalMats.filter(cm=>cm&&cm.gate).forEach(cm=>{
      const failMode=(cm.gate&&cm.gate.failureMode)||'Requires verification';
      const confidence=(cm.gate&&cm.gate.confidenceScore)||80;
      const chemRes=(cm.gate&&cm.gate.chemicalResistance)||'limited';
      const indSuit=(cm.gate&&cm.gate.industrialSuitability)||'conditional';
      h+='<div class="gate-item">';
      h+='<strong>'+(cm.matName||'Unknown')+'</strong>';
      h+='<div class="gate-dual-rating">Chemical: <span class="rating-'+chemRes+'">'+chemRes+'</span> | Industrial: <span class="rating-'+indSuit+'">'+indSuit+'</span></div>';
      h+='<div class="gate-failure-mode">Risk: <em>'+failMode+'</em></div>';
      if(cm.gate&&cm.gate.mitigations&&cm.gate.mitigations.length>0){
        h+='<div class="gate-mitigations"><strong>Mitigations:</strong><ul>';
        cm.gate.mitigations.filter(m=>m).slice(0,3).forEach(m=>h+='<li>'+m+'</li>');
        h+='</ul></div>';
      }
      if(cm.gate&&cm.gate.monitoring&&cm.gate.monitoring.length>0){
        h+='<div class="gate-monitoring"><strong>Monitoring:</strong><ul>';
        cm.gate.monitoring.filter(m=>m).slice(0,2).forEach(m=>h+='<li>'+m+'</li>');
        h+='</ul></div>';
      }
      h+='<div class="gate-confidence">Confidence: '+confidence+'%</div>';
      h+='</div>';
    });
    h+='</div>';
  }

  if(tempLimits&&tempLimits.length>0){
    h+='<div class="gate-section temp"><div class="gate-label">ğŸŒ¡ï¸ TEMPERATURE MODE ACTIVATIONS</div>';
    tempLimits.filter(t=>t&&t.message).forEach(t=>h+='<div class="gate-item">'+t.message+'</div>');
    h+='</div>';
  }

  if(rationales&&rationales.length>0){
    h+='<div class="gate-rationales"><div class="gate-label">ğŸ“‹ ENGINEERING RATIONALE</div>';
    const uniqueRationales=[...new Set(rationales.filter(r=>r))].slice(0,5);
    uniqueRationales.forEach(r=>h+='<div class="gate-rationale">'+r+'</div>');
    h+='</div>';
  }

  h+='<div class="gate-footer">V87 Engine: Design Intent Override â€¢ Temperature Mode Switches â€¢ Confidence Enforcement â€¢ Hard Exclusion</div>';
  h+='</div>';
  return h;
}

function calc(){try{
// V16.2 HARDENING: P2-B & P2-C - Reset state and track execution order (Agent 4 & 11)
resetExecutionSequence();
resetAllState();
trackExecutionStep('CALC_START');

// V87: Increment usage counter
try{
let count=parseInt(localStorage.getItem('certaUsageCount')||'0')+1;
localStorage.setItem('certaUsageCount',count.toString());
DOM.setText('usageCount',count.toLocaleString());
}catch(e){}

const fk=document.getElementById('fluidSelect').value,temp=parseFloat(DOM.getValue('tempInput')),unit=DOM.getValue('tempUnit');

// V16.2: Temperature bounds check (P1-D)
let tempC = temp;
if (unit === 'F') tempC = (temp - 32) * 5 / 9;
if (unit === 'K') tempC = temp - 273.15;
const tempValid = validateTemperature(tempC);
if (!tempValid.valid) {
  DOM.setHTML('results','<div class=\"warning\">âš ï¸ Temperature Error: ' + tempValid.errors.join(', ') + '</div>');
  return;
}
if (tempValid.warnings.length > 0) {
  console.warn('Temperature warnings:', tempValid.warnings);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 Â§5: CREATE RUN CONTEXT (SINGLE SOURCE OF TRUTH)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trackExecutionStep('CREATE_CONTEXT');
const runCtx = createRunContext(fk, temp, unit);
if (!runCtx.valid) {
  DOM.setHTML('results','<div class=\"warning\">âš ï¸ ' + (runCtx.error || 'Invalid input') + '</div>');
  return;
}
const ctx = runCtx.context;
const tC = ctx.temperature;

// V15.0 Â§9: ASSESS DATA COMPLETENESS
const dataCheck = assessDataCompleteness(fk, tC);
if (!dataCheck.complete) {
  let helpMsg = '';
  if (dataCheck.issues.some(i => i.includes('Temperature outside'))) {
    helpMsg = '<br><small style="color:#fcd34d">ğŸ’¡ Tip: Check if another version of this fluid covers your temperature range (e.g., "Ambient" vs "Hot" variants)</small>';
  }
  DOM.setHTML('results','<div class=\"warning\">âš ï¸ ' + dataCheck.message + '<br><small>' + dataCheck.issues.join(', ') + '</small>' + helpMsg + '</div>');
  return;
}

// V89: Clear audit trail at start of each calculation
clearAuditTrail();
// V91: Clear evaluation cache on new calculation
_clearCache();

curFluid=fk;curTemp=tC;const fl=F[fk];
// V15.0: Data already validated in createRunContext
const p=interp(tC,fl.d);
if(!p||p.sg==null||p.visc==null){DOM.setHTML('results','<div class="warning">âš ï¸ Could not calculate fluid properties</div>');return;}
const dens=p.sg*1000,kv=(p.visc/1000)/dens*1e6;const hk=getH(fk),hz=hk?H[hk]:null;const ck=getC(fk,fl.c);let cp=getCompatWithWarning(ck);const sk=getS(fk,fl.c),seals=S[sk]||S['General'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.0 Â§7: ENGINE EXECUTION CONTRACT (STRICT ORDER)
// Stage 3-6: Material instantiation, failure-mode mapping, temp escalation, hard gates
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trackExecutionStep('GATES');
const archTypes=getChemistryArchetype(fk,tC);
const allMats=Object.keys(M.materials);
const gateResults=runGateForAllMaterials(fk,tC,allMats);
const hasGateFailures=gateResults.failed.length>0;
const hasConditionals=gateResults.conditional.length>0;

// V15.0 Â§10: CONSTRUCT CANDIDATE SETS
trackExecutionStep('CANDIDATE_SETS');
const candidateSets = constructCandidateSets(ctx, gateResults);
if (candidateSets._validity === 'INVALID') {
  DOM.setHTML('results','<div class="warning">âš ï¸ Failed to construct candidate sets - evaluation aborted</div>');
  return;
}

// V16.2: Verify candidate set consistency (P15)
const setConsistency = verifyCandidateSetConsistency(candidateSets);
if (!setConsistency.valid) {
  console.error('Candidate set consistency errors:', setConsistency.errors);
}

// V15.0 Â§13: RESOLVE SEAL ELIGIBILITY
trackExecutionStep('SEALS');
const sealEligibility = resolveSealEligibility(ctx);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.2 FIX: Â§14 GENERATE FAO (FinalAssessmentOutput) - Single Source of Truth
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trackExecutionStep('FAO_GENERATE');
const faoResult = generateFAO(ctx, candidateSets, sealEligibility, [], []);
if (!faoResult.valid) {
  DOM.setHTML('results','<div class="warning">âš ï¸ V15 Â§14: Failed to generate FAO - evaluation aborted</div>');
  return;
}

// V16.2: Compute and store FAO hash for integrity verification (P2-D)
const faoIntegrityHash = computeFAOHash(faoResult.fao);
console.log('V16.2 FAO Integrity Hash:', faoIntegrityHash);

// V16.2: Verify execution order (P2-B)
const orderCheck = verifyExecutionOrder(['CALC_START', 'CREATE_CONTEXT', 'GATES', 'CANDIDATE_SETS', 'SEALS', 'FAO_GENERATE']);
if (!orderCheck.valid) {
  console.error('V15 Â§7 Execution order violation:', orderCheck);
}

// V15.2 FIX: Â§15 Validate UI State - ensure FAO is current
if (!validateUIState(faoResult.fao)) {
  DOM.setHTML('results','<div class="warning">âš ï¸ V15 Â§15: UI state validation failed - stale data detected</div>');
  return;
}

trackExecutionStep('RENDER_START');

// V7.3 CRITICAL FIX: Modify cp arrays based on gate results for CONSISTENCY
// This ensures Material Compatibility section matches Lifecycle Comparison
const failedIds=gateResults.failed.map(r=>r.matId);
const conditionalIds=gateResults.conditional.map(r=>r.matId);

// Deep clone cp to avoid modifying the source data
cp={
  excellent:cp.excellent?cp.excellent.filter(m=>!failedIds.includes(m)&&!conditionalIds.includes(m)):[],
  good:cp.good?[...cp.good.filter(m=>!failedIds.includes(m)),
    ...(cp.excellent?cp.excellent.filter(m=>conditionalIds.includes(m)):[])
  ]:[],
  fair:cp.fair?cp.fair.filter(m=>!failedIds.includes(m)):[],
  poor:cp.poor?[...cp.poor,...failedIds.filter(m=>!cp.poor.includes(m))]:failedIds
};

// V84: Collect all temp limits and rationales for banner
let allTempLimits=[],allRationales=[];
gateResults.failed.forEach(r=>{
  if(r&&r.gate&&r.gate.tempLimits)allTempLimits=allTempLimits.concat(r.gate.tempLimits.filter(t=>t));
  if(r&&r.gate&&r.gate.rationales)allRationales=allRationales.concat(r.gate.rationales.filter(t=>t));
});
gateResults.conditional.forEach(r=>{
  if(r&&r.gate&&r.gate.rationales)allRationales=allRationales.concat(r.gate.rationales.filter(t=>t));
});
// Remove duplicate rationales
allRationales=[...new Set(allRationales.filter(r=>r))];

let h='<div class="results" style="position:relative">';

// V17.6 F2-001: Prominent Warning Banner - Parliament Session 13 Mandate
h+='<div class="results-warning-banner"><div class="icon">âš ï¸</div><div class="title">SCREENING RESULTS ONLY - NOT A CERTIFICATION</div><div class="text">These results are for preliminary assessment only. Professional verification, corrosion testing, and manufacturer approval are required before implementation.</div></div>';

// V81: Generate Assessment ID and display in top-right corner
var now=new Date();var yr=now.getFullYear();var mo=String(now.getMonth()+1).padStart(2,'0');var dy=String(now.getDate()).padStart(2,'0');
// V16.1 FIX: Deterministic docId fallback per V15 Â§2.1
try{var storedId=localStorage.getItem('certaDocId_'+yr+mo+dy);docIdCounter=storedId?parseInt(storedId)+1:1;localStorage.setItem('certaDocId_'+yr+mo+dy,docIdCounter);}catch(e){
var hashVal=0;var hashStr=fk+tC+ctx.primaryRegime;for(var i=0;i<hashStr.length;i++){hashVal=((hashVal<<5)-hashVal)+hashStr.charCodeAt(i);hashVal=hashVal&hashVal;}
docIdCounter=Math.abs(hashVal%99999)+1;}
var docId='CERTA-'+yr+'-'+mo+'-'+dy+'-'+String(docIdCounter).padStart(5,'0');

// V15.1: Store calculation data for export
lastCalcData={
  fluidId:fk,
  fluidName:fl.n,
  tempC:tC,
  regime:ctx.primaryRegime,
  sealState:sealEligibility.state,
  faoHash:docId,
  sg:p.sg,
  visc:p.visc,
  timestamp:now.toISOString()
};
// Save to recent fluids
try{saveRecentFluid(fk,fl.n,fl.c);}catch(e){}

h+='<div style="position:absolute;top:8px;right:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;padding:6px 12px;font-size:0.7rem"><div style="color:#64748b;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.05em">Assessment ID</div><div style="color:#60a5fa;font-weight:600;font-family:monospace">'+docId+'</div></div>';

// V87: VALIDATION PIPELINE STATUS BANNER (Per Universal Rulebook)
const pipelineStages = [
  {name:'Classification', status:'âœ“', color:'#22c55e'},
  {name:'Failure Gates', status: hasGateFailures || gateResults.excluded.length > 0 ? 'âš ' : 'âœ“', color: hasGateFailures || gateResults.excluded.length > 0 ? '#f59e0b' : '#22c55e'},
  {name:'Temp Escalation', status: tC >= 50 ? 'âš ' : 'âœ“', color: tC >= 50 ? '#f59e0b' : '#22c55e'},
  {name:'Confidence Caps', status:'âœ“', color:'#22c55e'},
  {name:'TCO Analysis', status: hasGateFailures ? 'âŠ˜' : 'âœ“', color: hasGateFailures ? '#94a3b8' : '#22c55e'}
];
h+='<div style="background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border:1px solid #334155;border-radius:8px;padding:10px 14px;margin-bottom:15px">';
h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:0.7rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.05em">V16.1 Universal Rulebook Pipeline</span><span style="background:#22c55e;color:#052e16;font-size:0.6rem;padding:2px 6px;border-radius:10px;font-weight:600">FINAL</span></div>';

// RULEBOOK V3 Â§8: Final Universal Safety Rule
h+='<div style="font-size:0.65rem;color:#64748b;font-style:italic;margin-bottom:6px;padding:4px 8px;background:#0f172a;border-radius:4px;border-left:2px solid #3b82f6">';
h+='<strong style="color:#94a3b8">Â§8 Safety Invariant:</strong> No material recommended unless passed chemical, thermal, mechanical & regulatory validation under worst-case assumptions.';
h+='</div>';

// V89: STANDARDS COMPLIANCE FRAMEWORK
h+='<div style="font-size:0.6rem;color:#475569;margin-top:8px;padding:6px 8px;background:#0f172a;border-radius:4px;border:1px solid #1e293b">';
h+='<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">';
h+='<span title="Information Security Management">ğŸ”’ ISO 27001 Aligned</span>';
h+='<span title="Risk-Based Inspection">ğŸ“‹ API RP 581 Compatible</span>';
h+='<span title="Functional Safety - Advisory Only">âš ï¸ SIL 0 (Non-Safety)</span>';
h+='<span title="Globally Harmonized System">ğŸ§ª GHS-7 Compliant</span>';
h+='</div>';
h+='</div>';
h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
pipelineStages.forEach((s,i)=>{
  h+='<div style="display:flex;align-items:center;gap:4px;background:'+s.color+'15;border:1px solid '+s.color+'40;padding:4px 8px;border-radius:4px">';
  h+='<span style="color:'+s.color+';font-weight:bold;font-size:0.75rem">'+s.status+'</span>';
  h+='<span style="color:#cbd5e1;font-size:0.7rem">'+s.name+'</span>';
  h+='</div>';
  if(i < pipelineStages.length-1) h+='<span style="color:#475569;font-size:0.7rem">â†’</span>';
});
h+='</div></div>';

h+='<h2>ğŸ“Š '+fl.n+'</h2><div class="results-cat">'+fl.c+'</div>';

// V7.2: Add archetype tags
h+='<div style="margin:8px 0">';
archTypes.forEach(a=>h+='<span class="archetype-tag">'+a+'</span>');
h+='</div>';

// V84: Add gate failure banner with EXCLUDED materials (V84 FIX #9)
if(hasGateFailures||hasConditionals||gateResults.excluded.length>0){
h+=gateFailureBannerHTML(archTypes,gateResults.failed,gateResults.conditional,allTempLimits,allRationales,gateResults.excluded);
}

// V16.3 REC-M3: Prominent explosion warning banner for EXPLOSIVE_ENERGETIC
if(_currentRunContext && _currentRunContext.primaryRegime === 'EXPLOSIVE_ENERGETIC'){
h+='<div style="background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);border:3px solid #dc2626;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 4px 20px rgba(220,38,38,0.3)">';
h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">';
h+='<span style="font-size:2rem">ğŸ’¥</span>';
h+='<div style="color:#fef2f2;font-size:1.2rem;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.3)">EXPLOSION HAZARD - ENERGETIC MATERIAL</div>';
h+='</div>';
h+='<div style="color:#fecaca;font-size:0.9rem;line-height:1.5;margin-bottom:10px">';
h+='<strong>WARNING:</strong> This fluid is classified as an <strong>ENERGETIC/OXIDIZER</strong> material. ';
h+='Thermal decomposition, contamination, or confinement may result in <strong>DETONATION</strong>.</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:0.8rem">';
h+='<div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;color:#fed7aa"><strong>âš ï¸ THERMAL:</strong> Decomposes >200Â°C releasing toxic NOx gases</div>';
h+='<div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;color:#fed7aa"><strong>âš ï¸ CONTAMINATION:</strong> Contact with organics/fuels may cause detonation</div>';
h+='</div>';
h+='<div style="margin-top:10px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;font-size:0.75rem;color:#fca5a5">';
h+='<strong>REGULATORY:</strong> Subject to security-sensitive ammonium nitrate (SSAN) regulations. Storage, handling, and transport require specialist protocols.</div>';
h+='</div>';
}

if(p.ex)h+='<div class="warning">âš ï¸ Temperature outside data range.</div>';h+='<div class="grid"><div class="prop"><div class="prop-label">Specific Gravity</div><div class="prop-value">'+safeToFixed(p.sg, 4, '0')+'</div><div class="prop-unit">rel. to water</div></div><div class="prop"><div class="prop-label">Dynamic Viscosity</div><div class="prop-value">'+safeToFixed(p.visc, 3, '0')+'</div><div class="prop-unit">cP</div></div><div class="prop"><div class="prop-label">Density</div><div class="prop-value">'+safeToFixed(dens, 2, '0')+'</div><div class="prop-unit">kg/mÂ³</div></div><div class="prop"><div class="prop-label">Kinematic Viscosity</div><div class="prop-value">'+safeToFixed(kv, 3, '0')+'</div><div class="prop-unit">cSt</div></div></div><div class="temp-display">Temperature: '+safeToFixed(tC, 1, '0')+'Â°C | '+(tC*9/5+32).toFixed(1)+'Â°F | '+(tC+273.15).toFixed(1)+'K | <strong>Pressure: 1 bar (atm)</strong></div>';h+='<div class="chart-box"><div class="chart-title">ğŸ“ˆ Viscosity-Temperature Profile</div><canvas id="viscChart"></canvas><div class="chart-legend"><span><span class="legend-dot data"></span>Data Points</span><span><span class="legend-dot current"></span>Current (â˜…)</span></div></div>';h+='<div class="lifecycle-box"><div class="lifecycle-title">ğŸ“Š Material Lifecycle Comparison</div><div style="background:#1e3a5f;padding:10px;border-radius:6px;margin-bottom:12px;font-size:0.8rem;border-left:3px solid #60a5fa"><strong style="color:#93c5fd">ğŸ“‹ Analysis Assumptions:</strong><ul style="margin:6px 0 0 16px;color:#cbd5e1;line-height:1.5"><li>Velocity: 2-3 m/s (typical pump discharge)</li><li>Temperature: '+safeToFixed(tC, 0, '0')+'Â°C (as specified)</li><li>Concentration: Standard grade (check SDS)</li><li>Corrosion rates: Mid-range of published values [9,10]</li><li>Replacement labor: $500/mÂ² included</li></ul></div><div style="font-size:0.75rem;color:#94a3b8;margin-bottom:12px">Data: NACE Corrosion Data Survey [9], ASM Handbook Vol.13 [10], MEPS Steel Prices [11]</div><div id="lifecycleResults"></div></div>';h+='<div class="section"><div class="section-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><span>ğŸ”§ Material Compatibility</span><span>â–¼</span></div><div class="section-content">';let matIdx=0;if(cp.excellent&&cp.excellent.length){h+='<div class="compat-group"><div class="compat-title excellent">âœ“ Excellent</div><div class="compat-grid">';cp.excellent.forEach(m=>{const mt=M.materials[m];if(mt){const conf=calcConfidence('material',m,{tempDefined:true,inRange:!p.ex,rating:'excellent',fluidKey:fk,tempC:tC});h+='<div class="compat-item excellent"><div class="compat-name">'+mt.name+'</div><div class="compat-type">'+mt.type+'</div>'+confBadgeHTML(conf,'mat-'+matIdx)+'</div>';matIdx++;}});h+='</div></div>';}if(cp.good&&cp.good.length){h+='<div class="compat-group"><div class="compat-title good">â—‹ Good</div><div class="compat-grid">';cp.good.forEach(m=>{const mt=M.materials[m];if(mt){const conf=calcConfidence('material',m,{tempDefined:true,inRange:!p.ex,rating:'good',fluidKey:fk,tempC:tC});h+='<div class="compat-item good"><div class="compat-name">'+mt.name+'</div><div class="compat-type">'+mt.type+'</div>'+confBadgeHTML(conf,'mat-'+matIdx)+'</div>';matIdx++;}});h+='</div></div>';}if(cp.poor&&cp.poor.length){h+='<div class="compat-group"><div class="compat-title poor">âœ— Not Recommended</div><div class="compat-grid">';cp.poor.forEach(m=>{const mt=M.materials[m];if(mt){const conf=calcConfidence('material',m,{tempDefined:true,inRange:!p.ex,rating:'poor',fluidKey:fk,tempC:tC});h+='<div class="compat-item poor"><div class="compat-name">'+mt.name+'</div><div class="compat-type">'+mt.type+'</div>'+confBadgeHTML(conf,'mat-'+matIdx)+'</div>';matIdx++;}});h+='</div></div>';}h+='</div></div>';h+='<div class="section"><div class="section-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><span>âš™ï¸ Seal Recommendations ('+sk+')</span><span>â–¼</span></div><div class="section-content">';

// V88 FIX: Explicit seal prohibition banner for oxidizer/energetic fluids
const sealProfile=getFluidBehaviorProfile(fk,tC);
const isOxidizerOrEnergetic=sealProfile.flags.includes('OXIDIZER_STRONG')||sealProfile.flags.includes('OXIDIZER_ADJACENT')||sealProfile.flags.includes('ENERGETIC');
if(isOxidizerOrEnergetic){
h+='<div style="background:#7f1d1d;padding:12px;border-radius:8px;margin-bottom:12px;font-size:0.85rem;border:2px solid #dc2626;color:#fecaca">';
h+='<strong>ğŸš« SEAL RESTRICTION - OXIDIZING/ENERGETIC FLUID</strong><br>';
h+='<span style="font-size:0.8rem">Single mechanical seals are <strong>PROHIBITED</strong> for this fluid category due to catastrophic leakage risk. Only sealless (mag drive/canned motor) or dual containment seals are acceptable.</span>';
h+='</div>';
}

const isConcentratedAcid=(fk.includes('h2so4-9')||fk.includes('h2so4-8')||fk.includes('hcl-3')||fk.includes('hno3-9')||fk.includes('hno3-7')||fk.includes('oleum'));if(isConcentratedAcid){h+='<div style="background:#451a03;padding:10px;border-radius:6px;margin-bottom:12px;font-size:0.8rem;border:1px solid #c2410c;color:#fed7aa"><strong>âš ï¸ Concentrated Acid:</strong> Standard elastomers have limited life. Use PTFE, FFKM (Kalrez), or sealless. For Hâ‚‚SOâ‚„ >80%: velocity under 0.5 m/s.</div>';}
// V15 Â§13.5: Filter seals based on eligibility state - MUST match PDF implementation
const sealFilterResult = filterSealsByEligibility(seals, sealEligibility);
if(sealFilterResult.suppressed){h+='<div style="background:#450a0a;border:2px solid #dc2626;padding:12px;border-radius:8px;margin:10px 0"><div style="font-weight:bold;color:#fca5a5;font-size:1rem;margin-bottom:6px">ğŸš« SEAL SELECTION SUPPRESSED</div><div style="color:#fca5a5;font-size:0.85rem">'+sealFilterResult.reason+'</div><div style="color:#f87171;font-size:0.8rem;margin-top:8px">Contact equipment manufacturer for specialized containment solutions.</div></div>';}else{
if(sealFilterResult.filtered){h+='<div style="background:#1e3a5f;border:1px solid #3b82f6;padding:8px;border-radius:6px;margin-bottom:10px;font-size:0.8rem;color:#93c5fd"><strong>V15 Â§13.5:</strong> '+sealEligibility.state.replace(/_/g,' ')+' - Showing '+sealFilterResult.seals.length+' of '+sealFilterResult.originalCount+' seal options</div>';}
let sealIdx=0;sealFilterResult.seals.forEach(s=>{let cls=s.sealless?'sealless':(s.priority.includes('CRITICAL')?'critical':(s.priority.includes('STRONGLY')||s.priority.includes('RECOMMENDED')?'recommended':''));const sealConf=calcConfidence('seal',s,{hasAPI:s.apiPlan.includes('API'),tempDefined:true,viscDefined:true,categoryMatch:true,priority:s.priority});h+='<div class="seal-card '+cls+'"><div class="seal-header">';if(s.sealless)h+='<span class="seal-badge sealless">SEALLESS</span>';if(s.priority.includes('CRITICAL'))h+='<span class="seal-badge critical">CRITICAL</span>';else if(s.priority.includes('STRONGLY'))h+='<span class="seal-badge recommended">STRONGLY REC.</span>';h+='<span class="seal-type">'+s.type+'</span>'+confBadgeHTML(sealConf,'seal-'+sealIdx)+'</div><div class="seal-priority">Priority: '+s.priority+'</div><div class="seal-reason"><strong>Why:</strong> '+s.reason+'</div><div class="seal-specs"><div class="seal-spec"><div class="seal-spec-label">Specs</div>'+s.specs+'</div><div class="seal-spec"><div class="seal-spec-label">Materials</div>'+s.materials+'</div></div><div class="seal-spec" style="margin-top:8px"><div class="seal-spec-label">Standard</div>'+s.apiPlan+'</div></div>';sealIdx++;});}h+='</div></div>';if(hz){h+='<div class="section"><div class="section-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><span>âš ï¸ Chemical Hazards (GHS-7/AICIS)</span><span>â–¼</span></div><div class="section-content"><div class="hazard-signal '+(hz.signal==='DANGER'?'danger':(hz.signal==='WARNING'?'warning':'none'))+'">'+hz.pictograms.join(' ')+' '+hz.signal+'</div><div class="hazard-section"><h4>GHS Classifications</h4><div class="hazard-grid">';hz.ghsClasses.forEach(c=>h+='<div class="hazard-class">'+c+'</div>');h+='</div></div><div class="hazard-section"><h4>Hazard Statements</h4><ul>';hz.hStatements.forEach(s=>h+='<li>'+s+'</li>');h+='</ul></div>';if(hz.twa&&hz.twa!=='N/A')h+='<div class="hazard-section"><h4>Exposure Limits</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div style="background:#1e3a5f;padding:10px;border-radius:6px;border:1px solid #3b82f6"><div style="color:#93c5fd;font-size:0.75rem;margin-bottom:4px">TWA (8-hour)</div><div style="color:#e2e8f0;font-weight:600"> '+hz.twa+'</div></div><div style="background:#4c1d95;padding:10px;border-radius:6px;border:1px solid #8b5cf6"><div style="color:#c4b5fd;font-size:0.75rem;margin-bottom:4px">STEL (15-min)</div><div style="color:#e2e8f0;font-weight:600"> '+hz.stel+'</div></div></div>';h+='<div class="hazard-section"><h4>Required PPE</h4><div class="ppe-grid">';hz.ppe.forEach(p=>h+='<div class="ppe-item">âœ“ '+p+'</div>');h+='</div></div><div class="hazard-section"><h4>First Aid</h4><div class="first-aid">'+hz.firstAid+'</div></div><div class="hazard-section"><h4>Disposal</h4><div class="disposal">'+hz.disposal+'</div></div><div class="aicis"><strong>AICIS:</strong> '+hz.aicis+(hz.un!=='N/A'?' | <strong>UN:</strong> '+hz.un+' | <strong>PSN:</strong> '+hz.psn+' | <strong>ERG:</strong> '+hz.erg:'')+'</div></div></div>';}h+='<div class="section"><div class="section-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><span>ğŸ“š Reference List</span><span>â–¼</span></div><div class="section-content">';R.forEach(r=>{h+='<div class="ref-item"><div class="ref-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><span><span class="ref-num">['+r.num+']</span><span class="ref-title">'+r.title+'</span></span><span>â–¶</span></div><div class="ref-citations">';['apa','mla','chicago','harvard','ieee'].forEach(fmt=>{h+='<div class="citation"><span class="citation-label">'+fmt.toUpperCase()+'</span><span class="citation-text">'+r[fmt]+'</span><button class="copy-btn" onclick="copyC(this,`'+r[fmt].replace(/`/g,"'")+'`)">Copy</button></div>';});h+='</div></div>';});h+='</div></div></div>';DOM.setHTML('results',h);SafeTimer.set(()=>{drawChart(fk,tC);calcLifecycle();},50);DOM.show('reynoldsCard');DOM.show('cavCard');DOM.show('printCard');}catch(err){console.error('CERTA calc() error:',err);DOM.setHTML('results','<div style="background:#7f1d1d;color:#fca5a5;padding:20px;border-radius:8px;margin:10px"><h3>âš ï¸ Error in Assessment</h3><p>'+err.message+'</p><pre style="font-size:0.7rem;overflow:auto">'+err.stack+'</pre></div>');}}
function copyC(btn,txt){navigator.clipboard.writeText(txt);btn.textContent='âœ“';btn.classList.add('copied');setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},2000);}

// V89: Export audit trail to JSON file
function exportAuditTrail() {
  const auditData = {
    exportDate: new Date().toISOString(),
    engineVersion: 'CERTA V15.0',
    sessionId: docId || 'N/A',
    fluidKey: curFluid || 'N/A',
    temperature: curTemp || 'N/A',
    entries: getAuditTrail()
  };
  const blob = new Blob([JSON.stringify(auditData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'CERTA_Audit_' + (docId || 'export') + '.json';
  a.click();
  URL.revokeObjectURL(url);
}
function getFluidRefs(fk,c){var refs=[1,2,3];if(fk.startsWith('h2so4')||fk.startsWith('hcl')||fk.startsWith('hno3')||fk.startsWith('h3po4')||fk.includes('naoh')||fk.includes('koh'))refs.push(9,10);if(c.includes('Petroleum')||c.includes('Aromatic'))refs.push(4,5);if(fk.includes('cyanide')||c.includes('Mining'))refs.push(9,10);if(c.includes('Food'))refs.push(6,7);refs.push(6,7,8,9,10,11,12,13,14,15,16);return[...new Set(refs)].sort((a,b)=>a-b);}
// PDF Translation Labels
var PDF_I18N={
en:{fluidProps:'Fluid Properties',viscTemp:'Viscosity-Temperature Data',lifecycle:'Material Lifecycle Analysis',matCompat:'Material Compatibility',sealRec:'Seal Recommendations',hazards:'Chemical Hazards',reynolds:'Reynolds Number Analysis',cavitation:'Cavitation Risk Assessment',references:'Reference List',tempC:'Temp (Â°C)',sg:'Specific Gravity',visc:'Viscosity (cP)',material:'Material',rating:'Rating',corrRate:'Corrosion Rate',serviceLife:'Service Life',tco:'10-Year TCO',excellent:'Excellent Compatibility',good:'Good Compatibility',notRec:'Not Recommended',assumptions:'Assumptions',recommendation:'Recommendation',elastomers:'Sealing & Elastomer Materials',failMode:'Failure Mode',inspection:'Inspection',strategy:'Strategy',disclaimer:'SCREENING TOOL ONLY - Results do not replace material qualification, corrosion testing, or manufacturer approval',generated:'Generated',checksum:'Checksum',document:'Document',regime:'Chemical Regime',sealState:'Seal State',materials:'Materials',temperature:'Temperature'},
es:{fluidProps:'Propiedades del Fluido',viscTemp:'Datos Viscosidad-Temperatura',lifecycle:'AnÃ¡lisis de Ciclo de Vida',matCompat:'Compatibilidad de Materiales',sealRec:'Recomendaciones de Sellos',hazards:'Peligros QuÃ­micos',reynolds:'AnÃ¡lisis de Reynolds',cavitation:'EvaluaciÃ³n de CavitaciÃ³n',references:'Referencias',tempC:'Temp (Â°C)',sg:'Gravedad EspecÃ­fica',visc:'Viscosidad (cP)',material:'Material',rating:'ClasificaciÃ³n',corrRate:'Tasa de CorrosiÃ³n',serviceLife:'Vida Ãštil',tco:'TCO 10 AÃ±os',excellent:'Excelente Compatibilidad',good:'Buena Compatibilidad',notRec:'No Recomendado',assumptions:'Supuestos',recommendation:'RecomendaciÃ³n',elastomers:'Materiales ElastomÃ©ricos',failMode:'Modo de Falla',inspection:'InspecciÃ³n',strategy:'Estrategia',disclaimer:'SOLO HERRAMIENTA DE EVALUACIÃ“N - Los resultados no reemplazan la calificaciÃ³n de materiales ni pruebas de corrosiÃ³n',generated:'Generado',checksum:'Suma de verificaciÃ³n',document:'Documento',regime:'RÃ©gimen QuÃ­mico',sealState:'Estado de Sello',materials:'Materiales',temperature:'Temperatura'},
zh:{fluidProps:'æµä½“ç‰¹æ€§',viscTemp:'ç²˜åº¦-æ¸©åº¦æ•°æ®',lifecycle:'ææ–™ç”Ÿå‘½å‘¨æœŸåˆ†æ',matCompat:'ææ–™å…¼å®¹æ€§',sealRec:'å¯†å°æ¨è',hazards:'åŒ–å­¦å±å®³',reynolds:'é›·è¯ºæ•°åˆ†æ',cavitation:'æ±½èš€é£é™©è¯„ä¼°',references:'å‚è€ƒæ–‡çŒ®',tempC:'æ¸©åº¦(Â°C)',sg:'æ¯”é‡',visc:'ç²˜åº¦(cP)',material:'ææ–™',rating:'è¯„çº§',corrRate:'è…èš€ç‡',serviceLife:'ä½¿ç”¨å¯¿å‘½',tco:'10å¹´æ€»æˆæœ¬',excellent:'ä¼˜ç§€å…¼å®¹æ€§',good:'è‰¯å¥½å…¼å®¹æ€§',notRec:'ä¸æ¨è',assumptions:'å‡è®¾æ¡ä»¶',recommendation:'æ¨è',elastomers:'å¯†å°å¼¹æ€§ä½“ææ–™',failMode:'å¤±æ•ˆæ¨¡å¼',inspection:'æ£€æŸ¥',strategy:'ç­–ç•¥',disclaimer:'ä»…ä¾›ç­›é€‰ - ç»“æœä¸èƒ½æ›¿ä»£ææ–™é‰´å®šæˆ–è…èš€æµ‹è¯•',generated:'ç”Ÿæˆæ—¶é—´',checksum:'æ ¡éªŒå’Œ',document:'æ–‡æ¡£',regime:'åŒ–å­¦ç¯å¢ƒ',sealState:'å¯†å°çŠ¶æ€',materials:'ææ–™',temperature:'æ¸©åº¦'},
de:{fluidProps:'Fluideigenschaften',viscTemp:'ViskositÃ¤t-Temperatur-Daten',lifecycle:'Material-Lebenszyklusanalyse',matCompat:'MaterialvertrÃ¤glichkeit',sealRec:'Dichtungsempfehlungen',hazards:'Chemische Gefahren',reynolds:'Reynolds-Analyse',cavitation:'Kavitationsbewertung',references:'Referenzen',tempC:'Temp (Â°C)',sg:'Spez. Gewicht',visc:'ViskositÃ¤t (cP)',material:'Material',rating:'Bewertung',corrRate:'Korrosionsrate',serviceLife:'Lebensdauer',tco:'10-Jahres-TCO',excellent:'Ausgezeichnete VertrÃ¤glichkeit',good:'Gute VertrÃ¤glichkeit',notRec:'Nicht empfohlen',assumptions:'Annahmen',recommendation:'Empfehlung',elastomers:'Dichtungsmaterialien',failMode:'Versagensart',inspection:'Inspektion',strategy:'Strategie',disclaimer:'NUR SCREENING - Ergebnisse ersetzen keine Materialqualifikation oder Korrosionstests',generated:'Erstellt',checksum:'PrÃ¼fsumme',document:'Dokument',regime:'Chemisches Regime',sealState:'Dichtungszustand',materials:'Materialien',temperature:'Temperatur'},
ar:{fluidProps:'Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø³Ø§Ø¦Ù„',viscTemp:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø²ÙˆØ¬Ø©-Ø§Ù„Ø­Ø±Ø§Ø±Ø©',lifecycle:'ØªØ­Ù„ÙŠÙ„ Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ù…ÙˆØ§Ø¯',matCompat:'ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…ÙˆØ§Ø¯',sealRec:'ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø­Ø´ÙˆØ§Øª',hazards:'Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©',reynolds:'ØªØ­Ù„ÙŠÙ„ Ø±ÙŠÙ†ÙˆÙ„Ø¯Ø²',cavitation:'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙƒÙ‡Ù',references:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹',tempC:'Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)',sg:'Ø§Ù„Ø«Ù‚Ù„ Ø§Ù„Ù†ÙˆØ¹ÙŠ',visc:'Ø§Ù„Ù„Ø²ÙˆØ¬Ø© (cP)',material:'Ø§Ù„Ù…Ø§Ø¯Ø©',rating:'Ø§Ù„ØªØµÙ†ÙŠÙ',corrRate:'Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ¢ÙƒÙ„',serviceLife:'Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ',tco:'Ø§Ù„ØªÙƒÙ„ÙØ© 10 Ø³Ù†ÙˆØ§Øª',excellent:'ØªÙˆØ§ÙÙ‚ Ù…Ù…ØªØ§Ø²',good:'ØªÙˆØ§ÙÙ‚ Ø¬ÙŠØ¯',notRec:'ØºÙŠØ± Ù…ÙˆØµÙ‰ Ø¨Ù‡',assumptions:'Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª',recommendation:'Ø§Ù„ØªÙˆØµÙŠØ©',elastomers:'Ù…ÙˆØ§Ø¯ Ø§Ù„Ø­Ø´ÙˆØ§Øª Ø§Ù„Ù…Ø·Ø§Ø·ÙŠØ©',failMode:'Ù†Ù…Ø· Ø§Ù„ÙØ´Ù„',inspection:'Ø§Ù„ÙØ­Øµ',strategy:'Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©',disclaimer:'Ø£Ø¯Ø§Ø© ÙØ­Øµ ÙÙ‚Ø· - Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø§ ØªØ­Ù„ Ù…Ø­Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ¢ÙƒÙ„',generated:'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡',checksum:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ',document:'Ø§Ù„Ù…Ø³ØªÙ†Ø¯',regime:'Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ',sealState:'Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø´Ùˆ',materials:'Ø§Ù„Ù…ÙˆØ§Ø¯',temperature:'Ø§Ù„Ø­Ø±Ø§Ø±Ø©'}
};
function printPDF(){
// V16.2 HARDENING: P1-A - Add try-catch wrapper (Agent 3: Safety & Compliance)
try {
// Get current language for PDF
var pdfLang=curLang||'en';
var L=PDF_I18N[pdfLang]||PDF_I18N.en;
var isRTL=pdfLang==='ar';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.2 CRITICAL FIX: Â§14.1 UI = PDF Rule
// PDF must render from the same FAO snapshot - NO recalculation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var res=document.getElementById('results');
if(!res.innerHTML){alert('Please calculate properties first!');return;}

// V15.2: Check if FAO exists
if(!_currentFAO){
  alert('âš ï¸ V15 Â§14.1 Violation: No FAO available.\nPlease calculate properties first.');
  return;
}

// V16.2: Verify FAO integrity hash (P2-D)
var faoHash = computeFAOHash(_currentFAO);
if (!faoHash) {
  alert('âš ï¸ V16.2: FAO integrity check failed.\nPlease recalculate.');
  return;
}

// V15.2: Verify checksum matches current inputs (prevent stale PDF)
var fk=document.getElementById('fluidSelect').value;
var temp=parseFloat(DOM.getValue('tempInput'));
var unit=DOM.getValue('tempUnit');
var tC=temp;
if(unit==='F')tC=(temp-32)*5/9;
if(unit==='K')tC=temp-273.15;

// V16.2: Validate temperature (P1-D)
var tempValidation = validateTemperature(tC);
if (!tempValidation.valid) {
  alert('âš ï¸ Temperature Error:\n' + tempValidation.errors.join('\n'));
  return;
}

// Generate expected checksum from current inputs
var expectedChecksum=generateChecksum({runId:_currentFAO.runId,fluidId:fk,temperature:tC});

// V15 Â§14.1: If mismatch, abort rendering
if(_currentFAO.checksum!==expectedChecksum){
  alert('âš ï¸ V15 Â§14.1: Results out of sync!\n\nInputs have changed since calculation.\nPlease click "Calculate Properties" before generating PDF.');
  return;
}

// V15.2: Consume frozen FAO data - NO recalculation
var fl=F[fk];
var pr=interp(tC,fl.d),dens=pr.sg*1000,kv=(pr.visc/1000)/dens*1e6;
var ck=getC(fk,fl.c),cpRaw=getCompatWithWarning(ck);
var corr=getCorrosionWithWarning(ck);
var sk=getS(fk,fl.c),seals=S[sk]||S['General'];
var hk=getH(fk),hz=hk?H[hk]:null;
var fluidRefs=getFluidRefs(fk,fl.c);

// V15.2: Use FAO checksum and data - NOT recalculated
var pdfChecksum=_currentFAO.checksum;
var pdfTimestamp=new Date().toISOString();

// V15.2 CRITICAL: Extract gate results from FAO candidateSets - NO recalculation
var pdfGateResults={
  // V16.1 FIX: ConditionalReferenceSet and ExcludedSet already contain {matId, matName, gate} objects
  // Don't re-wrap them - use directly
  failed:(_currentFAO.candidateSets.ExcludedSet||[]).map(function(item){
    // Handle both string IDs and object formats
    if(typeof item === 'string') return {matId: item};
    if(item && item.matId) return item;
    return {matId: String(item)};
  }),
  conditional:(_currentFAO.candidateSets.ConditionalReferenceSet||[]).map(function(item){
    if(typeof item === 'string') return {matId: item};
    if(item && item.matId) return item;
    return {matId: String(item)};
  }),
  passed:(_currentFAO.candidateSets.CompatibilitySet||[]).map(function(item){
    if(typeof item === 'string') return {matId: item};
    if(item && item.matId) return item;
    return {matId: String(item)};
  })
};
var pdfFailedIds=pdfGateResults.failed.map(function(r){return r.matId;});
var pdfConditionalIds=pdfGateResults.conditional.map(function(r){return r.matId;});
// V16.1 FIX: Match UI logic exactly per V15 Â§14.1 UI=PDF parity
// - excellent: remove both failed AND conditional
// - good: only remove failed (NOT conditional), then add demoted conditionals from excellent
// - fair: only remove failed
// - poor: add failed materials
var cp={
excellent:(cpRaw.excellent||[]).filter(function(m){return !pdfFailedIds.includes(m)&&!pdfConditionalIds.includes(m);}),
good:[...(cpRaw.good||[]).filter(function(m){return !pdfFailedIds.includes(m);}),...(cpRaw.excellent||[]).filter(function(m){return pdfConditionalIds.includes(m);})],
fair:(cpRaw.fair||[]).filter(function(m){return !pdfFailedIds.includes(m);}),
poor:[...(cpRaw.poor||[]),...pdfFailedIds.filter(function(m){return !(cpRaw.poor||[]).includes(m);})]
};
var css='@page{size:A4;margin:12mm 15mm 20mm 15mm}@font-face{font-family:Inter;src:local("Inter")}*{margin:0;padding:0;box-sizing:border-box}body{font-family:"Inter",Arial,Helvetica,sans-serif;padding:0;color:#1a1a2e;font-size:9px;line-height:1.4;background:#fff}.doc-header{background:linear-gradient(135deg,#1e3a5f 0%,#0f172a 100%);color:white;padding:15px 20px;margin:-12mm -15mm 15px -15mm;width:calc(100% + 30mm)}.doc-header-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}.doc-logo{font-size:18px;font-weight:700;letter-spacing:1px}.doc-logo span{color:#60a5fa}.doc-id{text-align:right;font-size:8px;opacity:0.9}.doc-title{font-size:14px;font-weight:600;margin:8px 0 4px}.doc-subtitle{font-size:9px;opacity:0.8}.summary-bar{display:flex;gap:10px;margin:15px 0;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px}.summary-item{flex:1;text-align:center;padding:8px;border-radius:4px}.summary-item.temp{background:#eff6ff;border:1px solid #3b82f6}.summary-item.regime{border:2px solid}.summary-item.seal{background:#f0fdf4;border:1px solid #22c55e}.summary-item.mats{background:#fefce8;border:1px solid #eab308}.summary-label{font-size:7px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px}.summary-value{font-size:12px;font-weight:700;font-family:"JetBrains Mono","Consolas",monospace}.regime-banner{padding:12px 15px;border-radius:6px;margin:12px 0;text-align:center;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:1px}.regime-banner.explosive{background:linear-gradient(135deg,#7f1d1d,#dc2626);color:#fecaca;border:2px solid #ef4444}.regime-banner.oxidizing{background:linear-gradient(135deg,#7c2d12,#ea580c);color:#fed7aa;border:2px solid #f97316}.regime-banner.fluoride{background:linear-gradient(135deg,#581c87,#9333ea);color:#e9d5ff;border:2px solid #a855f7}.regime-banner.acid{background:linear-gradient(135deg,#991b1b,#dc2626);color:#fecaca;border:2px solid #ef4444}.regime-banner.base{background:linear-gradient(135deg,#1e3a8a,#3b82f6);color:#dbeafe;border:2px solid #60a5fa}.regime-banner.neutral{background:linear-gradient(135deg,#14532d,#22c55e);color:#dcfce7;border:2px solid #4ade80}.regime-banner.unknown{background:#374151;color:#e5e7eb;border:2px solid #6b7280}h1{color:#1e3a5f;font-size:13px;font-weight:600;border-bottom:2px solid #3b82f6;padding-bottom:4px;margin:15px 0 8px;page-break-after:avoid}h2{color:#1e3a5f;font-size:10px;font-weight:600;margin:12px 0 6px;padding:6px 10px;background:linear-gradient(90deg,#eff6ff,#fff);border-left:3px solid #3b82f6;border-radius:0 4px 4px 0;page-break-after:avoid}.info-row{display:flex;gap:10px;margin-bottom:10px}.info-box{flex:1;padding:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:4px}.info-label{font-size:7px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}.info-value{font-size:11px;font-weight:600;color:#1e3a5f;font-family:"JetBrains Mono","Consolas",monospace}.props{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0}.prop{background:#fff;border:1px solid #e2e8f0;border-radius:6px;padding:10px;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,0.05)}.prop-label{font-size:7px;color:#64748b;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:3px}.prop-value{font-size:13px;font-weight:700;color:#1e3a5f;font-family:"JetBrains Mono","Consolas",monospace}.prop-unit{font-size:7px;color:#94a3b8;margin-top:2px}.mat-table{width:100%;border-collapse:collapse;margin:8px 0;font-size:8px}.mat-table th{background:#1e3a5f;color:white;padding:6px 8px;text-align:left;font-weight:600;font-size:7px;text-transform:uppercase}.mat-table td{padding:5px 8px;border-bottom:1px solid #e2e8f0}.mat-table tr:nth-child(even){background:#f8fafc}.mat-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:7px;font-weight:700}.mat-badge.pass{background:#dcfce7;color:#166534;border:1px solid #22c55e}.mat-badge.cond{background:#fef3c7;color:#92400e;border:1px solid #f59e0b}.mat-badge.fail{background:#fee2e2;color:#991b1b;border:1px solid #ef4444}.cg{margin:8px 0;padding:8px;background:#f8fafc;border-radius:4px}.ct{font-weight:600;font-size:9px;padding:4px 10px;border-radius:4px;margin-bottom:6px;display:inline-block}.ct.e{background:#dcfce7;color:#166534;border:1px solid #22c55e}.ct.g{background:#dbeafe;color:#1e40af;border:1px solid #3b82f6}.ct.p{background:#fee2e2;color:#991b1b;border:1px solid #ef4444}.cl{display:flex;flex-wrap:wrap;gap:4px}.ci{padding:3px 8px;border-radius:4px;font-size:8px;font-weight:500}.ci.e{background:#f0fdf4;border:1px solid #86efac;color:#166534}.ci.g{background:#eff6ff;border:1px solid #93c5fd;color:#1e40af}.ci.p{background:#fef2f2;border:1px solid #fca5a5;color:#991b1b}.seal{border:1px solid #e2e8f0;border-radius:6px;padding:10px;margin:8px 0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.05)}.seal.sl{border-left:4px solid #22c55e;background:#f0fdf4}.seal.cr{border-left:4px solid #ef4444;background:#fef2f2}.st{font-weight:700;font-size:10px;color:#1e3a5f;margin-bottom:4px}.sp{color:#64748b;font-size:8px;margin-bottom:6px}.hz{padding:12px;border-radius:6px;margin:10px 0;page-break-inside:avoid}.hz.d{background:#fef2f2;border:2px solid #ef4444}.hz.w{background:#fffbeb;border:2px solid #f59e0b}.sig{font-size:14px;font-weight:700;text-align:center;margin-bottom:8px;padding:8px;border-radius:4px}.hz.d .sig{background:#dc2626;color:white}.hz.w .sig{background:#f59e0b;color:white}.hs{margin:8px 0}.hs h4{font-size:8px;font-weight:600;color:#374151;margin-bottom:4px;text-transform:uppercase}.hl{list-style:none;padding:0}.hl li{padding:3px 0;border-bottom:1px solid #f3f4f6;font-size:8px}.ppe{display:flex;flex-wrap:wrap;gap:4px}.pi{background:#dbeafe;padding:3px 8px;border-radius:4px;font-size:8px;color:#1e40af}.fa{background:#dcfce7;padding:8px;border-radius:4px;font-size:8px;color:#166534}.dp{background:#f3f4f6;padding:8px;border-radius:4px;font-size:8px;color:#374151}.exp-lim{display:flex;gap:10px;margin:8px 0}.exp-box{flex:1;padding:8px;border-radius:4px;text-align:center}.twa-box{background:#1e3a5f;color:#e2e8f0;border:1px solid #3b82f6}.stel-box{background:#581c87;color:#e2e8f0;border:1px solid #9333ea}.refs{margin-top:15px;padding:10px;background:#f8fafc;border-radius:4px;border:1px solid #e2e8f0}.refs h2{margin:0 0 8px;background:none;border:none;padding:0}.ref{font-size:7px;color:#64748b;margin:3px 0;padding-left:10px;text-indent:-10px}.doc-footer{position:fixed;bottom:0;left:0;right:0;background:#f8fafc;border-top:2px solid #1e3a5f;padding:8px 15mm;font-size:7px;display:flex;justify-content:space-between}.footer-left{color:#64748b}.footer-center{color:#dc2626;font-weight:600;text-align:center;flex:1}.footer-right{color:#64748b;text-align:right}.conf-pdf{display:inline-block;padding:2px 6px;border-radius:3px;font-size:7px;font-weight:600;margin-left:4px;font-family:"JetBrains Mono",monospace}.conf-pdf.vh{background:#064e3b;color:#6ee7b7}.conf-pdf.hi{background:#1e3a5f;color:#7dd3fc}.conf-pdf.md{background:#78350f;color:#fcd34d}.conf-pdf.lo{background:#7f1d1d;color:#fca5a5}.conf-note{font-size:7px;color:#64748b;font-style:italic;margin:6px 0;padding:6px;background:#f8fafc;border-radius:4px;border-left:2px solid #3b82f6}.warning-box{background:#fef2f2;border:2px solid #dc2626;border-radius:6px;padding:10px;margin:10px 0}.warning-title{font-weight:700;color:#991b1b;font-size:9px;margin-bottom:4px}.warning-text{color:#7f1d1d;font-size:8px}@media print{body{padding:0}.doc-footer{position:fixed}tr{page-break-inside:avoid}.regime-banner{-webkit-print-color-adjust:exact;print-color-adjust:exact}}';
var h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+fl.n+' - CERTA Assessment Report</title><style>'+css+'</style></head><body style="font-family:Arial,sans-serif;font-size:10px;line-height:1.4;color:#111;padding:20px;max-width:800px;margin:0 auto;direction:'+(isRTL?'rtl':'ltr')+';text-align:'+(isRTL?'right':'left')+'">';
// Generate document ID early for header
var now=new Date();var yr=now.getFullYear();var mo=String(now.getMonth()+1).padStart(2,'0');var dy=String(now.getDate()).padStart(2,'0');
try{var storedId=localStorage.getItem('certaDocId_'+yr+mo+dy);docIdCounter=storedId?parseInt(storedId)+1:1;localStorage.setItem('certaDocId_'+yr+mo+dy,docIdCounter);}catch(e){var hashVal=0;var hashStr=pdfChecksum||fk+tC;for(var i=0;i<hashStr.length;i++){hashVal=((hashVal<<5)-hashVal)+hashStr.charCodeAt(i);hashVal=hashVal&hashVal;}docIdCounter=Math.abs(hashVal%99999)+1;}
var docId='CERTA-'+yr+'-'+mo+'-'+dy+'-'+String(docIdCounter).padStart(5,'0');
// Regime colors map
var regimeColors={explosive:'#dc2626',oxidizing:'#ea580c',fluoride:'#9333ea',acid:'#dc2626',base:'#3b82f6',neutral:'#22c55e',unknown:'#6b7280'};
var pdfRegimeClass='neutral';var pdfRegimeText=_currentFAO.primaryRegime||'UNKNOWN';
if(pdfRegimeText.includes('EXPLOSIVE')||pdfRegimeText.includes('ENERGETIC'))pdfRegimeClass='explosive';
else if(pdfRegimeText.includes('OXIDIZ'))pdfRegimeClass='oxidizing';
else if(pdfRegimeText.includes('FLUORIDE')||pdfRegimeText.includes('HF'))pdfRegimeClass='fluoride';
else if(pdfRegimeText.includes('ACID'))pdfRegimeClass='acid';
else if(pdfRegimeText.includes('BASE')||pdfRegimeText.includes('ALKALI')||pdfRegimeText.includes('CAUSTIC'))pdfRegimeClass='base';
else if(pdfRegimeText.includes('NEUTRAL')||pdfRegimeText.includes('AQUEOUS'))pdfRegimeClass='neutral';
else pdfRegimeClass='unknown';
var regimeColor=regimeColors[pdfRegimeClass];
// Professional Header with inline styles
h+='<div style="background:#1e3a5f;color:white;padding:20px;margin:-20px -20px 20px -20px">';
h+='<table style="width:100%;border:none"><tr><td style="vertical-align:top"><div style="font-size:24px;font-weight:bold;letter-spacing:1px">CERTA</div><div style="font-size:10px;opacity:0.8">Industrial Fluid Assessment Platform</div></td>';
h+='<td style="text-align:right;vertical-align:top;font-size:9px"><div>'+L.document+': <b>'+docId+'</b></div><div>'+now.toLocaleDateString()+' '+now.toLocaleTimeString()+'</div><div style="margin-top:5px">Policy V16.8 | FAO âœ“</div></td></tr></table>';
h+='<div style="margin-top:15px;font-size:18px;font-weight:bold">'+fl.n+'</div>';
h+='<div style="font-size:10px;opacity:0.8">'+fl.c+'</div></div>';
// Regime Banner with inline color
h+='<div style="background:'+regimeColor+';color:white;padding:12px;text-align:center;font-weight:bold;font-size:12px;margin-bottom:15px;border-radius:4px">âš ï¸ '+L.regime+': '+pdfRegimeText.replace(/_/g,' ')+'</div>';
// Executive Summary Table
var matPass=cp.excellent?cp.excellent.length:0;
var matCond=cp.good?cp.good.length:0;
var matFail=cp.poor?cp.poor.length:0;
h+='<table style="width:100%;border-collapse:collapse;margin-bottom:15px"><tr>';
h+='<td style="width:25%;text-align:center;padding:10px;background:#eff6ff;border:1px solid #3b82f6"><div style="font-size:8px;color:#64748b;text-transform:uppercase">'+L.temperature+'</div><div style="font-size:16px;font-weight:bold;color:#1e3a5f">'+safeToFixed(tC,1,'0')+' Â°C</div></td>';
h+='<td style="width:25%;text-align:center;padding:10px;border:2px solid '+regimeColor+'"><div style="font-size:8px;color:#64748b;text-transform:uppercase">'+L.regime+'</div><div style="font-size:11px;font-weight:bold;color:'+regimeColor+'">'+pdfRegimeText.replace(/_/g,' ').substring(0,15)+'</div></td>';
h+='<td style="width:25%;text-align:center;padding:10px;background:#f0fdf4;border:1px solid #22c55e"><div style="font-size:8px;color:#64748b;text-transform:uppercase">'+L.sealState+'</div><div style="font-size:11px;font-weight:bold;color:#166534">'+(_currentFAO.sealEligibilityState||'N/A').replace(/_/g,' ').substring(0,12)+'</div></td>';
h+='<td style="width:25%;text-align:center;padding:10px;background:#fefce8;border:1px solid #eab308"><div style="font-size:8px;color:#64748b;text-transform:uppercase">'+L.materials+'</div><div style="font-size:16px;font-weight:bold;color:#854d0e">'+matPass+'P '+matCond+'C '+matFail+'F</div></td>';
h+='</tr></table>';
// FAO Verification
h+='<div style="background:#ecfdf5;border:1px solid #10b981;padding:8px;text-align:center;font-size:8px;color:#065f46;margin-bottom:15px;border-radius:4px">âœ… V15 Â§14.1 VERIFIED | RunID: '+_currentFAO.runId+' | Checksum: '+pdfChecksum+'</div>';
// V6.2: PDF REFUSAL INTELLIGENCE
var pdfProfile=getFluidBehaviorProfile(fk,tC);
var pdfFlags=pdfProfile.flags;
var pdfIsStrongOx=pdfFlags.includes('OXIDIZER_STRONG');
var pdfIsDehydrating=pdfFlags.includes('DEHYDRATING');
var pdfIsStrongAlkali=pdfFlags.includes('ALKALI_STRONG');
var pdfIsPhosphoricAcid=pdfFlags.includes('PHOSPHORIC_ACID');
var pdfSevereChemistry=(pdfIsStrongOx||pdfIsDehydrating)&&tC>=40;
var pdfRefusalFlags=[];
if(pdfSevereChemistry&&tC>=60)pdfRefusalFlags.push({msg:'High temperature + severe chemistry',action:'Specialist corrosion engineer review required'});
if(tC>100||tC<-20)pdfRefusalFlags.push({msg:'Extreme temperature conditions',action:'Verify material ratings at actual temperature'});
if(pdfIsStrongOx&&(fk.includes('chlor')||fk.includes('hcl')))pdfRefusalFlags.push({msg:'Oxidizer + halide combination',action:'Pitting/crevice corrosion risk - metallurgist review'});
if(pdfIsStrongAlkali&&tC>50)pdfRefusalFlags.push({msg:'Caustic SCC conditions (T>50Â°C)',action:'Stress analysis and PWHT verification required'});
if(tC>150)pdfRefusalFlags.push({msg:'Temperature exceeds elastomer limits',action:'FFKM or metal seals only'});
if(pdfRefusalFlags.length>0){
h+='<div class="expert-review"><div class="expert-title">ğŸš¨ EXPERT REVIEW FLAGS ('+pdfRefusalFlags.length+')</div>';
h+='<div style="font-size:8px;margin-bottom:6px">The following conditions require specialist verification. CERTA provides screening guidance only.</div>';
pdfRefusalFlags.forEach(function(r){h+='<div class="expert-flag"><strong>âš ï¸ '+r.msg+'</strong><div class="expert-action">â†’ '+r.action+'</div></div>';});
h+='</div>';}
// V81: Add Hard Failure Gate banner to PDF (now from FAO, not recalculated)
if(pdfGateResults.failed.length>0||pdfGateResults.conditional.length>0){
h+='<div style="background:#1e1b4b;border:2px solid #4338ca;border-radius:6px;padding:10px;margin:10px 0">';
h+='<div style="font-weight:bold;color:#a5b4fc;font-size:11px;margin-bottom:6px">ğŸš« HARD FAILURE GATE ACTIVE</div>';
if(pdfGateResults.failed.length>0){
h+='<div style="background:#450a0a;padding:6px;border-radius:4px;margin:4px 0;border-left:3px solid #dc2626">';
h+='<span style="color:#fca5a5;font-size:9px;font-weight:bold">FAILED ('+pdfGateResults.failed.length+'): </span>';
h+='<span style="color:#fca5a5;font-size:8px">'+pdfGateResults.failed.map(function(r){return M.materials[r.matId]?M.materials[r.matId].name:r.matId;}).join(', ')+'</span>';
h+='</div>';}
if(pdfGateResults.conditional.length>0){
h+='<div style="background:#422006;padding:6px;border-radius:4px;margin:4px 0;border-left:3px solid #d97706">';
h+='<span style="color:#fcd34d;font-size:9px;font-weight:bold">CONDITIONAL ('+pdfGateResults.conditional.length+'): </span>';
h+='<span style="color:#fcd34d;font-size:8px">'+pdfGateResults.conditional.map(function(r){return M.materials[r.matId]?M.materials[r.matId].name:r.matId;}).join(', ')+'</span>';
h+='</div>';}
h+='<div style="font-size:7px;color:#c7d2fe;margin-top:6px">Material arrays modified to reflect gate results. Verify specialist constraints in your application.</div>';
h+='</div>';}
h+='<h2>ğŸ“Š '+L.fluidProps+'</h2>';
h+='<div class="props"><div class="prop"><div class="prop-label">'+L.sg+'</div><div class="prop-value">'+safeToFixed(pr.sg, 4, '0')+'</div><div class="prop-unit">relative to water</div></div>';
h+='<div class="prop"><div class="prop-label">'+L.visc.replace(' (cP)','')+'</div><div class="prop-value">'+safeToFixed(pr.visc, 3, '0')+'</div><div class="prop-unit">cP (mPaÂ·s)</div></div>';
h+='<div class="prop"><div class="prop-label">Density</div><div class="prop-value">'+safeToFixed(dens, 2, '0')+'</div><div class="prop-unit">kg/mÂ³</div></div>';
h+='<div class="prop"><div class="prop-label">Kinematic Viscosity</div><div class="prop-value">'+safeToFixed(kv, 3, '0')+'</div><div class="prop-unit">cSt (mmÂ²/s)</div></div></div>';
if(pr.ex)h+='<div style="background:#fef3c7;border:1px solid #f59e0b;padding:6px;border-radius:4px;margin:8px 0;font-size:9px">âš ï¸ Temperature outside data range - values extrapolated</div>';
h+='<h2 style="color:#1e3a5f;font-size:12px;border-bottom:2px solid #3b82f6;padding-bottom:5px;margin:15px 0 10px">ğŸ“ˆ '+L.viscTemp+'</h2>';
h+='<table style="width:100%;border-collapse:collapse;margin-bottom:15px"><thead><tr><th style="background:#1e3a5f;color:white;padding:8px;text-align:center;border:1px solid #334155">'+L.tempC+'</th><th style="background:#1e3a5f;color:white;padding:8px;text-align:center;border:1px solid #334155">'+L.sg+'</th><th style="background:#1e3a5f;color:white;padding:8px;text-align:center;border:1px solid #334155">'+L.visc+'</th></tr></thead><tbody>';
fl.d.forEach(function(d){var isCurrent=Math.abs(d[0]-tC)<5;h+='<tr style="background:'+(isCurrent?'#fef3c7':'#fff')+'"><td style="padding:6px;text-align:center;border:1px solid #e5e7eb">'+d[0]+'</td><td style="padding:6px;text-align:center;border:1px solid #e5e7eb">'+safeToFixed(d[1], 4, '0')+'</td><td style="padding:6px;text-align:center;border:1px solid #e5e7eb;font-weight:'+(isCurrent?'bold':'normal')+'">'+safeToFixed(d[2], 3, '0')+'</td></tr>';});
h+='</tbody></table>';

// V16.3 REC-C3: TCO suppression for EXPLOSIVE_ENERGETIC per V15 Â§14
var pdfRegime = _currentFAO ? _currentFAO.primaryRegime : resolvePrimaryRegime(fk, tC).primary;
var pdfSuppressTCORegimes = ['UNKNOWN_RESTRICTED', 'EXPLOSIVE_ENERGETIC', 'FLUORIDE_ACID', 'TOXIC_SPECIAL'];
if (pdfSuppressTCORegimes.includes(pdfRegime)) {
  h+='<h2>ğŸ“Š Material Lifecycle Analysis</h2>';
  h+='<div style="background:#1e1b4b;border:2px solid #6366f1;padding:12px;border-radius:6px;margin:8px 0">';
  h+='<div style="color:#a5b4fc;font-weight:bold;font-size:10px;margin-bottom:6px">âš ï¸ TCO ANALYSIS SUPPRESSED</div>';
  h+='<div style="color:#c7d2fe;font-size:8px;line-height:1.4">';
  h+='<strong>V15 Â§14:</strong> Cost-based lifecycle recommendations are not provided for <strong>' + 
     pdfRegime.replace(/_/g, ' ') + '</strong> fluids.<br>';
  h+='Material selection must prioritize safety and containment over economics.</div></div>';
} else {
// BEGIN NORMAL TCO ANALYSIS
h+='<h2 style="color:#1e3a5f;font-size:12px;border-bottom:2px solid #3b82f6;padding-bottom:5px;margin:15px 0 10px">ğŸ“Š '+L.lifecycle+'</h2>';
// Use Fluid Behavior Profile for consistent chemistry classification in PDF
var pdfProfile=getFluidBehaviorProfile(fk,tC);
var pdfFlags=pdfProfile.flags;
var pdfIsStrongOx=pdfFlags.includes('OXIDIZER_STRONG');
var pdfIsDehydrating=pdfFlags.includes('DEHYDRATING');
var pdfIsVelocitySensitive=pdfFlags.includes('VELOCITY_SENSITIVE');
var pdfIsPhosphoricAcid=pdfFlags.includes('PHOSPHORIC_ACID');
// V16.3 REC-H1: Include OXIDIZER_ADJACENT and ENERGETIC for elastomer warnings
var pdfIsOxidizerAdjacent=pdfFlags.includes('OXIDIZER_ADJACENT');
var pdfIsEnergetic=pdfFlags.includes('ENERGETIC');
var pdfIsAnyOxidizer=pdfIsStrongOx||pdfIsOxidizerAdjacent||pdfIsEnergetic;
var pdfSevereChemistry=(pdfIsStrongOx||pdfIsDehydrating)&&tC>=40;
var pdfUseRobustness=pdfSevereChemistry;
var pdfModeLabel=pdfIsDehydrating?'Concentrated Hâ‚‚SOâ‚„/Dehydrating':pdfIsStrongOx?'Strong Oxidizer':pdfIsPhosphoricAcid?'Phosphoric Acid':'Reactive Chemistry';
h+='<div style="background:#f8fafc;border:1px solid #e2e8f0;padding:8px;border-radius:4px;margin-bottom:10px;font-size:8px"><strong>'+L.assumptions+':</strong> Velocity 2-3 m/s | Temp '+safeToFixed(tC, 0, '0')+'Â°C | Standard concentration | Corrosion rates mid-range [9,10] | Labor $500/mÂ²'+(pdfUseRobustness?' | <strong style="color:#c2410c">âš ï¸ '+pdfModeLabel.toUpperCase()+' MODE</strong>':'')+'</div>';
h+='<table style="width:100%;border-collapse:collapse;margin-bottom:15px"><thead><tr><th style="background:#1e3a5f;color:white;padding:6px;text-align:left;border:1px solid #334155;font-size:9px">'+L.material+'</th><th style="background:#1e3a5f;color:white;padding:6px;text-align:center;border:1px solid #334155;font-size:9px">'+L.rating+'</th><th style="background:#1e3a5f;color:white;padding:6px;text-align:center;border:1px solid #334155;font-size:9px">'+L.corrRate+'</th><th style="background:#1e3a5f;color:white;padding:6px;text-align:center;border:1px solid #334155;font-size:9px">'+L.serviceLife+'</th><th style="background:#1e3a5f;color:white;padding:6px;text-align:center;border:1px solid #334155;font-size:9px">'+(pdfUseRobustness?'Robustness':L.tco)+'</th></tr></thead><tbody>';
var bestTCO=Infinity,bestRob=0,results=[],elastomerResults=[];
var elastomerIds=['FKM','EPDM','NBR','Kalrez','Neoprene','Silicone'];
// V85: Track excluded materials for display
var pdfExcludedMats=[];
// V16.2: Auto-analyze all materials (removed manual selection grid)
Object.keys(M.materials).forEach(function(id){var mat=M.materials[id];if(!mat)return;
// V85 CRITICAL: Skip materials that failed hard failure gate - SCC, dissolution, embrittlement override corrosion rate
if(pdfFailedIds.includes(id)){
pdfExcludedMats.push({id:id,name:mat.name,reason:pdfGateResults.failed.find(function(f){return f.matId===id;})});
return; // Do NOT include in lifecycle analysis
}
var isElastomer=elastomerIds.includes(id);
var rating='Good',rc='g';var corrData=corr[id]||[0.01,0.05];if(cp.excellent&&cp.excellent.includes(id)){rating='Excellent';rc='e';}else if(cp.poor&&cp.poor.includes(id)){rating='Poor';rc='p';}var avgCorr=(corrData[0]+corrData[1])/2;var costs=M.costs[id];var life=costs.wall/avgCorr;if(life>50)life=50;var replacements=Math.max(0,Math.ceil(10/life)-1);var matCost=costs.price*100;var repCost=replacements*(matCost+500);var tco=matCost+repCost;if(!isElastomer&&tco<bestTCO)bestTCO=tco;
// Robustness calculation using behavior flags (same as UI)
var robustness=50;
if(rating==='Excellent')robustness+=40;else if(rating==='Good')robustness+=20;else if(rating==='Poor')robustness-=20;
if(id==='PTFE'||id==='PVDF'||id==='PEEK')robustness+=15;
if(id==='Kalrez')robustness+=12;
// Dehydrating agent penalties
if(pdfIsDehydrating){
if(id==='Hastelloy-C')robustness-=40;
if(id==='Titanium')robustness-=30;
if(id==='Aluminum')robustness-=35;
if(id==='Carbon-Steel'||id==='Cast-Iron')robustness-=25;
if(id==='316SS')robustness-=20;
if(id==='304SS')robustness-=25;
}
// Strong oxidizer penalties
if(pdfIsStrongOx){
if(id==='Titanium')robustness+=20;
if(id==='316SS'||id==='304SS')robustness-=20;
if(id==='Aluminum')robustness-=15;
if(id==='Carbon-Steel')robustness-=30;
}
// V86: Phosphoric acid - industry standard materials get bonuses
var pdfIsPhosphoricAcid=pdfFlags.includes('PHOSPHORIC_ACID');
if(pdfIsPhosphoricAcid){
if(id==='316SS')robustness+=15;
if(id==='Hastelloy-C')robustness+=15;
if(id==='Titanium')robustness+=12;
if(id==='304SS')robustness+=10;
if(id==='PTFE'||id==='PVDF')robustness+=10;
if(id==='Carbon-Steel')robustness-=25;
if(id==='Aluminum')robustness-=25;
}
// V6.2: Strong alkali penalties (caustic SCC, amphoteric attack)
if(pdfIsStrongAlkali){
if(id==='Aluminum'){robustness-=40;rating='Poor';rc='p';}  // Amphoteric dissolution
if(id==='Titanium'&&tC>50){robustness-=30;rating='Poor';rc='p';}  // Hot alkali attack
if(id==='Carbon-Steel'&&tC>50)robustness-=20;  // SCC risk
if(id==='PVC'){robustness-=35;if(tC>40){rating='Poor';rc='p';}}  // Plasticizer extraction
if(id==='CPVC'&&tC>60)robustness-=20;  // Stress cracking
}
// V6.2: Check negative knowledge base in PDF
var pdfFailureFlags=[];
if(M.failureKnowledge){
M.failureKnowledge.forEach(function(fk){
if(fk.material!==id)return;
var classMatch=false;
if(fk.fluidClass==='STRONG_BASE'&&pdfIsStrongAlkali)classMatch=true;
if(fk.fluidClass==='STRONG_ACID'&&(pdfIsDehydrating||pdfFlags.includes('REDUCING_ACID')))classMatch=true;
if(fk.fluidClass==='STRONG_OXIDIZER'&&pdfIsStrongOx)classMatch=true;
if(fk.fluidClass==='DEHYDRATING'&&pdfIsDehydrating)classMatch=true;
if(classMatch){
var tempMatch=fk.trigger.some(function(t){
if(t.includes('Any'))return true;
if(t.includes('Temp>')&&tC>=parseInt(t.replace(/[^0-9]/g,'')))return true;
return false;
});
if(tempMatch||fk.trigger.some(function(t){return !t.includes('Temp');})){
pdfFailureFlags.push(fk.failMode);
robustness-=30;
rating='Poor';rc='p';
}}});
}
if(pdfIsVelocitySensitive&&(id==='Carbon-Steel'||id==='Cast-Iron'))robustness-=15;
robustness=Math.max(0,Math.min(100,robustness));
if(!isElastomer&&robustness>bestRob)bestRob=robustness;
// V6.2: Separate elastomers from structural materials
var matWarning=pdfFailureFlags.length>0?pdfFailureFlags.join('; '):'';
if(isElastomer){
elastomerResults.push({id:id,name:mat.name,rating:rating,rc:rc,robustness:robustness,warning:matWarning});
}else{
results.push({id:id,name:mat.name,rating:rating,rc:rc,corr:avgCorr,life:life,tco:tco,robustness:robustness,warning:matWarning});
}});
// Sort by robustness in extreme chemistries, else by TCO
if(pdfUseRobustness){results.sort(function(a,b){return b.robustness-a.robustness;});}else{results.sort(function(a,b){return a.tco-b.tco;});}
results.forEach(function(r){var isBest=pdfUseRobustness?(r.robustness===bestRob):(r.tco===bestTCO);
var warnStyle=r.warning?'<div style="font-size:7px;color:#991b1b;margin-top:2px">âš ï¸ '+r.warning+'</div>':'';
// V16.3 REC-H3: Display "N/A (Polymer)" for zero/minimal corrosion materials
var corrDisplay=r.corr<0.001?'<span style="color:#059669">N/A</span>':safeToFixed(r.corr, 3, '0')+' mm/yr';
var lifeDisplay=r.corr<0.001?'<span style="color:#059669">Excellent</span>':safeToFixed(r.life, 1, '0')+' years';
var rowBg=isBest?'#ecfdf5':'#fff';
var ratingBg=r.rc==='e'?'#dcfce7':r.rc==='g'?'#dbeafe':'#fee2e2';
var ratingColor=r.rc==='e'?'#166534':r.rc==='g'?'#1e40af':'#991b1b';
if(pdfUseRobustness){
h+='<tr style="background:'+rowBg+'"><td style="padding:5px;border:1px solid #e5e7eb;font-size:9px">'+r.name+warnStyle+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center"><span style="background:'+ratingBg+';color:'+ratingColor+';padding:2px 6px;border-radius:3px;font-size:8px;font-weight:bold">'+r.rating+'</span></td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:9px">'+corrDisplay+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:9px">'+lifeDisplay+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-weight:bold;color:'+(r.robustness>=80?'#059669':r.robustness>=60?'#d97706':'#dc2626')+'">'+r.robustness+'%'+(isBest?' âœ“':'')+'</td></tr>';
}else{
h+='<tr style="background:'+rowBg+'"><td style="padding:5px;border:1px solid #e5e7eb;font-size:9px">'+r.name+warnStyle+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center"><span style="background:'+ratingBg+';color:'+ratingColor+';padding:2px 6px;border-radius:3px;font-size:8px;font-weight:bold">'+r.rating+'</span></td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:9px">'+corrDisplay+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:9px">'+lifeDisplay+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:9px;font-weight:bold">$'+safeToFixed(r.tco, 0, '0')+'/mÂ²'+(isBest?' âœ“':'')+'</td></tr>';
}});
h+='</tbody></table>';
// V6.2: Separate elastomer/sealing materials table (no fake service life!)
if(elastomerResults.length>0){
h+='<div style="margin-top:15px;font-weight:bold;font-size:10px;color:#7c3aed">ğŸ”© '+L.elastomers+'</div>';
h+='<div style="background:#f3e8ff;padding:6px;border-radius:4px;margin:6px 0;font-size:8px;color:#581c87;border:1px solid #c4b5fd">Note: Elastomers fail by swelling, hardening, and permeation â€” not corrosion. Inspection intervals shown, not service life.</div>';
h+='<table style="width:100%;border-collapse:collapse;margin-bottom:15px"><thead><tr><th style="background:#581c87;color:white;padding:6px;text-align:left;border:1px solid #7c3aed;font-size:9px">'+L.material+'</th><th style="background:#581c87;color:white;padding:6px;text-align:center;border:1px solid #7c3aed;font-size:9px">'+L.rating+'</th><th style="background:#581c87;color:white;padding:6px;text-align:center;border:1px solid #7c3aed;font-size:9px">'+L.failMode+'</th><th style="background:#581c87;color:white;padding:6px;text-align:center;border:1px solid #7c3aed;font-size:9px">'+L.inspection+'</th><th style="background:#581c87;color:white;padding:6px;text-align:center;border:1px solid #7c3aed;font-size:9px">'+L.strategy+'</th></tr></thead><tbody>';
elastomerResults.forEach(function(r){
// V16.3 REC-H1: Use pdfIsAnyOxidizer for broader oxidizer/energetic coverage
var failMode=(pdfIsAnyOxidizer||pdfIsDehydrating)?'Oxidative aging':'Chemical swelling';
var inspection=(pdfIsAnyOxidizer||pdfIsDehydrating)?'6-12 months':'12-24 months';
var strategy=(pdfIsAnyOxidizer||pdfIsDehydrating)?'Preventive replacement':'Condition-based';
var ratingBg=r.rc==='e'?'#dcfce7':r.rc==='g'?'#dbeafe':'#fee2e2';
var ratingColor=r.rc==='e'?'#166534':r.rc==='g'?'#1e40af':'#991b1b';
h+='<tr style="background:#fff"><td style="padding:5px;border:1px solid #e5e7eb;font-size:9px">'+r.name+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center"><span style="background:'+ratingBg+';color:'+ratingColor+';padding:2px 6px;border-radius:3px;font-size:8px;font-weight:bold">'+r.rating+'</span></td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:8px">'+failMode+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:8px;font-weight:bold;color:#7c3aed">'+inspection+'</td><td style="padding:5px;border:1px solid #e5e7eb;text-align:center;font-size:8px">'+strategy+'</td></tr>';
});
h+='</tbody></table>';
}
// V85: Display excluded materials banner in PDF
if(pdfExcludedMats.length>0){
h+='<div style="background:#1a1a2e;border:2px solid #6366f1;border-radius:4px;padding:8px;margin:8px 0">';
h+='<div style="font-weight:bold;color:#a5b4fc;font-size:9px;margin-bottom:4px">ğŸš« EXCLUDED FROM ANALYSIS ('+pdfExcludedMats.length+' materials)</div>';
h+='<div style="font-size:7px;color:#c7d2fe;margin-bottom:6px">Binary failure modes override corrosion rate economics. Materials below cannot be analyzed for TCO/lifecycle.</div>';
pdfExcludedMats.forEach(function(ex){
var reason=ex.reason?ex.reason.failureMode||'Hard failure mode':'Prohibited in this chemistry';
h+='<div style="background:#450a0a;padding:4px;border-radius:2px;margin:2px 0;border-left:2px solid #dc2626">';
h+='<span style="color:#fca5a5;font-size:8px;font-weight:bold">'+ex.name+':</span> ';
h+='<span style="color:#fecaca;font-size:7px">'+reason+'</span></div>';
});
h+='</div>';
}
if(results.length>0){
if(pdfUseRobustness){
var bestRobMat=results[0];
h+='<div class="rec-box" style="background:#fff7ed;border-color:#c2410c"><div class="rec-title" style="color:#c2410c">âš ï¸ '+pdfModeLabel+' Mode - Robustness Ranking</div>';
h+='<div style="font-size:8px;color:#78350f;margin-bottom:4px">TCO suppressed - '+(pdfIsDehydrating?'velocity/concentration sensitivity dominates in dehydrating acids':'corrosion uncertainty dominates')+'. Ranking by material robustness.</div>';
h+=bestRobMat.name+' offers highest robustness at '+bestRobMat.robustness+'% for this severe environment. '+(pdfIsDehydrating?'PTFE-lined systems recommended. Carbon steel only at <0.5 m/s.':'PTFE-lined or titanium systems recommended.')+'</div>';
}else{
// V81 CRITICAL: PDF must also respect CONDITIONAL constraint - SYNCED with UI logic
var best=results.find(function(r){return r.tco===bestTCO;});
var compatibleResults=results.filter(function(r){return r.status==='COMPATIBLE';});
var conditionalResults=results.filter(function(r){return r.status==='CONDITIONAL';});
var bestCompatible=compatibleResults.length>0?compatibleResults.reduce(function(a,b){return a.tco<b.tco?a:b;}):null;
var isBestConditional=best&&best.status==='CONDITIONAL';
if(isBestConditional){
h+='<div class="rec-box" style="background:#fff7ed;border-color:#c2410c"><div class="rec-title" style="color:#c2410c">âš ï¸ TCO Analysis - Compatibility Constraint Applied</div>';
h+='<div style="font-size:8px;color:#78350f;margin-bottom:4px"><strong>Engineering Note:</strong> '+best.name+' shows lowest TCO ($'+safeToFixed(best.tco, 0, '0')+'/mÂ²) but is CONDITIONAL for this chemistry. CONDITIONAL materials cannot be recommended as "BEST VALUE" due to unpredictable service life.</div>';
if(bestCompatible){h+='<div style="margin:4px 0"><strong>BEST VALUE (COMPATIBLE):</strong> '+bestCompatible.name+' at $'+safeToFixed(bestCompatible.tco, 0, '0')+'/mÂ² - reliable service life.</div>';}
h+='<div style="margin:4px 0;padding:4px;background:#fef3c7;border-radius:3px"><strong>CONDITIONAL (Lower TCO):</strong> '+best.name+' - requires verification, shortened inspection, contingency budget.</div>';
h+='</div>';
}else if(best){
h+='<div class="rec-box"><div class="rec-title">âœ“ Recommendation</div>'+best.name+' offers lowest 10-year TCO at $'+safeToFixed(best.tco, 0, '0')+'/mÂ² with '+safeToFixed(best.life, 1, '0')+' year service life.</div>';
}}}
// V16.3 REC-C3: Close TCO suppression else block
}
h+='<h2 style="color:#1e3a5f;font-size:12px;border-bottom:2px solid #3b82f6;padding-bottom:5px;margin:15px 0 10px">ğŸ”§ '+L.matCompat+'</h2>';
var pdfMatIdx=0;
// V6.2: Suppress % when material is CONDITIONAL or in severity mode - show status instead
if(cp.excellent&&cp.excellent.length){h+='<div style="margin-bottom:10px"><div style="display:inline-block;background:#dcfce7;color:#166534;padding:4px 10px;border-radius:4px;font-weight:bold;font-size:10px;margin-bottom:6px">âœ“ '+L.excellent+'</div><div style="display:flex;flex-wrap:wrap;gap:6px">';cp.excellent.forEach(function(m){var mt=M.materials[m];if(mt){var conf=calcConfidence('material',m,{tempDefined:true,inRange:!pr.ex,rating:'excellent',fluidKey:fk,tempC:tC});var confDisplay=conf.notRecommended?'<span style="background:#dc2626;color:#fff;font-size:7px;padding:1px 4px;border-radius:2px">NOT REC</span>':conf.conditional?'<span style="background:#92400e;color:#fef3c7;font-size:7px;padding:1px 4px;border-radius:2px">COND</span>':conf.hasSeverityMode?'<span style="background:#059669;color:#fff;font-size:7px;padding:1px 4px;border-radius:2px">OK</span>':'<span style="background:#064e3b;color:#6ee7b7;font-size:7px;padding:1px 4px;border-radius:2px">'+conf.score+'%</span>';h+='<span style="background:#f0fdf4;border:1px solid #86efac;color:#166534;padding:4px 8px;border-radius:4px;font-size:9px">'+mt.name+' '+confDisplay+'</span>';pdfMatIdx++;}});h+='</div></div>';}
if(cp.good&&cp.good.length){h+='<div style="margin-bottom:10px"><div style="display:inline-block;background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:4px;font-weight:bold;font-size:10px;margin-bottom:6px">â—‹ '+L.good+'</div><div style="display:flex;flex-wrap:wrap;gap:6px">';cp.good.forEach(function(m){var mt=M.materials[m];if(mt){var conf=calcConfidence('material',m,{tempDefined:true,inRange:!pr.ex,rating:'good',fluidKey:fk,tempC:tC});var confDisplay=conf.notRecommended?'<span style="background:#dc2626;color:#fff;font-size:7px;padding:1px 4px;border-radius:2px">NOT REC</span>':conf.conditional?'<span style="background:#92400e;color:#fef3c7;font-size:7px;padding:1px 4px;border-radius:2px">COND</span>':conf.hasSeverityMode?'<span style="background:#059669;color:#fff;font-size:7px;padding:1px 4px;border-radius:2px">OK</span>':'<span style="background:#1e3a5f;color:#7dd3fc;font-size:7px;padding:1px 4px;border-radius:2px">'+conf.score+'%</span>';h+='<span style="background:#eff6ff;border:1px solid #93c5fd;color:#1e40af;padding:4px 8px;border-radius:4px;font-size:9px">'+mt.name+' '+confDisplay+'</span>';pdfMatIdx++;}});h+='</div></div>';}
if(cp.poor&&cp.poor.length){h+='<div style="margin-bottom:10px"><div style="display:inline-block;background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:4px;font-weight:bold;font-size:10px;margin-bottom:6px">âœ— '+L.notRec+'</div><div style="display:flex;flex-wrap:wrap;gap:6px">';cp.poor.forEach(function(m){var mt=M.materials[m];if(mt){var conf=calcConfidence('material',m,{tempDefined:true,inRange:!pr.ex,rating:'poor',fluidKey:fk,tempC:tC});var confDisplay=conf.notRecommended?'<span style="background:#dc2626;color:#fff;font-size:7px;padding:1px 4px;border-radius:2px">NOT REC</span>':conf.conditional?'<span style="background:#92400e;color:#fef3c7;font-size:7px;padding:1px 4px;border-radius:2px">COND</span>':conf.hasSeverityMode?'<span style="background:#059669;color:#fff;font-size:7px;padding:1px 4px;border-radius:2px">OK</span>':'<span style="background:#7f1d1d;color:#fca5a5;font-size:7px;padding:1px 4px;border-radius:2px">'+conf.score+'%</span>';h+='<span style="background:#fef2f2;border:1px solid #fca5a5;color:#991b1b;padding:4px 8px;border-radius:4px;font-size:9px">'+mt.name+' '+confDisplay+'</span>';pdfMatIdx++;}});h+='</div></div>';}
h+='<div style="background:#f8fafc;padding:6px;border-radius:4px;font-size:8px;color:#64748b;font-style:italic;border-left:2px solid #3b82f6">Confidence % indicates data robustness based on source quality, input completeness, and applicability range - not probability of failure.</div>';
// Collect and display material warnings for PDF
var matWarnings=[];
['excellent','good','poor'].forEach(function(rating){
if(cp[rating]&&cp[rating].length){cp[rating].forEach(function(m){
var conf=calcConfidence('material',m,{tempDefined:true,inRange:!pr.ex,rating:rating,fluidKey:fk,tempC:tC});
if(conf.warning){matWarnings.push({mat:M.materials[m]?M.materials[m].name:m,warn:conf.warning,conditional:conf.conditional,notRecommended:conf.notRecommended});}
});}});
if(matWarnings.length>0){
var hasNotRec=matWarnings.some(function(w){return w.notRecommended;});
var hasConditional=matWarnings.some(function(w){return w.conditional;});
h+='<div style="background:'+(hasNotRec?'#450a0a':hasConditional?'#7c2d12':'#fef3c7')+';border:1px solid '+(hasNotRec?'#dc2626':hasConditional?'#c2410c':'#f59e0b')+';border-radius:4px;padding:6px;margin:6px 0;font-size:8px">';
h+='<div style="font-weight:bold;color:'+(hasNotRec?'#fca5a5':hasConditional?'#fed7aa':'#92400e')+';margin-bottom:4px">âš ï¸ '+(hasNotRec?'Severe Chemistry - ':hasConditional?'Reactive Chemistry - ':'')+'Material Sensitivity Warnings</div>';
matWarnings.forEach(function(w){h+='<div style="color:'+(hasNotRec?'#fca5a5':hasConditional?'#fed7aa':'#78350f')+';margin:2px 0">â€¢ '+(w.notRecommended?'<strong style="color:#f87171">[NOT RECOMMENDED]</strong> ':w.conditional?'<strong style="color:#fcd34d">[CONDITIONAL]</strong> ':'')+'<strong>'+w.mat+':</strong> '+w.warn.replace('âš ï¸ ','').replace('CONDITIONAL: ','').replace('NOT RECOMMENDED: ','')+'</div>';});
h+='</div>';}
// V15 Â§13.5: Get seal eligibility from FAO and apply filtering - MUST match UI implementation
var pdfSealEligibility = {
  state: _currentFAO.sealEligibilityState || 'STANDARD_ALLOWED',
  allowedCategories: _currentFAO.allowedSealCategories || [],
  reason: _currentFAO.sealReason || ''
};
var pdfSealFilterResult = filterSealsByEligibility(seals, pdfSealEligibility);
h+='<h2>âš™ï¸ '+L.sealRec+' ('+sk+' Service)</h2>';
if(pdfSealFilterResult.suppressed){
h+='<div style="background:#fef2f2;border:2px solid #dc2626;padding:10px;border-radius:6px;margin:8px 0"><div style="font-weight:bold;color:#991b1b;font-size:10px;margin-bottom:4px">ğŸš« SEAL SELECTION SUPPRESSED</div><div style="color:#7f1d1d;font-size:8px">'+pdfSealFilterResult.reason+'</div><div style="color:#991b1b;font-size:7px;margin-top:6px">Contact equipment manufacturer for specialized containment solutions.</div></div>';
}else{
if(pdfSealFilterResult.filtered){h+='<div style="background:#eff6ff;border:1px solid #3b82f6;padding:6px;border-radius:4px;margin:6px 0;font-size:8px;color:#1e40af"><strong>V15 Â§13.5:</strong> '+pdfSealEligibility.state.replace(/_/g,' ')+' - Showing '+pdfSealFilterResult.seals.length+' of '+pdfSealFilterResult.originalCount+' seal options</div>';}
var pdfSealIdx=0;
pdfSealFilterResult.seals.forEach(function(s){var cls=s.sealless?'sl':(s.priority.includes('CRITICAL')?'cr':'');var sealConf=calcConfidence('seal',s,{hasAPI:s.apiPlan.includes('API'),tempDefined:true,viscDefined:true,categoryMatch:true,priority:s.priority});var confCls=sealConf.score>=90?'vh':sealConf.score>=75?'hi':sealConf.score>=60?'md':'lo';h+='<div class="seal '+cls+'"><div class="st">'+(s.sealless?'ğŸŸ¢ ':'')+(s.priority.includes('CRITICAL')?'ğŸ”´ ':'')+s.type+' <span class="conf-pdf '+confCls+'">'+sealConf.score+'%</span></div><div class="sp">Priority: '+s.priority+'</div><div style="margin:4px 0"><strong>Why:</strong> '+s.reason+'</div><div style="display:flex;gap:8px;flex-wrap:wrap;font-size:8px"><div><strong>Specs:</strong> '+s.specs+'</div><div><strong>Materials:</strong> '+s.materials+'</div><div><strong>Standard:</strong> '+s.apiPlan+'</div></div></div>';pdfSealIdx++;});
}
h+='<div class="conf-note">Confidence % reflects data source authority and applicability to specified conditions.</div>';
if(hz){h+='<h2>âš ï¸ '+L.hazards+' (GHS-7/AICIS)</h2>';
h+='<div class="hz '+(hz.signal==='DANGER'?'d':'w')+'"><div class="sig">'+hz.pictograms.join(' ')+' '+hz.signal+'</div>';
h+='<div class="hs"><h4>GHS Classifications</h4><ul class="hl">';hz.ghsClasses.forEach(function(c){h+='<li>'+c+'</li>';});h+='</ul></div>';
h+='<div class="hs"><h4>Hazard Statements (H-codes)</h4><ul class="hl">';hz.hStatements.forEach(function(s){h+='<li>'+s+'</li>';});h+='</ul></div>';
if(hz.twa&&hz.twa!=='N/A'){h+='<div class="hs"><h4>Occupational Exposure Limits (Safe Work Australia WES)</h4><div class="exp-lim"><div class="exp-box twa-box"><div style="font-size:7px;color:#93c5fd">TWA (8-hour)</div><strong>'+hz.twa+'</strong></div><div class="exp-box stel-box"><div style="font-size:7px;color:#c4b5fd">STEL (15-min)</div><strong>'+(hz.stel||'N/A')+'</strong></div></div></div>';}
h+='<div class="hs"><h4>Required PPE</h4><div class="ppe">';hz.ppe.forEach(function(p){h+='<span class="pi">âœ“ '+p+'</span>';});h+='</div></div>';
h+='<div class="hs"><h4>First Aid</h4><div class="fa">'+hz.firstAid+'</div></div>';
h+='<div class="hs"><h4>Disposal</h4><div class="dp">'+hz.disposal+'</div></div>';
h+='<div style="font-size:8px;margin-top:8px;padding:6px;background:#f3f4f6;border-radius:4px"><strong>AICIS:</strong> '+hz.aicis+(hz.un&&hz.un!=='N/A'?' | <strong>UN:</strong> '+hz.un+' | <strong>PSN:</strong> '+hz.psn+' | <strong>ERG:</strong> '+hz.erg:'')+'</div>';
h+='<div style="font-size:7px;margin-top:6px;padding:4px;background:#eff6ff;border-radius:3px;border-left:2px solid #3b82f6"><strong>Australian Regulatory Sources:</strong> Safe Work Australia HCIS [13], Workplace Exposure Standards [14], AICIS [7], ADG Code [16]</div></div>';}
// Add Reynolds Number if calculated
if(lastReynolds){
h+='<h2>ğŸ§® '+L.reynolds+'</h2>';
h+='<div class="props">';
h+='<div class="prop"><div class="prop-label">Reynolds Number</div><div class="prop-value">'+lastReynolds.Re.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',')+'</div></div>';
h+='<div class="prop"><div class="prop-label">Flow Regime</div><div class="prop-value" style="font-size:11px;color:'+(lastReynolds.regime==='Laminar'?'#10b981':lastReynolds.regime==='Transition'?'#f59e0b':'#ef4444')+'">'+lastReynolds.regime+'</div></div>';
h+='<div class="prop"><div class="prop-label">Velocity</div><div class="prop-value">'+lastReynolds.velocity.toFixed(2)+'</div><div class="prop-unit">m/s</div></div>';
h+='<div class="prop"><div class="prop-label">Pipe Diameter</div><div class="prop-value">'+lastReynolds.diameter.toFixed(1)+'</div><div class="prop-unit">mm</div></div>';
h+='</div>';
h+='<div style="font-size:8px;color:#666;margin:6px 0;padding:4px;background:#eff6ff;border-radius:4px;border:1px solid #3b82f6">ğŸ“Š <strong>Input Parameters:</strong> Flow Rate = '+lastReynolds.inputQ+' '+lastReynolds.inputQUnit+' | Pipe Diameter = '+lastReynolds.inputD+' '+lastReynolds.inputDUnit+' | Temperature = '+lastReynolds.inputT+'Â°'+lastReynolds.inputTUnit+'</div>';
h+='<div style="font-size:8px;color:#666;margin:6px 0;padding:4px;background:#f3f4f6;border-radius:4px">Re < 2,300: Laminar | 2,300 < Re < 4,000: Transition | Re > 4,000: Turbulent</div>';
}
// Add Cavitation Analysis if calculated
if(lastCavitation){
h+='<h2>ğŸ”¬ '+L.cavitation+'</h2>';
var cavColor=lastCavitation.status==='Safe'?'#d1fae5':lastCavitation.status==='Warning'?'#fef3c7':'#fee2e2';
var cavBorder=lastCavitation.status==='Safe'?'#10b981':lastCavitation.status==='Warning'?'#f59e0b':'#ef4444';
var cavIcon=lastCavitation.status==='Safe'?'âœ… SAFE':lastCavitation.status==='Warning'?'âš ï¸ WARNING':'âŒ DANGER';
var cavConfPdf=lastCavitation.confidence||{score:75,level:'HIGH'};
var cavConfCls=cavConfPdf.score>=90?'vh':cavConfPdf.score>=75?'hi':cavConfPdf.score>=60?'md':'lo';
h+='<div style="background:'+cavColor+';border:2px solid '+cavBorder+';border-radius:6px;padding:10px;margin:8px 0">';
h+='<div style="font-size:12px;font-weight:bold;text-align:center;margin-bottom:8px">'+cavIcon+' (Margin: '+lastCavitation.margin.toFixed(1)+'%) <span class="conf-pdf '+cavConfCls+'">Confidence: '+cavConfPdf.score+'%</span></div>';
h+='<div class="props">';
h+='<div class="prop" style="background:white"><div class="prop-label">Vapor Pressure</div><div class="prop-value">'+lastCavitation.vaporP.toFixed(4)+'</div><div class="prop-unit">bar</div></div>';
h+='<div class="prop" style="background:white"><div class="prop-label">NPSHa</div><div class="prop-value">'+lastCavitation.NPSHa.toFixed(2)+'</div><div class="prop-unit">m</div></div>';
h+='<div class="prop" style="background:white"><div class="prop-label">NPSHr</div><div class="prop-value">'+lastCavitation.NPSHr.toFixed(2)+'</div><div class="prop-unit">m</div></div>';
h+='<div class="prop" style="background:white"><div class="prop-label">Suction P</div><div class="prop-value">'+lastCavitation.suctionP.toFixed(2)+'</div><div class="prop-unit">bar</div></div>';
h+='</div></div>';
h+='<div style="font-size:8px;color:#666;margin:6px 0;padding:4px;background:#f5f3ff;border-radius:4px;border:1px solid #8b5cf6">ğŸ“Š <strong>Input Parameters:</strong> Suction Pressure = '+lastCavitation.suctionP.toFixed(2)+' bar | NPSHr = '+lastCavitation.NPSHr.toFixed(1)+' m | Temperature = '+lastCavitation.inputT+'Â°'+lastCavitation.inputTUnit+' | Fluid = '+lastCavitation.fluidName+'</div>';
h+='<div class="conf-note">Cavitation confidence based on vapor pressure data source (CRC/Perry), input completeness, and safety margin adequacy.</div>';
h+='<div style="font-size:8px;color:#666;margin:6px 0;padding:4px;background:#f3f4f6;border-radius:4px">NPSHa must exceed NPSHr by >10% margin. >50% recommended for safety.</div>';
}
h+='<div class="refs"><h2 style="font-size:10px;margin:0 0 6px">ğŸ“š '+L.references+'</h2>';
R.forEach(function(r){if(fluidRefs.includes(r.num))h+='<div class="ref">['+r.num+'] '+r.apa+'</div>';});
h+='</div>';
// Professional Footer
h+='<div style="margin-top:20px;padding:15px;background:linear-gradient(135deg,#1e3a5f,#0f172a);border-radius:6px;color:white">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
h+='<div style="font-size:10px;font-weight:600">CERTA V17.7 | Policy V16.8</div>';
h+='<div style="font-size:9px;font-family:JetBrains Mono,monospace">'+docId+'</div>';
h+='</div>';
h+='<div style="background:#dc2626;color:white;padding:8px;border-radius:4px;text-align:center;font-weight:600;font-size:8px;margin-bottom:8px">âš ï¸ '+L.disclaimer+'</div>';
h+='<div style="display:flex;justify-content:space-between;font-size:7px;opacity:0.8">';
h+='<div>'+L.generated+': '+new Date().toLocaleString()+'</div>';
h+='<div>'+L.checksum+': '+pdfChecksum+'</div>';
h+='<div>FAO âœ“</div>';
h+='</div>';
h+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.2);font-size:6px;opacity:0.7;text-align:center">Standards: ISO 27001 Aligned | API RP 581 Compatible | GHS-7 Compliant | Â§2 Deterministic | Â§14 FAO Parity</div>';
h+='</div>';
h+='</body></html>';
var w=window.open('','_blank','width=800,height=600');if(w){w.document.write(h);w.document.close();w.focus();setTimeout(function(){w.print();},500);}else{alert('Please allow popups to print the report.');}
// V16.2 HARDENING: P1-A - Close try-catch wrapper
} catch(err) {
  console.error('CERTA printPDF() error:', err);
  alert('âš ï¸ PDF Generation Error\n\n' + err.message + '\n\nPlease try recalculating first.');
}
}
// Reynolds Number Calculator (#3)
// V16.2 HARDENING: P1-A - Add try-catch wrapper (Agent 3: Safety & Compliance)
function calcReynolds(){
try {
const res=document.getElementById('results');
if(!res.innerHTML){alert('Please calculate fluid properties first!');return;}
const fk=document.getElementById('fluidSelect').value,fl=F[fk];
const temp=parseFloat(DOM.getValue('tempInput')),unit=DOM.getValue('tempUnit');
let tC=temp;if(unit==='F')tC=(temp-32)*5/9;if(unit==='K')tC=temp-273.15;

// V16.2: Temperature validation (P1-D)
const tempValid = validateTemperature(tC);
if (!tempValid.valid) {
  alert('âš ï¸ Temperature Error:\n' + tempValid.errors.join('\n'));
  return;
}

const pr=interp(tC,fl.d),dens=pr.sg*1000,dynVisc=pr.visc/1000;
// Get flow rate
let Q=parseFloat(DOM.getValue('flowRate'));
const fUnit=DOM.getValue('flowUnit');
if(fUnit==='lpm')Q=Q/1000/60;else if(fUnit==='gpm')Q=Q*0.00378541/60;else Q=Q/3600;
// Get pipe diameter
let D=parseFloat(DOM.getValue('pipeDia'));
const dUnit=DOM.getValue('diaUnit');
if(dUnit==='in')D=D*25.4;
D=D/1000;

// V16.2: Division-by-zero guards (P1-C)
if (D <= 0 || !isFinite(D)) {
  alert('âš ï¸ Invalid pipe diameter. Must be greater than zero.');
  return;
}
if (dynVisc <= 0 || !isFinite(dynVisc)) {
  alert('âš ï¸ Invalid viscosity. Cannot calculate Reynolds number.');
  return;
}

// Calculate velocity and Reynolds
const A=Math.PI*D*D/4;
const v=safeDivide(Q, A, 0);
const Re=safeDivide(dens*v*D, dynVisc, 0);

// V16.2: Bounds check on results
if (!isFinite(Re) || Re < 0) {
  alert('âš ï¸ Invalid Reynolds number result. Check input values.');
  return;
}

// Display
DOM.show('reDisplay');
DOM.setText('reValue',safeToFixed(Re, 0, '0').replace(/\B(?=(\d{3})+(?!\d))/g,','));
const regime=document.getElementById('flowRegime');
const L=I18N[curLang];
if(Re<2300){regime.className='flow-regime laminar';regime.textContent='ğŸŸ¢ '+L.laminar+' (Re < 2,300)';}
else if(Re<4000){regime.className='flow-regime transition';regime.textContent='ğŸŸ¡ '+L.transition+' (2,300 < Re < 4,000)';}
else{regime.className='flow-regime turbulent';regime.textContent='ğŸ”´ '+L.turbulent+' (Re > 4,000)';}
// SECONDARY FIX: Add caveat for viscous fluids where Re is borderline
let viscousCaveat='';
if(pr.visc>10&&Re>2000&&Re<10000){
viscousCaveat='<div style="margin-top:8px;padding:8px;background:#451a03;border:1px solid #c2410c;border-radius:4px;font-size:0.75rem;color:#fed7aa"><strong>âš ï¸ Viscous Fluid Warning:</strong> At '+safeToFixed(pr.visc, 1, '0')+' cP, this fluid may exhibit non-Newtonian behavior near pipe walls. Re='+safeToFixed(Re, 0, '0')+' is borderline. <strong>Verify pressure drop empirically.</strong> Published correlations assume Newtonian behavior.</div>';
}
DOM.setHTML('reDetails','Velocity: <strong>'+safeToFixed(v, 2, '0')+' m/s</strong> | Density: '+safeToFixed(dens, 1, '0')+' kg/mÂ³ | Viscosity: '+safeToFixed(pr.visc, 3, '0')+' cP<br><span style="font-size:0.75rem;color:#64748b;margin-top:4px;display:inline-block">ğŸ“Š Input: Q='+DOM.getValue('flowRate')+' '+DOM.getValue('flowUnit')+', D='+DOM.getValue('pipeDia')+' '+DOM.getValue('diaUnit')+', T='+DOM.getValue('tempInput')+'Â°'+DOM.getValue('tempUnit')+'</span>'+viscousCaveat);
lastReynolds={Re:Re,velocity:v,density:dens,viscosity:pr.visc,diameter:D*1000,flowRate:Q*3600,regime:Re<2300?'Laminar':Re<4000?'Transition':'Turbulent',inputQ:DOM.getValue('flowRate'),inputQUnit:DOM.getValue('flowUnit'),inputD:DOM.getValue('pipeDia'),inputDUnit:DOM.getValue('diaUnit'),inputT:DOM.getValue('tempInput'),inputTUnit:DOM.getValue('tempUnit'),viscousCaveat:pr.visc>10&&Re>2000&&Re<10000};
} catch(err) {
  console.error('CERTA calcReynolds() error:', err);
  alert('âš ï¸ Reynolds Calculation Error\n\n' + err.message);
}
}
// Cavitation Risk Assessment (#7)
// V16.2 HARDENING: P1-A - Add try-catch wrapper (Agent 3: Safety & Compliance)
function calcCavitation(){
try {
const res=document.getElementById('results');
if(!res.innerHTML){alert('Please calculate fluid properties first!');return;}
const fk=document.getElementById('fluidSelect').value,fl=F[fk];
const temp=parseFloat(DOM.getValue('tempInput')),unit=DOM.getValue('tempUnit');
let tC=temp;if(unit==='F')tC=(temp-32)*5/9;if(unit==='K')tC=temp-273.15;

// V16.2: Temperature validation (P1-D)
const tempValid = validateTemperature(tC);
if (!tempValid.valid) {
  alert('âš ï¸ Temperature Error:\n' + tempValid.errors.join('\n'));
  return;
}

const pr=interp(tC,fl.d),dens=pr.sg*1000;

// V16.2: Validate density (P1-C)
if (dens <= 0 || !isFinite(dens)) {
  alert('âš ï¸ Invalid density. Cannot calculate cavitation risk.');
  return;
}

// Get vapor pressure - find matching fluid or use default
let vpData=VP['default'];
if(VP[fk])vpData=VP[fk];
else if(fk.includes('water')||fk==='wfi')vpData=VP['water'];
else if(fk.includes('methanol'))vpData=VP['methanol'];
else if(fk.includes('ethanol'))vpData=VP['ethanol'];
else if(fk.includes('acetone'))vpData=VP['acetone'];
else if(fk==='benzene')vpData=VP['benzene'];
else if(fk==='toluene'||fk==='xylene')vpData=VP['toluene'];
else if(fk==='gasoline'||fk==='naphtha')vpData=VP['gasoline'];
else if(fk==='diesel'||fk.includes('fuel-oil'))vpData=VP['diesel'];
// Interpolate vapor pressure
let Pv=0.02;
for(let i=0;i<vpData.length-1;i++){
if(tC>=vpData[i][0]&&tC<=vpData[i+1][0]){
const denom = vpData[i+1][0]-vpData[i][0];
const f = denom !== 0 ? (tC-vpData[i][0])/denom : 0;
Pv=vpData[i][1]+f*(vpData[i+1][1]-vpData[i][1]);break;
}}
if(tC<vpData[0][0])Pv=vpData[0][1];
if(tC>vpData[vpData.length-1][0])Pv=vpData[vpData.length-1][1];
// Get inputs
const Ps=parseFloat(document.getElementById('suctionP').value);
const NPSHr=parseFloat(document.getElementById('npshr').value);

// V16.2: Input validation (P1-C)
if (isNaN(Ps) || isNaN(NPSHr)) {
  alert('âš ï¸ Invalid input values. Check suction pressure and NPSHr.');
  return;
}
if (NPSHr <= 0) {
  alert('âš ï¸ NPSHr must be greater than zero.');
  return;
}

// Calculate NPSH available (simplified - at pump centerline)
const g=9.81;
const NPSHa=safeDivide((Ps-Pv)*100000, dens*g, 0);
const margin=safeDivide((NPSHa-NPSHr)*100, NPSHr, 0);
// Display
const cavRes=document.getElementById('cavResult');
cavRes.style.display='block';
DOM.setText('vaporP',safeToFixed(Pv, 4, '0')+' bar');
DOM.setText('npsha',safeToFixed(NPSHa, 2, '0')+' m');
DOM.setText('npshReq',safeToFixed(NPSHr, 2, '0')+' m');
DOM.setText('npshMargin',safeToFixed(margin, 1, '0')+'%');
const status=document.getElementById('cavStatus'),L=I18N[curLang];
if(margin>50){cavRes.className='cav-result safe';status.textContent=L.safe;}
else if(margin>10){cavRes.className='cav-result warning';status.textContent=L.warning;}
else{cavRes.className='cav-result danger';status.textContent=L.danger;}
// Confidence scoring for cavitation
const cavConf=calcConfidence('cavitation',null,{allInputs:!isNaN(Ps)&&!isNaN(NPSHr),tempInRange:!interp(tC,fl.d).ex,margin:margin});
DOM.setHTML('cavConfidence',confBadgeHTML(cavConf,'cav-0'));
// Display input parameters
DOM.setHTML('cavParams','ğŸ“Š Input: Suction P='+safeToFixed(Ps, 2, '0')+' bar, NPSHr='+safeToFixed(NPSHr, 1, '0')+' m, T='+DOM.getValue('tempInput')+'Â°'+DOM.getValue('tempUnit')+', Fluid='+F[fk].n);
lastCavitation={vaporP:Pv,NPSHa:NPSHa,NPSHr:NPSHr,margin:margin,status:margin>50?'Safe':margin>10?'Warning':'Danger',suctionP:Ps,inputT:DOM.getValue('tempInput'),inputTUnit:DOM.getValue('tempUnit'),fluidName:F[fk].n,confidence:cavConf};
} catch(err) {
  console.error('CERTA calcCavitation() error:', err);
  alert('âš ï¸ Cavitation Calculation Error\n\n' + err.message);
}
}
// Multi-Language System (#22)
function setLang(lang){
curLang=lang;
const L=I18N[lang];
document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
document.querySelector('.lang-btn[onclick="setLang(\''+lang+'\')"]').classList.add('active');
// RTL support for Arabic
document.body.dir=lang==='ar'?'rtl':'ltr';
document.body.style.textAlign=lang==='ar'?'right':'left';
DOM.setText('mainTitle','ğŸ”¬ CERTA');
DOM.setText('mainSubtitle','V17.5 | Policy V16.5.2 | '+L.subtitle);
document.querySelectorAll('[data-i18n]').forEach(el=>{
const key=el.getAttribute('data-i18n');
if(L[key])el.textContent=L[key];
});
try{localStorage.setItem('fluidCalcLang',lang);}catch(e){}
}
// V17.6 F2-001: Disclaimer Modal Functions - Parliament Session 13
function checkDisclaimer(){
  try{
    const accepted=localStorage.getItem('certaDisclaimerAccepted');
    const acceptedDate=localStorage.getItem('certaDisclaimerDate');
    // Require re-acceptance every 30 days
    if(accepted==='true'&&acceptedDate){
      const daysSince=(Date.now()-parseInt(acceptedDate))/(1000*60*60*24);
      if(daysSince<30)return true;
    }
  }catch(e){}
  return false;
}
function showDisclaimer(){
  document.getElementById('disclaimerOverlay').style.display='flex';
}
function updateDisclaimerBtn(){
  const cb=document.getElementById('disclaimerCheck');
  document.getElementById('disclaimerAccept').disabled=!cb.checked;
}
function acceptDisclaimer(){
  try{
    localStorage.setItem('certaDisclaimerAccepted','true');
    localStorage.setItem('certaDisclaimerDate',Date.now().toString());
  }catch(e){}
  document.getElementById('disclaimerOverlay').style.display='none';
}
function init(){
// V17.6 F2-001: Show disclaimer if not accepted
if(!checkDisclaimer()){
  showDisclaimer();
}
// V16.2 HARDENING: P2-A - Startup integrity validation (Agent 5: Regression & Feature)
try {
  const integrityCheck = validateStartupIntegrity();
  if (!integrityCheck.valid) {
    console.error('CERTA Startup Integrity Check FAILED:', integrityCheck.errors);
    alert('âš ï¸ CERTA Integrity Error\n\nMissing core functions:\n' + integrityCheck.errors.join('\n') + '\n\nPlease reload the page.');
    return;
  }
  if (integrityCheck.warnings.length > 0) {
    console.warn('CERTA Startup Warnings:', integrityCheck.warnings);
  }
} catch(e) {
  console.error('Startup validation error:', e);
}

filter();
// Count actual fluids
const fluidCount=Object.keys(F).length;
DOM.setText('fluidCount',fluidCount);
// Load usage counter
try{
const savedCount=localStorage.getItem('certaUsageCount');
if(savedCount)DOM.setText('usageCount',parseInt(savedCount).toLocaleString());
}catch(e){}
// Load saved language
try{const savedLang=localStorage.getItem('fluidCalcLang');if(savedLang&&I18N[savedLang])setLang(savedLang);}catch(e){}
// Build category list with icons
const cats={};Object.values(F).forEach(f=>{if(!cats[f.c])cats[f.c]=0;cats[f.c]++;});
const g=document.getElementById('catsGrid');
const catIcons={
  'Acids':'ğŸ§ª','Organic Acids':'ğŸ‹','Bases':'âš—ï¸','Alkalis':'âš—ï¸',
  'Solvents':'ğŸ”¬','Chlorinated Solvents':'â˜£ï¸','Alcohols':'ğŸ·',
  'Water & Aqueous':'ğŸ’§','Brine':'ğŸ§‚','Seawater':'ğŸŒŠ',
  'Fuels':'â›½','Petroleum':'ğŸ›¢ï¸','Oils':'ğŸ›¢ï¸',
  'Food & Beverage':'ğŸ','Dairy':'ğŸ¥›','Brewing':'ğŸº',
  'Gases':'ğŸ’¨','Refrigerants':'â„ï¸','Ammonia':'â˜ï¸',
  'Oxidizers':'ğŸ”¥','Peroxides':'âš ï¸'
};
const catClasses={
  'Acids':'acid','Organic Acids':'acid','Bases':'base','Alkalis':'base',
  'Solvents':'solvent','Chlorinated Solvents':'solvent','Alcohols':'solvent',
  'Water & Aqueous':'water','Brine':'water','Seawater':'water',
  'Fuels':'fuel','Petroleum':'fuel','Oils':'fuel',
  'Food & Beverage':'food','Dairy':'food','Brewing':'food',
  'Gases':'gas','Refrigerants':'gas','Ammonia':'gas'
};
Object.entries(cats).sort().forEach(([c,n])=>{
  const icon=Object.entries(catIcons).find(([k])=>c.toLowerCase().includes(k.toLowerCase()));
  const cls=Object.entries(catClasses).find(([k])=>c.toLowerCase().includes(k.toLowerCase()));
  const iconStr=icon?icon[1]+' ':'';
  const clsStr=cls?cls[1]:'';
  g.innerHTML+='<div class="cat-item '+clsStr+'" onclick="filterByCategory(\''+c.replace(/'/g,"\\'")+'\')">'+iconStr+c+' ('+n+')</div>';
});
}
// V87: Filter by category when clicking badge
// V16: filterByCategory disabled - category selector removed per rulebook
function filterByCategory(cat){
  // V16: Function disabled - category selector removed from UI
  return;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.1 UI/UX ENHANCEMENTS - Additional Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Enhancement #11: Theme Toggle
function toggleTheme(){
const html=document.documentElement;
const theme=html.getAttribute('data-theme')==='dark'?'light':'dark';
html.setAttribute('data-theme',theme);
DOM.setText('themeIcon',theme==='dark'?'ğŸŒ™':'â˜€ï¸');
localStorage.setItem('certaTheme',theme);
}

function loadTheme(){
const theme=localStorage.getItem('certaTheme')||'dark';
document.documentElement.setAttribute('data-theme',theme);
const icon=document.getElementById('themeIcon');
if(icon)icon.textContent=theme==='dark'?'ğŸŒ™':'â˜€ï¸';
}

// Enhancement #12: Onboarding
const onboardSteps=[
{title:'Welcome to CERTA V17.2',text:'CERTA is a chemistry-first industrial screening engine for material compatibility evaluation. This quick tour will show you the key features.'},
{title:'Select Your Fluid',text:'Use the industry selector to narrow down from 430+ fluids, or search directly by name, formula, or category.'},
{title:'View Regime Classification',text:'After running an assessment, you\'ll see the chemical regime banner showing hazard level and containment requirements per V15 Â§6.'},
{title:'Export Your Results',text:'Generate PDF reports with FAO hash for audit verification. All exports include the same data per V15 Â§14 UI=PDF rule.'}
];
let onboardStep=0;

function showOnboarding(){
if(localStorage.getItem('certaOnboarded'))return;
DOM.addClass('onboarding','active');
updateOnboard();
}

function updateOnboard(){
const s=onboardSteps[onboardStep];
DOM.setText('onboardStep',onboardStep+1);
DOM.setText('onboardTitle',s.title);
DOM.setText('onboardText',s.text);
}

function nextOnboarding(){
onboardStep++;
if(onboardStep>=onboardSteps.length){skipOnboarding();}
else{updateOnboard();}
}

function skipOnboarding(){
DOM.removeClass('onboarding','active');
localStorage.setItem('certaOnboarded','true');
}

// Enhancement #2: Industry Filtering
function filterByIndustry(){
const ind=document.getElementById('industrySelect').value;
// V16: categorySelect removed - filter directly to fluid dropdown
const fluidSel=document.getElementById('fluidSelect');
const filtered=[];
Object.entries(F).forEach(([id,f])=>{
if(!ind||f.c.toLowerCase().includes(ind.toLowerCase())||
(ind==='Mining'&&(f.c.includes('Mining')||f.c.includes('Slurr')))||
(ind==='Chemicals'&&(f.c.includes('Acid')||f.c.includes('Base')||f.c.includes('Solvent')))||
(ind==='Wastewater'&&(f.c.includes('Wastewater')||f.c.includes('Disinfect')))||
(ind==='Fertilizers'&&f.c.includes('Fertilizer'))||
(ind==='Pulp & Paper'&&f.c.includes('Pulp'))||
(ind==='Explosives'&&f.c.includes('Explosive'))||
(ind==='Animal Feed'&&f.c.includes('Feed'))||
(ind==='Food'&&f.c.includes('Food'))||
(ind==='Pharmaceutical'&&f.c.includes('Pharm'))){
filtered.push([id,f]);
}
});
// V16: Category dropdown removed - populate fluid dropdown directly
fluidSel.innerHTML='<option value="">Select a fluid...</option>'+filtered.sort((a,b)=>a[1].n.localeCompare(b[1].n)).map(([id,f])=>'<option value="'+id+'">'+f.n+'</option>').join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V15.2: QUICK ACCESS / INDUSTRY REFERENCE REMOVED
// Per RULEBOOK V3 Â§8: No assumptions about "industry standard behavior"
// Per V15 Â§9.3 No Silent Defaults: No pre-populated fluid shortcuts
// Per V15 Â§2.1 Determinism: No user-specific localStorage tracking
// All fluid selection must be explicit via search/dropdown only
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// V15.2: Functions disabled/removed - fluid selection must be explicit
function loadIndustryFluids(){ return; }
function selectIndustryFluid(id){ return; }
function saveRecentFluid(id,name,cat){ return; }
function loadRecentFluids(){ return; }

// Enhancement #8: Export Functions
function showExportPanel(){
const panel=document.getElementById('exportPanel');
if(panel)panel.style.display='block';
}

function exportPDF(){window.print();}
function exportExcel(){
if(!lastCalcData){alert('Run an assessment first');return;}
const csv='CERTA Assessment Report\nFluid,'+lastCalcData.fluidName+'\nTemperature,'+lastCalcData.tempC+'Â°C\nRegime,'+lastCalcData.regime+'\nSeal State,'+lastCalcData.sealState+'\nFAO Hash,'+lastCalcData.faoHash;
downloadFile(csv,'CERTA_'+lastCalcData.fluidId+'.csv','text/csv');
}
function exportCSV(){exportExcel();}
function showQRCode(){alert('QR Code feature - scan to access this assessment on mobile');}

function downloadFile(content,filename,type){
const blob=new Blob([content],{type});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=filename;a.click();
URL.revokeObjectURL(url);
}

// Mobile Nav
function scrollToSection(id){
const el=document.getElementById(id);
if(el)el.scrollIntoView({behavior:'smooth'});
}

// Enhanced init
const origInit=window.onload;
window.onload=function(){
loadTheme();
init(); // V16.1 FIX: Call init() to populate fluid list
if(origInit)origInit();
// V15.2: Quick Access / Industry Reference removed per RULEBOOK V3 Â§8 and V15 Â§9.3
// All fluid selection must be explicit via search/dropdown - no shortcuts or defaults
setTimeout(showOnboarding,800);
};
</script> <!-- Mobile Navigation (Enhancement #5) -->
<nav class="mobile-nav" role="navigation">
<button class="mobile-nav-item active" onclick="scrollToSection('searchBox')"><span class="icon">ğŸ§ª</span><span class="label">Fluid</span></button>
<button class="mobile-nav-item" onclick="scrollToSection('results')"><span class="icon">ğŸ“Š</span><span class="label">Results</span></button>
<button class="mobile-nav-item" onclick="window.print()"><span class="icon">ğŸ“¤</span><span class="label">Export</span></button>
<button class="mobile-nav-item" onclick="onboardStep=0;DOM.addClass('onboarding','active');updateOnboard()"><span class="icon">â“</span><span class="label">Help</span></button>
</nav> <!-- Screen Reader Announcements -->
<div id="srAnnounce" class="sr-only" role="status" aria-live="polite"></div> </body>
</html>
